<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Payment Analyzer">
<title>Payment Analyzer Professional v9.0 Enhanced - Production Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
<style>
/* === Root Variables & Base Styles === */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

:root {
    --primary: #0f172a;
    --primary-light: #1e293b;
    --accent: #3b82f6;
    --accent-dark: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #dc2626;
    --slate-50: #f8fafc;
    --slate-100: #f1f5f9;
    --slate-200: #e2e8f0;
    --slate-300: #cbd5e1;
    --slate-400: #94a3b8;
    --slate-500: #64748b;
    --slate-600: #475569;
    --slate-700: #334155;
    --slate-800: #1e293b;
    --slate-900: #0f172a;
    --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
    --bottom-nav-height: 60px;
    --safe-area-bottom: env(safe-area-inset-bottom, 0);
    --header-height: 50px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: var(--font-primary);
    line-height: 1.6;
    color: var(--primary);
    background: linear-gradient(180deg, #f0f4f8 0%, #d9e2ec 100%);
    min-height: 100vh;
    padding: 0;
    margin: 0;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === Watermark for Professional Edition === */
.watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 120px;
    font-weight: 900;
    color: rgba(0, 0, 0, 0.03);
    z-index: 0;
    pointer-events: none;
    text-transform: uppercase;
    display: none;
}

@media (min-width: 768px) {
    .watermark { display: block; }
}

/* === App Container === */
.app-container {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
    padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
}

/* === Page Header === */
.page-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-bottom: 1px solid var(--slate-200);
    padding: 12px 16px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.page-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 100%;
}

.page-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.page-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.header-btn {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 8px;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.2s;
}

.header-btn:active {
    transform: scale(0.95);
    background: var(--slate-50);
}

/* === Validation Badge === */
.validation-badge {
    background: linear-gradient(135deg, var(--slate-400) 0%, var(--slate-500) 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    animation: pulse 2s infinite;
}

.validation-badge.validated {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
}

.validation-badge.invalid {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* === Page Container === */
.page {
    display: none;
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 16px;
    animation: fadeIn 0.3s ease;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* === Bottom Navigation with Badges === */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--slate-200);
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 0 8px;
    padding-bottom: var(--safe-area-bottom);
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}

.nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: var(--slate-500);
    padding: 8px 4px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 8px;
    position: relative;
    min-height: 48px;
}

.nav-item:active {
    transform: scale(0.95);
}

.nav-item.active {
    color: var(--accent);
}

.nav-item.active .nav-icon {
    transform: translateY(-2px);
}

.nav-icon {
    font-size: 22px;
    margin-bottom: 4px;
    transition: all 0.3s;
}

.nav-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: capitalize;
}

.nav-item.active::before {
    content: '';
    position: absolute;
    top: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 3px;
    background: var(--accent);
    border-radius: 0 0 3px 3px;
}

.nav-badge {
    position: absolute;
    top: 4px;
    right: 20%;
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: badgePop 0.3s ease;
}

@keyframes badgePop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* === Recovery Banner === */
.recovery-banner {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    color: white;
    padding: 12px 24px;
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1100;
    animation: slideDown 0.5s ease-out;
    max-width: calc(100% - 32px);
}

.recovery-banner.show {
    display: flex;
}

@keyframes slideDown {
    from {
        transform: translate(-50%, -100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

.recovery-banner-text {
    font-size: 14px;
    font-weight: 600;
}

.recovery-banner-action {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.recovery-banner-close {
    background: transparent;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

/* === Dashboard Page === */
.dashboard-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.view-toggle {
    background: white;
    border-radius: 12px;
    padding: 4px;
    display: flex;
    gap: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.toggle-btn {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--slate-600);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.toggle-btn.active {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.executive-summary {
    background: linear-gradient(135deg, #1e3a8a 0%, #6d28d9 100%);
    color: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
}

.executive-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
}

.summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
}

.summary-title {
    font-size: 18px;
    font-weight: 700;
}

.summary-period {
    font-size: 12px;
    opacity: 0.9;
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    position: relative;
    z-index: 1;
}

.summary-stat {
    background: rgba(255, 255, 255, 0.1);
    padding: 12px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-stat-label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.summary-stat-value {
    font-size: 20px;
    font-weight: 800;
}

.summary-stat-change {
    font-size: 11px;
    margin-top: 2px;
    opacity: 0.9;
}

.positive { color: #10b981; }
.negative { color: #f87171; }

.calendar-widget {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.calendar-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
}

.calendar-nav {
    display: flex;
    gap: 8px;
}

.calendar-nav-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--slate-200);
    background: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.calendar-day-header {
    font-size: 10px;
    font-weight: 600;
    color: var(--slate-500);
    text-align: center;
    padding: 4px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    border-radius: 6px;
    position: relative;
    cursor: pointer;
}

.calendar-day.has-data {
    background: var(--slate-50);
    font-weight: 600;
}

.calendar-day.has-data::after {
    content: '';
    position: absolute;
    bottom: 2px;
    width: 4px;
    height: 4px;
    background: var(--accent);
    border-radius: 50%;
}

.calendar-day.today {
    background: var(--accent);
    color: white;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.kpi-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--slate-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    border-color: var(--accent);
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--accent);
}

.kpi-card.primary::before { background: var(--primary); }
.kpi-card.success::before { background: var(--success); }
.kpi-card.warning::before { background: var(--warning); }
.kpi-card.danger::before { background: var(--danger); }

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.kpi-label {
    font-size: 11px;
    color: var(--slate-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.kpi-icon {
    font-size: 16px;
    opacity: 0.5;
    width: 40px;
    height: 40px;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.kpi-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 4px;
    font-family: var(--font-mono);
}

.kpi-trend {
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.trend-up { color: var(--success); }
.trend-down { color: var(--danger); }
.trend-neutral { color: var(--slate-500); }

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.chart-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
}

.chart-legend {
    display: flex;
    gap: 12px;
    font-size: 11px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.bar-chart {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    height: 120px;
    gap: 8px;
    padding: 0 4px;
}

.bar-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    animation: slideUp 0.4s ease-out forwards;
    opacity: 0;
}

.bar {
    width: 100%;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    border-radius: 4px 4px 0 0;
    min-height: 4px;
    transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    cursor: pointer;
}

.bar.secondary {
    background: linear-gradient(135deg, var(--slate-300) 0%, var(--slate-400) 100%);
}

.animated-bar {
    transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 4px 4px 0 0;
    position: relative;
    cursor: pointer;
}

.animated-bar:hover {
    filter: brightness(1.1);
    transform: scaleY(1.02);
}

.animated-bar::after {
    content: attr(data-value);
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    font-weight: 700;
    opacity: 0;
    transition: opacity 0.2s;
}

.animated-bar:hover::after {
    opacity: 1;
}

@keyframes slideUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
    from {
        opacity: 0;
        transform: translateY(10px);
    }
}

.empty-chart {
    text-align: center;
    padding: 40px;
    color: var(--slate-400);
    font-size: 14px;
}

.chart-tooltip {
    animation: fadeIn 0.2s;
}

.bar-label {
    font-size: 10px;
    color: var(--slate-500);
    margin-top: 4px;
    text-align: center;
}

.forecast-card {
    background: linear-gradient(135deg, var(--slate-50) 0%, var(--slate-100) 100%);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 16px;
}

.forecast-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.forecast-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
}

.forecast-badge {
    background: var(--accent);
    color: white;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.forecast-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.forecast-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: white;
    border-radius: 8px;
}

.forecast-label {
    font-size: 13px;
    color: var(--slate-600);
}

.forecast-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
    font-family: var(--font-mono);
}

.quick-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 24px;
}

.action-btn {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 16px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.action-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-btn.secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--slate-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.upload-section {
    padding: 0;
}

.upload-area {
    background: white;
    border: 3px dashed var(--slate-300);
    border-radius: 16px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
}

.upload-area::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    opacity: 0;
    transition: opacity 0.3s;
}

.upload-area:hover::before {
    opacity: 0.05;
}

.upload-area:active {
    transform: scale(0.98);
    border-color: var(--accent);
}

.upload-area.drag-active {
    border-color: var(--accent);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%);
    transform: scale(1.02);
}

.upload-area.drag-active::before {
    opacity: 0.1;
}

.upload-area.drag-active .upload-icon {
    animation: bounce 0.5s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.upload-content {
    position: relative;
    z-index: 1;
}

.upload-icon {
    font-size: 48px;
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    position: relative;
}

.upload-icon svg {
    width: 100%;
    height: 100%;
    stroke: var(--slate-400);
    transition: all 0.3s ease;
}

.upload-area:hover .upload-icon svg {
    stroke: var(--accent);
    transform: scale(1.1);
}

.upload-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.upload-subtitle {
    font-size: 14px;
    color: var(--slate-500);
}

.file-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.file-item {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s;
}

.file-item:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.file-icon {
    width: 48px;
    height: 48px;
    background: var(--slate-100);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 24px;
}

.file-details {
    flex: 1;
    text-align: left;
}

.file-name {
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
    word-break: break-word;
}

.file-meta {
    font-size: 12px;
    color: var(--slate-500);
}

.remove-btn {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.remove-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.validation-alert {
    background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    font-weight: 600;
    display: none;
}

.validation-alert.show {
    display: block;
}

.validation-alert.error {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
}

.validation-alert.success {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
}

.validation-icon {
    font-size: 24px;
    margin-right: 10px;
}

.reports-content {
    padding: 0;
    position: relative;
}

.pull-indicator {
    position: absolute;
    top: -50px;
    left: 0;
    right: 0;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    color: white;
    font-size: 14px;
    font-weight: 600;
    transition: transform 0.3s;
}

.report-summary {
    background: linear-gradient(135deg, #1e3a8a 0%, #6d28d9 100%);
    color: white;
    padding: 24px;
    border-radius: 16px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

.report-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

.report-summary > * {
    position: relative;
    z-index: 1;
}

.summary-value {
    font-size: 32px;
    font-weight: 900;
}

.summary-meta {
    margin-top: 16px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.meta-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.meta-label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.meta-value {
    font-size: 16px;
    font-weight: 700;
}

.daily-results {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.results-header {
    background: var(--slate-50);
    padding: 12px 16px;
    border-bottom: 1px solid var(--slate-200);
    font-weight: 700;
    font-size: 14px;
    color: var(--primary);
}

.result-row {
    padding: 12px 16px;
    border-bottom: 1px solid var(--slate-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
}

.result-row:hover {
    background: linear-gradient(90deg, transparent 0%, var(--slate-50) 50%, transparent 100%);
}

.result-date {
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
    font-family: var(--font-mono);
}

.result-values {
    display: flex;
    gap: 16px;
    align-items: center;
}

.result-amount {
    font-family: var(--font-mono);
    font-weight: 700;
    font-size: 14px;
}

.result-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.badge-danger {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
    border: 1px solid rgba(220, 38, 38, 0.3);
}

.badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.settlement-section {
    padding: 16px;
    background: linear-gradient(180deg, var(--slate-50) 0%, white 100%);
}

.breakdown-details {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--slate-200);
    margin-bottom: 16px;
}

.breakdown-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--slate-200);
}

.breakdown-row:last-child {
    border-bottom: none;
}

.breakdown-label {
    font-size: 14px;
    color: var(--slate-600);
    font-weight: 500;
}

.breakdown-value {
    font-size: 15px;
    font-weight: 700;
    font-family: var(--font-mono);
    color: var(--primary);
}

.breakdown-row.total {
    border-top: 3px solid var(--primary);
    margin-top: 12px;
    padding-top: 12px;
}

.breakdown-row.total .breakdown-label {
    font-weight: 800;
    color: var(--primary);
    font-size: 16px;
}

.breakdown-row.total .breakdown-value {
    font-size: 20px;
    font-weight: 900;
    color: var(--accent);
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.history-item {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
}

.history-item:active {
    transform: scale(0.98);
    border-color: var(--accent);
}

.history-date {
    font-size: 12px;
    color: var(--slate-500);
    margin-bottom: 4px;
}

.history-period {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.history-stats {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
}

.history-total {
    font-weight: 600;
    color: var(--accent);
    font-family: var(--font-mono);
}

.settings-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.settings-section {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.settings-header {
    background: var(--slate-50);
    padding: 12px 16px;
    border-bottom: 1px solid var(--slate-200);
    font-weight: 700;
    font-size: 14px;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.settings-body {
    padding: 16px;
}

.setting-field {
    margin-bottom: 16px;
}

.setting-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--slate-700);
    margin-bottom: 8px;
    display: block;
}

.setting-input {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--slate-200);
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    font-family: var(--font-mono);
    transition: all 0.2s;
    background: white;
}

.setting-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.setting-description {
    font-size: 11px;
    color: var(--slate-500);
    margin-top: 4px;
}

.settings-actions {
    padding: 16px;
    border-top: 1px solid var(--slate-200);
    display: flex;
    gap: 12px;
}

.btn-primary {
    flex: 1;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.btn-secondary {
    flex: 1;
    background: var(--slate-200);
    color: var(--slate-700);
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: var(--slate-300);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
}

.btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

.storage-info {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    border: 1px solid #0284c7;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
}

.storage-info-title {
    font-size: 13px;
    font-weight: 700;
    color: #0c4a6e;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.storage-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 12px;
}

.storage-stat {
    display: flex;
    flex-direction: column;
}

.storage-stat-label {
    font-size: 11px;
    color: #075985;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.storage-stat-value {
    font-size: 18px;
    font-weight: 800;
    color: #0c4a6e;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
}

.empty-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.empty-message {
    font-size: 14px;
    color: var(--slate-500);
    margin-bottom: 24px;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.loading-card {
    background: white;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    text-align: center;
    min-width: 280px;
}

.spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--slate-200);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 12px;
}

.loading-progress {
    background: var(--slate-200);
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 16px;
}

.loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dark) 100%);
    transition: width 0.3s;
}

/* Enhanced Toast with all production features */
.toast {
    position: fixed;
    bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 20px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(17, 24, 39, 0.95);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    z-index: 3000;
    display: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: calc(100% - 32px);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    animation: toastSlideUp 0.3s ease;
}

.toast.show {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toast::before {
    content: '';
    font-size: 16px;
}

.toast.success { 
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.35);
}
.toast.success::before { content: '✅'; }

.toast.warn { 
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
    box-shadow: 0 10px 30px rgba(245, 158, 11, 0.35);
}
.toast.warn::before { content: '⚠️'; }

.toast.error { 
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.95), rgba(185, 28, 28, 0.95));
    box-shadow: 0 10px 30px rgba(220, 38, 38, 0.35);
}
.toast.error::before { content: '❌'; }

@keyframes toastSlideUp {
    0% { 
        transform: translate(-50%, 100%); 
        opacity: 0; 
    }
    100% { 
        transform: translate(-50%, 0); 
        opacity: 1; 
    }
}

@media (min-width: 768px) {
    .app-container {
        max-width: 768px;
        margin: 0 auto;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
    }
    
    .bottom-nav {
        max-width: 768px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .kpi-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .summary-stats {
        grid-template-columns: repeat(4, 1fr);
    }
}

/* Enhanced Print Styles */
@media print {
    @page {
        size: A4;
        margin: 10mm;
    }
    
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        font-size: 10pt !important;
    }
    
    .app-container {
        padding-bottom: 0 !important;
        box-shadow: none !important;
        max-width: 100% !important;
    }
    
    /* Professional header for print */
    .reports-content::before {
        content: "PAYMENT ANALYSIS REPORT";
        display: block;
        font-size: 24pt;
        font-weight: 900;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid var(--primary);
        color: var(--primary);
    }
    
    /* Report metadata for print */
    .report-summary::after {
        content: "Analysis Date: " attr(data-date) " | Period: " attr(data-period);
        display: block;
        margin-top: 10px;
        font-size: 9pt;
        color: var(--slate-600);
        text-align: center;
    }
    
    /* Enhanced table styles for print */
    .result-row {
        page-break-inside: avoid;
        border-bottom: 1px solid var(--slate-200) !important;
    }
    
    .breakdown-details {
        page-break-inside: avoid;
        border: 2px solid var(--primary) !important;
    }
    
    /* Footer for print */
    .reports-content::after {
        content: "Generated by Payment Analyzer Professional v9.0 Enhanced | © 2024 | Page " counter(page);
        display: block;
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--slate-300);
        font-size: 9pt;
        color: var(--slate-500);
    }
    
    /* Hide non-printable elements */
    .watermark,
    .bottom-nav,
    .page-header,
    .header-btn,
    .action-btn,
    .remove-btn,
    .view-toggle,
    .calendar-widget,
    .forecast-card,
    .quick-actions,
    .empty-state,
    .upload-section,
    .loading-overlay,
    .toast,
    .recovery-banner,
    .validation-alert,
    .pull-indicator {
        display: none !important;
    }
    
    .page {
        padding: 0 !important;
        display: block !important;
    }
}

.hidden { display: none !important; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }

.with-prefix {
    position: relative;
}

.with-prefix .currency-prefix {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    font-weight: 600;
    color: var(--slate-600);
    pointer-events: none;
    font-family: var(--font-mono);
}

.with-prefix .setting-input {
    padding-left: 36px;
}

.file-input {
    display: none;
}

@media (max-width: 768px) {
    .modal {
        width: calc(100% - 16px);
        margin: 8px;
    }
    
    .recovery-banner {
        width: calc(100% - 20px);
        left: 10px;
        transform: none;
        border-radius: 12px;
    }
}

/* === Enhanced Upload Area Styles === */
.upload-area.enhanced-upload {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px dashed var(--slate-300);
    border-radius: 16px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.upload-area.enhanced-upload:hover {
    border-color: var(--accent);
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.08);
}

.upload-area.enhanced-upload.dragging {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.05);
    border-width: 3px;
}


.upload-formats {
    font-size: 0.75rem;
    color: var(--slate-400);
    margin-top: 8px;
}

/* === Enhanced File List === */
.file-list.enhanced-file-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 24px;
}

.file-list.enhanced-file-list .file-item {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.file-list.enhanced-file-list .file-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-color: var(--accent);
}





.file-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: var(--slate-100);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.file-type-badge.runsheet {
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent);
}

.file-type-badge.invoice {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

/* === Analysis Preview === */
.analysis-preview {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 12px;
    padding: 20px;
    margin-top: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid var(--slate-200);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.preview-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--primary);
    margin: 0;
}

.preview-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
}

.preview-item {
    padding: 12px;
    background: var(--slate-50);
    border-radius: 8px;
    text-align: center;
}

.preview-label {
    font-size: 0.75rem;
    color: var(--slate-500);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.preview-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary);
}

/* === Enhanced Action Button === */
.action-btn.enhanced-action-btn {
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 32px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.action-btn.enhanced-action-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn-icon, .btn-text {
    transition: opacity 0.3s ease;
}

.btn-loader {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

.action-btn.loading .btn-icon,
.action-btn.loading .btn-text {
    opacity: 0;
}

/* === Enhanced Report Header === */
.report-header.enhanced-header {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: white;
    padding: 32px 24px;
    border-radius: 16px;
    margin-bottom: 32px;
    position: relative;
    overflow: hidden;
}

.report-header.enhanced-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
        opacity: 0.5; 
    }
    50% { 
        transform: scale(1.1); 
        opacity: 0.8; 
    }
}

.report-header-content {
    position: relative;
    z-index: 1;
}

.report-company {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.report-title {
    font-size: 1rem;
    font-weight: 400;
    opacity: 0.9;
    margin-bottom: 24px;
}

.report-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
}

.report-meta-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.report-meta-label {
    font-size: 0.75rem;
    opacity: 0.7;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.report-meta-value {
    font-size: 1rem;
    font-weight: 600;
}

/* === Enhanced KPI Dashboard === */
.kpi-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.kpi-card:hover::before {
    width: 8px;
}

.kpi-card.kpi-primary::before {
    background: var(--accent);
}

.kpi-card.kpi-secondary::before {
    background: var(--slate-400);
}

.kpi-title {
    font-size: 0.875rem;
    color: var(--slate-600);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.kpi-icon svg {
    width: 20px;
    height: 20px;
    stroke: var(--accent);
}

.kpi-subtitle {
    font-size: 0.75rem;
    color: var(--slate-500);
}

.kpi-trend.positive {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.kpi-trend.negative {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
}

/* === Comprehensive Data Table === */
.table-section {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 32px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid var(--slate-200);
}

.table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.table-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    margin: 0;
}

.table-actions {
    display: flex;
    gap: 12px;
}

.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -24px;
    padding: 0 24px;
}

.data-table {
    width: 100%;
    min-width: 900px;
    border-collapse: separate;
    border-spacing: 0;
}

.data-table thead {
    background: var(--slate-50);
}

.data-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.75rem;
    color: var(--slate-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--slate-200);
    white-space: nowrap;
    position: sticky;
    top: 0;
    background: var(--slate-50);
    z-index: 10;
}

.data-table td {
    padding: 16px 12px;
    font-size: 0.875rem;
    color: var(--slate-700);
    border-bottom: 1px solid var(--slate-100);
    white-space: nowrap;
}

.data-table tbody tr {
    transition: background 0.2s ease;
}

.data-table tbody tr:hover {
    background: var(--slate-50);
}

.data-table .date-cell {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
}

.data-table .amount-cell {
    font-family: var(--font-mono);
    font-weight: 600;
    text-align: right;
}

.data-table .amount-cell.positive {
    color: var(--success);
}

.data-table .amount-cell.negative {
    color: var(--danger);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.reconciled {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.status-badge.pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.status-badge.error {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
}

/* === Settlement Breakdown === */
.settlement-breakdown {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px;
    padding: 24px;
    margin-top: 32px;
    border: 1px solid var(--slate-200);
}

.breakdown-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 20px;
}

.breakdown-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.breakdown-item {
    background: white;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.breakdown-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

.breakdown-item.breakdown-total {
    background: var(--primary);
    color: white;
}

.breakdown-item.breakdown-total .breakdown-label,
.breakdown-item.breakdown-total .breakdown-value {
    color: white;
}


/* === Enhanced Print Styles === */
@media print {
    .report-header.enhanced-header {
        background: none !important;
        color: var(--primary) !important;
        border: 2px solid var(--primary);
        page-break-inside: avoid;
    }
    
    .report-header.enhanced-header * {
        color: var(--primary) !important;
    }
    
    .report-company {
        color: var(--primary) !important;
        border-bottom: 2px solid var(--primary);
        padding-bottom: 8px;
        margin-bottom: 16px;
    }
    
    .kpi-card {
        box-shadow: none !important;
        border: 1px solid var(--slate-300) !important;
        page-break-inside: avoid;
    }
    
    .table-section {
        box-shadow: none !important;
        border: 1px solid var(--slate-300) !important;
        page-break-inside: avoid;
    }
    
    .data-table {
        min-width: 100% !important;
        font-size: 0.75rem;
    }
    
    .data-table th {
        background: var(--slate-100) !important;
        position: static !important;
    }
    
    .settlement-breakdown {
        background: var(--slate-50) !important;
        page-break-inside: avoid;
    }
    
    .analysis-preview,
    .upload-area,
    .file-remove,
    .bottom-nav,
    .page-header,
    .table-actions,
    .validation-alert {
        display: none !important;
    }
    
    @page {
        size: A4;
        margin: 15mm;
    }
    
    .report-container {
        max-width: 100% !important;
    }
}

/* === Enhanced Onboarding Styles === */
.onboarding-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
    text-align: center;
    animation: fadeInUp 0.8s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Welcome Hero Section */
.welcome-hero {
    margin-bottom: 60px;
}

.hero-animation {
    position: relative;
    height: 120px;
    margin-bottom: 32px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.floating-icon {
    font-size: 48px;
    position: absolute;
    animation: float 3s ease-in-out infinite;
}

.floating-icon.delay-1 {
    left: -60px;
    animation-delay: 0.5s;
}

.floating-icon.delay-2 {
    right: -60px;
    animation-delay: 1s;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-20px);
    }
}

.welcome-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 16px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: slideInFromTop 0.8s ease-out;
}

@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.welcome-subtitle {
    font-size: 1.125rem;
    color: var(--slate-600);
    line-height: 1.6;
    animation: slideInFromBottom 0.8s ease-out 0.2s both;
}

@keyframes slideInFromBottom {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Section Titles */
.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 32px;
    position: relative;
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
}

/* Quick Start Steps */
.quick-start-section {
    margin-bottom: 60px;
}

.steps-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 32px;
    margin-top: 40px;
}

.step-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 32px 24px;
    position: relative;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: slideInFromLeft 0.6s ease-out;
    animation-fill-mode: both;
}

.step-card:nth-child(1) { animation-delay: 0.1s; }
.step-card:nth-child(2) { animation-delay: 0.2s; }
.step-card:nth-child(3) { animation-delay: 0.3s; }

@keyframes slideInFromLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.step-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
}

.step-number {
    position: absolute;
    top: -16px;
    left: 24px;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.step-icon {
    font-size: 40px;
    margin-bottom: 20px;
}

.step-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 12px;
}

.step-description {
    color: var(--slate-600);
    line-height: 1.6;
}

/* Features Section */
.features-section {
    margin-bottom: 60px;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 24px;
    margin-top: 40px;
}

.feature-card {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    animation: fadeIn 0.6s ease-out;
    animation-fill-mode: both;
}

.feature-card:nth-child(1) { animation-delay: 0.1s; }
.feature-card:nth-child(2) { animation-delay: 0.2s; }
.feature-card:nth-child(3) { animation-delay: 0.3s; }
.feature-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.feature-card:hover {
    border-color: var(--accent);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.feature-icon {
    font-size: 32px;
    margin-bottom: 16px;
}

.feature-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 8px;
}

.feature-description {
    font-size: 0.875rem;
    color: var(--slate-600);
    line-height: 1.5;
}

/* Call to Action Section */
.cta-section {
    margin-bottom: 50px;
}

.primary-cta-btn {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 18px 36px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    position: relative;
    overflow: hidden;
    margin-bottom: 16px;
}

.primary-cta-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.primary-cta-btn:hover::before {
    left: 100%;
}

.primary-cta-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
}

.primary-cta-btn:active {
    transform: translateY(-1px);
}

.btn-icon {
    font-size: 1.25rem;
}

.btn-arrow {
    font-size: 1.125rem;
    transition: transform 0.3s ease;
}

.primary-cta-btn:hover .btn-arrow {
    transform: translateX(4px);
}

.cta-note {
    font-size: 0.875rem;
    color: var(--slate-500);
    margin-top: 12px;
}

/* Tips Section */
.tips-section {
    background: linear-gradient(135deg, var(--slate-50) 0%, var(--slate-100) 100%);
    border-radius: 20px;
    padding: 32px;
    border: 1px solid var(--slate-200);
}

.tips-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 24px;
    text-align: center;
}

.tips-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    text-align: left;
}

.tip-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--slate-200);
    transition: all 0.3s ease;
}

.tip-item:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.tip-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
    margin-top: 2px;
}

.tip-text {
    color: var(--slate-700);
    line-height: 1.5;
    font-size: 0.875rem;
}

/* === Mobile Optimizations === */
@media (max-width: 640px) {
    .onboarding-container {
        padding: 20px 16px;
    }
    
    .welcome-title {
        font-size: 2rem;
    }
    
    .welcome-subtitle {
        font-size: 1rem;
    }
    
    .floating-icon.delay-1 {
        left: -40px;
    }
    
    .floating-icon.delay-2 {
        right: -40px;
    }
    
    .steps-container {
        grid-template-columns: 1fr;
        gap: 24px;
    }
    
    .features-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    
    .feature-card {
        padding: 20px 16px;
    }
    
    .primary-cta-btn {
        font-size: 1rem;
        padding: 16px 32px;
    }
    
    .tips-list {
        gap: 12px;
    }
    
    .tip-item {
        padding: 12px;
    }
    
    .report-header.enhanced-header {
        padding: 24px 16px;
    }
    
    .report-company {
        font-size: 1.25rem;
    }
    
    .kpi-dashboard {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .kpi-value {
        font-size: 1.75rem;
    }
    
    .table-wrapper {
        margin: 0 -16px;
        padding: 0 16px;
    }
    
    .data-table {
        font-size: 0.75rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 12px 8px;
    }
    
    .breakdown-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
<div class="watermark">ANALYZER PRO</div>
<div class="app-container">
    <!-- Toast Notification -->
    <output aria-live="polite" class="toast" id="toast"></output>
    
    <!-- Recovery Banner -->
    <div class="recovery-banner" id="recoveryBanner">
        <span class="recovery-banner-text" id="recoveryText">Restored your last analysis</span>
        <button class="recovery-banner-action" id="startNewBtn">Start New</button>
        <button class="recovery-banner-close" id="closeBannerBtn">×</button>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Processing documents...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Page -->
    <div class="page active" id="dashboard-page">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span>🏠</span>
                    <span>Dashboard</span>
                </h1>
                <div class="page-actions">
                    <button class="header-btn" id="refreshDashboard" aria-label="Refresh">
                        🔄
                    </button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-content" id="dashboardContent">
            <!-- View Toggle -->
            <div class="view-toggle" style="display: none;">
                <button class="toggle-btn active" id="monthlyToggle" data-view="monthly">
                    <span>📅</span>
                    <span>Monthly</span>
                </button>
                <button class="toggle-btn" id="weeklyToggle" data-view="weekly">
                    <span>📆</span>
                    <span>Weekly</span>
                </button>
            </div>
            
            <!-- Executive Summary -->
            <div class="executive-summary" id="executiveSummary" style="display: none;">
                <div class="summary-header">
                    <div class="summary-title">Executive Summary</div>
                    <div class="summary-period" id="summaryPeriod">This Month</div>
                </div>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Total Revenue</div>
                        <div class="summary-stat-value" id="summaryRevenue">£0.00</div>
                        <div class="summary-stat-change positive" id="revenueChange">↑ 0%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Daily</div>
                        <div class="summary-stat-value" id="summaryDaily">£0.00</div>
                        <div class="summary-stat-change" id="dailyChange">→ 0%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Deliveries</div>
                        <div class="summary-stat-value" id="summaryDeliveries">0</div>
                        <div class="summary-stat-change positive" id="deliveriesChange">↑ 0%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Performance</div>
                        <div class="summary-stat-value" id="summaryPerformance">0%</div>
                        <div class="summary-stat-change" id="performanceChange">→ Good</div>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Widget -->
            <div class="calendar-widget" style="display: none;">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendarMonth">December 2024</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="calPrev">‹</button>
                        <button class="calendar-nav-btn" id="calNext">›</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="kpi-grid" style="display: none;">
                <div class="kpi-card success">
                    <div class="kpi-header">
                        <div class="kpi-label">Expected</div>
                        <div class="kpi-icon">💰</div>
                    </div>
                    <div class="kpi-value" id="kpiExpected">£0.00</div>
                    <div class="kpi-trend trend-up" id="expectedTrend">
                        <span>↑</span>
                        <span>0% vs last</span>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">Received</div>
                        <div class="kpi-icon">✅</div>
                    </div>
                    <div class="kpi-value" id="kpiReceived">£0.00</div>
                    <div class="kpi-trend trend-neutral" id="receivedTrend">
                        <span>→</span>
                        <span>0% vs last</span>
                    </div>
                </div>
                
                <div class="kpi-card warning">
                    <div class="kpi-header">
                        <div class="kpi-label">Pending</div>
                        <div class="kpi-icon">⏳</div>
                    </div>
                    <div class="kpi-value" id="kpiPending">£0.00</div>
                    <div class="kpi-trend trend-down" id="pendingTrend">
                        <span>↓</span>
                        <span>0% vs last</span>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">Efficiency</div>
                        <div class="kpi-icon">📈</div>
                    </div>
                    <div class="kpi-value" id="kpiEfficiency">0%</div>
                    <div class="kpi-trend trend-up" id="efficiencyTrend">
                        <span>↑</span>
                        <span>Good</span>
                    </div>
                </div>
            </div>
            
            <!-- Chart Container -->
            <div class="chart-container" style="display: none;">
                <div class="chart-header">
                    <div class="chart-title">Revenue Trend</div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--accent)"></div>
                            <span>Expected</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--slate-400)"></div>
                            <span>Actual</span>
                        </div>
                    </div>
                </div>
                <div class="bar-chart" id="revenueChart">
                    <!-- Chart bars will be rendered here -->
                </div>
            </div>
            
            <!-- Forecast Section -->
            <div class="forecast-card" style="display: none;">
                <div class="forecast-header">
                    <div class="forecast-title">📊 Forecast</div>
                    <div class="forecast-badge">AI Predicted</div>
                </div>
                <div class="forecast-items">
                    <div class="forecast-item">
                        <div class="forecast-label">Next Week Expected</div>
                        <div class="forecast-value" id="forecastWeek">£0.00</div>
                    </div>
                    <div class="forecast-item">
                        <div class="forecast-label">Month End Projection</div>
                        <div class="forecast-value" id="forecastMonth">£0.00</div>
                    </div>
                    <div class="forecast-item">
                        <div class="forecast-label">Suggested Daily Target</div>
                        <div class="forecast-value" id="forecastTarget">£0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions" style="display: none;">
                <button class="action-btn" id="quickAnalyze">
                    <span>📊</span>
                    <span>Start New Analysis</span>
                </button>
                <button class="action-btn secondary" id="viewReports">
                    <span>📈</span>
                    <span>View All Reports</span>
                </button>
            </div>
            
            <!-- Enhanced Onboarding Experience -->
            <div class="onboarding-container" id="dashboardEmpty">
                <!-- Welcome Hero Section -->
                <div class="welcome-hero">
                    <div class="hero-animation">
                        <div class="floating-icon">📊</div>
                        <div class="floating-icon delay-1">💰</div>
                        <div class="floating-icon delay-2">📄</div>
                    </div>
                    <h1 class="welcome-title">Welcome to Payment Analyzer Pro!</h1>
                    <p class="welcome-subtitle">Your intelligent companion for tracking delivery payments and financial insights</p>
                </div>

                <!-- Quick Start Steps -->
                <div class="quick-start-section">
                    <h2 class="section-title">Get Started in 3 Easy Steps</h2>
                    <div class="steps-container">
                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-icon">📤</div>
                            <h3 class="step-title">Upload Documents</h3>
                            <p class="step-description">Drop your runsheets and invoices to start analyzing</p>
                        </div>
                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-icon">⚡</div>
                            <h3 class="step-title">Instant Analysis</h3>
                            <p class="step-description">Our AI processes your data in seconds</p>
                        </div>
                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div class="step-icon">📈</div>
                            <h3 class="step-title">View Insights</h3>
                            <p class="step-description">Get detailed reports and payment tracking</p>
                        </div>
                    </div>
                </div>

                <!-- Feature Highlights -->
                <div class="features-section">
                    <h2 class="section-title">What You Can Do</h2>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">🔍</div>
                            <h4 class="feature-title">Smart Analysis</h4>
                            <p class="feature-description">Automatically calculate expected vs paid amounts</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">📊</div>
                            <h4 class="feature-title">Visual Reports</h4>
                            <p class="feature-description">Beautiful charts and comprehensive breakdowns</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">💾</div>
                            <h4 class="feature-title">Auto Save</h4>
                            <p class="feature-description">Your data is safely stored and always accessible</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🖨️</div>
                            <h4 class="feature-title">Export Ready</h4>
                            <p class="feature-description">Print or export professional reports</p>
                        </div>
                    </div>
                </div>

                <!-- Call to Action -->
                <div class="cta-section">
                    <button class="primary-cta-btn" id="emptyStartAnalysis">
                        <span class="btn-icon">🚀</span>
                        <span class="btn-text">Start Your First Analysis</span>
                        <span class="btn-arrow">→</span>
                    </button>
                    <p class="cta-note">No registration required • Works offline • Free to use</p>
                </div>

                <!-- Tips Section -->
                <div class="tips-section">
                    <h3 class="tips-title">💡 Pro Tips</h3>
                    <div class="tips-list">
                        <div class="tip-item">
                            <span class="tip-icon">📋</span>
                            <span class="tip-text">Upload both runsheets and invoices for complete analysis</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">⚙️</span>
                            <span class="tip-text">Customize payment rates in Settings for accurate calculations</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">📱</span>
                            <span class="tip-text">Works great on mobile - analyze payments anywhere</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Page -->
    <div class="page" id="analysis-page">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span>🔍</span>
                    <span>Analyse</span>
                </h1>
                <div class="page-actions">
                    <div class="validation-badge" id="analysisValidationBadge" style="display: none;">
                        <span class="badge-text">PENDING</span>
                    </div>
                    <button class="header-btn" id="clearFiles" aria-label="Clear all">
                        🗑️
                    </button>
                </div>
            </div>
        </div>
        
        <div class="upload-section">
            <div class="upload-area enhanced-upload" id="uploadArea">
                <div class="upload-content">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </div>
                    <div class="upload-title">Upload PDF Files</div>
                    <div class="upload-subtitle">Drag & drop or tap to select runsheets and invoices</div>
                    <div class="upload-formats">Supports: PDF files only</div>
                </div>
            </div>
            <input accept=".pdf" class="file-input" id="fileInput" multiple type="file"/>
            
            <div class="file-list enhanced-file-list" id="fileList"></div>
            
            <div class="analysis-preview" id="analysisPreview" style="display: none;">
                <div class="preview-header">
                    <h3 class="preview-title">Analysis Preview</h3>
                    <div class="validation-badge" id="previewValidationBadge">
                        <span class="badge-icon">⏳</span>
                        <span class="badge-text">Validating...</span>
                    </div>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="preview-item">
                        <div class="preview-label">Total Files</div>
                        <div class="preview-value" id="previewTotalFiles">0</div>
                    </div>
                    <div class="preview-item">
                        <div class="preview-label">Runsheets</div>
                        <div class="preview-value" id="previewRunsheets">0</div>
                    </div>
                    <div class="preview-item">
                        <div class="preview-label">Invoices</div>
                        <div class="preview-value" id="previewInvoices">0</div>
                    </div>
                    <div class="preview-item">
                        <div class="preview-label">Status</div>
                        <div class="preview-value" id="previewStatus">Ready</div>
                    </div>
                </div>
            </div>
            
            <div class="validation-alert" id="validationAlert">
                <span class="validation-icon">⚠️</span>
                <span id="validationMessage"></span>
            </div>
            
            <button class="action-btn enhanced-action-btn mt-3" id="analyzeBtn" disabled>
                <span class="btn-icon">🔍</span>
                <span class="btn-text">Analyze Documents</span>
                <span class="btn-loader" style="display: none;">
                    <div class="loading"></div>
                </span>
            </button>
        </div>
    </div>
    
    <!-- Reports Page -->
    <div class="page" id="reports-page">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span>📊</span>
                    <span>Reports</span>
                </h1>
                <div class="page-actions">
                    <button class="header-btn" id="printReport" aria-label="Print">
                        🖨️
                    </button>
                    <button class="header-btn" id="exportReport" aria-label="Export">
                        💾
                    </button>
                </div>
            </div>
        </div>
        
        <div class="reports-content" id="reportsContent">
            <!-- Pull indicator for mobile refresh -->
            <div class="pull-indicator" id="pullIndicator">
                <span>↓ Pull to refresh</span>
            </div>
            
            <!-- Report content will be dynamically inserted -->
            <div class="empty-state" id="emptyReportState">
                <div class="empty-icon">📊</div>
                <div class="empty-title">No Report Available</div>
                <div class="empty-message">Complete an analysis to view reports</div>
            </div>
            
            <!-- Enhanced Report Structure (hidden by default) -->
            <div class="report-container" id="reportContainer" style="display: none;">
                <!-- Professional Report Header -->
                <div class="report-header enhanced-header">
                    <div class="report-header-content">
                        <div class="report-company">PAYMENT ANALYZER</div>
                        <div class="report-title">Financial Analysis Report</div>
                        <div class="report-meta">
                            <div class="report-meta-item">
                                <div class="report-meta-label">Period</div>
                                <div class="report-meta-value" id="reportPeriod">-</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Generated</div>
                                <div class="report-meta-value" id="reportDate">-</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Total Days</div>
                                <div class="report-meta-value" id="reportDays">-</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Status</div>
                                <div class="report-meta-value" id="reportStatus">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced KPI Dashboard -->
                <div class="kpi-dashboard">
                    <div class="kpi-card kpi-primary">
                        <div class="kpi-header">
                            <div class="kpi-title">Expected Total</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiExpected">£0.00</div>
                        <div class="kpi-subtitle" id="kpiExpectedSub">Total earnings</div>
                    </div>
                    
                    <div class="kpi-card kpi-secondary">
                        <div class="kpi-header">
                            <div class="kpi-title">Paid Amount</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="5" width="20" height="14" rx="2"/>
                                    <line x1="2" y1="10" x2="22" y2="10"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiPaid">£0.00</div>
                        <div class="kpi-subtitle" id="kpiPaidSub">Amount received</div>
                    </div>
                    
                    <div class="kpi-card" id="kpiDifferenceCard">
                        <div class="kpi-header">
                            <div class="kpi-title">Difference</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 12H4M12 4v16"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiDifference">£0.00</div>
                        <div class="kpi-trend" id="kpiTrend">
                            <span id="kpiTrendText">-</span>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-title">Consignments</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiConsignments">0</div>
                        <div class="kpi-subtitle" id="kpiConsignmentsSub">Total deliveries</div>
                    </div>
                </div>
                
                <!-- Comprehensive Data Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Daily Analysis Breakdown</h3>
                        <div class="table-actions">
                            <button class="button button-small button-secondary" id="toggleTableView">
                                <span>Compact View</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="data-table" id="dataTable" role="table" aria-label="Financial analysis breakdown by date">
                            <thead>
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Day</th>
                                    <th scope="col">Consignments</th>
                                    <th scope="col">Rate</th>
                                    <th scope="col">Base Pay</th>
                                    <th scope="col">Pickups</th>
                                    <th scope="col">Bonuses</th>
                                    <th scope="col">Expected</th>
                                    <th scope="col">Paid</th>
                                    <th scope="col">Difference</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Table rows will be inserted here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2"><strong>Totals</strong></td>
                                    <td class="amount-cell" id="footerConsignments">0</td>
                                    <td>-</td>
                                    <td class="amount-cell" id="footerBase">£0.00</td>
                                    <td class="amount-cell" id="footerPickups">£0.00</td>
                                    <td class="amount-cell" id="footerBonuses">£0.00</td>
                                    <td class="amount-cell" id="footerExpected">£0.00</td>
                                    <td class="amount-cell" id="footerPaid">£0.00</td>
                                    <td class="amount-cell" id="footerDifference">£0.00</td>
                                    <td>-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Settlement Breakdown -->
                <div class="settlement-breakdown">
                    <h3 class="breakdown-title">Settlement Summary</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-item">
                            <span class="breakdown-label">Consignment Payments</span>
                            <span class="breakdown-value" id="breakdownConsignments">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Pickup Services</span>
                            <span class="breakdown-value" id="breakdownPickups">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Unloading Bonus</span>
                            <span class="breakdown-value" id="breakdownUnloading">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Attendance Bonus</span>
                            <span class="breakdown-value" id="breakdownAttendance">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Early Arrival Bonus</span>
                            <span class="breakdown-value" id="breakdownEarly">£0.00</span>
                        </div>
                        <div class="breakdown-item breakdown-total">
                            <span class="breakdown-label">Total Expected</span>
                            <span class="breakdown-value" id="breakdownTotal">£0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Page -->
    <div class="page" id="history-page">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span>📜</span>
                    <span>History</span>
                </h1>
                <div class="page-actions">
                    <button class="header-btn" id="clearHistory" aria-label="Clear history">
                        🗑️
                    </button>
                </div>
            </div>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be dynamically inserted -->
            <div class="empty-state">
                <div class="empty-icon">📜</div>
                <div class="empty-title">No History</div>
                <div class="empty-message">Your analysis history will appear here</div>
            </div>
        </div>
    </div>
    
    <!-- Settings Page -->
    <div class="page" id="settings-page">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span>⚙️</span>
                    <span>Settings</span>
                </h1>
            </div>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-header">Consignment Rates</div>
                <div class="settings-body">
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="weekdayRate">Weekday Rate</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="weekdayRate" type="number" step="0.01" value="2.00"/>
                        <div class="setting-description">Rate per consignment Mon-Fri</div>
                    </div>
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="saturdayRate">Saturday Rate</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="saturdayRate" type="number" step="0.01" value="3.00"/>
                        <div class="setting-description">Rate per consignment on Saturday</div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header">Daily Bonuses</div>
                <div class="settings-body">
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="unloadingBonus">Unloading Bonus</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="unloadingBonus" type="number" step="0.01" value="30.00"/>
                        <div class="setting-description">Paid daily except Mondays</div>
                    </div>
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="attendanceBonus">Attendance Bonus</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="attendanceBonus" type="number" step="0.01" value="25.00"/>
                        <div class="setting-description">Paid on weekdays only</div>
                    </div>
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="earlyBonus">Early Arrival Bonus</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="earlyBonus" type="number" step="0.01" value="50.00"/>
                        <div class="setting-description">Paid on weekdays only</div>
                    </div>
                </div>
                <div class="settings-actions">
                    <button class="btn-secondary" id="resetRules">Reset</button>
                    <button class="btn-primary" id="saveRules">Save Changes</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header">Data Management</div>
                <div class="settings-body">
                    <div class="storage-info" id="storageInfoDiv">
                        <div class="storage-info-title">
                            <span>📊</span>
                            <span>Storage Statistics</span>
                        </div>
                        <div class="storage-stats">
                            <div class="storage-stat">
                                <span class="storage-stat-label">Total Analyses</span>
                                <span class="storage-stat-value" id="totalAnalysesCount">0</span>
                            </div>
                            <div class="storage-stat">
                                <span class="storage-stat-label">Storage Used</span>
                                <span class="storage-stat-value" id="storageUsed">0 KB</span>
                            </div>
                            <div class="storage-stat">
                                <span class="storage-stat-label">Compression</span>
                                <span class="storage-stat-value" id="compressionStatus">Enabled</span>
                            </div>
                            <div class="storage-stat">
                                <span class="storage-stat-label">Version</span>
                                <span class="storage-stat-value" id="storageVersion">9.0</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="action-btn secondary" id="exportCurrentBtn">
                        <span>💾</span>
                        <span>Export Current Analysis</span>
                    </button>
                    <button class="action-btn secondary mt-2" id="exportAllBtn">
                        <span>📚</span>
                        <span>Export All Data</span>
                    </button>
                    <button class="btn-danger mt-2" id="clearAllData" style="width: 100%;">
                        <span>🗑️</span>
                        <span>Clear All Data</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#dashboard" class="nav-item active" data-page="dashboard">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">Dashboard</span>
        </a>
        <a href="#analysis" class="nav-item" data-page="analysis">
            <span class="nav-icon">🔍</span>
            <span class="nav-label">Analyse</span>
        </a>
        <a href="#reports" class="nav-item" data-page="reports">
            <span class="nav-icon">📊</span>
            <span class="nav-label">Reports</span>
        </a>
        <a href="#history" class="nav-item" data-page="history">
            <span class="nav-icon">📜</span>
            <span class="nav-label">History</span>
        </a>
        <a href="#settings" class="nav-item" data-page="settings">
            <span class="nav-icon">⚙️</span>
            <span class="nav-label">Settings</span>
        </a>
    </nav>
</div>

<!-- Configure PDF.js -->
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // Polyfill for File.arrayBuffer() if not available
    if (typeof File.prototype.arrayBuffer === 'undefined') {
        File.prototype.arrayBuffer = function() {
            const file = this;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        };
    }
</script>

<!-- COMPLETE MODULES WITH ENHANCEMENTS -->

<!-- Router Module -->
<script id="routerModule" type="application/x-module">
// Router Module - Handles navigation between pages with badge system
const currentPage = { value: 'dashboard' };
const pageHandlers = {};

exports.init = function() {
    console.log('🚀 Router initialized');
    
    // Setup navigation click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            exports.navigate(page);
        });
    });
    
    // Handle browser back/forward
    window.addEventListener('hashchange', () => {
        const hash = window.location.hash.slice(1) || 'dashboard';
        exports.navigate(hash, false);
    });
    
    // Set initial page from URL hash
    const initialPage = window.location.hash.slice(1) || 'dashboard';
    exports.navigate(initialPage, false);
};

exports.navigate = function(page, updateHash = true) {
    console.log(`📍 Navigating to: ${page}`);
    
    // Hide all pages
    document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
    });
    
    // Show target page
    const targetPage = document.getElementById(`${page}-page`);
    if (targetPage) {
        targetPage.classList.add('active');
        
        // Update nav item states
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Update URL hash
        if (updateHash) {
            window.location.hash = page;
        }
        
        // Store current page
        currentPage.value = page;
        
        // Call page load handler if exists
        if (pageHandlers[page] && pageHandlers[page].onLoad) {
            pageHandlers[page].onLoad();
        }
    }
};

exports.registerPageHandler = function(page, handler) {
    pageHandlers[page] = handler;
};

exports.getCurrentPage = function() {
    return currentPage.value;
};

// Navigation badge system
exports.setNavBadge = function(page, count) {
    const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
    if (!navItem) return;
    
    let badge = navItem.querySelector('.nav-badge');
    
    if (count > 0) {
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'nav-badge';
            navItem.appendChild(badge);
        }
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'flex';
    } else if (badge) {
        badge.style.display = 'none';
    }
};
</script>

<!-- State Module - COMPLETE from original v8.2 with mobile enhancements -->
<script id="stateModule" type="application/x-module">
// State Management Module - Optimized with unique analysis storage
const STORAGE_KEY = 'paymentAnalyzer_v9';
const COMPRESSED_KEY = 'paymentAnalyzer_v9_compressed';
const ANALYSES_KEY = 'paymentAnalyzer_v9_analyses';
const VERSION = '9.0.0';

// Generate a fingerprint for a set of files
function generateFileFingerprint(files) {
    const fileInfo = files.map(f => ({
        name: f.name,
        size: f.size,
        lastModified: f.lastModified || 0
    })).sort((a, b) => a.name.localeCompare(b.name));
    
    return btoa(JSON.stringify(fileInfo)).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
}

// Format date properly
function formatDate(timestamp) {
    return new Date(timestamp).toISOString();
}

// Get file info without redundancy
function getMinimalFileInfo(files) {
    return files.map(f => ({
        name: f.name,
        size: f.size,
        type: f.name.toLowerCase().includes('runsheet') ? 'R' : 
              (f.name.toLowerCase().includes('invoice') || 
               f.name.toLowerCase().includes('bill')) ? 'I' : 'U'
    }));
}

// Save current session state (for recovery)
exports.save = function(state) {
    try {
        const enhancedState = {
            ...state,
            version: VERSION,
            lastModified: formatDate(Date.now())
        };
        
        const serialized = JSON.stringify(enhancedState);
        
        if (window.LZString) {
            const compressed = LZString.compressToUTF16(serialized);
            localStorage.setItem(COMPRESSED_KEY, compressed);
            
            localStorage.setItem(STORAGE_KEY + '_meta', JSON.stringify({
                version: VERSION,
                lastModified: enhancedState.lastModified,
                compressed: true
            }));
        } else {
            localStorage.setItem(STORAGE_KEY, serialized);
        }
        
        try { window.dispatchEvent(new CustomEvent('pa:state:saved')); } catch(e) {}
        return true;
    } catch (error) {
        console.error('Save failed:', error);
        return false;
    }
}

exports.load = function() {
    try {
        if (window.LZString) {
            const compressed = localStorage.getItem(COMPRESSED_KEY);
            if (compressed) {
                const decompressed = LZString.decompressFromUTF16(compressed);
                if (decompressed) {
                    return JSON.parse(decompressed);
                }
            }
        }
        
        const serialized = localStorage.getItem(STORAGE_KEY);
        if (serialized) {
            return JSON.parse(serialized);
        }
        
        return null;
    } catch (error) {
        console.error('Failed to load state:', error);
        return null;
    }
}

// Clear all storage
exports.clear = function() {
    try {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(COMPRESSED_KEY);
        localStorage.removeItem(STORAGE_KEY + '_meta');
        localStorage.removeItem(ANALYSES_KEY);
        // Also clear old versions for migration
        localStorage.removeItem('paymentAnalyzer_v8');
        localStorage.removeItem('paymentAnalyzer_v8_compressed');
        localStorage.removeItem('paymentAnalyzer_v8_analyses');
        try { window.dispatchEvent(new CustomEvent('pa:state:cleared')); } catch(e) {}
        return true;
    } catch (error) {
        console.error('Clear failed:', error);
        return false;
    }
}

// OPTIMIZED: Save or update unique analysis
exports.saveAnalysis = function(files, analysisData, processedData) {
    try {
        const fingerprint = generateFileFingerprint(files);
        const analyses = exports.getAllAnalyses();
        const rules = requireModule('rulesModule').load();
        
        // Check for existing analysis with same period and similar results
        const isDuplicate = Object.values(analyses).some(existing => {
            return existing.period === analysisData.metadata.periodRange &&
                   existing.summary.days === analysisData.metadata.totalDays &&
                   Math.abs(existing.summary.consignments - analysisData.totals.totalConsignments) < 5 && // Allow small variance
                   Math.abs(existing.summary.expected - analysisData.totals.expectedTotal) < 1 &&
                   Math.abs(existing.summary.paid - analysisData.totals.paidTotal) < 1;
        });
        
        if (isDuplicate) {
            console.log('⚠️ Duplicate analysis detected, skipping save');
            exports.updateStorageDisplay();
            return fingerprint;
        }
        
        // Generate a unique session ID for this analysis
        const sessionId = `${fingerprint}_${Date.now()}_${Math.random().toString(36).substring(7)}`;
        
        // Create optimized storage structure
        const optimizedAnalysis = {
            id: sessionId,
            fingerprint: fingerprint,
            created: formatDate(Date.now()),
            updated: formatDate(Date.now()),
            period: analysisData.metadata.periodRange,
            files: getMinimalFileInfo(files),
            summary: {
                days: analysisData.metadata.totalDays,
                consignments: analysisData.totals.totalConsignments,
                expected: analysisData.totals.expectedTotal,
                paid: analysisData.totals.paidTotal,
                difference: Math.round(analysisData.totals.differenceTotal * 100) / 100,
                status: analysisData.metadata.overallStatus.includes('FAVORABLE') ? 'F' : 'U'
            },
            details: {
                daily: analysisData.results.map(r => ({
                    d: r.date.split('-').slice(1).join('-'),
                    c: r.consignments,
                    e: r.expectedTotal,
                    p: r.paidAmount,
                    pc: r.pickupCount || 0
                })),
                totals: {
                    base: analysisData.totals.baseTotal,
                    bonus: analysisData.totals.bonusTotal,
                    pickup: analysisData.totals.pickupTotal
                }
            },
            rules: {
                wd: rules.weekdayRate,
                sat: rules.saturdayRate,
                unl: rules.unloadingBonus,
                att: rules.attendanceBonus,
                early: rules.earlyBonus
            },
            // Store complete data for mobile app
            results: analysisData.results,
            totals: analysisData.totals,
            metadata: analysisData.metadata
        };
        
        // Add new analysis with unique session ID
        analyses[sessionId] = optimizedAnalysis;
        
        // Limit total number of analyses to prevent excessive storage
        const analysesArray = Object.values(analyses);
        if (analysesArray.length > 50) {
            // Sort by created date and keep the most recent
            const sortedKeys = Object.keys(analyses).sort((a, b) => {
                const dateA = new Date(analyses[a].created || 0);
                const dateB = new Date(analyses[b].created || 0);
                return dateB - dateA;
            });
            
            // Keep only the 50 most recent
            const keepKeys = sortedKeys.slice(0, 50);
            const newAnalyses = {};
            keepKeys.forEach(key => {
                newAnalyses[key] = analyses[key];
            });
            
            // Save the trimmed analyses
            const serialized = JSON.stringify(newAnalyses);
            if (window.LZString) {
                const compressed = LZString.compressToUTF16(serialized);
                localStorage.setItem(ANALYSES_KEY, compressed);
            } else {
                localStorage.setItem(ANALYSES_KEY, serialized);
            }
        } else {
            // Save all analyses
            const serialized = JSON.stringify(analyses);
            if (window.LZString) {
                const compressed = LZString.compressToUTF16(serialized);
                localStorage.setItem(ANALYSES_KEY, compressed);
            } else {
                localStorage.setItem(ANALYSES_KEY, serialized);
            }
        }
        
        const totalAnalyses = Object.keys(analyses).length;
        console.log(`✅ Analysis saved (${totalAnalyses} total analyses stored)`);
        
        // Update storage info display if available
        exports.updateStorageDisplay();
        
        return sessionId;
    } catch (error) {
        console.error('Failed to save analysis:', error);
        return null;
    }
}

// Get all unique analyses
exports.getAllAnalyses = function() {
    try {
        let data;
        if (window.LZString) {
            const compressed = localStorage.getItem(ANALYSES_KEY);
            if (compressed) {
                const decompressed = LZString.decompressFromUTF16(compressed);
                if (decompressed) {
                    data = decompressed;
                }
            }
        }
        
        if (!data) {
            data = localStorage.getItem(ANALYSES_KEY);
        }
        
        return data ? JSON.parse(data) : {};
    } catch (error) {
        console.error('Failed to load analyses:', error);
        return {};
    }
}

// Check if files have been analyzed before
exports.findExistingAnalysis = function(files) {
    try {
        const fingerprint = generateFileFingerprint(files);
        const analyses = exports.getAllAnalyses();
        
        // Find all analyses with matching fingerprint
        const matchingAnalyses = Object.values(analyses).filter(a => 
            a.fingerprint === fingerprint
        );
        
        if (matchingAnalyses.length > 0) {
            // Get the most recent analysis
            const mostRecent = matchingAnalyses.sort((a, b) => 
                new Date(b.updated || b.created) - new Date(a.updated || a.created)
            )[0];
            
            console.log(`📦 Found ${matchingAnalyses.length} existing analyse(s) for these files`);
            console.log(`  Most recent from ${mostRecent.updated || mostRecent.created}`);
            
            // Check if rules have changed
            const currentRules = requireModule('rulesModule').load();
            const rulesChanged = 
                currentRules.weekdayRate !== mostRecent.rules.wd ||
                currentRules.saturdayRate !== mostRecent.rules.sat ||
                currentRules.unloadingBonus !== mostRecent.rules.unl ||
                currentRules.attendanceBonus !== mostRecent.rules.att ||
                currentRules.earlyBonus !== mostRecent.rules.early;
            
            if (rulesChanged) {
                console.log('⚠️ Payment rules have changed since last analysis');
            }
            
            // Return the full analysis data for mobile
            return {
                analysis: {
                    results: mostRecent.results,
                    totals: mostRecent.totals,
                    metadata: mostRecent.metadata
                },
                rulesChanged,
                timestamp: new Date(mostRecent.updated || mostRecent.created).getTime(),
                previousCount: matchingAnalyses.length - 1
            };
        }
        
        return null;
    } catch (error) {
        console.error('Failed to check existing analysis:', error);
        return null;
    }
}

// ENHANCED: Export data with proper formatting
exports.exportData = function(currentAnalysisData = null, exportAll = false) {
    try {
        const analyses = exports.getAllAnalyses();
        const analysesArray = Object.values(analyses);
        
        let exportData;
        
        if (!exportAll && currentAnalysisData) {
            // Export current analysis with full details
            const rules = requireModule('rulesModule').load();
            exportData = {
                version: VERSION,
                exportDate: formatDate(Date.now()),
                exportType: 'current_analysis',
                analysis: currentAnalysisData,
                rules: rules,
                metadata: {
                    exportDate: formatDate(Date.now())
                }
            };
        } else {
            // Export all analyses
            exportData = {
                version: VERSION,
                exportDate: formatDate(Date.now()),
                exportType: 'all_analyses',
                totalAnalyses: analysesArray.length,
                analyses: analysesArray
            };
        }
        
        if (exportData) {
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = exportAll ? 
                `payment-analyses-all-${dateStr}.json` : 
                `payment-analysis-current-${dateStr}.json`;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log(`📊 Exported ${exportData.exportType}`);
            requireModule('uiModule').showToast(
                exportAll ? `Exported ${exportData.totalAnalyses} analyses` : 'Current analysis exported',
                'success'
            );
        }
        
    } catch (error) {
        console.error('Export failed:', error);
        requireModule('uiModule').showToast('Export failed', 'error');
    }
}

// Get storage info
exports.getStorageInfo = function() {
    try {
        const analyses = exports.getAllAnalyses();
        const savedState = exports.load();
        
        // Calculate storage size
        const analysesSize = localStorage.getItem(ANALYSES_KEY)?.length || 0;
        const stateSize = (localStorage.getItem(COMPRESSED_KEY) || 
                          localStorage.getItem(STORAGE_KEY))?.length || 0;
        
        return {
            version: VERSION,
            totalAnalyses: Object.keys(analyses).length,
            lastStateUpdate: savedState?.lastModified || 'Never',
            storageUsed: {
                analyses: `${(analysesSize / 1024).toFixed(2)} KB`,
                state: `${(stateSize / 1024).toFixed(2)} KB`,
                total: `${((analysesSize + stateSize) / 1024).toFixed(2)} KB`
            },
            compression: window.LZString ? 'Enabled' : 'Disabled'
        };
    } catch (error) {
        return { error: error.message };
    }
}

// Update storage display in settings modal
exports.updateStorageDisplay = function() {
    const info = exports.getStorageInfo();
    const totalAnalysesEl = document.getElementById('totalAnalysesCount');
    const storageUsedEl = document.getElementById('storageUsed');
    const compressionEl = document.getElementById('compressionStatus');
    const versionEl = document.getElementById('storageVersion');
    
    if (totalAnalysesEl) totalAnalysesEl.textContent = info.totalAnalyses;
    if (storageUsedEl) storageUsedEl.textContent = info.storageUsed?.total || '0 KB';
    if (compressionEl) compressionEl.textContent = info.compression || 'Unknown';
    if (versionEl) versionEl.textContent = VERSION;
}

exports.generateFileFingerprint = generateFileFingerprint;
exports.VERSION = VERSION;
</script>

<!-- Rules Module - COMPLETE from original v8.2 -->
<script id="rulesModule" type="application/x-module">
// Payment Rules Module
const RULES_KEY = 'pa:rules:v9';

const DEFAULT_RULES = {
    weekdayRate: 2.00,
    saturdayRate: 3.00,
    unloadingBonus: 30.00,
    attendanceBonus: 25.00,
    earlyBonus: 50.00
};

exports.load = function() {
    try {
        const saved = localStorage.getItem(RULES_KEY);
        if (saved) {
            return { ...DEFAULT_RULES, ...JSON.parse(saved) };
        }
    } catch (error) {
        console.error('Failed to load rules:', error);
    }
    return { ...DEFAULT_RULES };
}

exports.save = function(rules) {
    try {
        localStorage.setItem(RULES_KEY, JSON.stringify(rules));
        return true;
    } catch (error) {
        requireModule('uiModule').showToast('Could not save rules.', 'error');
        return false;
    }
}

exports.reset = function() {
    return exports.save(DEFAULT_RULES);
}

exports.getDefaults = function() {
    return { ...DEFAULT_RULES };
}
</script>

<!-- Parser Module - COMPLETE from original v8.2 with all validation -->
<script id="parserModule" type="application/x-module">
// PDF Parser Module - FIXED version with proper function scoping

// Define all functions as local constants first
const extractDocumentTotal = function(text) {
    const totalPatterns = [
        /Docket\s+Total:\s*([0-9,]+\.?\d*)/i,
        /GBP\s*([0-9,]+\.?\d*)\s*Total:/i,
        /Total:\s*GBP\s*([0-9,]+\.?\d*)/i,
        /Total:\s*([0-9,]+\.?\d*)/i
    ];
    
    for (const pattern of totalPatterns) {
        const match = text.match(pattern);
        if (match) {
            const amount = parseFloat(match[1].replace(/,/g, ''));
            if (amount > 0) {
                console.log(`📊 Document total found: £${amount.toFixed(2)}`);
                return amount;
            }
        }
    }
    
    console.log('⚠️ Document total not found');
    return null;
};

const extractTextFromPDF = async function(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    
    let fullText = '';
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
    }
    return fullText;
};

const extractDateFromRunsheet = function(text) {
    const match = text.match(/Date:\s*(\d{2}[-\/]\d{2}[-\/]\d{4})/);
    if (match) {
        const parts = match[1].replace(/\//g, '-').split('-');
        return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }
    return null;
};

const extractConsignmentsFromRunsheet = function(text) {
    const tokens = text.split(/\s+/);
    const consignmentsList = [];
    
    for (let i = 0; i < tokens.length - 1; i++) {
        const token = tokens[i];
        const nextToken = tokens[i + 1];
        
        if (/^\d+$/.test(token)) {
            const num = parseInt(token);
            
            if (/^\d{7}$/.test(nextToken) || /^AH\d+$/.test(nextToken)) {
                const nearbyTokens = tokens.slice(i, i + 10).join(' ');
                if (nearbyTokens.includes('Delivery') || nearbyTokens.includes('Collection')) {
                    consignmentsList.push({
                        number: num,
                        id: nextToken
                    });
                }
            }
        }
    }
    
    if (consignmentsList.length > 0) {
        console.log(`✅ Runsheet - Total deliveries: ${consignmentsList.length}`);
        console.log(`  First: ${consignmentsList.slice(0, 3).map(c => `#${c.number} ${c.id}`).join(', ')}`);
        console.log(`  Last: ${consignmentsList.slice(-3).map(c => `#${c.number} ${c.id}`).join(', ')}`);
    }
    
    return consignmentsList.length;
};

const extractInvoiceAmounts = function(text) {
    const amounts = {};
    const pickups = {};
    
    console.log('📄 Processing Invoice...');
    
    const documentTotal = extractDocumentTotal(text);
    
    const tokens = text.split(/\s+/);
    let currentDate = null;
    let currentTime = null;
    const processedExtraDrops = new Set();
    let serviceBlockOpen = false;
    
    for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        
        if (token === 'Docket' && i + 1 < tokens.length && tokens[i+1] === 'Total:') {
            console.log('  ✓ Reached invoice summary - stopping extraction');
            break;
        }
        
        if (/^\d{2}\/\d{2}\/\d{2}$/.test(token)) {
            if (i + 1 < tokens.length && /^\d{2}:\d{2}$/.test(tokens[i + 1])) {
                serviceBlockOpen = false;
                
                const [day, month, year] = token.split('/');
                currentDate = `20${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                currentTime = tokens[i + 1];
                serviceBlockOpen = true;
                
                const isPickup = i + 2 < tokens.length && tokens[i + 2] === '-PickUp';
                
                let foundAmount = false;
                for (let j = i + 2; j < Math.min(i + 30, tokens.length); j++) {
                    const checkToken = tokens[j];
                    
                    if (/^\d+\.\d+/.test(checkToken)) {
                        const match = checkToken.match(/^(\d+\.\d{2})/);
                        if (match) {
                            const amount = parseFloat(match[1]);
                            
                            if (amount >= 3 && amount <= 500) {
                                if (!amounts[currentDate]) amounts[currentDate] = 0;
                                amounts[currentDate] += amount;
                                
                                if (isPickup) {
                                    if (!pickups[currentDate]) {
                                        pickups[currentDate] = { count: 0, total: 0 };
                                    }
                                    pickups[currentDate].count++;
                                    pickups[currentDate].total += amount;
                                    console.log(`    🚚 ${currentDate}: +£${amount.toFixed(2)} (PickUp Service #${pickups[currentDate].count})`);
                                } else {
                                    const contextTokens = tokens.slice(i, j);
                                    let serviceType = 'Unknown';
                                    if (contextTokens.includes('Multidrops')) serviceType = 'Multidrops';
                                    else if (contextTokens.includes('Small') && contextTokens.includes('Van')) serviceType = 'Small Van';
                                    else if (contextTokens.includes('LWB')) serviceType = 'LWB Transit';
                                    
                                    console.log(`    💰 ${currentDate}: +£${amount.toFixed(2)} (${serviceType})`);
                                }
                                
                                foundAmount = true;
                                break;
                            }
                        }
                    }
                }
                
                if (!foundAmount && serviceBlockOpen) {
                    console.log(`    ⚠️ No valid amount found for ${currentDate} ${currentTime}`);
                }
            }
        }
        
        if (serviceBlockOpen && token === 'Extra' && i + 1 < tokens.length && tokens[i + 1] === 'Drops') {
            for (let m = i + 2; m < Math.min(i + 5, tokens.length); m++) {
                const extraMatch = tokens[m].match(/^(\d+\.\d{2})/);
                if (extraMatch) {
                    const extraAmount = parseFloat(extraMatch[1]);
                    if (extraAmount > 0 && extraAmount < 50) {
                        const extraKey = `${currentDate}|${currentTime}|${i}|${extraAmount}`;
                        if (!processedExtraDrops.has(extraKey) && currentDate) {
                            if (!amounts[currentDate]) amounts[currentDate] = 0;
                            amounts[currentDate] += extraAmount;
                            processedExtraDrops.add(extraKey);
                            console.log(`    🎯 ${currentDate}: +£${extraAmount.toFixed(2)} (Extra Drops)`);
                        }
                        break;
                    }
                }
            }
        }
        
        if (token === 'Carried' && i + 1 < tokens.length && tokens[i + 1] === 'Forward') {
            console.log('  📄 Found "Carried Forward" - multi-page invoice detected');
        }
    }
    
    const finalAmounts = {};
    let extractedTotal = 0;
    console.log('\n📊 Daily totals:');
    for (const [date, total] of Object.entries(amounts)) {
        finalAmounts[date] = Math.round(total * 100) / 100;
        extractedTotal += finalAmounts[date];
        console.log(`  ${date}: £${finalAmounts[date].toFixed(2)}`);
        if (pickups[date]) {
            console.log(`    └─ Includes ${pickups[date].count} pickup(s): £${pickups[date].total.toFixed(2)}`);
        }
    }
    
    let validationPassed = true;
    if (documentTotal !== null) {
        const difference = Math.abs(extractedTotal - documentTotal);
        const tolerance = 0.01;
        
        console.log(`\n🔍 VALIDATION RESULTS:`);
        console.log(`  Extracted total: £${extractedTotal.toFixed(2)}`);
        console.log(`  Document total:  £${documentTotal.toFixed(2)}`);
        console.log(`  Difference:      £${difference.toFixed(2)}`);
        
        if (difference > tolerance) {
            validationPassed = false;
            console.log(`  ❌ VALIDATION FAILED - Extraction mismatch detected!`);
            console.log(`  ⚠️ Amounts may be incorrect. Please review manually.`);
        } else {
            console.log(`  ✅ VALIDATION PASSED - Amounts match document total`);
        }
    } else {
        console.log('  ⚠️ Could not validate - document total not found');
    }
    
    if (Object.keys(finalAmounts).length === 0) {
        console.log('⚠️ No amounts found - check invoice format');
    }
    
    finalAmounts._validationPassed = validationPassed;
    finalAmounts._documentTotal = documentTotal;
    finalAmounts._extractedTotal = extractedTotal;
    finalAmounts._pickups = pickups;
    
    return finalAmounts;
};

const detectDocumentType = function(text, filename = '') {
    const name = filename.toLowerCase();
    
    // Check filename first
    if (name.includes('runsheet') || name.includes('dv_')) return 'runsheet';
    if (name.includes('self') || name.includes('invoice') || name.includes('bill')) return 'invoice';
    
    // Check content
    if (text.includes('Runsheet') || text.includes('Delivery') && text.includes('Collection')) {
        return 'runsheet';
    }
    if (text.includes('Invoice') || text.includes('Docket Total') || text.includes('GBP')) {
        return 'invoice';
    }
    
    return 'unknown';
};

const parseDocuments = async function(files, rules) {
    console.log('\n📄 Starting document parsing...');
    console.log(`Processing ${files.length} file(s)`);
    
    const results = { 
        items: [], 
        total: 0, 
        errors: [],
        filesCount: files.length,
        runsheets: {},
        invoices: {},
        pickups: {}
    };
    
    for (const file of files) {
        try {
            console.log(`\n📋 Processing: ${file.name}`);
            const text = await extractTextFromPDF(file);
            const type = detectDocumentType(text, file.name);
            console.log(`  Type detected: ${type}`);
            
            if (type === 'invoice') {
                console.log('  📊 Extracting invoice amounts...');
                const extractedData = extractInvoiceAmounts(text);
                const docTotal = extractedData._documentTotal || extractedData._extractedTotal || 0;
                
                console.log(`  Document total: £${docTotal?.toFixed(2) || '0.00'}`);
                console.log(`  Validation: ${extractedData._validationPassed ? '✅ PASSED' : '❌ FAILED'}`);
                
                results.items.push({
                    name: file.name,
                    type: 'invoice',
                    total: docTotal,
                    details: extractedData,
                    validationPassed: extractedData._validationPassed
                });
                
                // Store invoice amounts
                console.log('  💾 Storing invoice amounts in results...');
                let dailyCount = 0;
                for (const [date, amount] of Object.entries(extractedData)) {
                    if (!date.startsWith('_')) {
                        results.invoices[date] = amount;
                        dailyCount++;
                        console.log(`    ✓ ${date}: £${amount.toFixed(2)} stored in results.invoices`);
                    }
                }
                console.log(`  📊 Total days with payments stored: ${dailyCount}`);
                
                // Store pickup data if present
                if (extractedData._pickups) {
                    console.log('  🚚 Processing pickup data...');
                    let pickupCount = 0;
                    for (const [date, pickup] of Object.entries(extractedData._pickups)) {
                        results.pickups[date] = pickup;
                        pickupCount += pickup.count;
                        console.log(`    ✓ ${date}: ${pickup.count} pickup(s) = £${pickup.total.toFixed(2)}`);
                    }
                    console.log(`  📊 Total pickup services stored: ${pickupCount}`);
                }
                
                if (docTotal) {
                    results.total += docTotal;
                    console.log(`  💰 Running total: £${results.total.toFixed(2)}`);
                }
                
            } else if (type === 'runsheet') {
                console.log('  📦 Extracting runsheet data...');
                const date = extractDateFromRunsheet(text);
                const consignments = extractConsignmentsFromRunsheet(text);
                
                if (date) {
                    results.runsheets[date] = { consignments };
                    results.items.push({
                        name: file.name,
                        type: 'runsheet',
                        date,
                        consignments
                    });
                    console.log(`  ✓ Date: ${date}`);
                    console.log(`  ✓ Consignments: ${consignments}`);
                    console.log(`  ✓ Stored in results.runsheets[${date}]`);
                } else {
                    console.log('  ⚠️ Could not extract date from runsheet');
                }
            } else {
                console.log('  ⚠️ Unknown document type - skipping');
            }
        } catch (err) {
            console.error(`  ❌ Error processing ${file.name}:`, err);
            results.errors.push({
                name: file.name,
                error: String(err)
            });
        }
    }
    
    console.log('\n=== PARSING COMPLETE - FINAL RESULTS ===');
    console.log(`✅ Successfully processed: ${results.items.length} files`);
    console.log(`❌ Errors encountered: ${results.errors.length}`);
    console.log(`📊 Invoice days in results: ${Object.keys(results.invoices).length}`);
    if (Object.keys(results.invoices).length > 0) {
        console.log('  Invoice dates:', Object.keys(results.invoices).sort().join(', '));
    }
    console.log(`📦 Runsheet days in results: ${Object.keys(results.runsheets).length}`);
    if (Object.keys(results.runsheets).length > 0) {
        console.log('  Runsheet dates:', Object.keys(results.runsheets).sort().join(', '));
    }
    console.log(`🚚 Days with pickups: ${Object.keys(results.pickups).length}`);
    console.log(`💰 Grand total: £${results.total.toFixed(2)}`);
    console.log('=====================================\n');
    
    return results;
};

// Export all functions
exports.extractTextFromPDF = extractTextFromPDF;
exports.extractDateFromRunsheet = extractDateFromRunsheet;
exports.extractConsignmentsFromRunsheet = extractConsignmentsFromRunsheet;
exports.extractInvoiceAmounts = extractInvoiceAmounts;
exports.detectDocumentType = detectDocumentType;
exports.parseDocuments = parseDocuments;
</script>

<!-- UI Module - Enhanced for mobile with all original functions -->
<script id="uiModule" type="application/x-module">
// UI Module - Handles all DOM interactions for mobile and desktop
exports.showToast = function(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.className = 'toast';
    toast.classList.add(type);
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
};

exports.showLoading = function(show = true) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
};

exports.updateProgress = function(percent) {
    const bar = document.getElementById('progressBar');
    if (bar) bar.style.width = `${percent}%`;
};

exports.updateLoadingText = function(text) {
    const loadingText = document.getElementById('loadingText');
    if (loadingText) loadingText.textContent = text;
};

exports.showValidationAlert = function(message, type = 'warning') {
    const alert = document.getElementById('validationAlert');
    const messageElement = document.getElementById('validationMessage');
    
    if (alert && messageElement) {
        messageElement.textContent = message;
        alert.className = 'validation-alert show';
        
        if (type === 'error') {
            alert.classList.add('error');
        } else if (type === 'success') {
            alert.classList.add('success');
        }
    }
    
    // Update validation badge
    const badge = document.getElementById('analysisValidationBadge');
    if (badge) {
        badge.style.display = 'flex';
        badge.className = `validation-badge ${type === 'success' ? 'validated' : type === 'error' ? 'invalid' : ''}`;
        badge.querySelector('.badge-text').textContent = type === 'success' ? 'VALID' : type === 'error' ? 'ERROR' : 'PENDING';
    }
};

exports.hideValidationAlert = function() {
    const alert = document.getElementById('validationAlert');
    if (alert) alert.classList.remove('show');
    
    // Hide validation badge
    const badge = document.getElementById('analysisValidationBadge');
    if (badge) badge.style.display = 'none';
};

/**
 * Updates the file list display with enhanced preview functionality
 * @param {Array} files - Array of file objects with id, name, size properties
 */
exports.updateFileList = function(files) {
    try {
        const fileList = document.getElementById('fileList');
        if (!fileList) {
            console.error('File list element not found');
            return;
        }
        
        fileList.innerHTML = '';
    
    if (files.length === 0) {
        fileList.innerHTML = '<div class="empty-state"><div class="empty-message">No files selected</div></div>';
        document.getElementById('analysisPreview').style.display = 'none';
        return;
    }
    
    // Count file types
    let runsheets = 0;
    let invoices = 0;
    
    files.forEach(file => {
        const fileType = file.name.toLowerCase().includes('runsheet') ? 'runsheet' : 'invoice';
        if (fileType === 'runsheet') runsheets++;
        else invoices++;
        
        const div = document.createElement('div');
        div.className = 'file-item';
        // Sanitize file name to prevent XSS
        const safeName = file.name.replace(/[<>]/g, '');
        const safeId = String(file.id).replace(/[<>"']/g, '');
        
        div.innerHTML = `
            <div class="file-icon">
                ${fileType === 'runsheet' ? '📦' : '💰'}
            </div>
            <div class="file-info">
                <div class="file-name">${safeName}</div>
                <div class="file-details">
                    <span class="file-size">${(file.size / 1024).toFixed(1)}KB</span>
                    <span class="file-type-badge ${fileType}">
                        ${fileType === 'runsheet' ? 'Runsheet' : 'Invoice'}
                    </span>
                </div>
            </div>
            <button class="file-remove" data-file-id="${safeId}" aria-label="Remove ${safeName}">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" aria-hidden="true">
                    <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        `;
        fileList.appendChild(div);
    });
    
    // Update analysis preview
    const preview = document.getElementById('analysisPreview');
    preview.style.display = 'block';
    
    document.getElementById('previewTotalFiles').textContent = files.length;
    document.getElementById('previewRunsheets').textContent = runsheets;
    document.getElementById('previewInvoices').textContent = invoices;
    
    // Update validation badge
    const validationBadge = document.getElementById('previewValidationBadge');
    if (runsheets > 0 && invoices > 0) {
        validationBadge.className = 'validation-badge valid';
        validationBadge.innerHTML = '<span class="badge-icon">✓</span><span class="badge-text">Ready</span>';
        document.getElementById('previewStatus').textContent = 'Ready to analyze';
    } else {
        validationBadge.className = 'validation-badge invalid';
        validationBadge.innerHTML = '<span class="badge-icon">⚠️</span><span class="badge-text">Incomplete</span>';
        document.getElementById('previewStatus').textContent = runsheets === 0 ? 'Missing runsheets' : 'Missing invoices';
    }
    } catch (error) {
        console.error('Error updating file list:', error);
        // Show user-friendly error message
        const fileList = document.getElementById('fileList');
        if (fileList) {
            fileList.innerHTML = '<div class="empty-state"><div class="empty-message">Error updating file list</div></div>';
        }
    }
};

/**
 * Renders the comprehensive financial analysis report
 * @param {Object} data - Analysis data object containing results, totals, and metadata
 * @param {Array} data.results - Daily breakdown results
 * @param {Object} data.totals - Summary totals and calculations
 * @param {Object} data.metadata - Report metadata (period, dates, etc.)
 */
exports.renderReport = function(data) {
    // Cache DOM elements for better performance
    const content = document.getElementById('reportsContent');
    const emptyState = document.getElementById('emptyReportState');
    const reportContainer = document.getElementById('reportContainer');
    
    // Set date attribute for printing
    content.setAttribute('data-date', new Date().toLocaleDateString('en-GB'));
    
    if (!data || !data.results) {
        emptyState.style.display = 'block';
        reportContainer.style.display = 'none';
        return;
    }
    
    const { results, totals, metadata } = data;
    
    // Hide empty state, show report
    emptyState.style.display = 'none';
    reportContainer.style.display = 'block';
    
    // Update report header
    document.getElementById('reportPeriod').textContent = metadata.periodRange || '-';
    document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-GB');
    document.getElementById('reportDays').textContent = metadata.totalDays || '0';
    document.getElementById('reportStatus').textContent = totals.differenceTotal >= 0 ? 'Balanced' : 'Discrepancy';
    
    // Update KPIs
    document.getElementById('kpiExpected').textContent = `£${totals.expectedTotal.toFixed(2)}`;
    document.getElementById('kpiPaid').textContent = `£${totals.paidTotal.toFixed(2)}`;
    document.getElementById('kpiDifference').textContent = `£${Math.abs(totals.differenceTotal).toFixed(2)}`;
    document.getElementById('kpiConsignments').textContent = totals.totalConsignments || '0';
    
    // Update KPI subtitles
    const avgConsignments = totals.workingDays > 0 ? 
        Math.round(totals.totalConsignments / totals.workingDays) : 0;
    document.getElementById('kpiConsignmentsSub').textContent = `Avg: ${avgConsignments}/day`;
    
    // Update difference card style
    const diffCard = document.getElementById('kpiDifferenceCard');
    const trendElement = document.getElementById('kpiTrend');
    
    if (totals.differenceTotal >= 0) {
        diffCard.classList.add('kpi-primary');
        trendElement.className = 'kpi-trend positive';
        document.getElementById('kpiTrendText').textContent = '✓ Positive balance';
    } else {
        diffCard.classList.remove('kpi-primary');
        trendElement.className = 'kpi-trend negative';
        document.getElementById('kpiTrendText').textContent = '✗ Negative balance';
    }
    
    // Update comprehensive table
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    results.forEach(row => {
        const tr = document.createElement('tr');
        
        let status;
        if (row.difference >= 0) {
            status = '<span class="status-badge reconciled">✓ OK</span>';
        } else if (Math.abs(row.difference) <= 5) {
            status = '<span class="status-badge pending">⚠ Minor</span>';
        } else {
            status = '<span class="status-badge error">✗ Review</span>';
        }
        
        let pickupDisplay = row.pickupTotal > 0 
            ? `£${row.pickupTotal.toFixed(2)} (${row.pickupCount})` 
            : '-';
        
        tr.innerHTML = `
            <td class="date-cell">${row.date.split('-').reverse().join('/')}</td>
            <td>${row.day}</td>
            <td class="amount-cell">${row.consignments || '-'}</td>
            <td class="amount-cell">£${row.rate.toFixed(2)}</td>
            <td class="amount-cell">£${row.basePayment.toFixed(2)}</td>
            <td class="amount-cell">${pickupDisplay}</td>
            <td class="amount-cell">£${row.totalBonus.toFixed(2)}</td>
            <td class="amount-cell">£${row.expectedTotal.toFixed(2)}</td>
            <td class="amount-cell">£${row.paidAmount.toFixed(2)}</td>
            <td class="amount-cell ${row.difference >= 0 ? 'positive' : 'negative'}">
                ${row.difference >= 0 ? '+' : ''}£${Math.abs(row.difference).toFixed(2)}
            </td>
            <td>${status}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Update footer totals
    document.getElementById('footerConsignments').textContent = totals.totalConsignments;
    document.getElementById('footerBase').textContent = `£${totals.baseTotal.toFixed(2)}`;
    document.getElementById('footerPickups').textContent = `£${totals.pickupTotal.toFixed(2)}`;
    document.getElementById('footerBonuses').textContent = `£${totals.bonusTotal.toFixed(2)}`;
    document.getElementById('footerExpected').textContent = `£${totals.expectedTotal.toFixed(2)}`;
    document.getElementById('footerPaid').textContent = `£${totals.paidTotal.toFixed(2)}`;
    document.getElementById('footerDifference').textContent = 
        `${totals.differenceTotal >= 0 ? '+' : ''}£${Math.abs(totals.differenceTotal).toFixed(2)}`;
    
    // Update settlement breakdown
    document.getElementById('breakdownConsignments').textContent = `£${totals.baseTotal.toFixed(2)}`;
    document.getElementById('breakdownPickups').textContent = `£${totals.pickupTotal.toFixed(2)}`;
    document.getElementById('breakdownUnloading').textContent = `£${totals.unloadingTotal.toFixed(2)}`;
    document.getElementById('breakdownAttendance').textContent = `£${totals.attendanceTotal.toFixed(2)}`;
    document.getElementById('breakdownEarly').textContent = `£${totals.earlyTotal.toFixed(2)}`;
    document.getElementById('breakdownTotal').textContent = `£${totals.expectedTotal.toFixed(2)}`;
};

exports.renderHistory = function() {
    const historyList = document.getElementById('historyList');
    const analyses = requireModule('stateModule').getAllAnalyses();
    const analysesArray = Object.values(analyses).sort((a, b) => 
        new Date(b.created) - new Date(a.created)
    );
    
    if (analysesArray.length === 0) {
        historyList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">📜</div>
                <div class="empty-title">No History</div>
                <div class="empty-message">Your analysis history will appear here</div>
            </div>
        `;
        return;
    }
    
    historyList.innerHTML = analysesArray.map(analysis => {
        const date = new Date(analysis.created);
        const formattedDate = date.toLocaleDateString('en-GB');
        const totals = analysis.totals || {};
        
        return `
            <div class="history-item" data-analysis-id="${analysis.id}">
                <div class="history-date">${formattedDate}</div>
                <div class="history-period">${analysis.metadata?.periodRange || 'Unknown Period'}</div>
                <div class="history-stats">
                    <span>${analysis.metadata?.totalDays || 0} days</span>
                    <span class="history-total">£${(totals.expectedTotal || 0).toFixed(2)}</span>
                </div>
            </div>
        `;
    }).join('');
};

exports.showRecoveryBanner = function(timestamp) {
    const banner = document.getElementById('recoveryBanner');
    const text = document.getElementById('recoveryText');
    
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    let timeAgo;
    if (days > 0) timeAgo = `${days} day${days > 1 ? 's' : ''} ago`;
    else if (hours > 0) timeAgo = `${hours} hour${hours > 1 ? 's' : ''} ago`;
    else if (minutes > 0) timeAgo = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    else timeAgo = 'just now';
    
    text.textContent = `Restored your last analysis from ${timeAgo}`;
    banner.classList.add('show');
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        if (banner.classList.contains('show')) {
            banner.classList.remove('show');
        }
    }, 10000);
};

exports.hideRecoveryBanner = function() {
    const banner = document.getElementById('recoveryBanner');
    banner.classList.remove('show');
};

exports.updateSettingsForm = function(rules) {
    document.getElementById('weekdayRate').value = rules.weekdayRate.toFixed(2);
    document.getElementById('saturdayRate').value = rules.saturdayRate.toFixed(2);
    document.getElementById('unloadingBonus').value = rules.unloadingBonus.toFixed(2);
    document.getElementById('attendanceBonus').value = rules.attendanceBonus.toFixed(2);
    document.getElementById('earlyBonus').value = rules.earlyBonus.toFixed(2);
};

exports.getSettingsFormData = function() {
    return {
        weekdayRate: parseFloat(document.getElementById('weekdayRate').value) || 0,
        saturdayRate: parseFloat(document.getElementById('saturdayRate').value) || 0,
        unloadingBonus: parseFloat(document.getElementById('unloadingBonus').value) || 0,
        attendanceBonus: parseFloat(document.getElementById('attendanceBonus').value) || 0,
        earlyBonus: parseFloat(document.getElementById('earlyBonus').value) || 0
    };
};
</script>

<!-- Dashboard Module - Enhanced with chart visualizations -->
<script id="dashboardModule" type="application/x-module">
// Dashboard Module with enhanced features
let currentView = 'monthly'; // 'monthly' or 'weekly'
let currentCalendarMonth = new Date();

exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('dashboard', {
        onLoad: () => {
            console.log('📊 Loading dashboard');
            exports.refresh();
        }
    });
    
    // View toggle
    document.getElementById('monthlyToggle').addEventListener('click', () => {
        setView('monthly');
    });
    
    document.getElementById('weeklyToggle').addEventListener('click', () => {
        setView('weekly');
    });
    
    // Calendar navigation
    document.getElementById('calPrev').addEventListener('click', () => {
        currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
        renderCalendar();
    });
    
    document.getElementById('calNext').addEventListener('click', () => {
        currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
        renderCalendar();
    });
    
    // Action buttons
    document.getElementById('refreshDashboard').addEventListener('click', exports.refresh);
    document.getElementById('quickAnalyze').addEventListener('click', () => {
        Router.navigate('analysis');
    });
    document.getElementById('viewReports').addEventListener('click', () => {
        Router.navigate('reports');
    });
    document.getElementById('emptyStartAnalysis').addEventListener('click', () => {
        Router.navigate('analysis');
    });
};

function setView(view) {
    currentView = view;
    
    // Update toggle buttons
    document.getElementById('monthlyToggle').classList.toggle('active', view === 'monthly');
    document.getElementById('weeklyToggle').classList.toggle('active', view === 'weekly');
    
    // Update period text
    document.getElementById('summaryPeriod').textContent = view === 'monthly' ? 'This Month' : 'This Week';
    
    // Refresh data for new view
    exports.refresh();
}

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const monthYearEl = document.getElementById('calendarMonth');
    
    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    monthYearEl.textContent = `${monthNames[currentCalendarMonth.getMonth()]} ${currentCalendarMonth.getFullYear()}`;
    
    // Clear grid
    grid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 1);
    const lastDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Get data for this month
    const State = requireModule('stateModule');
    const analyses = State.getAllAnalyses();
    const datesWithData = new Set();
    
    Object.values(analyses).forEach(analysis => {
        if (analysis.results) {
            analysis.results.forEach(result => {
                const date = new Date(result.date);
                if (date.getMonth() === currentCalendarMonth.getMonth() && 
                    date.getFullYear() === currentCalendarMonth.getFullYear()) {
                    datesWithData.add(date.getDate());
                }
            });
        }
    });
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        grid.appendChild(emptyDay);
    }
    
    // Add days of month
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = day;
        
        // Check if this is today
        if (today.getDate() === day && 
            today.getMonth() === currentCalendarMonth.getMonth() && 
            today.getFullYear() === currentCalendarMonth.getFullYear()) {
            dayEl.classList.add('today');
        }
        
        // Check if this day has data
        if (datesWithData.has(day)) {
            dayEl.classList.add('has-data');
        }
        
        grid.appendChild(dayEl);
    }
}

function renderChart(data) {
    const chartContainer = document.getElementById('revenueChart');
    chartContainer.innerHTML = '';
    
    // Get data points based on view
    let dataPoints = currentView === 'weekly' ? getWeeklyData(data) : getMonthlyData(data);
    
    if (dataPoints.length === 0 || dataPoints.every(d => d.expected === 0 && d.actual === 0)) {
        chartContainer.innerHTML = '<div class="empty-chart">No data for selected period</div>';
        return;
    }
    
    // Find max value for scaling
    const maxValue = Math.max(...dataPoints.map(d => Math.max(d.expected, d.actual)), 1);
    
    // Create gradient definitions
    const svgDefs = document.createElement('div');
    svgDefs.innerHTML = `
        <svg width="0" height="0" style="position:absolute">
            <defs>
                <linearGradient id="expectedGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="actualGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#059669;stop-opacity:0.8" />
                </linearGradient>
            </defs>
        </svg>
    `;
    chartContainer.appendChild(svgDefs);
    
    // Render bars with animations
    dataPoints.forEach((point, index) => {
        const column = document.createElement('div');
        column.className = 'bar-column';
        column.style.animationDelay = `${index * 50}ms`;
        
        // Container for bars
        const barsContainer = document.createElement('div');
        barsContainer.style.position = 'relative';
        barsContainer.style.flex = '1';
        barsContainer.style.display = 'flex';
        barsContainer.style.alignItems = 'flex-end';
        
        // Expected bar
        const expectedBar = document.createElement('div');
        expectedBar.className = 'bar animated-bar';
        expectedBar.style.height = `${(point.expected / maxValue) * 100}%`;
        expectedBar.style.background = 'url(#expectedGradient)';
        expectedBar.style.width = '45%';
        expectedBar.style.marginRight = '10%';
        expectedBar.setAttribute('data-value', `£${point.expected.toFixed(0)}`);
        
        // Actual bar
        const actualBar = document.createElement('div');
        actualBar.className = 'bar animated-bar';
        actualBar.style.height = `${(point.actual / maxValue) * 100}%`;
        actualBar.style.background = 'url(#actualGradient)';
        actualBar.style.width = '45%';
        actualBar.setAttribute('data-value', `£${point.actual.toFixed(0)}`);
        
        // Value labels on hover
        expectedBar.addEventListener('click', (e) => {
            showChartTooltip(e, `Expected: £${point.expected.toFixed(2)}`);
        });
        
        actualBar.addEventListener('click', (e) => {
            showChartTooltip(e, `Actual: £${point.actual.toFixed(2)}`);
        });
        
        // Label
        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = point.label;
        
        barsContainer.appendChild(expectedBar);
        barsContainer.appendChild(actualBar);
        column.appendChild(barsContainer);
        column.appendChild(label);
        chartContainer.appendChild(column);
    });
}

function showChartTooltip(event, text) {
    const tooltip = document.createElement('div');
    tooltip.className = 'chart-tooltip';
    tooltip.textContent = text;
    tooltip.style.cssText = `
        position: fixed;
        left: ${event.clientX}px;
        top: ${event.clientY - 40}px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 9999;
        pointer-events: none;
        animation: fadeIn 0.2s;
    `;
    document.body.appendChild(tooltip);
    
    setTimeout(() => tooltip.remove(), 2000);
}

function getWeeklyData(analyses) {
    const data = [];
    const today = new Date();
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        
        let expected = 0;
        let actual = 0;
        
        // Sum up data for this day across all analyses
        Object.values(analyses).forEach(analysis => {
            if (analysis.results) {
                analysis.results.forEach(result => {
                    const resultDate = new Date(result.date);
                    if (resultDate.toDateString() === date.toDateString()) {
                        expected += result.expectedTotal || 0;
                        actual += result.paidAmount || 0;
                    }
                });
            }
        });
        
        data.push({
            label: dayNames[date.getDay()],
            expected: expected,
            actual: actual
        });
    }
    
    return data;
}

function getMonthlyData(analyses) {
    const data = [];
    const today = new Date();
    
    for (let i = 3; i >= 0; i--) {
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - (i * 7 + today.getDay()));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        let expected = 0;
        let actual = 0;
        
        // Sum up data for this week across all analyses
        Object.values(analyses).forEach(analysis => {
            if (analysis.results) {
                analysis.results.forEach(result => {
                    const resultDate = new Date(result.date);
                    if (resultDate >= weekStart && resultDate <= weekEnd) {
                        expected += result.expectedTotal || 0;
                        actual += result.paidAmount || 0;
                    }
                });
            }
        });
        
        data.push({
            label: `W${4-i}`,
            expected: expected,
            actual: actual
        });
    }
    
    return data;
}

function calculateForecasts(analyses) {
    // Simple forecasting based on historical averages
    const analysesArray = Object.values(analyses);
    if (analysesArray.length === 0) {
        return {
            nextWeek: 0,
            monthEnd: 0,
            dailyTarget: 0
        };
    }
    
    // Calculate average daily revenue
    let totalRevenue = 0;
    let totalDays = 0;
    
    analysesArray.forEach(analysis => {
        if (analysis.totals) {
            totalRevenue += analysis.totals.expectedTotal || 0;
            totalDays += analysis.metadata?.totalDays || 0;
        }
    });
    
    const avgDaily = totalDays > 0 ? totalRevenue / totalDays : 0;
    
    // Simple forecasts
    const nextWeek = avgDaily * 5; // 5 working days
    const daysLeftInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate() - new Date().getDate();
    const monthEnd = avgDaily * Math.min(daysLeftInMonth, 20); // Max 20 working days
    const dailyTarget = avgDaily * 1.1; // 10% growth target
    
    return {
        nextWeek,
        monthEnd,
        dailyTarget
    };
}

exports.refresh = function() {
    const State = requireModule('stateModule');
    const analyses = State.getAllAnalyses();
    const analysesArray = Object.values(analyses);
    
    // Check if we have data
    const hasData = analysesArray.length > 0;
    const dashboardContent = document.getElementById('dashboardContent');
    const emptyState = document.getElementById('dashboardEmpty');
    
    if (!hasData) {
        // Show empty state, hide all dashboard content
        document.querySelector('.view-toggle').style.display = 'none';
        document.querySelector('.executive-summary').style.display = 'none';
        document.querySelector('.calendar-widget').style.display = 'none';
        document.querySelector('.kpi-grid').style.display = 'none';
        document.querySelector('.chart-container').style.display = 'none';
        document.querySelector('.forecast-card').style.display = 'none';
        document.querySelector('.quick-actions').style.display = 'none';
        emptyState.style.display = 'block';
        
        // Clear navigation badges when no data
        const Router = requireModule('routerModule');
        Router.setNavBadge('reports', null);
        Router.setNavBadge('history', null);
        
        return;
    }
    
    // Hide empty state and show content
    document.querySelector('.view-toggle').style.display = 'block';
    document.querySelector('.executive-summary').style.display = 'block';
    document.querySelector('.calendar-widget').style.display = 'block';
    document.querySelector('.kpi-grid').style.display = 'grid';
    document.querySelector('.chart-container').style.display = 'block';
    document.querySelector('.forecast-card').style.display = 'block';
    document.querySelector('.quick-actions').style.display = 'block';
    emptyState.style.display = 'none';
    
    // Calculate metrics based on current view
    const now = new Date();
    let periodStart, periodEnd;
    
    if (currentView === 'monthly') {
        periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
        periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    } else {
        // Weekly - last 7 days
        periodStart = new Date(now);
        periodStart.setDate(now.getDate() - 6);
        periodEnd = now;
    }
    
    // Calculate totals for current period
    let currentRevenue = 0;
    let currentDeliveries = 0;
    let currentExpected = 0;
    let currentPaid = 0;
    let daysWithData = 0;
    
    analysesArray.forEach(analysis => {
        if (analysis.results) {
            analysis.results.forEach(result => {
                const resultDate = new Date(result.date);
                if (resultDate >= periodStart && resultDate <= periodEnd) {
                    currentRevenue += result.expectedTotal || 0;
                    currentDeliveries += result.consignments || 0;
                    currentExpected += result.expectedTotal || 0;
                    currentPaid += result.paidAmount || 0;
                    daysWithData++;
                }
            });
        }
    });
    
    // Calculate previous period for comparison
    let prevPeriodStart, prevPeriodEnd;
    if (currentView === 'monthly') {
        prevPeriodStart = new Date(periodStart);
        prevPeriodStart.setMonth(prevPeriodStart.getMonth() - 1);
        prevPeriodEnd = new Date(periodStart);
        prevPeriodEnd.setDate(prevPeriodEnd.getDate() - 1);
    } else {
        prevPeriodStart = new Date(periodStart);
        prevPeriodStart.setDate(prevPeriodStart.getDate() - 7);
        prevPeriodEnd = new Date(periodStart);
        prevPeriodEnd.setDate(prevPeriodEnd.getDate() - 1);
    }
    
    let prevRevenue = 0;
    let prevDeliveries = 0;
    
    analysesArray.forEach(analysis => {
        if (analysis.results) {
            analysis.results.forEach(result => {
                const resultDate = new Date(result.date);
                if (resultDate >= prevPeriodStart && resultDate <= prevPeriodEnd) {
                    prevRevenue += result.expectedTotal || 0;
                    prevDeliveries += result.consignments || 0;
                }
            });
        }
    });
    
    // Calculate changes
    const revenueChangePercent = prevRevenue > 0 ? ((currentRevenue - prevRevenue) / prevRevenue * 100) : 0;
    const deliveriesChangePercent = prevDeliveries > 0 ? ((currentDeliveries - prevDeliveries) / prevDeliveries * 100) : 0;
    const avgDaily = daysWithData > 0 ? currentRevenue / daysWithData : 0;
    const performance = currentExpected > 0 ? (currentPaid / currentExpected * 100) : 0;
    
    // Update Executive Summary
    document.getElementById('summaryRevenue').textContent = `£${currentRevenue.toFixed(2)}`;
    document.getElementById('summaryDaily').textContent = `£${avgDaily.toFixed(2)}`;
    document.getElementById('summaryDeliveries').textContent = currentDeliveries.toString();
    document.getElementById('summaryPerformance').textContent = `${performance.toFixed(0)}%`;
    
    // Update change indicators
    const revenueChangeEl = document.getElementById('revenueChange');
    revenueChangeEl.textContent = `${revenueChangePercent >= 0 ? '↑' : '↓'} ${Math.abs(revenueChangePercent).toFixed(0)}%`;
    revenueChangeEl.className = `summary-stat-change ${revenueChangePercent >= 0 ? 'positive' : 'negative'}`;
    
    const deliveriesChangeEl = document.getElementById('deliveriesChange');
    deliveriesChangeEl.textContent = `${deliveriesChangePercent >= 0 ? '↑' : '↓'} ${Math.abs(deliveriesChangePercent).toFixed(0)}%`;
    deliveriesChangeEl.className = `summary-stat-change ${deliveriesChangePercent >= 0 ? 'positive' : 'negative'}`;
    
    // Update KPIs
    document.getElementById('kpiExpected').textContent = `£${currentExpected.toFixed(2)}`;
    document.getElementById('kpiReceived').textContent = `£${currentPaid.toFixed(2)}`;
    document.getElementById('kpiPending').textContent = `£${Math.max(0, currentExpected - currentPaid).toFixed(2)}`;
    document.getElementById('kpiEfficiency').textContent = `${Math.min(100, performance).toFixed(0)}%`;
    
    // Update trends
    document.getElementById('expectedTrend').innerHTML = `<span>${revenueChangePercent >= 0 ? '↑' : '↓'}</span><span>${Math.abs(revenueChangePercent).toFixed(0)}% vs last</span>`;
    document.getElementById('efficiencyTrend').innerHTML = `<span>↑</span><span>${performance >= 95 ? 'Excellent' : performance >= 85 ? 'Good' : 'Needs Review'}</span>`;
    
    // Render calendar
    renderCalendar();
    
    // Render chart
    renderChart(analyses);
    
    // Calculate and update forecasts
    const forecasts = calculateForecasts(analyses);
    document.getElementById('forecastWeek').textContent = `£${forecasts.nextWeek.toFixed(2)}`;
    document.getElementById('forecastMonth').textContent = `£${forecasts.monthEnd.toFixed(2)}`;
    document.getElementById('forecastTarget').textContent = `£${forecasts.dailyTarget.toFixed(2)}`;
};
</script>

<!-- Analysis Module - Enhanced with all production features -->
<script id="analysisModule" type="application/x-module">
// Analysis Module - Enhanced with production features
let uploadedFiles = [];
let lastAnalysisData = null;

// File management
function detectFileType(filename) {
    const name = filename.toLowerCase();
    if (name.includes('runsheet') || name.includes('dv_')) return 'runsheet';
    if (name.includes('self') || name.includes('invoice') || name.includes('bill')) return 'invoice';
    return 'unknown';
}

exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('analysis', {
        onLoad: () => {
            console.log('🔍 Loading analysis page');
            updateAnalyzeButton();
        }
    });
    
    // File upload
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    
    // Enhanced drag and drop for desktop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.add('drag-active');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.remove('drag-active');
        }, false);
    });

    uploadArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            // Create a synthetic event for the file input
            const fileInput = document.getElementById('fileInput');
            const dataTransfer = new DataTransfer();
            
            Array.from(files).forEach(file => {
                if (file.type === 'application/pdf') {
                    dataTransfer.items.add(file);
                }
            });
            
            fileInput.files = dataTransfer.files;
            handleFileSelect({ target: fileInput });
            
            requireModule('uiModule').showToast(`${dataTransfer.files.length} file(s) added`, 'success');
        }
    }, false);
    
    // File removal
    document.getElementById('fileList').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-btn')) {
            const fileId = e.target.dataset.fileId;
            removeFile(fileId);
        }
    });
    
    // Clear all files
    document.getElementById('clearFiles').addEventListener('click', () => {
        if (uploadedFiles.length > 0 && confirm('Clear all files?')) {
            uploadedFiles = [];
            requireModule('uiModule').updateFileList(uploadedFiles);
            updateAnalyzeButton();
            document.getElementById('fileInput').value = '';
        }
    });
    
    // Analyze button
    document.getElementById('analyzeBtn').addEventListener('click', analyze);
};

function handleFileSelect(event) {
    console.log('📁 handleFileSelect called');
    
    const files = Array.from(event.target.files);
    console.log(`  Processing ${files.length} file(s)`);
    
    files.forEach(file => {
        const fileObj = {
            id: Date.now() + Math.random(),
            file: file,
            name: file.name,
            type: detectFileType(file.name),
            size: file.size
        };
        
        console.log(`  Added file: ${file.name} (${fileObj.type})`);
        uploadedFiles.push(fileObj);
    });
    
    console.log(`  Total uploaded files: ${uploadedFiles.length}`);
    requireModule('uiModule').updateFileList(uploadedFiles);
    updateAnalyzeButton();
}

function removeFile(fileId) {
    console.log(`🗑️ Removing file with ID: ${fileId}`);
    uploadedFiles = uploadedFiles.filter(f => f.id !== parseFloat(fileId));
    requireModule('uiModule').updateFileList(uploadedFiles);
    updateAnalyzeButton();
}

function updateAnalyzeButton() {
    const btn = document.getElementById('analyzeBtn');
    btn.disabled = uploadedFiles.length === 0;
}

// Enhanced analysis with detailed progress updates
async function analyze() {
    if (uploadedFiles.length === 0) return;
    
    const UI = requireModule('uiModule');
    const Parser = requireModule('parserModule');
    const Rules = requireModule('rulesModule');
    const State = requireModule('stateModule');
    const Router = requireModule('routerModule');
    
    console.log('\n🔍 STARTING ANALYSIS...');
    console.log(`Files to analyze: ${uploadedFiles.length}`);
    uploadedFiles.forEach((f, i) => {
        console.log(`  ${i + 1}. ${f.name} (${f.type})`);
    });
    
    // Progress stages
    const stages = [
        { percent: 10, text: 'Initializing analysis...' },
        { percent: 20, text: 'Loading payment rules...' },
        { percent: 30, text: 'Reading PDF files...' },
        { percent: 50, text: 'Extracting invoice data...' },
        { percent: 60, text: 'Processing runsheets...' },
        { percent: 70, text: 'Validating amounts...' },
        { percent: 80, text: 'Calculating payments...' },
        { percent: 90, text: 'Generating report...' },
        { percent: 100, text: 'Analysis complete!' }
    ];
    
    let currentStage = 0;
    
    function updateStage() {
        if (currentStage < stages.length) {
            const stage = stages[currentStage];
            UI.updateProgress(stage.percent);
            UI.updateLoadingText(stage.text);
            currentStage++;
        }
    }
    
    // Check if these files have been analyzed before
    const files = uploadedFiles.map(f => f.file);
    const existingAnalysis = State.findExistingAnalysis(files);
    
    if (existingAnalysis) {
        console.log('📦 Found existing analysis for these files!');
        console.log(`  Originally analyzed: ${new Date(existingAnalysis.timestamp).toLocaleString()}`);
        
        // Build message with rules change notification
        let message = `These files were analyzed before on ${new Date(existingAnalysis.timestamp).toLocaleDateString()}.\n\n`;
        
        if (existingAnalysis.previousCount > 0) {
            message += `📊 This set of files has been analyzed ${existingAnalysis.previousCount + 1} time(s) before.\n\n`;
        }
        
        if (existingAnalysis.rulesChanged) {
            message += `⚠️ NOTE: Payment rules have changed since the last analysis.\n`;
            message += `You may want to re-analyze with the new rules.\n\n`;
        }
        
        message += `Would you like to use the saved results?\n\n`;
        message += `YES = Use saved results (faster, no duplicate)\n`;
        message += `NO = Re-analyze files (slower, creates new entry)`;
        
        const useCache = confirm(message);
        
        if (useCache) {
            console.log('✅ Using cached analysis results');
            lastAnalysisData = existingAnalysis.analysis;
            
            // Render the cached results
            UI.renderReport(lastAnalysisData);
            
            if (existingAnalysis.rulesChanged) {
                UI.showToast('Using previous results (payment rules have changed)', 'warn');
            } else {
                UI.showToast('Using previously analyzed results', 'success');
            }
            
            // Save state but don't create new analysis
            State.save({
                version: State.VERSION,
                lastAnalysis: lastAnalysisData,
                lastModified: Date.now(),
                files: {
                    uploaded: uploadedFiles.map(f => ({
                        name: f.name,
                        size: f.size,
                        type: f.type,
                        lastModified: f.file.lastModified || 0
                    }))
                },
                rules: Rules.load()
            });
            
            // Navigate to reports page
            Router.navigate('reports');
            
            console.log('✅ Cached analysis loaded successfully (no duplicate created)!');
            return; // Exit without creating a new analysis entry
        } else {
            console.log('🔄 User chose to re-analyze files (will create new entry)');
        }
    }
    
    UI.showLoading(true);
    updateStage(); // Stage 0: Initializing
    
    try {
        updateStage(); // Stage 1: Loading rules
        
        const rules = Rules.load();
        
        console.log('\n=== PAYMENT RULES LOADED ===');
        console.log(`Weekday rate: £${rules.weekdayRate.toFixed(2)}/consignment`);
        console.log(`Saturday rate: £${rules.saturdayRate.toFixed(2)}/consignment`);
        console.log(`Unloading bonus: £${rules.unloadingBonus.toFixed(2)}/day (except Mondays)`);
        console.log(`Attendance bonus: £${rules.attendanceBonus.toFixed(2)}/day (weekdays only)`);
        console.log(`Early arrival bonus: £${rules.earlyBonus.toFixed(2)}/day (weekdays only)`);
        console.log('============================\n');
        
        updateStage(); // Stage 2: Reading PDFs
        
        // Parse all documents
        console.log('📄 Calling Parser.parseDocuments...');
        const aggregateResult = await Parser.parseDocuments(files, rules);
        
        updateStage(); // Stage 3: Extracting data
        
        console.log('\n📊 AGGREGATE RESULT RECEIVED: ');
        console.log(`  Type of result: ${typeof aggregateResult}`);
        console.log(`  Has invoices property: ${aggregateResult.hasOwnProperty('invoices')}`);
        console.log(`  Type of invoices: ${typeof aggregateResult.invoices}`);
        console.log(`  Invoice data points: ${Object.keys(aggregateResult.invoices).length}`);
        
        if (Object.keys(aggregateResult.invoices).length > 0) {
            console.log('  📊 Invoice amounts by date:');
            for (const [date, amount] of Object.entries(aggregateResult.invoices)) {
                console.log(`    ${date}: £${amount.toFixed(2)}`);
            }
        } else {
            console.log('  ⚠️ WARNING: No invoice data found in aggregate result!');
        }
        
        updateStage(); // Stage 4: Processing
        updateStage(); // Stage 5: Validating
        
        // Process results into daily analysis
        const results = [];
        const totals = {
            expectedTotal: 0,
            paidTotal: 0,
            totalConsignments: 0,
            differenceTotal: 0,
            baseTotal: 0,
            bonusTotal: 0,
            unloadingTotal: 0,
            attendanceTotal: 0,
            earlyTotal: 0,
            pickupTotal: 0,
            pickupCount: 0,
            workingDays: 0
        };
        
        // Get all dates
        const runsheetDates = Object.keys(aggregateResult.runsheets);
        const invoiceDates = Object.keys(aggregateResult.invoices);
        
        console.log(`\n📅 Date consolidation:`);
        console.log(`  Runsheet dates: ${runsheetDates.length > 0 ? runsheetDates.sort().join(', ') : 'none'}`);
        console.log(`  Invoice dates: ${invoiceDates.length > 0 ? invoiceDates.sort().join(', ') : 'none'}`);
        
        const allDates = Array.from(
            new Set([...runsheetDates, ...invoiceDates])
        ).sort();
        
        console.log(`  Combined unique dates: ${allDates.length > 0 ? allDates.join(', ') : 'none'}`);
        
        if (allDates.length === 0) {
            console.log('\n❌ ERROR: No dates found to process!');
            console.log('  This usually means the invoice parsing failed.');
            console.log('  Check that invoice amounts are being extracted correctly.');
            UI.showToast('No data found in documents', 'error');
            UI.showLoading(false);
            return;
        }
        
        console.log(`\n📅 Processing ${allDates.length} unique dates...`);
        
        updateStage(); // Stage 6: Calculating
        

        
        // Process each date
        allDates.forEach((date, index) => {
            console.log(`\n  Processing date ${index + 1}/${allDates.length}: ${date}`);
            
            const dateObj = new Date(date + 'T12:00:00');
            const dayOfWeek = dateObj.getDay();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const isSaturday = dayOfWeek === 6;
            const isMonday = dayOfWeek === 1;
            
            const consignments = aggregateResult.runsheets[date]?.consignments || 0;
            const rate = isSaturday ? rules.saturdayRate : rules.weekdayRate;
            const pickupInfo = aggregateResult.pickups[date] || { count: 0, total: 0 };
            
            console.log(`    Day: ${dayNames[dayOfWeek]}`);
            console.log(`    Consignments from runsheet: ${consignments}`);
            console.log(`    Rate applied: £${rate.toFixed(2)}`);
            
            let expectedTotal = 0;
            let basePayment = 0;
            let unloadingBonus = 0;
            let attendanceBonus = 0;
            let earlyBonus = 0;
            
            if (consignments > 0 || pickupInfo.total > 0) {
                if (consignments > 0) {
                    basePayment = consignments * rate;
                    unloadingBonus = isMonday ? 0 : rules.unloadingBonus;
                    attendanceBonus = isSaturday ? 0 : rules.attendanceBonus;
                    earlyBonus = isSaturday ? 0 : rules.earlyBonus;
                    totals.workingDays++;
                    
                    if (isMonday) {
                        console.log(`    📅 Monday detected: No unloading bonus`);
                    }
                }
                expectedTotal = basePayment + unloadingBonus + attendanceBonus + earlyBonus;
            }
            
            expectedTotal += pickupInfo.total;
            
            const paidAmount = aggregateResult.invoices[date] || 0;
            const difference = paidAmount - expectedTotal;
            
            console.log(`    Base payment: ${consignments} × £${rate.toFixed(2)} = £${basePayment.toFixed(2)}`);
            if (pickupInfo.count > 0) {
                console.log(`    Pickups: ${pickupInfo.count} service(s) = £${pickupInfo.total.toFixed(2)}`);
            }
            console.log(`    Bonuses: Unloading(£${unloadingBonus.toFixed(2)}) + Attendance(£${attendanceBonus.toFixed(2)}) + Early(£${earlyBonus.toFixed(2)}) = £${(unloadingBonus + attendanceBonus + earlyBonus).toFixed(2)}`);
            console.log(`    Expected total: £${expectedTotal.toFixed(2)}`);
            console.log(`    Paid amount from invoice: £${paidAmount.toFixed(2)}`);
            console.log(`    Difference: ${difference >= 0 ? '+' : ''}£${difference.toFixed(2)} ${difference === 0 ? '✅' : difference > 0 ? '💚' : '🔴'}`);
            
            results.push({
                date,
                day: dayNames[dayOfWeek],
                consignments,
                rate,
                basePayment,
                unloadingBonus,
                attendanceBonus,
                earlyBonus,
                totalBonus: unloadingBonus + attendanceBonus + earlyBonus,
                pickupCount: pickupInfo.count,
                pickupTotal: pickupInfo.total,
                expectedTotal,
                paidAmount,
                difference
            });
            
            // Update totals
            totals.expectedTotal += expectedTotal;
            totals.paidTotal += paidAmount;
            totals.totalConsignments += consignments;
            totals.differenceTotal += difference;
            totals.baseTotal += basePayment;
            totals.bonusTotal += unloadingBonus + attendanceBonus + earlyBonus;
            totals.unloadingTotal += unloadingBonus;
            totals.attendanceTotal += attendanceBonus;
            totals.earlyTotal += earlyBonus;
            totals.pickupTotal += pickupInfo.total;
            totals.pickupCount += pickupInfo.count;
        });
        
        console.log('\n=== FINAL CALCULATION TOTALS ===');
        console.log(`Working Days: ${totals.workingDays}`);
        console.log(`Total Consignments: ${totals.totalConsignments}`);
        console.log(`Base Payment Total: £${totals.baseTotal.toFixed(2)}`);
        console.log(`  - Unloading Bonus: £${totals.unloadingTotal.toFixed(2)}`);
        console.log(`  - Attendance Bonus: £${totals.attendanceTotal.toFixed(2)}`);
        console.log(`  - Early Arrival Bonus: £${totals.earlyTotal.toFixed(2)}`);
        console.log(`Total Bonuses: £${totals.bonusTotal.toFixed(2)}`);
        console.log(`Pickup Services: ${totals.pickupCount} = £${totals.pickupTotal.toFixed(2)}`);
        console.log(`EXPECTED TOTAL: £${totals.expectedTotal.toFixed(2)}`);
        console.log(`PAID TOTAL: £${totals.paidTotal.toFixed(2)}`);
        console.log(`DIFFERENCE: ${totals.differenceTotal >= 0 ? '+' : ''}£${totals.differenceTotal.toFixed(2)}`);
        console.log(`STATUS: ${totals.differenceTotal >= 0 ? '✅ FAVORABLE' : '❌ UNFAVORABLE'}`);
        console.log('=================================\n');
        
        updateStage(); // Stage 7: Generating report
        
        // Calculate metadata
        let periodRange = '-';
        if (allDates.length > 0) {
            const startDate = new Date(allDates[0] + 'T12:00:00');
            const endDate = new Date(allDates[allDates.length - 1] + 'T12:00:00');
            periodRange = `${startDate.toLocaleDateString('en-GB')} - ${endDate.toLocaleDateString('en-GB')}`;
        }
        
        let overallStatus = totals.differenceTotal >= 0 ? 'FAVORABLE' : 'UNFAVORABLE';
        
        // Check validation
        const hasValidationIssue = aggregateResult.items.some(item => 
            item.type === 'invoice' && item.validationPassed === false
        );
        
        if (hasValidationIssue) {
            overallStatus = 'INVALID - REVIEW REQUIRED';
            UI.showValidationAlert('Invoice validation failed. Results may be inaccurate.', 'error');
            console.log('⚠️ Invoice validation failed - results may be inaccurate');
        } else if (aggregateResult.items.some(item => item.validationPassed === true)) {
            overallStatus = 'VALIDATED - ' + overallStatus;
            UI.showValidationAlert('Invoice validation successful', 'success');
            console.log('✅ Invoice validation passed');
        } else {
            console.log('ℹ️ No validation status available');
        }
        
        const metadata = {
            periodRange,
            totalDays: totals.workingDays,
            analysisDate: new Date().toLocaleDateString('en-GB'),
            overallStatus
        };
        
        // Store analysis data
        lastAnalysisData = { results, totals, metadata };
        
        // Create processed data structure for storage
        const processedData = {
            runsheets: aggregateResult.runsheets || {},
            invoices: aggregateResult.invoices || {},
            pickups: aggregateResult.pickups || {}
        };
        
        // Save to state with enhanced structure
        State.save({
            version: State.VERSION,
            lastAnalysis: lastAnalysisData,
            lastModified: Date.now(),
            files: {
                uploaded: uploadedFiles.map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type,
                    lastModified: f.file.lastModified || 0
                })),
                processed: processedData
            },
            rules: rules
        });
        
        // ONLY save as new analysis when actually performing analysis
        console.log('💾 Saving as new analysis entry...');
        State.saveAnalysis(files, lastAnalysisData, processedData);
        
        updateStage(); // Stage 8: Complete
        
        // Render report
        console.log('📊 Rendering report to UI...');
        UI.renderReport(lastAnalysisData);
        
        // Navigate to reports page
        Router.navigate('reports');
        
        UI.showToast('Analysis complete!', 'success');
        
        // Clear files after successful analysis
        uploadedFiles = [];
        document.getElementById('fileInput').value = '';
        
        console.log('✅ ANALYSIS COMPLETE AND RENDERED!');
        
    } catch (error) {
        console.error('Analysis error:', error);
        UI.showToast('Error processing files: ' + (error && error.message ? error.message : 'Unknown error'), 'error');
    } finally {
        UI.showLoading(false);
        UI.hideValidationAlert();
    }
}
</script>

<!-- Reports Module -->
<script id="reportsModule" type="application/x-module">
// Reports Module with enhanced export and print functionality
let currentReportData = null;

exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('reports', {
        onLoad: () => {
            console.log('📊 Loading reports page');
            exports.loadReport();
        }
    });
    
    // Print button with enhanced functionality
    document.getElementById('printReport').addEventListener('click', () => {
        if (!currentReportData) {
            requireModule('uiModule').showToast('No report to print', 'warn');
            return;
        }
        
        // Add print-specific class to body for styling
        document.body.classList.add('printing');
        
        // Trigger print
        window.print();
        
        // Remove print class after a delay
        setTimeout(() => {
            document.body.classList.remove('printing');
        }, 500);
    });
    
    // Export button with current report export
    document.getElementById('exportReport').addEventListener('click', () => {
        if (!currentReportData) {
            requireModule('uiModule').showToast('No report to export', 'warn');
            return;
        }
        
        const State = requireModule('stateModule');
        State.exportData(currentReportData, false);
    });
    
    // Pull-to-refresh for mobile
    let startY = 0;
    let isPulling = false;

    const reportsContent = document.getElementById('reportsContent');
    const pullIndicator = document.getElementById('pullIndicator');

    reportsContent.addEventListener('touchstart', (e) => {
        if (reportsContent.scrollTop === 0) {
            startY = e.touches[0].clientY;
            isPulling = true;
        }
    });

    reportsContent.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        
        const currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        
        if (diff > 0 && diff < 150) {
            pullIndicator.style.transform = `translateY(${diff}px)`;
            
            if (diff > 80) {
                pullIndicator.innerHTML = '<span>↑ Release to refresh</span>';
            } else {
                pullIndicator.innerHTML = '<span>↓ Pull to refresh</span>';
            }
        }
    });

    reportsContent.addEventListener('touchend', (e) => {
        if (!isPulling) return;
        
        const endY = e.changedTouches[0].clientY;
        const diff = endY - startY;
        
        if (diff > 80) {
            pullIndicator.innerHTML = '<span>🔄 Refreshing...</span>';
            exports.loadReport();
            requireModule('uiModule').showToast('Report refreshed', 'success');
        }
        
        pullIndicator.style.transform = 'translateY(0)';
        isPulling = false;
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (Router.getCurrentPage() === 'reports') {
            // Ctrl/Cmd + P to print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                document.getElementById('printReport').click();
            }
            // Ctrl/Cmd + E to export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                document.getElementById('exportReport').click();
            }
        }
    });
};

exports.loadReport = function() {
    const State = requireModule('stateModule');
    const UI = requireModule('uiModule');
    
    const savedState = State.load();
    if (savedState && savedState.lastAnalysis) {
        currentReportData = savedState.lastAnalysis;
        UI.renderReport(currentReportData);
        
        // Check if validation passed
        if (currentReportData.metadata && currentReportData.metadata.overallStatus) {
            if (currentReportData.metadata.overallStatus.includes('INVALID')) {
                UI.showToast('⚠️ Report has validation issues', 'warn');
            } else if (currentReportData.metadata.overallStatus.includes('VALIDATED')) {
                console.log('✅ Report is validated');
            }
        }
    } else {
        currentReportData = null;
        UI.renderReport(null);
    }
};
</script>

<!-- History Module -->
<script id="historyModule" type="application/x-module">
// History Module
exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('history', {
        onLoad: () => {
            console.log('📜 Loading history page');
            exports.loadHistory();
        }
    });
    
    // Clear history button
    document.getElementById('clearHistory').addEventListener('click', () => {
        if (confirm('Clear all history? This cannot be undone.')) {
            const State = requireModule('stateModule');
            State.clear();
            exports.loadHistory();
            requireModule('uiModule').showToast('History cleared', 'success');
        }
    });
    
    // History item clicks
    document.getElementById('historyList').addEventListener('click', (e) => {
        const item = e.target.closest('.history-item');
        if (item) {
            const analysisId = item.dataset.analysisId;
            exports.loadAnalysis(analysisId);
        }
    });
};

exports.loadHistory = function() {
    const UI = requireModule('uiModule');
    UI.renderHistory();
};

exports.loadAnalysis = function(analysisId) {
    const State = requireModule('stateModule');
    const UI = requireModule('uiModule');
    const Router = requireModule('routerModule');
    
    const analyses = State.getAllAnalyses();
    const analysis = analyses[analysisId];
    
    if (analysis) {
        UI.renderReport(analysis);
        Router.navigate('reports');
        UI.showToast('Analysis loaded', 'success');
    }
};
</script>

<!-- Settings Module -->
<script id="settingsModule" type="application/x-module">
// Settings Module with enhanced data management
exports.init = function() {
    const Router = requireModule('routerModule');
    const Rules = requireModule('rulesModule');
    const UI = requireModule('uiModule');
    const State = requireModule('stateModule');
    
    // Register page handler
    Router.registerPageHandler('settings', {
        onLoad: () => {
            console.log('⚙️ Loading settings page');
            const rules = Rules.load();
            UI.updateSettingsForm(rules);
            
            // Update storage info
            State.updateStorageDisplay();
            
            // Setup instant feedback
            setupInstantFeedback();
        }
    });
    
    function setupInstantFeedback() {
        // Add instant feedback for settings changes
        const settingsInputs = document.querySelectorAll('.setting-input');
        const originalValues = {};

        settingsInputs.forEach(input => {
            originalValues[input.id] = input.value;
            
            input.addEventListener('input', (e) => {
                const hasChanged = e.target.value !== originalValues[e.target.id];
                
                if (hasChanged) {
                    e.target.style.borderColor = 'var(--warning)';
                    e.target.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
                    
                    // Show live preview
                    const previewValue = parseFloat(e.target.value) || 0;
                    const description = e.target.nextElementSibling?.nextElementSibling;
                    if (description) {
                        description.innerHTML = `${description.textContent.split('(')[0].trim()} <span style="color: var(--warning); font-weight: bold;">(unsaved: £${previewValue.toFixed(2)})</span>`;
                    }
                } else {
                    e.target.style.borderColor = '';
                    e.target.style.boxShadow = '';
                }
                
                // Enable/disable save button
                const saveBtn = document.getElementById('saveRules');
                const hasAnyChange = Array.from(settingsInputs).some(input => 
                    input.value !== originalValues[input.id]
                );
                saveBtn.disabled = !hasAnyChange;
                saveBtn.textContent = hasAnyChange ? 'Save Changes' : 'No Changes';
            });
        });
    }
    
    // Save rules
    document.getElementById('saveRules').addEventListener('click', () => {
        const newRules = UI.getSettingsFormData();
        const oldRules = Rules.load();
        
        // Check if rules actually changed
        const rulesChanged = 
            newRules.weekdayRate !== oldRules.weekdayRate ||
            newRules.saturdayRate !== oldRules.saturdayRate ||
            newRules.unloadingBonus !== oldRules.unloadingBonus ||
            newRules.attendanceBonus !== oldRules.attendanceBonus ||
            newRules.earlyBonus !== oldRules.earlyBonus;
        
        if (rulesChanged) {
            Rules.save(newRules);
            UI.showToast('Settings saved successfully', 'success');
            
            // Check if we have analysis data that might need recalculation
            const savedState = State.load();
            if (savedState && savedState.lastAnalysis) {
                setTimeout(() => {
                    if (confirm('Payment rules have been updated. Would you like to view reports to re-analyze with the new rules?')) {
                        Router.navigate('reports');
                    }
                }, 500);
            }
        } else {
            UI.showToast('No changes to save', 'warn');
        }
    });
    
    // Reset rules
    document.getElementById('resetRules').addEventListener('click', () => {
        if (confirm('Reset to default payment rules?')) {
            const defaultRules = Rules.getDefaults();
            Rules.save(defaultRules);
            UI.updateSettingsForm(defaultRules);
            UI.showToast('Reset to defaults', 'success');
        }
    });
    
    // Export current analysis
    document.getElementById('exportCurrentBtn').addEventListener('click', () => {
        const savedState = State.load();
        if (savedState && savedState.lastAnalysis) {
            State.exportData(savedState.lastAnalysis, false);
        } else {
            UI.showToast('No current analysis to export', 'warn');
        }
    });
    
    // Export all data
    document.getElementById('exportAllBtn').addEventListener('click', () => {
        const analyses = State.getAllAnalyses();
        const analysesCount = Object.keys(analyses).length;
        
        if (analysesCount === 0) {
            UI.showToast('No data to export', 'warn');
            return;
        }
        
        State.exportData(null, true);
    });
    
    // Clear all data with enhanced confirmation
    document.getElementById('clearAllData').addEventListener('click', () => {
        const analyses = State.getAllAnalyses();
        const analysesCount = Object.keys(analyses).length;
        
        if (analysesCount === 0) {
            UI.showToast('No data to clear', 'warn');
            return;
        }
        
        const message = `⚠️ DELETE ALL DATA?\n\nThis will permanently delete:\n• ${analysesCount} saved analyse(s)\n• All payment history\n• All cached results\n\nThis action cannot be undone!`;
        
        if (confirm(message)) {
            if (confirm('Are you absolutely sure? This will delete EVERYTHING!')) {
                State.clear();
                UI.showToast('All data cleared successfully', 'success');
                
                // Navigate back to dashboard after clearing
                setTimeout(() => {
                    Router.navigate('dashboard');
                    // Refresh dashboard to show empty state
                    requireModule('dashboardModule').refresh();
                }, 500);
            }
        }
    });
    
    // Recovery banner handlers
    document.getElementById('startNewBtn').addEventListener('click', () => {
        UI.hideRecoveryBanner();
        Router.navigate('analysis');
    });
    
    document.getElementById('closeBannerBtn').addEventListener('click', () => {
        UI.hideRecoveryBanner();
    });
    
    // Add keyboard shortcuts for settings
    document.addEventListener('keydown', (e) => {
        if (Router.getCurrentPage() === 'settings') {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveRules').click();
            }
            // Ctrl/Cmd + R to reset
            if ((e.ctrlKey || e.metaKey) && e.key === 'r' && e.shiftKey) {
                e.preventDefault();
                document.getElementById('resetRules').click();
            }
        }
    });
};
</script>

<!-- App Module -->
<script id="appModule" type="application/x-module">
// Main Application Module - Production Ready
const APP_VERSION = '9.0.0';
const BUILD_DATE = '2024-12-20';

exports.boot = function() {
    console.log('🚀 Initializing Payment Analyzer Mobile v' + APP_VERSION);
    console.log('📅 Build date:', BUILD_DATE);
    
    try {
        // Check for browser compatibility
        if (!checkBrowserCompatibility()) {
            alert('Your browser may not support all features. Please use a modern browser for the best experience.');
        }
        
        // Initialize all modules
        requireModule('routerModule').init();
        requireModule('dashboardModule').init();
        requireModule('analysisModule').init();
        requireModule('reportsModule').init();
        requireModule('historyModule').init();
        requireModule('settingsModule').init();
        
        // Ensure dashboard shows correct state on initial load
        setTimeout(() => {
            requireModule('dashboardModule').refresh();
        }, 100);
        
        // Check for saved state and migrations
        checkAndMigrateData();
        
        // Check for recovery data
        checkRecoveryData();
        
        // Set up global error handling
        setupErrorHandling();
        
        // Check for iOS standalone mode
        if (window.navigator.standalone) {
            console.log('📱 Running in iOS standalone mode');
            document.body.classList.add('ios-standalone');
        }
        
        // Register service worker if available (for PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                console.log('Service worker registration skipped');
            });
        }
        
        console.log('✅ Application initialized successfully');
        
        // Add to window for debugging
        window.PA = {
            version: APP_VERSION,
            buildDate: BUILD_DATE,
            modules: {
                router: requireModule('routerModule'),
                state: requireModule('stateModule'),
                rules: requireModule('rulesModule'),
                parser: requireModule('parserModule'),
                ui: requireModule('uiModule'),
                dashboard: requireModule('dashboardModule'),
                analysis: requireModule('analysisModule'),
                reports: requireModule('reportsModule'),
                history: requireModule('historyModule'),
                settings: requireModule('settingsModule')
            },
            debug: {
                clearAll: () => {
                    if (confirm('Clear ALL data including analyses?')) {
                        requireModule('stateModule').clear();
                        location.reload();
                    }
                },
                exportState: () => {
                    const state = requireModule('stateModule').load();
                    console.log('Current state:', state);
                    return state;
                },
                getAnalyses: () => {
                    const analyses = requireModule('stateModule').getAllAnalyses();
                    console.log('All analyses:', analyses);
                    return analyses;
                },
                getStorageInfo: () => {
                    return requireModule('stateModule').getStorageInfo();
                }
            }
        };
        
        console.log('🔧 Debug interface available at window.PA');
        
    } catch (error) {
        console.error('❌ Boot error:', error);
        console.error('Stack trace:', error.stack);
        
        // Show user-friendly error
        const errorMessage = 'Failed to initialize the application. Please refresh the page or clear your browser cache.';
        if (document.body) {
            document.body.innerHTML = `
                <div style="padding: 20px; text-align: center; font-family: system-ui;">
                    <h2>⚠️ Loading Error</h2>
                    <p>${errorMessage}</p>
                    <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px;">Refresh Page</button>
                    <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; margin: 10px;">Clear Data & Refresh</button>
                </div>
            `;
        } else {
            alert(errorMessage);
        }
    }
};

function checkBrowserCompatibility() {
    // Check for required features
    const required = [
        typeof Promise !== 'undefined',
        typeof localStorage !== 'undefined',
        typeof FileReader !== 'undefined',
        typeof Blob !== 'undefined',
        'querySelector' in document,
        'addEventListener' in window
    ];
    
    return required.every(feature => feature);
}

function checkAndMigrateData() {
    try {
        const State = requireModule('stateModule');
        
        // Check for old version data (v8)
        const oldData = localStorage.getItem('paymentAnalyzer_v8');
        const oldAnalyses = localStorage.getItem('paymentAnalyzer_v8_analyses');
        
        if (oldData || oldAnalyses) {
            console.log('📦 Found v8 data, migrating to v9...');
            
            // Migrate v8 data to v9
            if (oldAnalyses) {
                // Parse and save old analyses to new format
                try {
                    let analysesData;
                    if (window.LZString) {
                        const decompressed = LZString.decompressFromUTF16(oldAnalyses);
                        if (decompressed) {
                            analysesData = JSON.parse(decompressed);
                        }
                    }
                    if (!analysesData) {
                        analysesData = JSON.parse(oldAnalyses);
                    }
                    
                    // Save to new key
                    const serialized = JSON.stringify(analysesData);
                    if (window.LZString) {
                        const compressed = LZString.compressToUTF16(serialized);
                        localStorage.setItem('paymentAnalyzer_v9_analyses', compressed);
                    } else {
                        localStorage.setItem('paymentAnalyzer_v9_analyses', serialized);
                    }
                    
                    console.log('✅ Successfully migrated analyses to v9');
                } catch (e) {
                    console.error('Failed to migrate analyses:', e);
                }
            }
            
            // Clean up old data
            localStorage.removeItem('paymentAnalyzer_v8');
            localStorage.removeItem('paymentAnalyzer_v8_compressed');
            localStorage.removeItem('paymentAnalyzer_v8_analyses');
        }
        
        // Verify data integrity
        const currentState = State.load();
        if (currentState && currentState.version !== State.VERSION) {
            console.log('🔄 Version mismatch, updating...');
            currentState.version = State.VERSION;
            State.save(currentState);
        }
        
    } catch (error) {
        console.error('Migration error:', error);
    }
}

function checkRecoveryData() {
    try {
        const State = requireModule('stateModule');
        const UI = requireModule('uiModule');
        
        const savedState = State.load();
        if (savedState && savedState.lastAnalysis && savedState.lastModified) {
            // Show recovery banner if data is less than 24 hours old
            const age = Date.now() - new Date(savedState.lastModified).getTime();
            if (age < 86400000) { // 24 hours
                UI.showRecoveryBanner(new Date(savedState.lastModified).getTime());
            }
        }
    } catch (error) {
        console.error('Recovery check error:', error);
    }
}

function setupErrorHandling() {
    // Global error handler
    window.addEventListener('error', (event) => {
        console.error('Global error:', event.error);
        
        // Log to analytics if available
        if (window.gtag) {
            window.gtag('event', 'exception', {
                description: event.error.toString(),
                fatal: false
            });
        }
    });
    
    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        
        // Prevent the default handling
        event.preventDefault();
        
        // Show user notification for critical errors
        if (event.reason && event.reason.message && event.reason.message.includes('PDF')) {
            requireModule('uiModule').showToast('Error processing PDF file', 'error');
        }
    });
    
    // Enhanced iOS memory management
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        // Monitor memory usage
        let memoryWarningCount = 0;
        
        // Periodic cleanup
        setInterval(() => {
            // Clear unused module cache
            if (window.performance && window.performance.memory) {
                const used = window.performance.memory.usedJSHeapSize;
                const limit = window.performance.memory.jsHeapSizeLimit;
                const usage = (used / limit) * 100;
                
                if (usage > 80) {
                    console.warn(`High memory usage: ${usage.toFixed(1)}%`);
                    memoryWarningCount++;
                    
                    // Clear old chart data
                    const charts = document.querySelectorAll('.bar-chart');
                    charts.forEach(chart => {
                        if (chart.children.length > 10) {
                            while (chart.children.length > 7) {
                                chart.removeChild(chart.firstChild);
                            }
                        }
                    });
                    
                    // Clear old history items if too many
                    const historyItems = document.querySelectorAll('.history-item');
                    if (historyItems.length > 20) {
                        for (let i = 20; i < historyItems.length; i++) {
                            historyItems[i].remove();
                        }
                    }
                    
                    // Force garbage collection if available
                    if (window.gc) {
                        window.gc();
                    }
                    
                    if (memoryWarningCount > 3) {
                        requireModule('uiModule').showToast('Memory usage high, consider restarting app', 'warn');
                    }
                }
            }
        }, 30000); // Check every 30 seconds
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Save critical state when app goes to background
                const State = requireModule('stateModule');
                const currentState = State.load();
                if (currentState) {
                    currentState.lastBackgrounded = Date.now();
                    State.save(currentState);
                }
            } else {
                // Refresh data when app comes back
                const Router = requireModule('routerModule');
                const currentPage = Router.getCurrentPage();
                
                if (currentPage === 'dashboard') {
                    requireModule('dashboardModule').refresh();
                }
            }
        });
        
        // Handle iOS memory warnings
        window.addEventListener('pagehide', () => {
            // Save state before potential termination
            const State = requireModule('stateModule');
            const currentState = State.load();
            if (currentState) {
                State.save(currentState);
            }
        });
    }
}
</script>

<!-- Module Loader -->
<script>
(function() {
    const modules = {};
    const moduleCache = {};
    
    window.defineModule = function(id, factory) {
        modules[id] = factory;
    };
    
    window.requireModule = function(id) {
        if (moduleCache[id]) return moduleCache[id];
        if (!modules[id]) {
            console.error(`❌ Module ${id} not found. Available modules:`, Object.keys(modules));
            throw new Error(`Module ${id} not found`);
        }
        
        const module = { exports: {} };
        const require = (depId) => requireModule(depId);
        
        try {
            modules[id].call(module.exports, module, module.exports, require);
            moduleCache[id] = module.exports;
        } catch (error) {
            console.error(`❌ Error executing module ${id}:`, error);
            throw error;
        }
        
        return module.exports;
    };
    
    function loadModules() {
        console.log('📦 Starting module loading...');
        const moduleScripts = document.querySelectorAll('script[type="application/x-module"]');
        console.log(`Found ${moduleScripts.length} modules to load`);
        
        let loadedCount = 0;
        let failedModules = [];
        
        moduleScripts.forEach(script => {
            const id = script.id;
            const content = script.textContent;
            
            if (!id) {
                console.error('❌ Module script found without ID');
                return;
            }
            
            console.log(`Loading module: ${id}`);
            
            try {
                // Check for syntax errors first
                try {
                    new Function(content); // Basic syntax check
                } catch (syntaxError) {
                    console.error(`❌ Syntax error in module ${id}:`, syntaxError);
                    failedModules.push({id, error: syntaxError});
                    return;
                }
                
                const factory = new Function('module', 'exports', 'require', content);
                defineModule(id, factory);
                loadedCount++;
                console.log(`✅ Module ${id} loaded successfully (${loadedCount}/${moduleScripts.length})`);
            } catch (error) {
                console.error(`❌ Failed to load module ${id}:`, error);
                console.error(`Module content preview:`, content.substring(0, 200) + '...');
                failedModules.push({id, error});
            }
        });
        
        console.log(`📊 Module loading complete: ${loadedCount}/${moduleScripts.length} loaded`);
        
        if (failedModules.length > 0) {
            console.error('❌ Failed modules:', failedModules);
            
            // Show detailed error on page
            const errorDetails = failedModules.map(m => 
                `Module: ${m.id}\nError: ${m.error.message}`
            ).join('\n\n');
            
            document.body.innerHTML = `
                <div style="padding: 20px; font-family: monospace; background: #fff;">
                    <h2 style="color: red;">⚠️ Module Loading Errors</h2>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">
${errorDetails}
                    </pre>
                    <p><strong>Debug Info:</strong></p>
                    <ul>
                        <li>Total modules: ${moduleScripts.length}</li>
                        <li>Loaded: ${loadedCount}</li>
                        <li>Failed: ${failedModules.length}</li>
                    </ul>
                    <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px;">Retry</button>
                    <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; margin: 10px;">Clear & Retry</button>
                </div>
            `;
            
            throw new Error('Module loading failed');
        }
        
        return true;
    }
    
    function bootstrap() {
        console.log('=== PAYMENT ANALYZER PRO v9.0 ENHANCED BOOTSTRAP ===');
        console.log('Browser:', navigator.userAgent);
        console.log('URL:', window.location.href);
        
        try {
            // Check basic requirements
            if (!window.localStorage) {
                throw new Error('localStorage not available');
            }
            
            if (!window.FileReader) {
                throw new Error('FileReader API not available');
            }
            
            // Load modules
            const modulesLoaded = loadModules();
            if (!modulesLoaded) {
                return; // Error already handled
            }
            
            // Initialize app
            console.log('🚀 Initializing app module...');
            const app = requireModule('appModule');
            
            if (app && app.boot) {
                console.log('📱 Calling app.boot()...');
                app.boot();
                console.log('✅ Application started successfully');
            } else {
                throw new Error('App module or boot function not found');
            }
        } catch (error) {
            console.error('❌ Bootstrap failed:', error);
            console.error('Stack trace:', error.stack);
            
            // More detailed error display
            const errorHtml = `
                <div style="padding: 20px; font-family: system-ui; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #dc2626;">⚠️ Loading Error</h2>
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <p style="margin: 0 0 10px 0;"><strong>Error:</strong> ${error.message}</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #dc2626;">Technical Details</summary>
                            <pre style="margin: 10px 0 0 0; font-size: 12px; overflow: auto; background: white; padding: 10px; border-radius: 4px;">${error.stack}</pre>
                        </details>
                    </div>
                    <p>Please try one of these options:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Refresh Page</button>
                        <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">Clear Data & Refresh</button>
                        <button onclick="window.open('https://www.google.com/chrome/', '_blank')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">Try Chrome Browser</button>
                    </div>
                    <div style="margin-top: 30px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                        <p style="margin: 0 0 10px 0;"><strong>Browser Info:</strong></p>
                        <code style="font-size: 11px; word-break: break-all;">${navigator.userAgent}</code>
                    </div>
                </div>
            `;
            
            if (document.body) {
                document.body.innerHTML = errorHtml;
            } else {
                alert('Critical error: ' + error.message);
            }
        }
    }
    
    // Start when DOM is ready
    console.log('🔄 Waiting for DOM...');
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM loaded, starting bootstrap...');
            bootstrap();
        });
    } else {
        console.log('📄 DOM already loaded, starting bootstrap...');
        setTimeout(bootstrap, 0);
    }
})();
</script>
