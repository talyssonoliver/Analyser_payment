<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Payment Analyzer">
<title>Payment Analyzer Professional v9.0 Enhanced - Production Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
<style>
/* === Root Variables & Base Styles === */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

:root {
    --primary: #0f172a;
    --primary-light: #1e293b;
    --accent: #3b82f6;
    --accent-dark: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #dc2626;
    --slate-50: #f8fafc;
    --slate-100: #f1f5f9;
    --slate-200: #e2e8f0;
    --slate-300: #cbd5e1;
    --slate-400: #94a3b8;
    --slate-500: #64748b;
    --slate-600: #475569;
    --slate-700: #334155;
    --slate-800: #1e293b;
    --slate-900: #0f172a;
    --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
    --bottom-nav-height: 60px;
    --safe-area-bottom: env(safe-area-inset-bottom, 0);
    --header-height: 50px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: var(--font-primary);
    line-height: 1.6;
    color: var(--primary);
    background: linear-gradient(180deg, #f0f4f8 0%, #d9e2ec 100%);
    min-height: 100vh;
    padding: 0;
    margin: 0;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === App Container === */
.app-container {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
    padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
}

/* === Page Header === */
.page-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-bottom: 1px solid var(--slate-200);
    padding: 12px 16px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.page-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 100%;
}

.page-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.page-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.header-btn {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 8px;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.2s;
}

.header-btn:active {
    transform: scale(0.95);
    background: var(--slate-50);
}

/* === Validation Badge === */
.validation-badge {
    background: linear-gradient(135deg, var(--slate-400) 0%, var(--slate-500) 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    animation: pulse 2s infinite;
}

.validation-badge.validated {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
}

.validation-badge.invalid {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* === Page Container === */
.page {
    display: none;
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 16px;
    animation: fadeIn 0.3s ease;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* === Bottom Navigation with Badges === */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--slate-200);
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 0 8px;
    padding-bottom: var(--safe-area-bottom);
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}

.nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: var(--slate-500);
    padding: 8px 4px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 8px;
    position: relative;
    min-height: 48px;
}

.nav-item:active {
    transform: scale(0.95);
}

.nav-item.active {
    color: var(--accent);
}

.nav-item.active .nav-icon {
    transform: translateY(-2px);
}

.nav-icon {
    font-size: 22px;
    margin-bottom: 4px;
    transition: all 0.3s;
}

.nav-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: capitalize;
}

.nav-item.active::before {
    content: '';
    position: absolute;
    top: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 3px;
    background: var(--accent);
    border-radius: 0 0 3px 3px;
}

.nav-badge {
    position: absolute;
    top: 4px;
    right: 20%;
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: badgePop 0.3s ease;
}

@keyframes badgePop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* === Recovery Banner === */
.recovery-banner {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    color: white;
    padding: 12px 24px;
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1100;
    animation: slideDown 0.5s ease-out;
    max-width: calc(100% - 32px);
}

.recovery-banner.show {
    display: flex;
}

@keyframes slideDown {
    from {
        transform: translate(-50%, -100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

.recovery-banner-text {
    font-size: 14px;
    font-weight: 600;
}

.recovery-banner-action {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.recovery-banner-close {
    background: transparent;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

/* === Dashboard Page === */
.dashboard-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.view-toggle {
    background: white;
    border-radius: 12px;
    padding: 4px;
    display: flex;
    gap: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.toggle-btn {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--slate-600);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.toggle-btn.active {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.executive-summary {
    background: linear-gradient(135deg, #1e3a8a 0%, #6d28d9 100%);
    color: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
}

.executive-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
}

.summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
}

.summary-title {
    font-size: 18px;
    font-weight: 700;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Removed analysis-filter-indicator - not needed on dashboard */

.summary-period {
    font-size: 12px;
    opacity: 0.9;
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    position: relative;
    z-index: 1;
}

.summary-stat {
    background: rgba(255, 255, 255, 0.1);
    padding: 12px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-stat-label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.summary-stat-value {
    font-size: 20px;
    font-weight: 800;
}

.summary-stat-change {
    font-size: 11px;
    margin-top: 2px;
    opacity: 0.9;
}

.positive { color: #10b981; }
.negative { color: #f87171; }

.calendar-widget {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.calendar-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
}

.calendar-nav {
    display: flex;
    gap: 8px;
}

.calendar-nav-btn {
    width: 32px;
    height: 32px;
    border: 2px solid var(--accent);
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.calendar-day-header {
    font-size: 10px;
    font-weight: 600;
    color: var(--slate-500);
    text-align: center;
    padding: 4px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    border-radius: 6px;
    position: relative;
    cursor: pointer;
}

.calendar-day.has-data {
    background: var(--slate-50);
    font-weight: 600;
}

.calendar-day.has-data::after {
    content: '';
    position: absolute;
    bottom: 2px;
    width: 4px;
    height: 4px;
    background: var(--accent);
    border-radius: 50%;
}

.calendar-day.today {
    background: var(--accent);
    color: white;
}

.calendar-day.selected {
    background: var(--accent-dark);
    color: white;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
}

.calendar-nav-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent) 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
}

.calendar-nav-btn:disabled,
.calendar-nav-btn.disabled {
    background: #e2e8f0;
    color: #94a3b8;
    border-color: #e2e8f0;
    cursor: not-allowed;
    transform: none;
}

.calendar-day:hover:not(.disabled) {
    background: var(--slate-100);
    transform: scale(1.05);
}

.calendar-day.disabled {
    color: var(--slate-300);
    cursor: not-allowed;
}

.calendar-day.future {
    background: var(--slate-100);
    color: var(--slate-400);
    cursor: not-allowed;
    opacity: 0.6;
}

.calendar-day.no-data {
    position: relative;
    cursor: pointer;
}

.calendar-day.no-data:hover {
    background: var(--slate-200);
    transform: scale(1.05);
}

.calendar-day.no-data::before {
    content: '+';
    position: absolute;
    top: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: 700;
    opacity: 0;
    transition: all 0.2s ease;
}

.calendar-day.no-data:hover::before {
    opacity: 1;
}

.calendar-day.clickable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.calendar-day.clickable:hover {
    background: var(--accent);
    color: white;
    transform: scale(1.05);
}


/* Tooltip styles */
.calendar-tooltip {
    position: absolute;
    background: var(--primary);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    white-space: normal;
    z-index: 10000;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.2s ease;
    pointer-events: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 250px;
}

.calendar-tooltip.show {
    opacity: 1;
    transform: translateY(0);
}

/* Form info icon and tooltip styles */
.form-label-with-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    cursor: help;
    user-select: none;
    position: relative;
}

.info-icon::after {
    content: '';
    width: 16px;
    height: 16px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%233b82f6' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M10 11h2v5m-2 0h4m-2.592-8.5h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
}

.info-icon svg {
    display: none;
}

.info-icon:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
    transition: all 0.2s ease;
}

.info-tooltip {
    position: absolute;
    background: var(--slate-800);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    z-index: 10001;
    pointer-events: none;
    transition: all 0.15s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    
    /* Position below the icon by default */
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(4px);
    margin-top: 4px;
    
    /* Ensure readability */
    letter-spacing: 0.02em;
}

.info-tooltip::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-bottom: 4px solid var(--slate-800);
}

.info-tooltip.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}

.info-tooltip.above {
    top: auto;
    bottom: 100%;
    margin-top: 0;
    margin-bottom: 4px;
    transform: translateX(-50%) translateY(-4px);
}

.info-tooltip.above::before {
    top: 100%;
    bottom: auto;
    border-bottom: none;
    border-top: 4px solid var(--slate-800);
}

.calendar-tooltip::before {
    content: '';
    position: absolute;
    top: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-bottom: 4px solid var(--primary);
}

.calendar-tooltip.above::before {
    top: auto;
    bottom: -4px;
    border-bottom: none;
    border-top: 4px solid var(--primary);
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.kpi-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--slate-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    border-color: var(--accent);
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--accent);
}

.kpi-card.primary::before { background: var(--primary); }
.kpi-card.success::before { background: var(--success); }
.kpi-card.warning::before { background: var(--warning); }
.kpi-card.danger::before { background: var(--danger); }

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.kpi-label {
    font-size: 11px;
    color: var(--slate-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.kpi-icon {
    font-size: 16px;
    opacity: 0.5;
    width: 40px;
    height: 40px;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.kpi-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 4px;
    font-family: var(--font-mono);
}

.kpi-trend {
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.trend-up { color: var(--success); }
.trend-down { color: var(--danger); }
.trend-neutral { color: var(--slate-500); }

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.chart-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
}

.chart-legend {
    display: flex;
    gap: 12px;
    font-size: 11px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.bar-chart {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    height: 120px;
    gap: 8px;
    padding: 0 4px;
}

.bar-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    animation: slideUp 0.4s ease-out forwards;
    opacity: 0;
}

.bar {
    width: 100%;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    border-radius: 4px 4px 0 0;
    min-height: 4px;
    transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    cursor: pointer;
}

.bar.secondary {
    background: linear-gradient(135deg, var(--slate-300) 0%, var(--slate-400) 100%);
}

.animated-bar {
    transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 4px 4px 0 0;
    position: relative;
    cursor: pointer;
}

.animated-bar:hover {
    filter: brightness(1.1);
    transform: scaleY(1.02);
}

.animated-bar::after {
    content: attr(data-value);
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    font-weight: 700;
    opacity: 0;
    transition: opacity 0.2s;
}

.animated-bar:hover::after {
    opacity: 1;
}

@keyframes slideUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
    from {
        opacity: 0;
        transform: translateY(10px);
    }
}

.empty-chart {
    text-align: center;
    padding: 40px;
    color: var(--slate-400);
    font-size: 14px;
}

.chart-tooltip {
    animation: fadeIn 0.2s;
}

.bar-label {
    font-size: 10px;
    color: var(--slate-500);
    margin-top: 4px;
    text-align: center;
}

.forecast-card {
    background: linear-gradient(135deg, var(--slate-50) 0%, var(--slate-100) 100%);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 16px;
}

.forecast-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.forecast-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
}

.forecast-badge {
    background: var(--accent);
    color: white;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.forecast-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.forecast-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: white;
    border-radius: 8px;
}

.forecast-label {
    font-size: 13px;
    color: var(--slate-600);
}

.forecast-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
    font-family: var(--font-mono);
}

.quick-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
}

.action-btn {
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 16px;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);

    gap: 12px;
}

.action-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-btn.secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--slate-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.upload-section {
    padding: 0;
}

.upload-area {
    background: white;
    border: 3px dashed var(--slate-300);
    border-radius: 16px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
}

.upload-area::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    opacity: 0;
    transition: opacity 0.3s;
}

.upload-area:hover::before {
    opacity: 0.05;
}

.upload-area:active {
    transform: scale(0.98);
    border-color: var(--accent);
}

.upload-area.drag-active {
    border-color: var(--accent);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%);
    transform: scale(1.02);
}

.upload-area.drag-active::before {
    opacity: 0.1;
}

.upload-area.drag-active .upload-icon {
    animation: bounce 0.5s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}


.upload-icon {
    font-size: 48px;
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    position: relative;
}

.upload-icon svg {
    width: 100%;
    height: 100%;
    stroke: var(--slate-400);
    transition: all 0.3s ease;
}

.upload-area:hover .upload-icon svg {
    stroke: var(--accent);
    transform: scale(1.1);
}



.file-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.file-item {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s;
}

.file-item:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.file-icon {
    width: 48px;
    height: 48px;
    background: var(--slate-100);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 24px;
    position: relative;
}

.file-icon.updated {
    background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
    border: 2px solid var(--accent);
    animation: fileUpdatePulse 2s ease-in-out 3;
}

.file-update-indicator {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 16px;
    height: 16px;
    background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
    border: 2px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    color: white;
    animation: updateIndicatorPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
}

@keyframes fileUpdatePulse {
    0%, 100% { 
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    }
    50% { 
        box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
    }
}

@keyframes updateIndicatorPop {
    0% { 
        transform: scale(0) rotate(-180deg);
        opacity: 0;
    }
    100% { 
        transform: scale(1) rotate(0deg);
        opacity: 1;
    }
}

.file-details {
    flex: 1;
    text-align: left;
}

.file-name {
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
    word-break: break-word;
}

.file-meta {
    font-size: 12px;
    color: var(--slate-500);
}

.remove-btn {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.remove-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.validation-alert {
    background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    font-weight: 600;
    display: none;
}

.validation-alert.show {
    display: block;
}

.validation-alert.error {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
}

.validation-alert.success {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
}

.validation-icon {
    font-size: 24px;
    margin-right: 10px;
}

.reports-content {
    padding: 20px 16px;
    max-width: 1200px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.9);
    min-height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    position: relative;
}

.pull-indicator {
    position: absolute;
    top: -50px;
    left: 0;
    right: 0;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    color: white;
    font-size: 14px;
    font-weight: 600;
    transition: transform 0.3s;
}

.report-summary {
    background: linear-gradient(135deg, #1e3a8a 0%, #6d28d9 100%);
    color: white;
    padding: 24px;
    border-radius: 16px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

.report-summary::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

.report-summary > * {
    position: relative;
    z-index: 1;
}

.summary-value {
    font-size: 32px;
    font-weight: 900;
}

.summary-meta {
    margin-top: 16px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.meta-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.meta-label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.meta-value {
    font-size: 16px;
    font-weight: 700;
}

.daily-results {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.results-header {
    background: var(--slate-50);
    padding: 12px 16px;
    border-bottom: 1px solid var(--slate-200);
    font-weight: 700;
    font-size: 14px;
    color: var(--primary);
}

.result-row {
    padding: 12px 16px;
    border-bottom: 1px solid var(--slate-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
}

.result-row:hover {
    background: linear-gradient(90deg, transparent 0%, var(--slate-50) 50%, transparent 100%);
}

.result-date {
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
    font-family: var(--font-mono);
}

.result-values {
    display: flex;
    gap: 16px;
    align-items: center;
}

.result-amount {
    font-family: var(--font-mono);
    font-weight: 700;
    font-size: 14px;
}

.result-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.badge-danger {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
    border: 1px solid rgba(220, 38, 38, 0.3);
}

.badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.settlement-section {
    padding: 16px;
    background: linear-gradient(180deg, var(--slate-50) 0%, white 100%);
}

.breakdown-details {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--slate-200);
    margin-bottom: 16px;
}

.breakdown-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--slate-200);
}

.breakdown-row:last-child {
    border-bottom: none;
}

.breakdown-label {
    font-size: 14px;
    color: var(--slate-600);
    font-weight: 500;
}

.breakdown-value {
    font-size: 15px;
    font-weight: 700;
    font-family: var(--font-mono);
    color: var(--primary);
}

.breakdown-row.total {
    border-top: 3px solid var(--primary);
    margin-top: 12px;
    padding-top: 12px;
}

.breakdown-row.total .breakdown-label {
    font-weight: 800;
    color: var(--primary);
    font-size: 16px;
}

.breakdown-row.total .breakdown-value {
    font-size: 20px;
    font-weight: 900;
    color: var(--accent);
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.history-item {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.history-item:active {
    transform: scale(0.98);
    border-color: var(--accent);
}

.history-date {
    font-size: 12px;
    color: var(--slate-500);
    margin-bottom: 4px;
}

.history-period {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.history-stats {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
}

.history-total {
    font-weight: 600;
    color: var(--accent);
    font-family: var(--font-mono);
}

/* Week-based history styles */
.week-group {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
}

.week-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: linear-gradient(135deg, var(--slate-50) 0%, var(--slate-100) 100%);
    border-bottom: 1px solid var(--slate-200);
    cursor: pointer;
}

.week-header:hover {
    background: linear-gradient(135deg, var(--slate-100) 0%, var(--slate-150) 100%);
}

.week-info .week-title {
    margin: 0 0 2px 0;
    font-size: 16px;
    font-weight: 700;
    color: var(--primary);
    cursor: pointer;
    transition: color 0.2s;
}

.week-info .week-title:hover {
    color: var(--accent);
    text-decoration: underline;
}

.week-dates {
    font-size: 12px;
    color: var(--slate-500);
}

.week-summary {
    display: flex;
    align-items: center;
    gap: 4px;
}

.week-stats {
    font-size: 12px;
    color: var(--slate-500);
}

.week-total {
    font-weight: 600;
    color: var(--accent);
    font-family: var(--font-mono);
    cursor: pointer;
    transition: all 0.2s;
    padding: 4px 8px;
    border-radius: 6px;
}

.week-total:hover {
    background: var(--accent);
    color: white;
    transform: scale(1.05);
}

.week-toggle {
    transition: transform 0.2s;
}

.week-header.expanded .week-toggle {
    transform: rotate(180deg);
}

.week-days {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 12px 16px 16px 16px;
}

/* Month group styles */
.month-group {
    margin-bottom: 24px;
}

.month-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
    color: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 12px;
}

.month-header:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.month-info .month-title {
    margin: 0 0 4px 0;
    font-size: 18px;
    font-weight: 700;
}

.month-stats {
    font-size: 12px;
    opacity: 0.8;
}

.month-summary {
    display: flex;
    align-items: center;
    gap: 12px;
}

.month-total {
    font-weight: 600;
    font-family: var(--font-mono);
    font-size: 16px;
}

.month-toggle {
    transition: transform 0.2s;
}

.month-header.expanded .month-toggle {
    transform: rotate(180deg);
}

.month-content {
    padding: 0 12px;
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}

.settings-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.settings-section {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.settings-header {
    background: var(--slate-50);
    padding: 12px 16px;
    border-bottom: 1px solid var(--slate-200);
    font-weight: 700;
    font-size: 14px;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.settings-body {
    padding: 16px;
}

.setting-field {
    margin-bottom: 16px;
}

.setting-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--slate-700);
    margin-bottom: 8px;
    display: block;
}

.setting-input {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--slate-200);
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    font-family: var(--font-mono);
    transition: all 0.2s;
    background: white;
}

.setting-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.setting-description {
    font-size: 11px;
    color: var(--slate-500);
    margin-top: 4px;
}

.settings-actions {
    padding: 16px;
    border-top: 1px solid var(--slate-200);
    display: flex;
    gap: 12px;
}

.btn-primary {
    flex: 1;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.btn-secondary {
    flex: 1;
    background: var(--slate-200);
    color: var(--slate-700);
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: var(--slate-300);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
}

.btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

.storage-info {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    border: 1px solid #0284c7;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
}

.storage-info-title {
    font-size: 13px;
    font-weight: 700;
    color: #0c4a6e;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.storage-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 12px;
}

.storage-stat {
    display: flex;
    flex-direction: column;
}

.storage-stat-label {
    font-size: 11px;
    color: #075985;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.storage-stat-value {
    font-size: 18px;
    font-weight: 800;
    color: #0c4a6e;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
}

.empty-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.empty-message {
    font-size: 14px;
    color: var(--slate-500);
    margin-bottom: 24px;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.loading-card {
    background: white;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    text-align: center;
    min-width: 280px;
}


@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 12px;
}

.loading-progress {
    background: var(--slate-200);
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 16px;
}

.loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dark) 100%);
    transition: width 0.3s;
}

/* Manual Entry Modal Styles */
.manual-entry-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 2500;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.manual-entry-overlay.show {
    display: flex;
}

.manual-entry-modal {
    background: white;
    border-radius: 16px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--slate-200);
}

.modal-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
}

.modal-icon {
    font-size: 20px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--slate-400);
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--slate-100);
    color: var(--slate-600);
}

.modal-body {
    padding: 0 24px;
    max-height: 60vh;
    overflow-y: auto;
}

.manual-entry-form {
    padding: 20px 0;
}

.form-section {
    margin-bottom: 32px;
}

.form-section:last-child {
    margin-bottom: 0;
}

.form-section-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-section-title::before {
    content: '';
    width: 4px;
    height: 16px;
    background: var(--accent);
    border-radius: 2px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
}

.form-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.form-field.full-width {
    grid-column: 1 / -1;
}

.form-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--slate-700);
}

.form-input {
    padding: 12px 16px;
    border: 2px solid var(--slate-200);
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s;
    background: white;
}

.form-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input[readonly] {
    background: var(--slate-50);
    color: var(--slate-600);
}

.form-help {
    font-size: 12px;
    color: var(--slate-500);
    font-style: italic;
}

.modal-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--slate-200);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
}


.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

@media (max-width: 768px) {
    .manual-entry-modal {
        margin: 10px;
        max-height: calc(100vh - 20px);
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .modal-footer {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}

/* Enhanced Toast with all production features */
.toast {
    position: fixed;
    bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 20px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(17, 24, 39, 0.95);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    z-index: 3000;
    display: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: calc(100% - 32px);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    animation: toastSlideUp 0.3s ease;
}

.toast.show {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toast::before {
    content: '';
    font-size: 16px;
}

.toast.success { 
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.35);
}
.toast.success::before { content: '✅'; }

.toast.warn { 
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
    box-shadow: 0 10px 30px rgba(245, 158, 11, 0.35);
}
.toast.warn::before { content: '⚠️'; }

.toast.error { 
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.95), rgba(185, 28, 28, 0.95));
    box-shadow: 0 10px 30px rgba(220, 38, 38, 0.35);
}
.toast.error::before { content: '❌'; }

@keyframes toastSlideUp {
    0% { 
        transform: translate(-50%, 100%); 
        opacity: 0; 
    }
    100% { 
        transform: translate(-50%, 0); 
        opacity: 1; 
    }
}

@media (min-width: 768px) {
    .app-container {
        max-width: 768px;
        margin: 0 auto;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
    }
    
    .bottom-nav {
        max-width: 768px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .kpi-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .summary-stats {
        grid-template-columns: repeat(4, 1fr);
    }
}

/* OPTIMIZED PRINT STYLES - A4 SINGLE PAGE */
@media print {
    @page {
        size: A4;
        margin: 10mm;
    }

    /* Global print resets */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* Base typography for print */
    body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        font-size: 10pt !important;
        line-height: 1.4 !important;
        color: black !important;
        font-family: Georgia, 'Times New Roman', serif !important;
    }

    /* Hide non-print elements */
    .upload-section,
    .loading-overlay,
    .modal-overlay,
    .validation-alert,
    .settings-btn,
    .remove-btn,
    .report-actions,
    .print-btn,
    .print-helper-text,
    .logo-mark,
    .company-header,
    .meta-badge,
    .recovery-banner,
    .state-actions,
    /* Hide RATE column (4th) AND STATUS column (11th) in print */
    thead th:nth-child(4),
    tbody td:nth-child(4),
    tfoot td:nth-child(4),
    thead th:nth-child(11),
    tbody td:nth-child(11),
    tfoot td:nth-child(11) {
        display: none !important;
    }

    /* Document container */
    .document {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        background: white !important;
    }

    /* Report header - keep original design but optimize space */
    .report-header {
        background: #f5f5f5 !important;
        color: black !important;
        padding: 12pt !important;
        border: 1pt solid #333 !important;
        margin-bottom: 10pt !important;
        page-break-after: avoid;
    }

    .report-header::before {
        display: none !important;
    }

    .report-title {
        font-size: 16pt !important;
        color: black !important;
        text-shadow: none !important;
        margin-bottom: 6pt !important;
        font-weight: 900 !important;
        text-align: center !important;
        font-family: Georgia, serif !important;
    }

    .report-subtitle {
        font-size: 11pt !important;
        color: #444 !important;
        margin-bottom: 10pt !important;
        text-align: center !important;
        font-weight: 600 !important;
        font-family: Verdana, Arial, sans-serif !important;
    }

    .report-metadata {
        background: white !important;
        border: 0.5pt solid #666 !important;
        padding: 6pt !important;
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 0 !important;
    }

    .metadata-item {
        text-align: center !important;
        border-right: 0.5pt solid #ddd !important;
        padding: 0 4pt !important;
    }

    .metadata-item:last-child {
        border-right: none !important;
    }

    .metadata-label {
        font-size: 7pt !important;
        color: #666 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.3pt !important;
        font-weight: 600 !important;
        font-family: Verdana, Arial, sans-serif !important;
        margin-bottom: 2pt !important;
    }

    .metadata-value {
        font-size: 9pt !important;
        color: black !important;
        font-weight: 700 !important;
        font-family: Georgia, serif !important;
    }

    /* KPI section */
    .kpi-section {
        background: white !important;
        padding: 0 !important;
        margin-bottom: 10pt !important;
        page-break-inside: auto;
    }

    .section-header {
        margin-bottom: 6pt !important;
        page-break-after: avoid;
        border-bottom: 1pt solid #333 !important;
        padding-bottom: 3pt !important;
    }

    .section-header::after {
        display: none !important;
    }

    .section-number {
        background: black !important;
        color: white !important;
        width: 18pt !important;
        height: 18pt !important;
        font-size: 9pt !important;
        box-shadow: none !important;
        margin-right: 6pt !important;
        font-weight: bold !important;
    }

    .section-title {
        font-size: 11pt !important;
        color: black !important;
        font-weight: 800 !important;
        font-family: Verdana, Arial, sans-serif !important;
    }

    /* KPI cards - max 5 in single row */
    .kpi-grid {
        display: grid !important;
        grid-template-columns: repeat(5, 1fr) !important;
        gap: 6pt !important;
        margin-bottom: 10pt !important;
    }

    .kpi-card {
        background: white !important;
        border: 1pt solid #666 !important;
        padding: 6pt !important;
        box-shadow: none !important;
        page-break-inside: avoid;
        min-height: 45pt !important;
    }

    .kpi-card:nth-child(n+6) {
        display: none !important;
    }

    .kpi-card.primary {
        border: 1pt solid black !important;
        background: #fafafa !important;
    }

    .kpi-card.success {
        border: 1pt solid black !important;
        background: #fafafa !important;
    }

    .kpi-card.danger {
        border: 1pt solid black !important;
        background: #f5f5f5 !important;
    }

    .kpi-card#differenceCard.success {
        border: 1pt solid black !important;
        background: #fafafa !important;
    }

    .kpi-card#differenceCard.danger {
        border: 1pt solid black !important;
        background: #f5f5f5 !important;
    }

    .kpi-label {
        font-size: 6pt !important;
        color: #555 !important;
        margin-bottom: 2pt !important;
        text-transform: uppercase !important;
        letter-spacing: 0.2pt !important;
        font-weight: 700 !important;
        line-height: 1.1 !important;
        font-family: Verdana, Arial, sans-serif !important;
    }

    .kpi-value {
        font-size: 12pt !important;
        color: black !important;
        margin-bottom: 2pt !important;
        font-weight: 900 !important;
        line-height: 1 !important;
        font-family: Georgia, serif !important;
        font-variant-numeric: tabular-nums !important;
    }

    .kpi-change {
        font-size: 6pt !important;
        color: #555 !important;
        line-height: 1.1 !important;
        font-family: Verdana, Arial, sans-serif !important;
    }

    /* Table section */
    .table-section {
        background: white !important;
        padding: 0 !important;
        margin-bottom: 10pt !important;
    }

    .table-wrapper {
        border: 0.75pt solid black !important;
        box-shadow: none !important;
        margin-top: 6pt !important;
        overflow: visible !important;
    }

    table {
        width: 100% !important;
        font-size: 8pt !important;
        table-layout: fixed !important;
        border-collapse: collapse !important;
        font-family: Verdana, Arial, sans-serif !important;
    }

    /* Column widths optimized (RATE and STATUS columns hidden) - 9 visible columns */
    colgroup {
        display: table-column-group !important;
    }
    
    col:nth-child(4),
    col:nth-child(11) {
        display: none !important;
        width: 0 !important;
    }
    
    /* Apply consistent widths and borders to all rows */
    thead th:nth-child(1),
    tbody td:nth-child(1),
    tfoot td:nth-child(1) { width: 12% !important; }
    
    thead th:nth-child(2),
    tbody td:nth-child(2),
    tfoot td:nth-child(2) { width: 10% !important; }
    
    thead th:nth-child(3),
    tbody td:nth-child(3),
    tfoot td:nth-child(3) { width: 14% !important; }
    
    thead th:nth-child(5),
    tbody td:nth-child(5),
    tfoot td:nth-child(5) { width: 12% !important; }
    
    thead th:nth-child(6),
    tbody td:nth-child(6),
    tfoot td:nth-child(6) { width: 13% !important; }
    
    thead th:nth-child(7),
    tbody td:nth-child(7),
    tfoot td:nth-child(7) { 
        width: 11% !important;
        border-right: 1pt solid #333 !important;
    }
    
    thead th:nth-child(8),
    tbody td:nth-child(8),
    tfoot td:nth-child(8) { width: 13% !important; }
    
    thead th:nth-child(9),
    tbody td:nth-child(9),
    tfoot td:nth-child(9) { 
        width: 12% !important;
        border-right: 1pt solid #333 !important;
    }
    
    thead th:nth-child(10),
    tbody td:nth-child(10),
    tfoot td:nth-child(10) { width: 13% !important; }

    thead {
        background: #e8e8e8 !important;
        display: table-header-group !important;
    }

    thead th {
        background: #e8e8e8 !important;
        color: black !important;
        font-size: 7pt !important;
        padding: 4pt 2pt !important;
        border-bottom: 0.75pt solid black !important;
        border-right: 0.5pt solid #ccc !important;
        font-weight: 800 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.2pt !important;
        line-height: 1.2 !important;
        vertical-align: middle !important;
        font-family: Verdana, Arial, sans-serif !important;
        text-align: center !important;
        white-space: normal !important;
        word-break: normal !important;
    }

    thead th:nth-child(3) {
        font-size: 6.5pt !important;
        letter-spacing: 0.1pt !important;
        padding: 4pt 1pt !important;
    }

    thead th.text-right {
        text-align: right !important;
    }

    tbody tr:hover {
        background: transparent !important;
    }

    tbody td {
        padding: 3pt 2pt !important;
        font-size: 7.5pt !important;
        color: black !important;
        border-right: 0.5pt solid #e8e8e8 !important;
        vertical-align: middle !important;
        line-height: 1.2 !important;
        font-family: Verdana, Arial, sans-serif !important;
        text-align: center !important;
        font-weight: normal !important;
    }

    tbody td:nth-child(7) {
        border-right: 1pt solid #ccc !important;
    }

    tbody td:nth-child(1) {
        font-weight: normal !important;
    }
    
    tbody td:nth-child(1) .cell-date {
        font-weight: normal !important;
    }

    .cell-currency {
        font-size: 8pt !important;
        color: black !important;
        font-weight: normal !important;
        text-align: right !important;
        padding-right: 3pt !important;
        font-family: Georgia, serif !important;
        font-variant-numeric: tabular-nums !important;
    }

    tbody td:nth-child(10) {
        font-weight: 700 !important;
        font-size: 8pt !important;
    }
    
    tbody td:nth-child(10) .cell-currency {
        font-weight: 700 !important;
        font-size: 8pt !important;
    }

    .cell-date {
        font-size: 7.5pt !important;
        color: black !important;
        font-weight: normal !important;
        font-family: Georgia, serif !important;
    }

    .cell-day {
        color: #444 !important;
        font-size: 7pt !important;
        font-weight: normal !important;
    }

    .cell-number {
        font-size: 8pt !important;
        color: black !important;
        font-weight: normal !important;
        font-variant-numeric: tabular-nums !important;
    }

    tfoot {
        background: #333 !important;
        color: white !important;
        display: table-footer-group !important;
        page-break-inside: avoid;
    }

    tfoot td {
        padding: 4pt 3pt !important;
        font-size: 8pt !important;
        font-weight: 800 !important;
        border-top: 1pt solid black !important;
        border-right: 0.5pt solid #555 !important;
        color: white !important;
        display: table-cell !important;
        visibility: visible !important;
    }
    
    tfoot td:nth-child(4) {
        display: none !important;
    }
    
    tfoot td:nth-child(11) {
        display: none !important;
    }

    tfoot td:first-child {
        padding-left: 5pt !important;
        text-align: left !important;
        font-weight: 900 !important;
    }

    tfoot td:nth-child(3) {
        display: table-cell !important;
        text-align: center !important;
        font-weight: 900 !important;
        font-size: 9pt !important;
    }

    tfoot .cell-currency {
        font-size: 9pt !important;
        color: white !important;
        font-weight: 800 !important;
        text-align: right !important;
        font-family: Georgia, serif !important;
        font-variant-numeric: tabular-nums !important;
    }

    #footerBase {
        display: table-cell !important;
        visibility: visible !important;
    }

    /* Settlement section */
    .settlement-section {
        background: white !important;
        padding: 0 !important;
        page-break-inside: auto;
        margin-bottom: 10pt !important;
    }

    .settlement-grid {
        display: grid !important;
        grid-template-columns: 65% 35% !important;
        gap: 8pt !important;
        width: 100% !important;
    }

    .breakdown-details {
        background: white !important;
        border: 0.75pt solid black !important;
        padding: 6pt !important;
        width: 100% !important;
    }

    .breakdown-row {
        padding: 2pt 0 !important;
        border-bottom: 0.5pt solid #ddd !important;
        display: flex !important;
        justify-content: space-between !important;
    }

    .breakdown-row:last-child {
        border-bottom: none !important;
    }

    .breakdown-label {
        font-size: 7pt !important;
        color: #333 !important;
        font-weight: 600 !important;
        font-family: Verdana, Arial, sans-serif !important;
    }

    .breakdown-value {
        font-size: 8.5pt !important;
        color: black !important;
        font-weight: 700 !important;
        font-family: Georgia, serif !important;
        font-variant-numeric: tabular-nums !important;
    }

    .breakdown-row.total {
        border-top: 1pt solid black !important;
        margin-top: 3pt !important;
        padding-top: 3pt !important;
    }

    .breakdown-row.total .breakdown-label {
        font-size: 10pt !important;
        color: black !important;
        font-weight: 900 !important;
    }

    .payment-status {
        background: white !important;
        color: black !important;
        border: none !important;
        border-top: 1.5pt solid black !important;
        border-right: 1.5pt solid black !important;
        border-bottom: 1.5pt solid black !important;
        border-left: 1.5pt solid black !important;
        padding: 8pt !important;
        box-shadow: none !important;
        text-align: center !important;
        min-height: 70pt !important;
        display: block !important;
        position: relative !important;
        box-sizing: border-box !important;
    }

    .payment-status.positive {
        border: none !important;
        border-top: 2pt double black !important;
        border-right: 2pt double black !important;
        border-bottom: 2pt double black !important;
        border-left: 2pt double black !important;
        background: #fafafa !important;
    }

    .status-icon {
        font-size: 16pt !important;
        margin-bottom: 3pt !important;
        line-height: 1 !important;
        display: block !important;
        position: relative !important;
        z-index: 2 !important;
    }

    .status-label {
        font-size: 6pt !important;
        color: #555 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.3pt !important;
        font-weight: 700 !important;
        margin-bottom: 2pt !important;
        font-family: Verdana, Arial, sans-serif !important;
        position: relative !important;
        z-index: 2 !important;
    }

    .status-value {
        font-size: 12pt !important;
        color: black !important;
        font-weight: 900 !important;
        font-family: Georgia, serif !important;
        position: relative !important;
        z-index: 2 !important;
        font-variant-numeric: tabular-nums !important;
    }

    /* Hide non-printable elements */
    .bottom-nav,
    .page-header,
    .header-btn,
    .action-btn,
    .remove-btn,
    .view-toggle,
    .calendar-widget,
    .forecast-card,
    .quick-actions,
    .empty-state,
    .upload-section,
    .loading-overlay,
    .toast,
    .recovery-banner,
    .validation-alert,
    .pull-indicator {
        display: none !important;
    }

    .page {
        padding: 0 !important;
        display: block !important;
    }
}

.hidden { display: none !important; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }

.with-prefix {
    position: relative;
}

.with-prefix .currency-prefix {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    font-weight: 600;
    color: var(--slate-600);
    pointer-events: none;
    font-family: var(--font-mono);
}

.with-prefix .setting-input {
    padding-left: 36px;
}

.file-input {
    display: none;
}

@media (max-width: 768px) {
    .modal {
        width: calc(100% - 16px);
        margin: 8px;
    }
    
    .recovery-banner {
        width: calc(100% - 20px);
        left: 10px;
        transform: none;
        border-radius: 12px;
    }
}

/* === Enhanced Upload Area Styles === */
.upload-area.enhanced-upload {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px dashed var(--slate-300);
    border-radius: 16px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.upload-area.enhanced-upload:hover {
    border-color: var(--accent);
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.08);
}

.upload-area.enhanced-upload.dragging {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.05);
    border-width: 3px;
}


.upload-formats {
    font-size: 0.75rem;
    color: var(--slate-400);
    margin-top: 8px;
}

/* === Enhanced File List === */
.file-list.enhanced-file-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 24px;
}

.file-list.enhanced-file-list .file-item {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.file-list.enhanced-file-list .file-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-color: var(--accent);
}

.file-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: var(--slate-100);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.file-type-badge.runsheet {
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent);
}

.file-type-badge.invoice {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.file-update-badge {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
    color: white;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    animation: updateBadgePulse 2s ease-in-out infinite;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
}

@keyframes updateBadgePulse {
    0%, 100% { 
        opacity: 1;
        transform: scale(1);
    }
    50% { 
        opacity: 0.8;
        transform: scale(0.98);
    }
}

/* === Analysis Preview === */
.analysis-preview {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 12px;
    padding: 20px;
    margin-top: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid var(--slate-200);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.preview-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
}

.preview-item {
    padding: 12px;
    background: var(--slate-50);
    border-radius: 8px;
    text-align: center;
}

.preview-label {
    font-size: 0.75rem;
    color: var(--slate-500);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.preview-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary);
}

/* === Enhanced Action Button === */
.action-btn.enhanced-action-btn {
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 32px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.action-btn.enhanced-action-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn-icon, .btn-text {
    transition: opacity 0.3s ease;
}


.action-btn.loading .btn-icon,
.action-btn.loading .btn-text {
    opacity: 0;
}

/* === Enhanced Report Header === */
.report-header.enhanced-header {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: white;
    padding: 32px 24px;
    border-radius: 16px;
    margin-bottom: 32px;
    position: relative;
    overflow: hidden;
}

.report-header.enhanced-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
        opacity: 0.5; 
    }
    50% { 
        transform: scale(1.1); 
        opacity: 0.8; 
    }
}

.report-header-content {
    position: relative;
    z-index: 1;
}

.report-company {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.report-title {
    font-size: 1rem;
    font-weight: 400;
    opacity: 0.9;
    margin-bottom: 24px;
}

.report-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
}

.report-meta-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.report-meta-label {
    font-size: 0.75rem;
    opacity: 0.7;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.report-meta-value {
    font-size: 1rem;
    font-weight: 600;
}

/* === Enhanced KPI Dashboard === */
.kpi-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.kpi-card:hover::before {
    width: 8px;
}

.kpi-card.kpi-primary::before {
    background: var(--accent);
}

.kpi-card.kpi-secondary::before {
    background: var(--slate-400);
}

.kpi-title {
    font-size: 0.875rem;
    color: var(--slate-600);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.kpi-icon svg {
    width: 20px;
    height: 20px;
    stroke: var(--accent);
}

.kpi-subtitle {
    font-size: 0.75rem;
    color: var(--slate-500);
}

.kpi-trend.positive {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.kpi-trend.negative {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
}

/* === Comprehensive Data Table === */
.table-section {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 32px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid var(--slate-200);
}

.table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.table-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    margin: 0;
}

.table-actions {
    display: flex;
    gap: 12px;
}

.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -24px;
    padding: 0 24px;
}

.data-table {
    width: 100%;
    min-width: 900px;
    border-collapse: separate;
    border-spacing: 0;
}

.data-table thead {
    background: var(--slate-50);
}

.data-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.75rem;
    color: var(--slate-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--slate-200);
    white-space: nowrap;
    position: sticky;
    top: 0;
    background: var(--slate-50);
    z-index: 10;
}

.data-table td {
    padding: 16px 12px;
    font-size: 0.875rem;
    color: var(--slate-700);
    border-bottom: 1px solid var(--slate-100);
    white-space: nowrap;
}

.data-table tbody tr {
    transition: background 0.2s ease;
}

.data-table tbody tr:hover {
    background: var(--slate-50);
}

.data-table .date-cell {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
}

.data-table .amount-cell {
    font-family: var(--font-mono);
    font-weight: 600;
    text-align: right;
}

.data-table .amount-cell.positive {
    color: var(--success);
}

.data-table .amount-cell.negative {
    color: var(--danger);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s ease;
}

.status-badge:hover {
    opacity: 0.8;
}

.status-badge.reconciled {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.status-badge.pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.status-badge.error {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
}

/* === Settlement Breakdown === */
.settlement-breakdown {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px;
    padding: 24px;
    margin-top: 32px;
    border: 1px solid var(--slate-200);
}

.breakdown-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 20px;
}

.breakdown-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.breakdown-item {
    background: white;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.breakdown-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

.breakdown-item.breakdown-total {
    background: var(--primary);
    color: white;
}

.breakdown-item.breakdown-total .breakdown-label,
.breakdown-item.breakdown-total .breakdown-value {
    color: white;
}


/* === PRINT-ONLY FIX v6.0.0 ===
   Scope: Daily table footer alignment (hide RATE/STATUS correctly in TFOOT);
          Payment Status border parity + centered text.
   Runtime UI untouched.
*/
@media print {
  /* Footer alignment when RATE (4) and STATUS (11) are hidden in THEAD/TBODY */
  .table-section thead th:nth-child(4),
  .table-section tbody td:nth-child(4) { display: none !important; }
  .table-section thead th:nth-child(11),
  .table-section tbody td:nth-child(11) { display: none !important; }

  /* TFOOT mapping (first cell has colspan=2):
     cells index => [1:TOTALS(colspan=2), 2:Consignments, 3:RATE placeholder, 4:Base, 5:Pickups, 6:Bonuses, 7:Expected, 8:Paid, 9:Difference, 10:STATUS placeholder] */
  .table-section tfoot td { display: table-cell !important; }
  .table-section tfoot td:nth-child(3)  { display: none !important; }
  .table-section tfoot td:nth-child(10) { display: none !important; }

  /* Payment Status — make border match breakdown-details and center contents */
  .payment-status {
    background: #fff !important;
    color: #111 !important;
    border: 1px solid var(--slate-200) !important;
    border-radius: 16px !important;
    box-shadow: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
    padding: 35px !important;
  }
}

/* === Enhanced Onboarding Styles === */
.onboarding-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;   
    text-align: center;
    animation: fadeInUp 0.8s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Welcome Hero Section */
.welcome-hero {
    margin-top: 240px;
    margin-bottom: 60px;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-20px);
    }
}

.welcome-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 16px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: slideInFromTop 0.8s ease-out;
}

@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.welcome-subtitle {
    font-size: 1.125rem;
    color: var(--slate-600);
    line-height: 1.6;
    animation: slideInFromBottom 0.8s ease-out 0.2s both;
}

@keyframes slideInFromBottom {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}


/* Quick Start Steps */
.quick-start-section {
    margin-bottom: 60px;
}

.steps-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 32px;
    margin-top: 40px;
}

.step-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 32px 24px;
    position: relative;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: slideInFromLeft 0.6s ease-out;
    animation-fill-mode: both;
}

.step-card:nth-child(1) { animation-delay: 0.1s; }
.step-card:nth-child(2) { animation-delay: 0.2s; }
.step-card:nth-child(3) { animation-delay: 0.3s; }

@keyframes slideInFromLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.step-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
}

.step-number {
    position: absolute;
    top: -16px;
    left: 24px;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.step-icon {
    font-size: 40px;
    margin-bottom: 20px;
}

.step-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 12px;
}

.step-description {
    color: var(--slate-600);
    line-height: 1.6;
}

/* Features Section */
.features-section {
    margin-bottom: 60px;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 24px;
    margin-top: 40px;
}

.feature-card {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    animation: fadeIn 0.6s ease-out;
    animation-fill-mode: both;
}

.feature-card:nth-child(1) { animation-delay: 0.1s; }
.feature-card:nth-child(2) { animation-delay: 0.2s; }
.feature-card:nth-child(3) { animation-delay: 0.3s; }
.feature-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.feature-card:hover {
    border-color: var(--accent);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.feature-icon {
    font-size: 32px;
    margin-bottom: 16px;
}

.feature-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 8px;
}

.feature-description {
    font-size: 0.875rem;
    color: var(--slate-600);
    line-height: 1.5;
}

/* Call to Action Section */
.cta-section {
    margin-bottom: 50px;
}

.cta-buttons {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 16px;
}

.primary-cta-btn {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 18px 36px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    position: relative;
    overflow: hidden;
    margin-bottom: 16px;
}

.primary-cta-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.primary-cta-btn:hover::before {
    left: 100%;
}

.primary-cta-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
}

.primary-cta-btn:active {
    transform: translateY(-1px);
}

.btn-icon {
    font-size: 1.25rem;
}

.btn-arrow {
    font-size: 1.125rem;
    transition: transform 0.3s ease;
}

.primary-cta-btn:hover .btn-arrow {
    transform: translateX(4px);
}


.cta-note {
    font-size: 0.875rem;
    color: var(--slate-500);
    margin-top: 12px;
}

/* Tips Section */
.tips-section {
    background: linear-gradient(135deg, var(--slate-50) 0%, var(--slate-100) 100%);
    border-radius: 20px;
    padding: 32px;
    border: 1px solid var(--slate-200);
}

.tips-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 24px;
    text-align: center;
}

.tips-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    text-align: left;
}

.tip-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--slate-200);
    transition: all 0.3s ease;
}

.tip-item:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.tip-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
    margin-top: 2px;
}

.tip-text {
    color: var(--slate-700);
    line-height: 1.5;
    font-size: 0.875rem;
}

/* === Mobile Optimizations === */
@media (max-width: 640px) {
    .onboarding-container {
        padding: 20px 16px;
    }
    
    .reports-header {
        padding: 16px;
        box-shadow: 0 2px 12px rgba(16, 185, 129, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
    }
    
    .welcome-title {
        font-size: 2rem;
    }
    
    .welcome-subtitle {
        font-size: 1rem;
    }
    
    .floating-icon.delay-1 {
        left: -40px;
    }
    
    .floating-icon.delay-2 {
        right: -40px;
    }
    
    .steps-container {
        grid-template-columns: 1fr;
        gap: 24px;
    }
    
    .features-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    
    .feature-card {
        padding: 20px 16px;
    }
    
    .cta-buttons {
        flex-direction: column;
        gap: 12px;
    }
    
    .primary-cta-btn {
        font-size: 1rem;
        padding: 16px 32px;
        width: 100%;
        justify-content: center;
    }
    
    .tips-list {
        gap: 12px;
    }
    
    .tip-item {
        padding: 12px;
    }
    
    .report-header.enhanced-header {
        padding: 24px 16px;
    }
     
    .kpi-dashboard {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .kpi-value {
        font-size: 1.75rem;
    }
    
    .table-wrapper {
        margin: 0 -16px;
        padding: 0 16px;
    }
    
    .data-table {
        font-size: 0.75rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 12px 8px;
    }
    
    .breakdown-grid {
        grid-template-columns: 1fr;
    }
}

/* === Enhanced Analysis Page Styles === */
.analysis-header {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-bottom: 3px solid var(--accent);
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
    position: relative;
    overflow: hidden;
}

.analysis-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(90deg, 
        rgba(59, 130, 246, 0.05) 0%, 
        rgba(59, 130, 246, 0.02) 50%, 
        rgba(59, 130, 246, 0.05) 100%);
    z-index: 0;
}

.analysis-header .page-header-content {
    position: relative;
    z-index: 1;
}

.title-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    border-radius: 8px;
    margin-right: 12px;
}

.clear-btn {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
    border: 1px solid rgba(220, 38, 38, 0.2);
    transition: all 0.3s ease;
}

.clear-btn:hover {
    background: var(--danger);
    color: white;
    transform: scale(1.05);
}

.analysis-container {
    padding: 20px 16px;
    max-width: 900px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.9);
    min-height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    position: relative;
}

.analysis-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 600px;
    height: 2px;
    background: linear-gradient(90deg, 
        transparent 0%, 
        var(--accent) 20%, 
        var(--accent) 80%, 
        transparent 100%);
    opacity: 0.6;
}

/* Progress Steps - Mobile First */
.analysis-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 32px;
    padding: 16px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 12px;
    border: 1px solid var(--slate-200);
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0.5;
    transition: all 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step.completed {
    opacity: 1;
}

.step-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--slate-200);
    color: var(--slate-500);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.75rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.step-circle:hover {
    background: var(--slate-300);
    transform: scale(1.05);
}

.step.active .step-circle {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.step.active .step-circle:hover {
    background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent) 100%);
    transform: scale(1.05);
}

.step.completed .step-circle {
    background: var(--success);
    color: white;
}

.step.completed .step-circle:hover {
    background: #059669;
    transform: scale(1.05);
}

.step-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--slate-600);
    text-align: center;
}

.step.active .step-label {
    color: var(--primary);
    font-weight: 600;
}

.step-connector {
    width: 40px;
    height: 2px;
    background: var(--slate-200);
    margin: 0 12px;
}


/* Upload Section Enhanced */
.upload-section-enhanced {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Manual Entries Display in Step 2 */
.manual-entries-display {
    margin: 24px 0;
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 20px;
}

.entries-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.entries-title::before {
    content: "📊";
    font-size: 1rem;
}

#manualEntriesListStep2 {
    max-height: 300px;
    overflow-y: auto;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
    position: relative;
    padding-bottom: 20px;
}

#manualEntriesListStep2::-webkit-scrollbar {
    display: none; /* Chrome, Safari and Opera */
}

/* Scroll indicator dots - only visible when there's more content below */
#manualEntriesListStep2::after {
    content: "• • •";
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    color: var(--accent);
    font-size: 12px;
    letter-spacing: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

/* Show dots when content is scrollable and not at bottom */
#manualEntriesListStep2.has-more-content::after {
    opacity: 0.7;
}

/* Step 2 Entry Cards - Professional Enhancement */
.step2-entry-card {
    background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 14px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    width: 100%;
    box-sizing: border-box;
    min-width: 280px;
    display: block;
    border-left: 3px solid transparent;
}

.step2-entry-card:hover {
    border-color: var(--accent);
    border-left-color: var(--accent);
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.08), 0 2px 8px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
}


.step2-entry-card:active {
    transform: translateY(0);
}

.entry-card-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 12px;
    width: 100%;
    flex-direction: row !important;
    flex-wrap: nowrap !important;
}

/* Removed old day styles - using new card-header styles */

.entry-total {
    font-weight: 700;
    color: var(--success);
    font-size: 1.1rem;
    text-align: right;
    display: inline-block;
}

.entry-card-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}
/* Professional Card Layout */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--slate-100);
}

.date-info {
    flex-grow: 1;
}

.day-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--slate-800);
    margin: 0 0 4px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.day-date {
    font-size: 0.85rem;
    color: var(--slate-500);
    margin: 0;
    font-weight: 500;
}

/* Enhanced Status Badges for Cards */
.status-badge.positive {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 1px solid #10b981;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
}

.status-badge.negative {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border: 1px solid #ef4444;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
}

.total-badge {
    padding: 6px 12px;
    background: var(--slate-100);
    border-radius: 6px;
    border: 1px solid var(--slate-200);
}

.total-amount {
    font-weight: 700;
    color: var(--slate-700);
    font-size: 0.9rem;
}

.main-amounts {
    margin-bottom: 16px;
}

.amount-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--slate-50);
}

.amount-row:last-child {
    border-bottom: none;
}

.amount-row.bonus-row {
    background: rgba(59, 130, 246, 0.03);
    margin: 0 -8px;
    padding: 8px;
    border-radius: 6px;
    border: none;
}

.amount-label {
    font-size: 0.85rem;
    color: var(--slate-600);
    font-weight: 500;
}

.amount-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--slate-800);
}

/* Breakdown Section */
.breakdown-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--slate-100);
}

/* Card-specific breakdown styles */
.step2-entry-card .breakdown-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--slate-700);
    margin: 0 0 12px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.step2-entry-card .breakdown-grid {
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.step2-entry-card .breakdown-item {
    padding: 6px 10px;
    background: var(--slate-25);
    border-radius: 6px;
    border: 1px solid var(--slate-100);
}

.item-label {
    font-size: 0.75rem;
    color: var(--slate-500);
    font-weight: 500;
}

.item-value {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--slate-700);
}

.entry-detail {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: var(--slate-600);
}

.detail-icon {
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

.detail-text {
    font-weight: 500;
}

.entry-edit-indicator {
    display: none;
}

.no-entries-message {
    text-align: center;
    color: var(--slate-500);
    font-style: italic;
    padding: 24px;
    background: var(--slate-50);
    border-radius: 8px;
    margin: 0;
}

/* Step 3 Analysis Results Styles */
.week-data-summary {
    margin: 24px 0;
    padding: 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border: 1px solid var(--slate-200);
    border-radius: 12px;
}

.analysis-summary {
    margin: 24px 0;
    padding: 20px;
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
}

.summary-title-stp3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.summary-title-stp3::before {
    content: "📈";
    font-size: 1rem;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
}

.summary-card-simple {
    background: var(--slate-50);
    border: 1px solid var(--slate-200);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    transition: all 0.2s ease;
}

.summary-card-simple:hover {
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
}

.summary-card-simple .card-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
}

.summary-card-simple .card-label {
    font-size: 0.875rem;
    color: var(--slate-600);
    font-weight: 500;
}

.empty-analysis-state {
    text-align: center;
    padding: 48px 24px;
}

.empty-analysis-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-analysis-message {
    color: var(--slate-500);
    margin-bottom: 24px;
    font-size: 1rem;
}

/* Mobile responsive for Step 3 */
@media (max-width: 640px) {
    .summary-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .week-data-summary,
    .analysis-summary {
        margin: 16px 0;
        padding: 16px;
    }
    
    .summary-card-simple {
        padding: 12px;
    }
    
    .summary-card-simple .card-value {
        font-size: 1.125rem;
    }
}

/* Enhanced Week Summary Styles */
.week-empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--slate-500);
}

.week-empty-icon {
    font-size: 2.5rem;
    margin-bottom: 12px;
    opacity: 0.6;
}

.week-empty-message {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 4px;
}

.week-empty-subtitle {
    font-size: 0.875rem;
    margin: 0;
}

.week-summary-enhanced {
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.week-stats-header {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    background: var(--slate-200);
    margin-bottom: 16px;
}

.week-stat {
    background: white;
    padding: 16px;
    text-align: center;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--slate-600);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.week-daily-breakdown {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}

.summary-item-enhanced {
    background: var(--slate-50);
    border: 1px solid var(--slate-200);
    border-radius: 6px;
    padding: 12px;
    transition: all 0.2s ease;
}

.summary-item-enhanced:hover {
    border-color: var(--accent);
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
}

.summary-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.summary-date-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.summary-day-name {
    font-weight: 600;
    color: var(--primary);
    font-size: 0.9rem;
}

.summary-day-type {
    font-size: 0.75rem;
    color: var(--slate-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-amount-main {
    font-weight: 700;
    color: var(--success);
    font-size: 1rem;
}

.summary-details-enhanced {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: var(--slate-600);
}

.week-summary-total {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    padding: 16px;
    border-radius: 8px;
}

.total-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.total-title {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 2px;
    display: block;
}

.total-subtitle {
    font-size: 0.75rem;
    opacity: 0.9;
}

/* Removed duplicate total-amount - using existing definition */

.total-breakdown {
    display: flex;
    gap: 24px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.breakdown-stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* Mobile responsive */
@media (max-width: 640px) {
    .entry-card-details {
        grid-template-columns: 1fr;
        gap: 6px;
    }
    
    .entry-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .step2-entry-card .breakdown-grid {
        grid-template-columns: 1fr;
        gap: 6px;
    }
    
    .day-name {
        font-size: 1rem;
    }
    
    .day-date {
        font-size: 0.8rem;
    }
    
    .status-badge {
        padding: 6px 10px;
        font-size: 0.85rem;
    }
    
    .step2-entry-card .breakdown-item {
        padding: 5px 8px;
    }
}

.section-header {
    text-align: center;
    margin-bottom: 12px;
    padding: 8px 0;
    position: relative;
}

.section-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 1px;
    background: linear-gradient(90deg, 
        transparent 0%, 
        var(--accent) 50%, 
        transparent 100%);
    opacity: 0.5;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
    position: relative;
    display: inline-block;
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
    opacity: 0.8;
}

.section-subtitle {
    font-size: 0.875rem;
    color: var(--slate-600);
    line-height: 1.4;
    font-weight: 500;
}

/* Input Method Toggle - Dashboard Style */
.input-method-toggle {
    background: white;
    border-radius: 12px;
    padding: 4px;
    display: flex;
    gap: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    margin-bottom: 16px;
    max-width: 320px;
    margin-left: auto;
    margin-right: auto;
}

.method-btn {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--slate-600);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.method-btn:hover {
    background: rgba(0, 0, 0, 0.04);
}

.method-btn.active {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.method-btn.active .method-label,
.method-btn.active .method-desc {
    color: white;
}

.method-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.method-icon svg {
    width: 16px;
    height: 16px;
}

.method-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--primary);
    line-height: 1.1;
}

.method-desc {
    display: none; /* Hide description for toggle button style */
}

.method-btn.active .method-desc {
    color: var(--accent);
}

/* Group label and description together */
.method-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* Very small mobile screens */
@media screen and (max-width: 480px) {
    .input-method-toggle {
        max-width: 280px !important;
    }
    
    .method-btn {
        padding: 8px 6px !important;
        font-size: 13px !important;
    }
    
    .method-label {
        font-size: 13px !important;
    }
    
    .method-icon svg {
        width: 14px !important;
        height: 14px !important;
    }
}

/* Manual Entry Container */
.manual-entry-container {
    margin-bottom: 32px;
}

.manual-entry-area {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 3px dashed var(--slate-300);
    border-radius: 16px;
    padding: 40px 20px;
    text-align: center;
    min-height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.manual-entry-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    max-width: 400px;
}

.manual-entry-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.manual-entry-icon svg {
    width: 28px;
    height: 28px;
}

.manual-entry-text {
    text-align: center;
}

.manual-entry-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.manual-entry-subtitle {
    font-size: 14px;
    color: var(--slate-600);
    margin-bottom: 20px;
    line-height: 1.5;
}

.manual-entry-btn {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.manual-entry-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

/* Manual Entries Section */
.manual-entries-section {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.manual-entries-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.manual-entries-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--slate-900);
}

/* Manual Entries List */
.manual-entries-list {
    margin-top: 16px;
    padding: 0;
}

.manual-entries-list .entry-item {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.manual-entries-list .entry-date {
    font-weight: 600;
    color: var(--slate-900);
}

.manual-entries-list .entry-details {
    color: var(--slate-600);
    font-size: 0.875rem;
}

.manual-entries-list .entry-amount {
    font-weight: 600;
    color: var(--success);
}

.manual-entries-list .entry-remove {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.75rem;
    cursor: pointer;
}

.manual-entries-list .entry-remove:hover {
    background: #dc2626;
}

.manual-entries-list .empty-state {
    text-align: center;
    padding: 20px;
    color: var(--slate-500);
    font-style: italic;
}

/* Workflow Cards */
.workflow-cards {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
}

.workflow-card {
    flex: 1;
    background: white;
    border: 2px solid var(--slate-200);
    border-radius: 12px;
    padding: 20px 16px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.workflow-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
}

.workflow-icon {
    font-size: 32px;
    margin-bottom: 12px;
    display: block;
}

.workflow-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.workflow-description {
    font-size: 14px;
    color: var(--slate-600);
    margin-bottom: 16px;
    line-height: 1.4;
}

/* Mobile responsive styles - maintaining horizontal layout */
@media screen and (max-width: 768px) {
    .input-method-toggle {
        max-width: 300px !important;
    }
    
    .method-btn {
        padding: 8px !important;
        font-size: 13px !important;
    }
    
    .method-label {
        font-size: 14px !important;
    }
    
    .method-desc {
        font-size: 10px !important;
    }
    
    .method-icon svg {
        width: 18px !important;
        height: 18px !important;
    }
    
    .workflow-cards {
        flex-direction: column;
        gap: 12px;
    }
    
    .workflow-card {
        width: 100%;
    }
}

/* Additional mobile-first approach for larger mobile screens */
@media screen and (max-width: 900px) {
    .upload-section-enhanced .input-method-toggle {
        display: flex !important;
        flex-direction: row !important;
        gap: 10px !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .upload-section-enhanced .input-method-toggle .method-btn {
        min-width: 150px !important;
        max-width: 200px !important;
        flex: 1 !important;
        padding: 14px 10px !important;
    }
}

/* Force mobile layout with highest specificity - horizontal layout */
@media screen and (max-width: 768px) {
    div.upload-section-enhanced div.input-method-toggle {
        display: flex !important;
        flex-direction: row !important;
        gap: 8px !important;
        align-items: center !important;
        justify-content: center !important;
        flex-wrap: wrap !important;
    }
    
    div.upload-section-enhanced div.input-method-toggle button.method-btn {
        min-width: 140px !important;
        max-width: 180px !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: row !important;
        padding: 12px 8px !important;
    }
}

/* Enhanced Upload Area */
.upload-area-container {
    position: relative;
    margin-bottom: 16px;
}

.enhanced-upload-v2 {
    position: relative;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px dashed var(--slate-300);
    border-radius: 12px;
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    min-height: 180px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.upload-background-pattern {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.enhanced-upload-v2:hover {
    border-color: var(--accent);
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
}

.enhanced-upload-v2:hover .upload-background-pattern {
    opacity: 1;
}

.enhanced-upload-v2.dragging {
    border-color: var(--accent);
    border-width: 4px;
    background: rgba(59, 130, 246, 0.05);
    transform: scale(1.02);
}

.upload-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
}

.upload-icon-large {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
}

.upload-icon-large svg {
    width: 30px;
    height: 30px;
    stroke: white;
    stroke-width: 2;
}

.enhanced-upload-v2:hover .upload-icon-large {
    transform: scale(1.1);
    box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
}

.upload-text-content {
    text-align: center;
}

.upload-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.upload-subtitle {
    font-size: 1rem;
    color: var(--slate-600);
    margin-bottom: 20px;
}

.upload-browse {
    color: var(--accent);
    font-weight: 600;
    text-decoration: underline;
    cursor: pointer;
}


.requirement-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 50px;
    font-size: 0.875rem;
    color: var(--slate-700);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.requirement-icon {
    font-size: 1rem;
}

/* Files Section */
.files-section {
    animation: slideIn 0.3s ease;
    margin-bottom: 32px;
}

.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--slate-200);
}

.files-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
}

.files-count {
    padding: 6px 12px;
    background: var(--slate-100);
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--slate-600);
}

/* Analysis Preview Section */
.analysis-preview-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid var(--slate-200);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    margin-bottom: 32px;
    animation: slideIn 0.3s ease;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.preview-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
    margin: 0;
}

.validation-badge.modern {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 16px;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid;
}

.validation-badge.modern.valid {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.2);
}

.validation-badge.modern.invalid {
    background: rgba(220, 38, 38, 0.1);
    color: var(--danger);
    border-color: rgba(220, 38, 38, 0.2);
}



.preview-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}


.preview-card-content {
    flex: 1;
}

.preview-card-label {
    font-size: 0.875rem;
    color: var(--slate-500);
    margin-bottom: 4px;
}


/* Modern Validation Alert */
.validation-alert.modern {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px 20px;
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 12px;
    margin-bottom: 24px;
}

.alert-icon {
    flex-shrink: 0;
    color: var(--warning);
    margin-top: 2px;
}

.alert-content {
    flex: 1;
}

.alert-title {
    font-weight: 600;
    color: var(--warning);
    margin-bottom: 4px;
    font-size: 0.875rem;
}

.alert-message {
    color: var(--slate-700);
    font-size: 0.875rem;
    line-height: 1.5;
}

/* Enhanced Action Section */
.action-section {
    text-align: center;
}

.action-buttons {
    display: flex;
    gap: 16px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
}

.analyze-btn.secondary {
    background: linear-gradient(135deg, var(--slate-200) 0%, var(--slate-300) 100%);
    color: var(--slate-700);
    border: 2px solid var(--slate-300);
}

.analyze-btn.secondary:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--slate-300) 0%, var(--slate-400) 100%);
    color: var(--slate-800);
    transform: translateY(-2px);
}

@media (max-width: 640px) {
    .action-buttons {
        flex-direction: column;
        gap: 12px;
    }
    
    .analyze-btn {
        width: 100%;
        max-width: 300px;
    }
}


.analyze-btn:not(:disabled):hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
}

.analyze-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.btn-content {
    display: flex;
    align-items: center;
    gap: 12px;
    transition: opacity 0.3s ease;
}

.btn-loader {
    position: absolute;
    display: flex;
    align-items: center;
    gap: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.analyze-btn.loading .btn-content {
    opacity: 0;
}

.analyze-btn.loading .btn-loader {
    opacity: 1;
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.action-note {
    font-size: 0.875rem;
    color: var(--slate-500);
    margin-top: 12px;
}

/* Enhanced Reports Page Styles */
.reports-header {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-bottom: 3px solid var(--success);
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
    position: relative;
    overflow: hidden;
}

.reports-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(90deg, 
        rgba(16, 185, 129, 0.05) 0%, 
        rgba(16, 185, 129, 0.02) 50%, 
        rgba(16, 185, 129, 0.05) 100%);
    z-index: 0;
}

.reports-header .page-header-content {
    position: relative;
    z-index: 1;
}

/* Enhanced History Page Styles */
.history-header {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-bottom: 3px solid var(--slate-600);
    box-shadow: 0 4px 20px rgba(71, 85, 105, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
    position: relative;
    overflow: hidden;
}

.history-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(90deg, 
        rgba(71, 85, 105, 0.05) 0%, 
        rgba(71, 85, 105, 0.02) 50%, 
        rgba(71, 85, 105, 0.05) 100%);
    z-index: 0;
}

.history-header .page-header-content {
    position: relative;
    z-index: 1;
}

.reports-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 600px;
    height: 2px;
    background: linear-gradient(90deg, 
        transparent 0%, 
        var(--success) 20%, 
        var(--success) 80%, 
        transparent 100%);
    opacity: 0.6;
}

/* Desktop Enhancements for Analysis and Reports Pages */
@media (min-width: 768px) {
    .analysis-container {
        padding: 32px 24px;
        background: rgba(255, 255, 255, 0.7);
    }
    
    .reports-content {
        padding: 32px 24px;
        background: rgba(255, 255, 255, 0.7);
    }
    
    .analysis-header,
    .history-header {
        padding: 12px 16px;
    }
    
    .page-title {
        font-size: 1.25rem;
    }
    
    .title-icon {
        width: 32px;
        height: 32px;
        font-size: 1.3rem;
    }
    
    .section-header {
        padding: 24px 0;
        margin-bottom: 32px;
    }
    
    .section-header::before {
        width: 100px;
    }
    
    .section-title {
        font-size: 1.75rem;
        margin-bottom: 12px;
    }
    
    .section-subtitle {
        font-size: 1.125rem;
    }
    
    .analysis-steps {
        padding: 24px;
        margin-bottom: 48px;
        border-radius: 16px;
    }
    
    .step-connector {
        width: 60px;
        margin: 0 16px;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        font-size: 0.875rem;
    }
    
    .step-label {
        font-size: 0.875rem;
    }
    
    .enhanced-upload-v2 {
        padding: 60px 40px;
        min-height: 300px;
        margin-top: 20px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .upload-icon-large {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }
    
    .upload-icon-large svg {
        width: 40px;
        height: 40px;
    }
    
    .upload-title {
        font-size: 1.5rem;
    }
    
    .upload-subtitle {
        font-size: 1.125rem;
        margin-bottom: 24px;
    }
}

/* Mobile-First Styles for Upload Requirements and Preview */
.upload-requirements {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-top: 20px;
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.preview-card {
    background: white;
    border: 1px solid var(--slate-200);
    border-radius: 12px;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.preview-card-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.preview-card-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
}

.analyze-btn {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 16px 32px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
    margin-bottom: 16px;
    min-width: 180px;
    height: 56px;
    overflow: hidden;
}

/* Desktop Enhancements for Additional Components */
@media (min-width: 768px) {
    .upload-requirements {
        flex-direction: row;
        justify-content: center;
        gap: 16px;
    }
    
    .preview-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }
    
    .preview-card {
        padding: 20px 16px;
        flex-direction: row;
        text-align: left;
        gap: 12px;
    }
    
    .preview-card-icon {
        font-size: 1.75rem;
    }
    
    .preview-card-value {
        font-size: 1.5rem;
    }
    
    .analyze-btn {
        padding: 18px 48px;
        font-size: 1.125rem;
        min-width: 200px;
        height: 60px;
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }
}
</style>
</head>
<body>
<div class="app-container">
    <!-- Toast Notification -->
    <output aria-live="polite" class="toast" id="toast"></output>
    
    <!-- Recovery Banner -->
    <div class="recovery-banner" id="recoveryBanner">
        <span class="recovery-banner-text" id="recoveryText">Restored your last analysis</span>
        <button class="recovery-banner-action" id="startNewBtn">Start New</button>
        <button class="recovery-banner-close" id="closeBannerBtn">×</button>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Processing documents...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- Manual Entry Modal -->
    <div class="manual-entry-overlay" id="manualEntryOverlay">
        <div class="manual-entry-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                        </svg>
                    </span>
                    <span>Manual Data Entry</span>
                </div>
                <button class="modal-close" id="closeManualEntry" aria-label="Close">×</button>
            </div>
            
            <div class="modal-body">
                <form id="manualEntryForm" class="manual-entry-form">
                    <div class="form-section">
                        <h3 class="form-section-title">Date Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="entryDate" class="form-label">Date</label>
                                <input type="date" id="entryDate" class="form-input" required>
                            </div>
                            <div class="form-field">
                                <label for="entryDay" class="form-label">Day Type</label>
                                <input type="text" id="entryDay" class="form-input" readonly>
                                <span class="form-help">Automatically calculated from date</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="form-section-title">Delivery Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="consignments" class="form-label">Consignments</label>
                                <input type="number" id="consignments" class="form-input" min="0" step="1" placeholder="0" required>
                            </div>
                            <div class="form-field">
                                <div class="form-label-with-info">
                                    <label for="baseAmount" class="form-label">Base Amount (£)</label>
                                    <span class="info-icon" data-tooltip="Calculated for you"></span>
                                </div>
                                <input type="number" id="baseAmount" class="form-input" min="0" step="0.01" placeholder="0.00" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="pickups" class="form-label">Pickups</label>
                                <input type="number" id="pickups" class="form-input" min="0" step="1" placeholder="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="form-section-title">Bonus Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <div class="form-label-with-info">
                                    <label for="earlyArrive" class="form-label">Early Arrive (£)</label>
                                    <span class="info-icon" data-tooltip="Depends on the day"></span>
                                </div>
                                <input type="number" id="earlyArrive" class="form-input" min="0" step="0.01" placeholder="0" readonly>
                            </div>
                            <div class="form-field">
                                <div class="form-label-with-info">
                                    <label for="onTimePercentage" class="form-label">Attendance Bonus (£)</label>
                                    <span class="info-icon" data-tooltip="Depends on the day"></span>
                                </div>
                                <input type="number" id="onTimePercentage" class="form-input" min="0" step="0.01" placeholder="0" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <div class="form-label-with-info">
                                    <label for="loadingBonus" class="form-label">Unloading Bonus (£)</label>
                                    <span class="info-icon" data-tooltip="Depends on the day"></span>
                                </div>
                                <input type="number" id="loadingBonus" class="form-input" min="0" step="0.01" placeholder="0" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="form-section-title">Payment Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="expectedTotal" class="form-label">Expected Total (£)</label>
                                <input type="number" id="expectedTotal" class="form-input" min="0" step="0.01" placeholder="0.00" readonly>
                                <span class="form-help">Calculated automatically</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field full-width">
                                <div class="payment-info-note">
                                    <span class="payment-info-icon">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="12" y1="16" x2="12" y2="12"/>
                                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                                        </svg>
                                    </span>
                                    <span class="payment-info-text">Payment typically comes a week after the work day and can be recorded later.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelManualEntry">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveManualEntry" form="manualEntryForm">Add Entry</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Day Modal -->
    <div class="manual-entry-overlay" id="editDayOverlay">
        <div class="manual-entry-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                        </svg>
                    </span>
                    <span>Edit Day Data</span>
                </div>
                <button class="modal-close" id="closeEditDay" aria-label="Close">×</button>
            </div>
            
            <div class="modal-body">
                <form id="editDayForm" class="manual-entry-form">
                    <div class="form-section">
                        <h3 class="form-section-title">Date Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="editDate" class="form-label">Date</label>
                                <input type="date" id="editDate" class="form-input" readonly>
                            </div>
                            <div class="form-field">
                                <label for="editDay" class="form-label">Day Type</label>
                                <input type="text" id="editDay" class="form-input" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="form-section-title">Delivery Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="editConsignments" class="form-label">Consignments</label>
                                <input type="number" id="editConsignments" class="form-input" min="0" step="1" placeholder="0" required>
                            </div>
                            <div class="form-field">
                                <label for="editBaseAmount" class="form-label">Base Amount (£)</label>
                                <input type="number" id="editBaseAmount" class="form-input" min="0" step="0.01" placeholder="0.00" readonly>
                                <span class="form-help">Calculated automatically</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="editPickups" class="form-label">Pickups</label>
                                <input type="number" id="editPickups" class="form-input" min="0" step="1" placeholder="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="form-section-title">Performance Bonuses (£)</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <div class="form-label-with-info">
                                    <label for="editEarlyArrive" class="form-label">Early Arrive (£)</label>
                                    <span class="info-icon" data-tooltip="Depends on the day"></span>
                                </div>
                                <input type="number" id="editEarlyArrive" class="form-input" min="0" step="0.01" placeholder="0" readonly>
                            </div>
                            <div class="form-field">
                                <div class="form-label-with-info">
                                    <label for="editOnTimePercentage" class="form-label">Attendance Bonus (£)</label>
                                    <span class="info-icon" data-tooltip="Depends on the day"></span>
                                </div>
                                <input type="number" id="editOnTimePercentage" class="form-input" min="0" step="0.01" placeholder="0" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <div class="form-label-with-info">
                                    <label for="editLoadingBonus" class="form-label">Unloading Bonus (£)</label>
                                    <span class="info-icon" data-tooltip="Depends on the day"></span>
                                </div>
                                <input type="number" id="editLoadingBonus" class="form-input" min="0" step="0.01" placeholder="0" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="form-section-title">Payment Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="editActualReceived" class="form-label">Actual Received (£)</label>
                                <input type="number" id="editActualReceived" class="form-input" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEditDay">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveEditDay" form="editDayForm">Update Entry</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Page -->
    <div class="page active" id="dashboard-page">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span>
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </span>
                    <span>Dashboard</span>
                </h1>
                <div class="page-actions">
                    <button class="header-btn" id="refreshDashboard" aria-label="Refresh">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <polyline points="1 20 1 14 7 14"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-content" id="dashboardContent">
            <!-- View Toggle -->
            <div class="view-toggle" style="display: none;">
                <button class="toggle-btn active" id="monthlyToggle" data-view="monthly">
                    <span>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </span>
                    <span>Monthly</span>
                </button>
                <button class="toggle-btn" id="weeklyToggle" data-view="weekly">
                    <span>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                            <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/>
                        </svg>
                    </span>
                    <span>Weekly</span>
                </button>
            </div>
            
            <!-- Executive Summary -->
            <div class="executive-summary" id="executiveSummary" style="display: none;">
                <div class="summary-header">
                    <div class="summary-title">
                        Executive Summary
                    </div>
                    <div class="summary-period" id="summaryPeriod">This Month</div>
                </div>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Total Revenue</div>
                        <div class="summary-stat-value" id="summaryRevenue">£0.00</div>
                        <div class="summary-stat-change positive" id="revenueChange">↑ 0%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Daily</div>
                        <div class="summary-stat-value" id="summaryDaily">£0.00</div>
                        <div class="summary-stat-change" id="dailyChange">→ 0%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Deliveries</div>
                        <div class="summary-stat-value" id="summaryDeliveries">0</div>
                        <div class="summary-stat-change positive" id="deliveriesChange">↑ 0%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Performance</div>
                        <div class="summary-stat-value" id="summaryPerformance">0%</div>
                        <div class="summary-stat-change" id="performanceChange">→ Good</div>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Widget -->
            <div class="calendar-widget" style="display: none;">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendarMonth">December 2024</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="calPrev">‹</button>
                        <button class="calendar-nav-btn" id="calNext">›</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="kpi-grid" style="display: none;">
                <div class="kpi-card success">
                    <div class="kpi-header">
                        <div class="kpi-label">Expected</div>
                        <div class="kpi-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value" id="kpiExpected">£0.00</div>
                    <div class="kpi-trend trend-up" id="expectedTrend">
                        <span>↑</span>
                        <span>0% vs last</span>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">Received</div>
                        <div class="kpi-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 12l2 2 4-4"/>
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value" id="kpiReceived">£0.00</div>
                    <div class="kpi-trend trend-neutral" id="receivedTrend">
                        <span>→</span>
                        <span>0% vs last</span>
                    </div>
                </div>
                
                <div class="kpi-card warning">
                    <div class="kpi-header">
                        <div class="kpi-label">Pending</div>
                        <div class="kpi-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value" id="kpiPending">£0.00</div>
                    <div class="kpi-trend trend-down" id="pendingTrend">
                        <span>↓</span>
                        <span>0% vs last</span>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">Efficiency</div>
                        <div class="kpi-icon">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value" id="kpiEfficiency">0%</div>
                    <div class="kpi-trend trend-up" id="efficiencyTrend">
                        <span>↑</span>
                        <span>Good</span>
                    </div>
                </div>
            </div>
            
            <!-- Chart Container -->
            <div class="chart-container" style="display: none;">
                <div class="chart-header">
                    <div class="chart-title">Revenue Trend</div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--accent)"></div>
                            <span>Expected</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--slate-400)"></div>
                            <span>Actual</span>
                        </div>
                    </div>
                </div>
                <div class="bar-chart" id="revenueChart">
                    <!-- Chart bars will be rendered here -->
                </div>
            </div>
            
            <!-- Forecast Section -->
            <div class="forecast-card" style="display: none;">
                <div class="forecast-header">
                    <div class="forecast-title">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; margin-right: 8px;">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M7 13v4M11 10v7M15 7v10"/>
                        </svg>
                        Forecast
                    </div>
                    <div class="forecast-badge">AI Predicted</div>
                </div>
                <div class="forecast-items">
                    <div class="forecast-item">
                        <div class="forecast-label">Next Week Expected</div>
                        <div class="forecast-value" id="forecastWeek">£0.00</div>
                    </div>
                    <div class="forecast-item">
                        <div class="forecast-label">Month End Projection</div>
                        <div class="forecast-value" id="forecastMonth">£0.00</div>
                    </div>
                    <div class="forecast-item">
                        <div class="forecast-label">Suggested Daily Target</div>
                        <div class="forecast-value" id="forecastTarget">£0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions" style="display: none;">
                <button class="action-btn" id="quickAnalyze">
                    <span>
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M7 13v4M11 10v7M15 7v10"/>
                        </svg>
                    </span>
                    <span>Upload & Analyze</span>
                </button>

                <button class="action-btn secondary" id="viewReports">
                    <span>
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </span>
                    <span>View All Reports</span>
                </button>
            </div>
            
            <!-- Enhanced Onboarding Experience -->
            <div class="onboarding-container" id="dashboardEmpty">
                <!-- Welcome Hero Section -->
                <div class="welcome-hero">
                    <h1 class="welcome-title">Welcome to Payment Analyzer!</h1>
                    <p class="welcome-subtitle">Your intelligent companion for tracking delivery payments and financial insights</p>
                </div>
                
                <!-- Call to Action -->
                <div class="cta-section">
                    <div class="cta-buttons">
                        <button class="primary-cta-btn" id="emptyGetStarted">
                            <span class="btn-icon">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M7 13v4M11 10v7M15 7v10"/>
                                </svg>
                            </span>
                            <span class="btn-text">Upload & Analyze</span>
                            <span class="btn-arrow">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M13 5l7 7-7 7"/>
                                </svg>
                            </span>
                        </button>
                    </div>
                    <p class="cta-note">Ready to go? Upload your documents or enter data to start analysis.</p>
                </div>
                <!-- Quick Start Steps -->
                <div class="quick-start-section">
                    <h2 class="section-title">Get Started in 3 Easy Steps</h2>
                    <div class="steps-container">
                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </div>
                            <h3 class="step-title">Add Your Data</h3>
                            <p class="step-description">Upload PDF documents or enter data manually</p>
                        </div>
                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                </svg>
                            </div>
                            <h3 class="step-title">Instant Analysis</h3>
                            <p class="step-description">Our AI processes your data in seconds</p>
                        </div>
                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div class="step-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                </svg>
                            </div>
                            <h3 class="step-title">View Insights</h3>
                            <p class="step-description">Get detailed reports and payment tracking</p>
                        </div>
                    </div>
                </div>

                <!-- Feature Highlights -->
                <div class="features-section">
                    <h2 class="section-title">What You Can Do</h2>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                </svg>
                            </div>
                            <h4 class="feature-title">Smart Analysis</h4>
                            <p class="feature-description">Automatically calculate expected vs paid amounts</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M7 13v4M11 10v7M15 7v10"/>
                                </svg>
                            </div>
                            <h4 class="feature-title">Visual Reports</h4>
                            <p class="feature-description">Beautiful charts and comprehensive breakdowns</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                            </div>
                            <h4 class="feature-title">Auto Save</h4>
                            <p class="feature-description">Your data is safely stored and always accessible</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 6 2 18 2 18 9"/>
                                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                                    <rect x="6" y="14" width="12" height="8"/>
                                </svg>
                            </div>
                            <h4 class="feature-title">Export Ready</h4>
                            <p class="feature-description">Print or export professional reports</p>
                        </div>
                    </div>
                </div>

                <!-- Call to Action -->
                <div class="cta-section">
                    <div class="cta-buttons">
                        <button class="primary-cta-btn" id="emptyGetStartedSecond">
                            <span class="btn-icon">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M9 7V2.221a2 2 0 0 0-.5.365L4.586 6.5a2 2 0 0 0-.365.5H9Zm2 0V2h7a2 2 0 0 1 2 2v6.41A7.5 7.5 0 1 0 10.5 22H6a2 2 0 0 1-2-2V9h5a2 2 0 0 0 2-2Z" clip-rule="evenodd"/>
                                    <path fill-rule="evenodd" d="M9 16a6 6 0 1 1 12 0 6 6 0 0 1-12 0Zm6-3a1 1 0 0 1 1 1v1h1a1 1 0 1 1 0 2h-1v1a1 1 0 1 1-2 0v-1h-1a1 1 0 1 1 0-2h1v-1a1 1 0 0 1 1-1Z" clip-rule="evenodd"/>
                                </svg>
                            </span>
                            <span class="btn-text">Get Started</span>
                            <span class="btn-arrow">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M13 5l7 7-7 7"/>
                                </svg>
                            </span>
                        </button>
                    </div>
                    <p class="cta-note">No registration required • Works offline • Free to use</p>
                </div>

                <!-- Tips Section -->
                <div class="tips-section">
                    <h3 class="tips-title">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; margin-right: 8px;">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        Pro Tips
                    </h3>
                    <div class="tips-list">
                        <div class="tip-item">
                            <span class="tip-icon">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                </svg>
                            </span>
                            <span class="tip-text">Upload PDFs or use manual entry for quick data input</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                </svg>
                            </span>
                            <span class="tip-text">Customize payment rates in Settings for accurate calculations</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="4" width="20" height="16" rx="2"/>
                                    <circle cx="8" cy="12" r="2"/>
                                    <path d="M18 12h.01"/>
                                    <path d="M16 12h.01"/>
                                </svg>
                            </span>
                            <span class="tip-text">Works great on mobile - analyze payments anywhere</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Page -->
    <div class="page" id="analysis-page">
        <div class="page-header analysis-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span class="title-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                    </span>
                    <span>Document Analysis</span>
                </h1>
                <div class="page-actions">
                    <div class="validation-badge" id="analysisValidationBadge" style="display: none;">
                        <span class="badge-text">PENDING</span>
                    </div>
                    <button class="header-btn clear-btn" id="clearFiles" aria-label="Clear all files">
                        <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="analysis-container">
            <!-- Progress Steps Indicator -->
            <div class="analysis-steps" id="analysisSteps">
                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Upload Files</div>
                </div>
                <div class="step-connector"></div>
                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Validate</div>
                </div>
                <div class="step-connector"></div>
                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Analyze</div>
                </div>
            </div>

            <!-- Enhanced Upload Section -->
            <div class="upload-section-enhanced">
                <div class="section-header">
                    <h2 class="section-title">Add Your Data</h2>
                    <p class="section-subtitle">Upload your documents or enter data manually to get started with payment analysis</p>
                </div>

                <!-- Data Input Method Toggle -->
                <div class="input-method-toggle">
                    <button class="method-btn active" id="uploadMethodBtn" data-method="upload">
                        <span class="method-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                        </span>
                        <span class="method-label">Upload Files</span>
                    </button>

                    <!-- Manual Entry Button -->
                    <button class="method-btn" id="manualMethodBtn" data-method="manual">
                        <span class="method-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                            </svg>
                        </span>
                        <span class="method-label">Manual Entry</span>
                    </button>
                </div>

                <!-- File Upload Area -->
                <div class="upload-area-container" id="uploadContainer">
                    <div class="upload-area enhanced-upload-v2" id="uploadArea">
                        <div class="upload-background-pattern"></div>
                        <div class="upload-content">
                            <div class="upload-icon-large">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </div>
                            <div class="upload-text-content">
                                <h3 class="upload-title">Drag & Drop Files Here</h3>
                                <p class="upload-subtitle">or <span class="upload-browse">browse files</span> from your device</p>
                                <div class="upload-requirements">
                                    <div class="requirement-item">
                                        <span class="requirement-icon">
                                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                <polyline points="14 2 14 8 20 8"/>
                                                <line x1="16" y1="13" x2="8" y2="13"/>
                                                <line x1="16" y1="17" x2="8" y2="17"/>
                                                <polyline points="10 9 9 9 8 9"/>
                                            </svg>
                                        </span>
                                        <span>PDF files only</span>
                                    </div>
                                    <div class="requirement-item">
                                        <span class="requirement-icon">
                                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                            </svg>
                                        </span>
                                        <span>Runsheets & Invoices</span>
                                    </div>
                                    <div class="requirement-item">
                                        <span class="requirement-icon">⚡</span>
                                        <span>Max 10MB per file</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input accept=".pdf" class="file-input" id="fileInput" multiple type="file" aria-label="Select PDF files for analysis" title="Choose PDF files to upload"/>
                </div>

                <!-- Action Buttons -->
                <div class="action-section">
                    <div class="action-buttons">
                        <button class="analyze-btn" id="analyzeBtn" disabled>
                            <span class="btn-content">
                                <span class="btn-icon">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M2 22l16-4 4-16-16 4-4 16zm7-7l5-5"/>
                                    </svg>
                                </span>
                                <span class="btn-text">Analyze Documents</span>
                            </span>
                            <span class="btn-loader" style="display: none;">
                                <div class="spinner"></div>
                                <span>Processing...</span>
                            </span>
                        </button>
                        <button class="analyze-btn secondary" id="startNewAnalysisBtn" style="display: none;">
                            <span class="btn-content">
                                <span class="btn-icon">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                </span>
                                <span class="btn-text">Start New Analysis</span>
                            </span>
                        </button>
                    </div>
                    <p class="action-note">Analysis typically takes 2-5 seconds per document</p>
                </div>
            </div>

            <!-- Step 2: Validate Section -->
            <div class="validate-section" style="display: none;">

                <!-- Manual Entries List (visible when manual method is active) -->
                <div class="manual-entries-section" id="manualEntriesSection" style="display: none;">
                    <div class="manual-entries-header">
                        <h3>Your Manual Entries</h3>
                        <button class="btn btn-primary" id="addNewEntryBtn">
                            <span class="btn-icon">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                </svg>
                            </span>
                            <span>Add Entry</span>
                        </button>
                    </div>
                    <div class="manual-entries-list" id="manualEntriesList">
                <!-- Content will be populated by populateStep2Content() -->

                        <!-- Entries will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Step 3: Analyze Section -->
            <div class="analyze-section" style="display: none;">
                <!-- Content will be populated by analysis results -->
            </div>
        </div>
    </div>
    
    <!-- Reports Page -->
    <div class="page" id="reports-page">
        <div class="page-header reports-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span class="title-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M7 13v4M11 10v7M15 7v10"/>
                        </svg>
                    </span>
                    <span>Reports</span>
                </h1>
                <div class="page-actions">
                    <button class="header-btn" id="printReport" aria-label="Print">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 6 2 18 2 18 9"/>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect x="6" y="14" width="12" height="8"/>
                        </svg>
                    </button>
                    <button class="header-btn" id="exportReport" aria-label="Export">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="reports-content" id="reportsContent">
            <!-- Pull indicator for mobile refresh -->
            <div class="pull-indicator" id="pullIndicator">
                <span>↓ Pull to refresh</span>
            </div>
            
            <!-- Report content will be dynamically inserted -->
            <div class="empty-state" id="emptyReportState">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M7 13v4M11 10v7M15 7v10"/>
                    </svg>
                </div>
                <div class="empty-title">No Report Available</div>
                <div class="empty-message">Complete an analysis to view reports</div>
            </div>
            
            <!-- Enhanced Report Structure (hidden by default) -->
            <div class="report-container" id="reportContainer" style="display: none;">
                <!-- Professional Report Header -->
                <div class="report-header enhanced-header">
                    <div class="report-header-content">
                        <div class="report-company">FINANCIAL ANALYSIS</div>
                        <div class="report-title"><span class="week-title">Financial Analysis Report</span></div>
                        <div class="report-meta">
                            <div class="report-meta-item">
                                <div class="report-meta-label">Period</div>
                                <div class="report-meta-value" id="reportPeriod">-</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Generated</div>
                                <div class="report-meta-value" id="reportDate">-</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Total Days</div>
                                <div class="report-meta-value" id="reportDays">-</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Status</div>
                                <div class="report-meta-value" id="reportStatus">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced KPI Dashboard -->
                <div class="kpi-dashboard">
                    <div class="kpi-card kpi-primary">
                        <div class="kpi-header">
                            <div class="kpi-title">Expected Total</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="reportKpiExpected">£0.00</div>
                        <div class="kpi-subtitle" id="reportKpiExpectedSub">Total earnings</div>
                    </div>
                    
                    <div class="kpi-card kpi-secondary">
                        <div class="kpi-header">
                            <div class="kpi-title">Paid Amount</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="5" width="20" height="14" rx="2"/>
                                    <line x1="2" y1="10" x2="22" y2="10"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="reportKpiPaid">£0.00</div>
                        <div class="kpi-subtitle" id="reportKpiPaidSub">Amount received</div>
                    </div>
                    
                    <div class="kpi-card" id="reportKpiDifferenceCard">
                        <div class="kpi-header">
                            <div class="kpi-title">Difference</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 12H4M12 4v16"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="reportKpiDifference">£0.00</div>
                        <div class="kpi-trend" id="kpiTrend">
                            <span id="kpiTrendText">-</span>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-title">Consignments</div>
                            <div class="kpi-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiConsignments">0</div>
                        <div class="kpi-subtitle" id="kpiConsignmentsSub">Total deliveries</div>
                    </div>
                </div>
                
                <!-- Comprehensive Data Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Daily Analysis Breakdown</h3>
                        <div class="table-actions">
                            <button class="button button-small button-secondary" id="toggleTableView">
                                <span>Compact View</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="data-table" id="dataTable" role="table" aria-label="Financial analysis breakdown by date">
                            <thead>
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Day</th>
                                    <th scope="col">Consignments</th>
                                    <th scope="col">Rate</th>
                                    <th scope="col">Base Pay</th>
                                    <th scope="col">Pickups</th>
                                    <th scope="col">Bonuses</th>
                                    <th scope="col">Expected</th>
                                    <th scope="col">Paid</th>
                                    <th scope="col">Difference</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Table rows will be inserted here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2"><strong>Totals</strong></td>
                                    <td class="amount-cell" id="footerConsignments">0</td>
                                    <td>-</td>
                                    <td class="amount-cell" id="footerBase">£0.00</td>
                                    <td class="amount-cell" id="footerPickups">£0.00</td>
                                    <td class="amount-cell" id="footerBonuses">£0.00</td>
                                    <td class="amount-cell" id="footerExpected">£0.00</td>
                                    <td class="amount-cell" id="footerPaid">£0.00</td>
                                    <td class="amount-cell" id="footerDifference">£0.00</td>
                                    <td>-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Settlement Breakdown -->
                <div class="settlement-breakdown">
                    <h3 class="breakdown-title">Settlement Summary</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-item">
                            <span class="breakdown-label">Consignment Payments</span>
                            <span class="breakdown-value" id="breakdownConsignments">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Pickup Services</span>
                            <span class="breakdown-value" id="breakdownPickups">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Unloading Bonus</span>
                            <span class="breakdown-value" id="breakdownUnloading">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Attendance Bonus</span>
                            <span class="breakdown-value" id="breakdownAttendance">£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Early Arrival Bonus</span>
                            <span class="breakdown-value" id="breakdownEarly">£0.00</span>
                        </div>
                        <div class="breakdown-item breakdown-total">
                            <span class="breakdown-label">Total Expected</span>
                            <span class="breakdown-value" id="breakdownTotal">£0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Page -->
    <div class="page" id="history-page">
        <div class="page-header history-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span class="title-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10 9 9 9 8 9"/>
                        </svg>
                    </span>
                    <span>History</span>
                </h1>
                <div class="page-actions">
                    <button class="header-btn" id="clearHistory" aria-label="Clear history">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be dynamically inserted -->
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                </div>
                <div class="empty-title">No History</div>
                <div class="empty-message">Your analysis history will appear here</div>
            </div>
        </div>
    </div>
    
    <!-- Settings Page -->
    <div class="page" id="settings-page">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <span>
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </span>
                    <span>Settings</span>
                </h1>
            </div>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-header">Consignment Rates</div>
                <div class="settings-body">
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="weekdayRate">Weekday Rate</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="weekdayRate" type="number" step="0.01" value="2.00"/>
                        <div class="setting-description">Rate per consignment Mon-Fri</div>
                    </div>
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="saturdayRate">Saturday Rate</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="saturdayRate" type="number" step="0.01" value="3.00"/>
                        <div class="setting-description">Rate per consignment on Saturday</div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header">Daily Bonuses</div>
                <div class="settings-body">
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="unloadingBonus">Unloading Bonus</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="unloadingBonus" type="number" step="0.01" value="30.00"/>
                        <div class="setting-description">Paid daily except Mondays</div>
                    </div>
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="attendanceBonus">Attendance Bonus</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="attendanceBonus" type="number" step="0.01" value="25.00"/>
                        <div class="setting-description">Paid on weekdays only</div>
                    </div>
                    <div class="setting-field with-prefix">
                        <label class="setting-label" for="earlyBonus">Early Arrival Bonus</label>
                        <span class="currency-prefix">£</span>
                        <input class="setting-input" id="earlyBonus" type="number" step="0.01" value="50.00"/>
                        <div class="setting-description">Paid on weekdays only</div>
                    </div>
                </div>
                <div class="settings-actions">
                    <button class="btn-secondary" id="resetRules">Reset</button>
                    <button class="btn-primary" id="saveRules">Save Changes</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header">Data Management</div>
                <div class="settings-body">
                    <div class="storage-info" id="storageInfoDiv">
                        <div class="storage-info-title">
                            <span>
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M7 13v4M11 10v7M15 7v10"/>
                                </svg>
                            </span>
                            <span>Storage Statistics</span>
                        </div>
                        <div class="storage-stats">
                            <div class="storage-stat">
                                <span class="storage-stat-label">Total Analyses</span>
                                <span class="storage-stat-value" id="totalAnalysesCount">0</span>
                            </div>
                            <div class="storage-stat">
                                <span class="storage-stat-label">Storage Used</span>
                                <span class="storage-stat-value" id="storageUsed">0 KB</span>
                            </div>
                            <div class="storage-stat">
                                <span class="storage-stat-label">Compression</span>
                                <span class="storage-stat-value" id="compressionStatus">Enabled</span>
                            </div>
                            <div class="storage-stat">
                                <span class="storage-stat-label">Version</span>
                                <span class="storage-stat-value" id="storageVersion">9.0</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="action-btn secondary" id="exportCurrentBtn">
                        <span>
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </span>
                        <span>Export Current Analysis</span>
                    </button>
                    <button class="action-btn secondary mt-2" id="exportAllBtn">
                        <span>📚</span>
                        <span>Export All Data</span>
                    </button>
                    <button class="btn-danger mt-2" id="clearAllData" style="width: 100%;">
                        <span>
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </span>
                        <span>Clear All Data</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#dashboard" class="nav-item active" data-page="dashboard">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
            </span>
            <span class="nav-label">Dashboard</span>
        </a>
        <a href="#analysis" class="nav-item" data-page="analysis">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
            </span>
            <span class="nav-label">Analyse</span>
        </a>
        <a href="#reports" class="nav-item" data-page="reports">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M7 13v4M11 10v7M15 7v10"/>
                </svg>
            </span>
            <span class="nav-label">Reports</span>
        </a>
        <a href="#history" class="nav-item" data-page="history">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
            </span>
            <span class="nav-label">History</span>
        </a>
        <a href="#settings" class="nav-item" data-page="settings">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </span>
            <span class="nav-label">Settings</span>
        </a>
    </nav>
</div>

<!-- Configure PDF.js -->
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // Polyfill for File.arrayBuffer() if not available
    if (typeof File.prototype.arrayBuffer === 'undefined') {
        File.prototype.arrayBuffer = function() {
            const file = this;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        };
    }
</script>

<!-- COMPLETE MODULES WITH ENHANCEMENTS -->

<!-- Router Module -->
<script id="routerModule" type="application/x-module">
// Router Module - Handles navigation between pages with badge system
const currentPage = { value: 'dashboard' };
const pageHandlers = {};

exports.init = function() {
    console.log('🚀 Router initialized');
    
    // Setup navigation click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            exports.navigate(page);
        });
    });
    
    // Handle browser back/forward
    window.addEventListener('hashchange', () => {
        const hash = window.location.hash.slice(1) || 'dashboard';
        exports.navigate(hash, false);
    });
    
    // Set initial page from URL hash
    const initialPage = window.location.hash.slice(1) || 'dashboard';
    exports.navigate(initialPage, false);
};

exports.navigate = function(page, updateHash = true) {
    console.log(`📍 Navigating to: ${page}`);
    
    // Remove any existing tooltips
    const existingTooltips = document.querySelectorAll('.calendar-tooltip, .chart-tooltip');
    existingTooltips.forEach(tooltip => {
        tooltip.remove();
    });
    
    // Hide all pages
    document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
    });
    
    // Show target page
    const targetPage = document.getElementById(`${page}-page`);
    if (targetPage) {
        targetPage.classList.add('active');
        
        // Update nav item states
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Update URL hash
        if (updateHash) {
            window.location.hash = page;
        }
        
        // Store current page
        currentPage.value = page;
        
        // Clear badge when navigating to history or reports pages
        if (page === 'history' || page === 'reports') {
            exports.setNavBadge(page, null);
        }
        
        // Call page load handler if exists
        if (pageHandlers[page] && pageHandlers[page].onLoad) {
            pageHandlers[page].onLoad();
        }
    }
};

exports.registerPageHandler = function(page, handler) {
    pageHandlers[page] = handler;
};

exports.getCurrentPage = function() {
    return currentPage.value;
};

// Navigation badge system
exports.setNavBadge = function(page, count) {
    const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
    if (!navItem) return;
    
    let badge = navItem.querySelector('.nav-badge');
    
    if (count > 0) {
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'nav-badge';
            navItem.appendChild(badge);
        }
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'flex';
    } else if (badge) {
        badge.style.display = 'none';
    }
};

// Step navigation for analysis page
exports.navigateToStep = function(stepNumber) {
    // Ensure we're on the analysis page first
    if (currentPage.value !== 'analysis') {
        exports.navigate('analysis');
    }
    
    // Let the analysis module handle the step change
    setTimeout(() => {
        const analysisModule = requireModule('analysisModule');
        if (analysisModule && analysisModule.setStep) {
            analysisModule.setStep(stepNumber);
        }
    }, 100);
};

</script>

<!-- State Module - COMPLETE from original v8.2 with mobile enhancements -->
<script id="stateModule" type="application/x-module">
// State Management Module - Optimized with unique analysis storage
const STORAGE_KEY = 'paymentAnalyzer_v9';
const COMPRESSED_KEY = 'paymentAnalyzer_v9_compressed';
const ANALYSES_KEY = 'paymentAnalyzer_v9_analyses';
const VERSION = '9.0.0';

// Generate a fingerprint for a set of files
function generateFileFingerprint(files) {
    const fileInfo = files.map(f => ({
        name: f.name,
        size: f.size,
        lastModified: f.lastModified || 0,
        type: f.type || 'application/pdf'
    })).sort((a, b) => a.name.localeCompare(b.name));
    
    console.log('🔐 Generating fingerprint for files:', fileInfo);
    
    // Create a more comprehensive hash
    const jsonString = JSON.stringify(fileInfo);
    const base64 = btoa(jsonString);
    
    // Simple hash function for better uniqueness
    let hash = 0;
    for (let i = 0; i < jsonString.length; i++) {
        const char = jsonString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    
    // Combine base64 and hash for uniqueness, but keep reasonable length
    const combined = base64.replace(/[^a-zA-Z0-9]/g, '') + Math.abs(hash).toString(36);
    
    // Return first 64 characters for even better uniqueness
    const fingerprint = combined.substring(0, 64);
    console.log('🔐 Generated fingerprint:', fingerprint);
    
    return fingerprint;
}

// Format date properly
function formatDate(timestamp) {
    return new Date(timestamp).toISOString();
}

// Get file info without redundancy
function getMinimalFileInfo(files) {
    return files.map(f => ({
        name: f.name,
        size: f.size,
        type: f.name.toLowerCase().includes('runsheet') ? 'R' : 
              (f.name.toLowerCase().includes('invoice') || 
               f.name.toLowerCase().includes('bill')) ? 'I' : 'U'
    }));
}

// Save current session state (for recovery)
exports.save = function(state) {
    try {
        const enhancedState = {
            ...state,
            version: VERSION,
            lastModified: formatDate(Date.now())
        };
        
        const serialized = JSON.stringify(enhancedState);
        
        if (window.LZString) {
            const compressed = LZString.compressToUTF16(serialized);
            localStorage.setItem(COMPRESSED_KEY, compressed);
            
            localStorage.setItem(STORAGE_KEY + '_meta', JSON.stringify({
                version: VERSION,
                lastModified: enhancedState.lastModified,
                compressed: true
            }));
        } else {
            localStorage.setItem(STORAGE_KEY, serialized);
        }
        
        try { window.dispatchEvent(new CustomEvent('pa:state:saved')); } catch(e) {}
        return true;
    } catch (error) {
        console.error('Save failed:', error);
        return false;
    }
}

exports.load = function() {
    try {
        if (window.LZString) {
            const compressed = localStorage.getItem(COMPRESSED_KEY);
            if (compressed) {
                const decompressed = LZString.decompressFromUTF16(compressed);
                if (decompressed) {
                    return JSON.parse(decompressed);
                }
            }
        }
        
        const serialized = localStorage.getItem(STORAGE_KEY);
        if (serialized) {
            return JSON.parse(serialized);
        }
        
        return null;
    } catch (error) {
        console.error('Failed to load state:', error);
        return null;
    }
}

// Clear all storage
exports.clear = function() {
    try {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(COMPRESSED_KEY);
        localStorage.removeItem(STORAGE_KEY + '_meta');
        localStorage.removeItem(ANALYSES_KEY);
        // Clear manual entries as well
        localStorage.removeItem('manualEntries_v9');
        // Clear uploaded files info
        localStorage.removeItem('uploadedFiles_v9');
        // Also clear old versions for migration
        localStorage.removeItem('paymentAnalyzer_v8');
        localStorage.removeItem('paymentAnalyzer_v8_compressed');
        localStorage.removeItem('paymentAnalyzer_v8_analyses');
        localStorage.removeItem('manualEntries_v8'); // Clear old manual entries too
        localStorage.removeItem('uploadedFiles_v8'); // Clear old uploaded files too
        try { window.dispatchEvent(new CustomEvent('pa:state:cleared')); } catch(e) {}
        return true;
    } catch (error) {
        console.error('Clear failed:', error);
        return false;
    }
}

// OPTIMIZED: Save or update unique analysis
exports.saveAnalysis = function(files, analysisData, processedData) {
    try {
        const fingerprint = generateFileFingerprint(files);
        const analyses = exports.getAllAnalyses();
        const rules = requireModule('rulesModule').load();
        
        // Check for existing analysis with same period and similar results
        const isDuplicate = Object.values(analyses).some(existing => {
            return existing.period === analysisData.metadata.periodRange &&
                   existing.summary.days === analysisData.metadata.totalDays &&
                   Math.abs(existing.summary.consignments - analysisData.totals.totalConsignments) < 5 && // Allow small variance
                   Math.abs(existing.summary.expected - analysisData.totals.expectedTotal) < 1 &&
                   Math.abs(existing.summary.paid - analysisData.totals.paidTotal) < 1;
        });
        
        if (isDuplicate) {
            console.log('⚠️ Duplicate analysis detected, skipping save');
            exports.updateStorageDisplay();
            return fingerprint;
        }
        
        // Generate a unique session ID for this analysis
        const sessionId = `${fingerprint}_${Date.now()}_${Math.random().toString(36).substring(7)}`;
        
        // Create optimized storage structure
        const optimizedAnalysis = {
            id: sessionId,
            fingerprint: fingerprint,
            created: formatDate(Date.now()),
            updated: formatDate(Date.now()),
            period: analysisData.metadata.periodRange,
            files: getMinimalFileInfo(files),
            summary: {
                days: analysisData.metadata.totalDays,
                consignments: analysisData.totals.totalConsignments,
                expected: analysisData.totals.expectedTotal,
                paid: analysisData.totals.paidTotal,
                difference: Math.round(analysisData.totals.differenceTotal * 100) / 100,
                status: analysisData.metadata.overallStatus.includes('FAVORABLE') ? 'F' : 'U'
            },
            details: {
                daily: analysisData.results.map(r => ({
                    d: r.date.split('-').slice(1).join('-'),
                    c: r.consignments,
                    e: r.expectedTotal,
                    p: r.paidAmount,
                    pc: r.pickupCount || 0
                })),
                totals: {
                    base: analysisData.totals.baseTotal,
                    bonus: analysisData.totals.bonusTotal,
                    pickup: analysisData.totals.pickupTotal
                }
            },
            rules: {
                wd: rules.weekdayRate,
                sat: rules.saturdayRate,
                unl: rules.unloadingBonus,
                att: rules.attendanceBonus,
                early: rules.earlyBonus
            },
            // Store complete data for mobile app
            results: analysisData.results,
            totals: analysisData.totals,
            metadata: analysisData.metadata
        };
        
        // Add new analysis with unique session ID
        analyses[sessionId] = optimizedAnalysis;
        
        // Limit total number of analyses to prevent excessive storage
        const analysesArray = Object.values(analyses);
        if (analysesArray.length > 50) {
            // Sort by created date and keep the most recent
            const sortedKeys = Object.keys(analyses).sort((a, b) => {
                const dateA = new Date(analyses[a].created || 0);
                const dateB = new Date(analyses[b].created || 0);
                return dateB - dateA;
            });
            
            // Keep only the 50 most recent
            const keepKeys = sortedKeys.slice(0, 50);
            const newAnalyses = {};
            keepKeys.forEach(key => {
                newAnalyses[key] = analyses[key];
            });
            
            // Save the trimmed analyses
            const serialized = JSON.stringify(newAnalyses);
            if (window.LZString) {
                const compressed = LZString.compressToUTF16(serialized);
                localStorage.setItem(ANALYSES_KEY, compressed);
            } else {
                localStorage.setItem(ANALYSES_KEY, serialized);
            }
        } else {
            // Save all analyses
            const serialized = JSON.stringify(analyses);
            if (window.LZString) {
                const compressed = LZString.compressToUTF16(serialized);
                localStorage.setItem(ANALYSES_KEY, compressed);
            } else {
                localStorage.setItem(ANALYSES_KEY, serialized);
            }
        }
        
        const totalAnalyses = Object.keys(analyses).length;
        console.log(`✅ Analysis saved (${totalAnalyses} total analyses stored)`);
        
        // Update storage info display if available
        exports.updateStorageDisplay();
        
        return sessionId;
    } catch (error) {
        console.error('Failed to save analysis:', error);
        return null;
    }
}

// Get all unique analyses
exports.getAllAnalyses = function() {
    try {
        let data;
        if (window.LZString) {
            const compressed = localStorage.getItem(ANALYSES_KEY);
            if (compressed) {
                const decompressed = LZString.decompressFromUTF16(compressed);
                if (decompressed) {
                    data = decompressed;
                }
            }
        }
        
        if (!data) {
            data = localStorage.getItem(ANALYSES_KEY);
        }
        
        return data ? JSON.parse(data) : {};
    } catch (error) {
        console.error('Failed to load analyses:', error);
        return {};
    }
}

// Check if files have been analyzed before
exports.findExistingAnalysis = function(files) {
    try {
        const fingerprint = generateFileFingerprint(files);
        console.log('🔐 Generated fingerprint for current files:', fingerprint);
        
        const analyses = exports.getAllAnalyses();
        console.log('🗃️ Existing analysis fingerprints:', Object.values(analyses).map(a => ({ 
            fingerprint: a.fingerprint, 
            period: a.period,
            created: a.created 
        })));
        
        // Find all analyses with matching fingerprint
        const matchingAnalyses = Object.values(analyses).filter(a => 
            a.fingerprint === fingerprint
        );
        
        if (matchingAnalyses.length > 0) {
            // Get the most recent analysis
            const mostRecent = matchingAnalyses.sort((a, b) => 
                new Date(b.updated || b.created) - new Date(a.updated || a.created)
            )[0];
            
            console.log(`📦 Found ${matchingAnalyses.length} existing analyse(s) for these files`);
            console.log(`  Most recent from ${mostRecent.updated || mostRecent.created}`);
            
            // Check if rules have changed
            const currentRules = requireModule('rulesModule').load();
            const rulesChanged = 
                currentRules.weekdayRate !== mostRecent.rules.wd ||
                currentRules.saturdayRate !== mostRecent.rules.sat ||
                currentRules.unloadingBonus !== mostRecent.rules.unl ||
                currentRules.attendanceBonus !== mostRecent.rules.att ||
                currentRules.earlyBonus !== mostRecent.rules.early;
            
            if (rulesChanged) {
                console.log('⚠️ Payment rules have changed since last analysis');
            }
            
            // Return the full analysis data for mobile
            return {
                analysis: {
                    results: mostRecent.results,
                    totals: mostRecent.totals,
                    metadata: mostRecent.metadata
                },
                rulesChanged,
                timestamp: new Date(mostRecent.updated || mostRecent.created).getTime(),
                previousCount: matchingAnalyses.length - 1
            };
        }
        
        return null;
    } catch (error) {
        console.error('Failed to check existing analysis:', error);
        return null;
    }
}

// ENHANCED: Export data with proper formatting
exports.exportData = function(currentAnalysisData = null, exportAll = false) {
    try {
        const analyses = exports.getAllAnalyses();
        const analysesArray = Object.values(analyses);
        
        let exportData;
        
        if (!exportAll && currentAnalysisData) {
            // Export current analysis with full details
            const rules = requireModule('rulesModule').load();
            exportData = {
                version: VERSION,
                exportDate: formatDate(Date.now()),
                exportType: 'current_analysis',
                analysis: currentAnalysisData,
                rules: rules,
                metadata: {
                    exportDate: formatDate(Date.now())
                }
            };
        } else {
            // Export all analyses
            exportData = {
                version: VERSION,
                exportDate: formatDate(Date.now()),
                exportType: 'all_analyses',
                totalAnalyses: analysesArray.length,
                analyses: analysesArray
            };
        }
        
        if (exportData) {
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = exportAll ? 
                `payment-analyses-all-${dateStr}.json` : 
                `payment-analysis-current-${dateStr}.json`;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log(`📊 Exported ${exportData.exportType}`);
            requireModule('uiModule').showToast(
                exportAll ? `Exported ${exportData.totalAnalyses} analyses` : 'Current analysis exported',
                'success'
            );
        }
        
    } catch (error) {
        console.error('Export failed:', error);
        requireModule('uiModule').showToast('Export failed', 'error');
    }
}

// Get storage info
exports.getStorageInfo = function() {
    try {
        const analyses = exports.getAllAnalyses();
        const savedState = exports.load();
        
        // Calculate storage size
        const analysesSize = localStorage.getItem(ANALYSES_KEY)?.length || 0;
        const stateSize = (localStorage.getItem(COMPRESSED_KEY) || 
                          localStorage.getItem(STORAGE_KEY))?.length || 0;
        
        return {
            version: VERSION,
            totalAnalyses: Object.keys(analyses).length,
            lastStateUpdate: savedState?.lastModified || 'Never',
            storageUsed: {
                analyses: `${(analysesSize / 1024).toFixed(2)} KB`,
                state: `${(stateSize / 1024).toFixed(2)} KB`,
                total: `${((analysesSize + stateSize) / 1024).toFixed(2)} KB`
            },
            compression: window.LZString ? 'Enabled' : 'Disabled'
        };
    } catch (error) {
        return { error: error.message };
    }
}

// Update storage display in settings modal
exports.updateStorageDisplay = function() {
    const info = exports.getStorageInfo();
    const totalAnalysesEl = document.getElementById('totalAnalysesCount');
    const storageUsedEl = document.getElementById('storageUsed');
    const compressionEl = document.getElementById('compressionStatus');
    const versionEl = document.getElementById('storageVersion');
    
    if (totalAnalysesEl) totalAnalysesEl.textContent = info.totalAnalyses;
    if (storageUsedEl) storageUsedEl.textContent = info.storageUsed?.total || '0 KB';
    if (compressionEl) compressionEl.textContent = info.compression || 'Unknown';
    if (versionEl) versionEl.textContent = VERSION;
}

exports.generateFileFingerprint = generateFileFingerprint;
exports.VERSION = VERSION;

// Selected week storage for week-specific reports
let selectedWeek = null;

exports.setSelectedWeek = function(weekInfo) {
    selectedWeek = weekInfo;
    console.log('📅 Selected week set:', weekInfo);
};

exports.getSelectedWeek = function() {
    return selectedWeek;
};

exports.clearSelectedWeek = function() {
    selectedWeek = null;
    console.log('📅 Selected week cleared');
};

// Filtered report storage for day/period-specific reports
let filteredReport = null;

exports.setFilteredReport = function(reportData) {
    filteredReport = reportData;
    console.log('📊 Filtered report set:', reportData.metadata?.periodRange);
};

exports.getFilteredReport = function() {
    return filteredReport;
};

exports.clearFilteredReport = function() {
    filteredReport = null;
    console.log('📊 Filtered report cleared');
};
</script>

<!-- Utilities Module - Date and time utilities for reports and analysis -->
<script id="utilitiesModule" type="application/x-module">
// Utilities Module - Common functions used across all pages

/**
 * Calculate the week number of the year from a Date object
 * @param {Date} date - The date to calculate the week for
 * @returns {number} - The week number of the year (1-53)
 */
function getWeekOfYear(date) {
    // Set date to start of the year
    const startOfYear = new Date(date.getFullYear(), 0, 1);
    // Set time to midnight to avoid timezone issues
    startOfYear.setHours(0, 0, 0, 0);
    date.setHours(0, 0, 0, 0);

    // Calculate days of the year considering timezone offset
    const dayOfYear = ((date - startOfYear) + ((startOfYear.getTimezoneOffset() - date.getTimezoneOffset()) * 60000)) / (1000 * 60 * 60 * 24);
    
    // Calculate week based on first day of the year
    const week = Math.ceil((dayOfYear + startOfYear.getDay() + 1) / 7);
    return week;
}

/**
 * Format date for display in reports
 * @param {Date|string|number} date - Date to format
 * @param {string} format - Desired format ('dd/mm/yyyy', 'yyyy-mm-dd', etc.)
 * @returns {string} - Formatted date
 */
function formatDateForDisplay(date, format = 'dd/mm/yyyy') {
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    
    switch (format) {
        case 'dd/mm/yyyy':
            return `${day}/${month}/${year}`;
        case 'yyyy-mm-dd':
            return `${year}-${month}-${day}`;
        case 'mm/dd/yyyy':
            return `${month}/${day}/${year}`;
        default:
            return `${day}/${month}/${year}`;
    }
}

/**
 * Group data by week of year
 * @param {Array} data - Array of objects with date property
 * @param {string} dateField - Name of the field containing the date
 * @returns {Object} - Data grouped by week
 */
function groupByWeek(data, dateField = 'date') {
    const grouped = {};
    
    data.forEach(item => {
        const date = new Date(item[dateField]);
        const week = getWeekOfYear(date);
        const year = date.getFullYear();
        const weekKey = `${year}-W${String(week).padStart(2, '0')}`;
        
        if (!grouped[weekKey]) {
            grouped[weekKey] = {
                week: week,
                year: year,
                weekKey: weekKey,
                startDate: getWeekStartDate(year, week),
                endDate: getWeekEndDate(year, week),
                items: []
            };
        }
        
        grouped[weekKey].items.push(item);
    });
    
    return grouped;
}

/**
 * Get week start date
 * @param {number} year - Year
 * @param {number} week - Week number
 * @returns {Date} - Start date of the week (Sunday)
 */
function getWeekStartDate(year, week) {
    const jan1 = new Date(year, 0, 1);
    const dayOfWeek = jan1.getDay();
    const firstWeekStart = new Date(year, 0, 1 - dayOfWeek);
    const weekStart = new Date(firstWeekStart.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
    return weekStart;
}

/**
 * Get week end date
 * @param {number} year - Year
 * @param {number} week - Week number
 * @returns {Date} - End date of the week (Saturday)
 */
function getWeekEndDate(year, week) {
    const weekStart = getWeekStartDate(year, week);
    const weekEnd = new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000);
    return weekEnd;
}

/**
 * Generate weekly summary report
 * @param {Object} weeklyData - Data grouped by week
 * @returns {Array} - Array with summary of each week
 */
function generateWeeklySummary(weeklyData) {
    const summary = [];
    
    Object.keys(weeklyData).sort().forEach(weekKey => {
        const weekData = weeklyData[weekKey];
        const totals = {
            count: weekData.items.length,
            totalAmount: 0,
            averageAmount: 0
        };
        
        // Calculate totals if items have numeric properties
        weekData.items.forEach(item => {
            if (item.amount && typeof item.amount === 'number') {
                totals.totalAmount += item.amount;
            }
        });
        
        totals.averageAmount = totals.count > 0 ? totals.totalAmount / totals.count : 0;
        
        summary.push({
            weekKey: weekKey,
            week: weekData.week,
            year: weekData.year,
            startDate: weekData.startDate,
            endDate: weekData.endDate,
            dateRange: `${formatDateForDisplay(weekData.startDate)} - ${formatDateForDisplay(weekData.endDate)}`,
            ...totals,
            items: weekData.items
        });
    });
    
    return summary;
}

// Export all functions
exports.getWeekOfYear = getWeekOfYear;
exports.formatDateForDisplay = formatDateForDisplay;
exports.groupByWeek = groupByWeek;
exports.getWeekStartDate = getWeekStartDate;
exports.getWeekEndDate = getWeekEndDate;
exports.generateWeeklySummary = generateWeeklySummary;

console.log('📅 Utilities Module loaded - Week calculation and reporting functions available');
</script>

<!-- Rules Module - COMPLETE from original v8.2 -->
<script id="rulesModule" type="application/x-module">
// Payment Rules Module
const RULES_KEY = 'pa:rules:v9';

const DEFAULT_RULES = {
    weekdayRate: 2.00,
    saturdayRate: 3.00,
    unloadingBonus: 30.00,
    attendanceBonus: 25.00,
    earlyBonus: 50.00
};

exports.load = function() {
    try {
        const saved = localStorage.getItem(RULES_KEY);
        if (saved) {
            return { ...DEFAULT_RULES, ...JSON.parse(saved) };
        }
    } catch (error) {
        console.error('Failed to load rules:', error);
    }
    return { ...DEFAULT_RULES };
}

exports.save = function(rules) {
    try {
        localStorage.setItem(RULES_KEY, JSON.stringify(rules));
        return true;
    } catch (error) {
        requireModule('uiModule').showToast('Could not save rules.', 'error');
        return false;
    }
}

exports.reset = function() {
    return exports.save(DEFAULT_RULES);
}

exports.getDefaults = function() {
    return { ...DEFAULT_RULES };
}
</script>

<!-- Parser Module - COMPLETE from original v8.2 with all validation -->
<script id="parserModule" type="application/x-module">
// PDF Parser Module - FIXED version with proper function scoping

// Define all functions as local constants first
const extractDocumentTotal = function(text) {
    const totalPatterns = [
        /Docket\s+Total:\s*([0-9,]+\.?\d*)/i,
        /GBP\s*([0-9,]+\.?\d*)\s*Total:/i,
        /Total:\s*GBP\s*([0-9,]+\.?\d*)/i,
        /Total:\s*([0-9,]+\.?\d*)/i
    ];
    
    for (const pattern of totalPatterns) {
        const match = text.match(pattern);
        if (match) {
            const amount = parseFloat(match[1].replace(/,/g, ''));
            if (amount > 0) {
                console.log(`📊 Document total found: £${amount.toFixed(2)}`);
                return amount;
            }
        }
    }
    
    console.log('⚠️ Document total not found');
    return null;
};

const extractTextFromPDF = async function(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    
    let fullText = '';
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
    }
    return fullText;
};

const extractDateFromRunsheet = function(text) {
    const match = text.match(/Date:\s*(\d{2}[-\/]\d{2}[-\/]\d{4})/);
    if (match) {
        const parts = match[1].replace(/\//g, '-').split('-');
        return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }
    return null;
};

const extractConsignmentsFromRunsheet = function(text) {
    const tokens = text.split(/\s+/);
    const consignmentsList = [];
    
    for (let i = 0; i < tokens.length - 1; i++) {
        const token = tokens[i];
        const nextToken = tokens[i + 1];
        
        if (/^\d+$/.test(token)) {
            const num = parseInt(token);
            
            if (/^\d{7}$/.test(nextToken) || /^AH\d+$/.test(nextToken)) {
                const nearbyTokens = tokens.slice(i, i + 10).join(' ');
                if (nearbyTokens.includes('Delivery') || nearbyTokens.includes('Collection')) {
                    consignmentsList.push({
                        number: num,
                        id: nextToken
                    });
                }
            }
        }
    }
    
    if (consignmentsList.length > 0) {
        console.log(`✅ Runsheet - Total deliveries: ${consignmentsList.length}`);
        console.log(`  First: ${consignmentsList.slice(0, 3).map(c => `#${c.number} ${c.id}`).join(', ')}`);
        console.log(`  Last: ${consignmentsList.slice(-3).map(c => `#${c.number} ${c.id}`).join(', ')}`);
    }
    
    return consignmentsList.length;
};

const extractInvoiceAmounts = function(text) {
    const amounts = {};
    const pickups = {};
    
    console.log('📄 Processing Invoice...');
    
    const documentTotal = extractDocumentTotal(text);
    
    const tokens = text.split(/\s+/);
    let currentDate = null;
    let currentTime = null;
    const processedExtraDrops = new Set();
    let serviceBlockOpen = false;
    
    for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        
        if (token === 'Docket' && i + 1 < tokens.length && tokens[i+1] === 'Total:') {
            console.log('  ✓ Reached invoice summary - stopping extraction');
            break;
        }
        
        if (/^\d{2}\/\d{2}\/\d{2}$/.test(token)) {
            if (i + 1 < tokens.length && /^\d{2}:\d{2}$/.test(tokens[i + 1])) {
                serviceBlockOpen = false;
                
                const [day, month, year] = token.split('/');
                currentDate = `20${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                currentTime = tokens[i + 1];
                serviceBlockOpen = true;
                
                const isPickup = i + 2 < tokens.length && tokens[i + 2] === '-PickUp';
                
                let foundAmount = false;
                for (let j = i + 2; j < Math.min(i + 30, tokens.length); j++) {
                    const checkToken = tokens[j];
                    
                    if (/^\d+\.\d+/.test(checkToken)) {
                        const match = checkToken.match(/^(\d+\.\d{2})/);
                        if (match) {
                            const amount = parseFloat(match[1]);
                            
                            if (amount >= 3 && amount <= 500) {
                                if (!amounts[currentDate]) amounts[currentDate] = 0;
                                amounts[currentDate] += amount;
                                
                                if (isPickup) {
                                    if (!pickups[currentDate]) {
                                        pickups[currentDate] = { count: 0, total: 0 };
                                    }
                                    pickups[currentDate].count++;
                                    pickups[currentDate].total += amount;
                                    console.log(`    🚚 ${currentDate}: +£${amount.toFixed(2)} (PickUp Service #${pickups[currentDate].count})`);
                                } else {
                                    const contextTokens = tokens.slice(i, j);
                                    let serviceType = 'Unknown';
                                    if (contextTokens.includes('Multidrops')) serviceType = 'Multidrops';
                                    else if (contextTokens.includes('Small') && contextTokens.includes('Van')) serviceType = 'Small Van';
                                    else if (contextTokens.includes('LWB')) serviceType = 'LWB Transit';
                                    
                                    console.log(`    💰 ${currentDate}: +£${amount.toFixed(2)} (${serviceType})`);
                                }
                                
                                foundAmount = true;
                                break;
                            }
                        }
                    }
                }
                
                if (!foundAmount && serviceBlockOpen) {
                    console.log(`    ⚠️ No valid amount found for ${currentDate} ${currentTime}`);
                }
            }
        }
        
        if (serviceBlockOpen && token === 'Extra' && i + 1 < tokens.length && tokens[i + 1] === 'Drops') {
            for (let m = i + 2; m < Math.min(i + 5, tokens.length); m++) {
                const extraMatch = tokens[m].match(/^(\d+\.\d{2})/);
                if (extraMatch) {
                    const extraAmount = parseFloat(extraMatch[1]);
                    if (extraAmount > 0 && extraAmount < 50) {
                        const extraKey = `${currentDate}|${currentTime}|${i}|${extraAmount}`;
                        if (!processedExtraDrops.has(extraKey) && currentDate) {
                            if (!amounts[currentDate]) amounts[currentDate] = 0;
                            amounts[currentDate] += extraAmount;
                            processedExtraDrops.add(extraKey);
                            console.log(`    🎯 ${currentDate}: +£${extraAmount.toFixed(2)} (Extra Drops)`);
                        }
                        break;
                    }
                }
            }
        }
        
        if (token === 'Carried' && i + 1 < tokens.length && tokens[i + 1] === 'Forward') {
            console.log('  📄 Found "Carried Forward" - multi-page invoice detected');
        }
    }
    
    const finalAmounts = {};
    let extractedTotal = 0;
    console.log('\n📊 Daily totals:');
    for (const [date, total] of Object.entries(amounts)) {
        finalAmounts[date] = Math.round(total * 100) / 100;
        extractedTotal += finalAmounts[date];
        console.log(`  ${date}: £${finalAmounts[date].toFixed(2)}`);
        if (pickups[date]) {
            console.log(`    └─ Includes ${pickups[date].count} pickup(s): £${pickups[date].total.toFixed(2)}`);
        }
    }
    
    let validationPassed = true;
    if (documentTotal !== null) {
        const difference = Math.abs(extractedTotal - documentTotal);
        const tolerance = 0.01;
        
        console.log(`\n🔍 VALIDATION RESULTS:`);
        console.log(`  Extracted total: £${extractedTotal.toFixed(2)}`);
        console.log(`  Document total:  £${documentTotal.toFixed(2)}`);
        console.log(`  Difference:      £${difference.toFixed(2)}`);
        
        if (difference > tolerance) {
            validationPassed = false;
            console.log(`  ❌ VALIDATION FAILED - Extraction mismatch detected!`);
            console.log(`  ⚠️ Amounts may be incorrect. Please review manually.`);
        } else {
            console.log(`  ✅ VALIDATION PASSED - Amounts match document total`);
        }
    } else {
        console.log('  ⚠️ Could not validate - document total not found');
    }
    
    if (Object.keys(finalAmounts).length === 0) {
        console.log('⚠️ No amounts found - check invoice format');
    }
    
    finalAmounts._validationPassed = validationPassed;
    finalAmounts._documentTotal = documentTotal;
    finalAmounts._extractedTotal = extractedTotal;
    finalAmounts._pickups = pickups;
    
    return finalAmounts;
};

const detectDocumentType = function(text, filename = '') {
    const name = filename.toLowerCase();
    
    // Check filename first
    if (name.includes('runsheet') || name.includes('dv_')) return 'runsheet';
    if (name.includes('self') || name.includes('invoice') || name.includes('bill')) return 'invoice';
    
    // Check content
    if (text.includes('Runsheet') || text.includes('Delivery') && text.includes('Collection')) {
        return 'runsheet';
    }
    if (text.includes('Invoice') || text.includes('Docket Total') || text.includes('GBP')) {
        return 'invoice';
    }
    
    return 'unknown';
};

const parseDocuments = async function(files, rules) {
    console.log('\n📄 Starting document parsing...');
    console.log(`Processing ${files.length} file(s)`);
    
    const results = { 
        items: [], 
        total: 0, 
        errors: [],
        filesCount: files.length,
        runsheets: {},
        invoices: {},
        pickups: {}
    };
    
    for (const file of files) {
        try {
            console.log(`\n📋 Processing: ${file.name}`);
            const text = await extractTextFromPDF(file);
            const type = detectDocumentType(text, file.name);
            console.log(`  Type detected: ${type}`);
            
            if (type === 'invoice') {
                console.log('  📊 Extracting invoice amounts...');
                const extractedData = extractInvoiceAmounts(text);
                const docTotal = extractedData._documentTotal || extractedData._extractedTotal || 0;
                
                console.log(`  Document total: £${docTotal?.toFixed(2) || '0.00'}`);
                console.log(`  Validation: ${extractedData._validationPassed ? '✅ PASSED' : '❌ FAILED'}`);
                
                results.items.push({
                    name: file.name,
                    type: 'invoice',
                    total: docTotal,
                    details: extractedData,
                    validationPassed: extractedData._validationPassed
                });
                
                // Store invoice amounts
                console.log('  💾 Storing invoice amounts in results...');
                let dailyCount = 0;
                for (const [date, amount] of Object.entries(extractedData)) {
                    if (!date.startsWith('_')) {
                        results.invoices[date] = amount;
                        dailyCount++;
                        console.log(`    ✓ ${date}: £${amount.toFixed(2)} stored in results.invoices`);
                    }
                }
                console.log(`  📊 Total days with payments stored: ${dailyCount}`);
                
                // Store pickup data if present
                if (extractedData._pickups) {
                    console.log('  🚚 Processing pickup data...');
                    let pickupCount = 0;
                    for (const [date, pickup] of Object.entries(extractedData._pickups)) {
                        results.pickups[date] = pickup;
                        pickupCount += pickup.count;
                        console.log(`    ✓ ${date}: ${pickup.count} pickup(s) = £${pickup.total.toFixed(2)}`);
                    }
                    console.log(`  📊 Total pickup services stored: ${pickupCount}`);
                }
                
                if (docTotal) {
                    results.total += docTotal;
                    console.log(`  💰 Running total: £${results.total.toFixed(2)}`);
                }
                
            } else if (type === 'runsheet') {
                console.log('  📦 Extracting runsheet data...');
                const date = extractDateFromRunsheet(text);
                const consignments = extractConsignmentsFromRunsheet(text);
                
                if (date) {
                    results.runsheets[date] = { consignments };
                    results.items.push({
                        name: file.name,
                        type: 'runsheet',
                        date,
                        consignments
                    });
                    console.log(`  ✓ Date: ${date}`);
                    console.log(`  ✓ Consignments: ${consignments}`);
                    console.log(`  ✓ Stored in results.runsheets[${date}]`);
                } else {
                    console.log('  ⚠️ Could not extract date from runsheet');
                }
            } else {
                console.log('  ⚠️ Unknown document type - skipping');
            }
        } catch (err) {
            console.error(`  ❌ Error processing ${file.name}:`, err);
            results.errors.push({
                name: file.name,
                error: String(err)
            });
        }
    }
    
    console.log('\n=== PARSING COMPLETE - FINAL RESULTS ===');
    console.log(`✅ Successfully processed: ${results.items.length} files`);
    console.log(`❌ Errors encountered: ${results.errors.length}`);
    console.log(`📊 Invoice days in results: ${Object.keys(results.invoices).length}`);
    if (Object.keys(results.invoices).length > 0) {
        console.log('  Invoice dates:', Object.keys(results.invoices).sort().join(', '));
    }
    console.log(`📦 Runsheet days in results: ${Object.keys(results.runsheets).length}`);
    if (Object.keys(results.runsheets).length > 0) {
        console.log('  Runsheet dates:', Object.keys(results.runsheets).sort().join(', '));
    }
    console.log(`🚚 Days with pickups: ${Object.keys(results.pickups).length}`);
    console.log(`💰 Grand total: £${results.total.toFixed(2)}`);
    console.log('=====================================\n');
    
    return results;
};

// Export all functions
exports.extractTextFromPDF = extractTextFromPDF;
exports.extractDateFromRunsheet = extractDateFromRunsheet;
exports.extractConsignmentsFromRunsheet = extractConsignmentsFromRunsheet;
exports.extractInvoiceAmounts = extractInvoiceAmounts;
exports.detectDocumentType = detectDocumentType;
exports.parseDocuments = parseDocuments;
</script>

<!-- UI Module - Enhanced for mobile with all original functions -->
<script id="uiModule" type="application/x-module">
// UI Module - Handles all DOM interactions for mobile and desktop
exports.showToast = function(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.className = 'toast';
    toast.classList.add(type);
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
};

exports.showLoading = function(show = true) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
};

exports.updateProgress = function(percent) {
    const bar = document.getElementById('progressBar');
    if (bar) bar.style.width = `${percent}%`;
};

exports.updateLoadingText = function(text) {
    const loadingText = document.getElementById('loadingText');
    if (loadingText) loadingText.textContent = text;
};

exports.showValidationAlert = function(message, type = 'warning') {
    const alert = document.getElementById('validationAlert');
    const messageElement = document.getElementById('validationMessage');
    
    if (alert && messageElement) {
        messageElement.textContent = message;
        alert.className = 'validation-alert show';
        
        if (type === 'error') {
            alert.classList.add('error');
        } else if (type === 'success') {
            alert.classList.add('success');
        }
    }
    
    // Update validation badge
    const badge = document.getElementById('analysisValidationBadge');
    if (badge) {
        badge.style.display = 'flex';
        badge.className = `validation-badge ${type === 'success' ? 'validated' : type === 'error' ? 'invalid' : ''}`;
        badge.querySelector('.badge-text').textContent = type === 'success' ? 'VALID' : type === 'error' ? 'ERROR' : 'PENDING';
    }
};

exports.hideValidationAlert = function() {
    const alert = document.getElementById('validationAlert');
    if (alert) alert.classList.remove('show');
    
    // Hide validation badge
    const badge = document.getElementById('analysisValidationBadge');
    if (badge) badge.style.display = 'none';
};

/**
 * Updates the file list display with enhanced preview functionality
 * @param {Array} files - Array of file objects with id, name, size properties
 */
exports.updateFileList = function(files) {
    try {
        const fileList = document.getElementById('fileList');
        if (!fileList) {
            console.error('File list element not found');
            return;
        }
        
        fileList.innerHTML = '';
    
    if (files.length === 0) {
        fileList.innerHTML = '<div class="empty-state"><div class="empty-message">No files selected</div></div>';
        document.getElementById('analysisPreview').style.display = 'none';
        document.getElementById('filesSection').style.display = 'none';
        return;
    }
    
    // Count file types
    let runsheets = 0;
    let invoices = 0;
    
    // Check for existing analysis to detect file updates
    const State = requireModule('stateModule');
    const savedState = State.load();
    const lastAnalysisFiles = savedState?.files?.uploaded || [];

    files.forEach(file => {
        const fileType = file.name.toLowerCase().includes('runsheet') ? 'runsheet' : 'invoice';
        if (fileType === 'runsheet') runsheets++;
        else invoices++;
        
        // Check if this file has been updated since last analysis
        const lastAnalyzedFile = lastAnalysisFiles.find(f => 
            f.name === file.name && f.size === file.size
        );
        
        const currentFileModified = file.file?.lastModified || 0;
        const isFileUpdated = lastAnalyzedFile && 
            currentFileModified > 0 && 
            (!lastAnalyzedFile.lastModified || currentFileModified > lastAnalyzedFile.lastModified);
        
        // Debug logging for file update detection
        if (lastAnalyzedFile) {
            console.log(`📄 File ${file.name}:`, {
                isUpdated: isFileUpdated,
                currentModified: new Date(currentFileModified).toLocaleString(),
                lastModified: lastAnalyzedFile.lastModified ? new Date(lastAnalyzedFile.lastModified).toLocaleString() : 'Unknown'
            });
        }
        
        const div = document.createElement('div');
        div.className = 'file-item';
        // Sanitize file name to prevent XSS
        const safeName = file.name.replace(/[<>]/g, '');
        const safeId = String(file.id).replace(/[<>"']/g, '');
        
        // Add update indicator if file has been modified
        const updateIndicator = isFileUpdated ? 
            '<div class="file-update-indicator" title="File has been updated since last analysis">!</div>' : '';
        
        const iconClass = isFileUpdated ? 'file-icon updated' : 'file-icon';
        
        div.innerHTML = `
            <div class="${iconClass}">
                ${fileType === 'runsheet' ? '📦' : '💰'}
                ${updateIndicator}
            </div>
            <div class="file-info">
                <div class="file-name">${safeName}</div>
                <div class="file-details">
                    <span class="file-size">${(file.size / 1024).toFixed(1)}KB</span>
                    <span class="file-type-badge ${fileType}">
                        ${fileType === 'runsheet' ? 'Runsheet' : 'Invoice'}
                    </span>
                    ${isFileUpdated ? '<span class="file-update-badge">Updated</span>' : ''}
                </div>
            </div>
            <button class="file-remove" data-file-id="${safeId}" aria-label="Remove ${safeName}">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" aria-hidden="true">
                    <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        `;
        fileList.appendChild(div);
    });
    
    // Show files section and analysis preview
    document.getElementById('filesSection').style.display = 'block';
    document.getElementById('filesCount').textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
    const preview = document.getElementById('analysisPreview');
    preview.style.display = 'block';
    
    document.getElementById('previewTotalFiles').textContent = files.length;
    document.getElementById('previewRunsheets').textContent = runsheets;
    document.getElementById('previewInvoices').textContent = invoices;
    
    // Update validation badge
    const validationBadge = document.getElementById('previewValidationBadge');
    if (runsheets > 0 && invoices > 0) {
        validationBadge.className = 'validation-badge valid';
        validationBadge.innerHTML = '<span class="badge-icon">✓</span><span class="badge-text">Ready</span>';
        document.getElementById('previewStatus').textContent = 'Ready to analyze';
    } else {
        validationBadge.className = 'validation-badge invalid';
        validationBadge.innerHTML = '<span class="badge-icon">⚠️</span><span class="badge-text">Incomplete</span>';
        document.getElementById('previewStatus').textContent = runsheets === 0 ? 'Missing runsheets' : 'Missing invoices';
    }
    } catch (error) {
        console.error('Error updating file list:', error);
        // Show user-friendly error message
        const fileList = document.getElementById('fileList');
        if (fileList) {
            fileList.innerHTML = '<div class="empty-state"><div class="empty-message">Error updating file list</div></div>';
        }
    }
};

/**
 * Updates the manual entries list display
 * @param {Array} entries - Array of manual entry objects
 */
exports.updateManualEntriesList = function(entries) {
    try {
        const entriesList = document.getElementById('manualEntriesList');
        if (!entriesList) {
            console.error('Manual entries list element not found');
            return;
        }
        
        entriesList.innerHTML = '';
        
        if (entries.length === 0) {
            entriesList.innerHTML = '<div class="empty-state"><div class="empty-message">No manual entries added</div></div>';
            return;
        }
        
        entries.forEach(entry => {
            const div = document.createElement('div');
            div.className = 'manual-entry-item';
            
            // Calculate totals for this entry
            const totalDeliveries = parseInt(entry.deliveries) || 0;
            const totalPayments = (parseFloat(entry.basePayment) || 0) + (parseFloat(entry.bonusPayment) || 0);
            
            // Format date
            const entryDate = new Date(entry.date);
            const formattedDate = entryDate.toLocaleDateString('en-GB', {
                weekday: 'short',
                day: '2-digit',
                month: 'short'
            });
            
            div.innerHTML = `
                <div class="entry-info">
                    <div class="entry-date">${formattedDate}</div>
                    <div class="entry-details">
                        <span class="deliveries-count">${totalDeliveries} deliveries</span>
                        <span class="payment-amount">£${totalPayments.toFixed(2)}</span>
                    </div>
                </div>
                <button class="entry-remove" data-entry-id="${entry.id}" aria-label="Remove entry for ${formattedDate}">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" aria-hidden="true">
                        <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            `;
            entriesList.appendChild(div);
        });
        
        console.log(`📝 Updated manual entries list: ${entries.length} entries displayed`);
        
    } catch (error) {
        console.error('Error updating manual entries list:', error);
        const entriesList = document.getElementById('manualEntriesList');
        if (entriesList) {
            entriesList.innerHTML = '<div class="empty-state"><div class="empty-message">Error updating entries list</div></div>';
        }
    }
};

/**
 * Renders the comprehensive financial analysis report
 * @param {Object} data - Analysis data object containing results, totals, and metadata
 * @param {Array} data.results - Daily breakdown results
 * @param {Object} data.totals - Summary totals and calculations
 * @param {Object} data.metadata - Report metadata (period, dates, etc.)
 */
exports.renderReport = function(data) {
    // Cache DOM elements for better performance
    const content = document.getElementById('reportsContent');
    const emptyState = document.getElementById('emptyReportState');
    const reportContainer = document.getElementById('reportContainer');
    
    // Set date attribute for printing
    content.setAttribute('data-date', new Date().toLocaleDateString('en-GB'));
    
    if (!data || !data.results) {
        emptyState.style.display = 'block';
        reportContainer.style.display = 'none';
        return;
    }
    
    const { results, totals, metadata } = data;
    
    // Hide empty state, show report
    emptyState.style.display = 'none';
    reportContainer.style.display = 'block';
    
    // Update report header
    const reportTitle = document.querySelector('.report-title');
    if (reportTitle) {
        // Debug metadata
        console.log('🎯 Report metadata for title:', metadata);
        
        // Set appropriate title based on metadata
        if (metadata.weekInfo) {
            console.log(`📅 Setting week title: Week ${metadata.weekInfo.week}, ${metadata.weekInfo.year}`);
            reportTitle.innerHTML = `<span class="week-title">Week ${metadata.weekInfo.week}, ${metadata.weekInfo.year}</span>`;
        } else if (metadata.totalDays === 1 && metadata.periodRange) {
            // Single day report
            console.log(`📅 Setting day title: ${metadata.periodRange}`);
            reportTitle.innerHTML = `<span class="week-title">${metadata.periodRange}</span>`;
        } else if (metadata.periodRange) {
            console.log('📅 Setting generic Payment Analysis Report title');
            reportTitle.innerHTML = `<span class="week-title">Payment Analysis Report</span>`;
        } else {
            console.log('📅 Setting fallback Financial Analysis Report title');
            reportTitle.innerHTML = `<span class="week-title">Financial Analysis Report</span>`;
        }
    }
    
    document.getElementById('reportPeriod').textContent = metadata.periodRange || '-';
    document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-GB');
    document.getElementById('reportDays').textContent = metadata.totalDays || '0';
    document.getElementById('reportStatus').textContent = (totals.differenceTotal || 0) >= 0 ? 'Balanced' : 'Discrepancy';
    
    // Update KPIs
    document.getElementById('reportKpiExpected').textContent = `£${(totals.expectedTotal || 0).toFixed(2)}`;
    document.getElementById('reportKpiPaid').textContent = `£${(totals.paidTotal || 0).toFixed(2)}`;
    document.getElementById('reportKpiDifference').textContent = `£${Math.abs(totals.differenceTotal || 0).toFixed(2)}`;
    document.getElementById('kpiConsignments').textContent = totals.totalConsignments || '0';
    
    // Update KPI subtitles
    const avgConsignments = (totals.workingDays || 0) > 0 ? 
        Math.round((totals.totalConsignments || 0) / (totals.workingDays || 1)) : 0;
    document.getElementById('kpiConsignmentsSub').textContent = `Avg: ${avgConsignments}/day`;
    
    // Update difference card style
    const diffCard = document.getElementById('reportKpiDifferenceCard');
    const trendElement = document.getElementById('kpiTrend');
    
    if ((totals.differenceTotal || 0) >= 0) {
        diffCard.classList.add('kpi-primary');
        trendElement.className = 'kpi-trend positive';
        document.getElementById('kpiTrendText').textContent = '✓ Positive balance';
    } else {
        diffCard.classList.remove('kpi-primary');
        trendElement.className = 'kpi-trend negative';
        document.getElementById('kpiTrendText').textContent = '✗ Negative balance';
    }
    
    // Update comprehensive table
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    results.forEach(row => {
        const tr = document.createElement('tr');
        
        let status;
        if ((row.difference || 0) >= 0) {
            status = '<span class="status-badge reconciled">✓ OK</span>';
        } else if (Math.abs(row.difference || 0) <= 5) {
            status = '<span class="status-badge pending">⚠ Minor</span>';
        } else {
            status = '<span class="status-badge error">✗ Review</span>';
        }
        
        let pickupDisplay = (row.pickupTotal || 0) > 0 
            ? `£${(row.pickupTotal || 0).toFixed(2)} (${row.pickupCount || 0})` 
            : '-';
        
        tr.innerHTML = `
            <td class="date-cell">${row.date.split('-').reverse().join('/')}</td>
            <td>${row.day}</td>
            <td class="amount-cell">${row.consignments || '-'}</td>
            <td class="amount-cell">£${(row.rate || 0).toFixed(2)}</td>
            <td class="amount-cell">£${(row.basePayment || 0).toFixed(2)}</td>
            <td class="amount-cell">${pickupDisplay}</td>
            <td class="amount-cell">£${(row.totalBonus || 0).toFixed(2)}</td>
            <td class="amount-cell">£${(row.expectedTotal || 0).toFixed(2)}</td>
            <td class="amount-cell">£${(row.paidAmount || 0).toFixed(2)}</td>
            <td class="amount-cell ${(row.difference || 0) >= 0 ? 'positive' : 'negative'}">
                ${(row.difference || 0) >= 0 ? '+' : ''}£${Math.abs(row.difference || 0).toFixed(2)}
            </td>
            <td>${status}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Update footer totals
    document.getElementById('footerConsignments').textContent = totals.totalConsignments || '0';
    document.getElementById('footerBase').textContent = `£${(totals.baseTotal || 0).toFixed(2)}`;
    document.getElementById('footerPickups').textContent = `£${(totals.pickupTotal || 0).toFixed(2)}`;
    document.getElementById('footerBonuses').textContent = `£${(totals.bonusTotal || 0).toFixed(2)}`;
    document.getElementById('footerExpected').textContent = `£${(totals.expectedTotal || 0).toFixed(2)}`;
    document.getElementById('footerPaid').textContent = `£${(totals.paidTotal || 0).toFixed(2)}`;
    document.getElementById('footerDifference').textContent = 
        `${(totals.differenceTotal || 0) >= 0 ? '+' : ''}£${Math.abs(totals.differenceTotal || 0).toFixed(2)}`;
    
    // Update settlement breakdown
    document.getElementById('breakdownConsignments').textContent = `£${(totals.baseTotal || 0).toFixed(2)}`;
    document.getElementById('breakdownPickups').textContent = `£${(totals.pickupTotal || 0).toFixed(2)}`;
    document.getElementById('breakdownUnloading').textContent = `£${(totals.unloadingTotal || 0).toFixed(2)}`;
    document.getElementById('breakdownAttendance').textContent = `£${(totals.attendanceTotal || 0).toFixed(2)}`;
    document.getElementById('breakdownEarly').textContent = `£${(totals.earlyTotal || 0).toFixed(2)}`;
    document.getElementById('breakdownTotal').textContent = `£${(totals.expectedTotal || 0).toFixed(2)}`;
};

exports.renderHistory = function() {
    const historyList = document.getElementById('historyList');
    const analyses = requireModule('stateModule').getAllAnalyses();
    const analysesArray = Object.values(analyses);
    
    if (analysesArray.length === 0) {
        historyList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">📜</div>
                <div class="empty-title">No History</div>
                <div class="empty-message">Your analysis history will appear here</div>
            </div>
        `;
        return;
    }
    
    // Extract all day-level entries from analyses (avoiding duplicates)
    const dayEntries = [];
    const processedDays = new Set(); // Track processed day-analysis combinations
    
    analysesArray.forEach(analysis => {
        if (analysis.details && analysis.details.daily) {
            // File-based analyses have details.daily structure
            analysis.details.daily.forEach(dayResult => {
                const currentYear = new Date().getFullYear();
                const [month, day] = dayResult.d.split('-');
                const fullDate = new Date(currentYear, parseInt(month) - 1, parseInt(day));
                const dayKey = `${analysis.id}-${fullDate.toISOString().split('T')[0]}`;
                
                if (!processedDays.has(dayKey)) {
                    processedDays.add(dayKey);
                    dayEntries.push({
                        date: fullDate,
                        dateString: fullDate.toISOString().split('T')[0],
                        analysisId: analysis.id,
                        totalAmount: dayResult.e || 0,  // e = expectedTotal
                        consignments: dayResult.c || 0,  // c = consignments
                        periodRange: analysis.period || 'Unknown Period',
                        createdAt: analysis.created
                    });
                }
            });
        } else if (analysis.period && !analysis.details) {
            // Manual entries without details.daily - extract individual days from period range
            const periodParts = analysis.period.split(' - ');
            if (periodParts.length === 2) {
                try {
                    // Parse dates in DD/MM/YYYY format
                    const startParts = periodParts[0].split('/');
                    const endParts = periodParts[1].split('/');
                    
                    const startDate = new Date(startParts[2], startParts[1] - 1, startParts[0]);
                    const endDate = new Date(endParts[2], endParts[1] - 1, endParts[0]);
                    
                    // Calculate working days (exclude Sundays)
                    let workingDays = 0;
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() !== 0) { // Not Sunday
                            workingDays++;
                        }
                    }
                    
                    // Calculate average per working day
                    const avgAmount = (analysis.summary?.expected || 0) / workingDays;
                    const avgConsignments = Math.round((analysis.summary?.consignments || 0) / workingDays);
                    
                    // Create entry for each working day
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() !== 0) { // Not Sunday
                            const dayKey = `${analysis.id}-${new Date(d).toISOString().split('T')[0]}`;
                            
                            if (!processedDays.has(dayKey)) {
                                processedDays.add(dayKey);
                                dayEntries.push({
                                    date: new Date(d),
                                    dateString: new Date(d).toISOString().split('T')[0],
                                    analysisId: analysis.id,
                                    totalAmount: avgAmount,
                                    consignments: avgConsignments,
                                    periodRange: analysis.period,
                                    createdAt: analysis.created
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Error parsing period dates:', error);
                }
            }
        }
    });
    
    // Sort all entries by date (most recent first)
    dayEntries.sort((a, b) => b.date - a.date);
    
    // Group by week and show with collapsible structure
    const Utils = requireModule('utilitiesModule');
    const groupedByWeek = Utils.groupByWeek(dayEntries, 'dateString');
    
    // Sort weeks by most recent first
    const sortedWeeks = Object.values(groupedByWeek).sort((a, b) => {
        if (a.year !== b.year) return b.year - a.year;
        return b.week - a.week;
    });
    
    // Determine if we need month grouping (more than 4 weeks)
    const needsMonthGrouping = sortedWeeks.length > 4;
    
    if (!needsMonthGrouping) {
        // Show all weeks directly
        const html = sortedWeeks.map(weekData => generateWeekHTML(weekData, Utils)).join('');
        historyList.innerHTML = html;
    } else {
        // Group weeks by month, show current month expanded, others collapsed
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        const monthGroups = {};
        
        sortedWeeks.forEach(weekData => {
            const weekStartDate = new Date(weekData.startDate);
            const monthKey = `${weekStartDate.getFullYear()}-${weekStartDate.getMonth()}`;
            
            if (!monthGroups[monthKey]) {
                monthGroups[monthKey] = {
                    year: weekStartDate.getFullYear(),
                    month: weekStartDate.getMonth(),
                    weeks: []
                };
            }
            monthGroups[monthKey].weeks.push(weekData);
        });
        
        const sortedMonths = Object.values(monthGroups).sort((a, b) => {
            if (a.year !== b.year) return b.year - a.year;
            return b.month - a.month;
        });
        
        const html = sortedMonths.map(monthData => {
            const isCurrentMonth = monthData.month === currentMonth && monthData.year === currentYear;
            return generateMonthHTML(monthData, Utils, isCurrentMonth);
        }).join('');
        
        historyList.innerHTML = html;
    }
};

// Helper functions for week and month HTML generation
function generateWeekHTML(weekData, Utils) {
    const startDate = Utils.formatDateForDisplay(new Date(weekData.startDate), 'short');
    const endDate = Utils.formatDateForDisplay(new Date(weekData.endDate), 'short');
    
    // Calculate totals for the week
    const weekTotals = weekData.items.reduce((acc, dayEntry) => ({
        totalAmount: acc.totalAmount + dayEntry.totalAmount,
        totalConsignments: acc.totalConsignments + dayEntry.consignments,
        totalDays: acc.totalDays + 1
    }), { totalAmount: 0, totalConsignments: 0, totalDays: 0 });
    
    // Sort days by date for chronological display
    const sortedDays = weekData.items.sort((a, b) => new Date(a.dateString) - new Date(b.dateString));
    
    const weekId = `week-${weekData.year}-${weekData.week}`;
    
    return `
        <div class="week-group">
            <div class="week-header" data-week-id="${weekId}">
                <div class="week-info">
                    <h3 class="week-title">Week ${weekData.week}, ${weekData.year}</h3>
                    <div class="week-dates">${startDate} - ${endDate}</div>
                </div>
                <div class="week-summary">
                    <span class="week-stats">${weekTotals.totalDays} days</span>
                    <span class="week-total">£${weekTotals.totalAmount.toFixed(2)}</span>
                    <div class="week-toggle">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="week-days" id="${weekId}" style="display: none;">
                ${sortedDays.map(dayEntry => {
                    const formattedDate = dayEntry.date.toLocaleDateString('en-GB', {
                        weekday: 'short',
                        day: '2-digit',
                        month: 'short'
                    });
                    
                    return `
                        <div class="history-item" data-analysis-id="${dayEntry.analysisId}" data-day-date="${dayEntry.dateString}">
                            <div class="history-date">${formattedDate}</div>
                            <div class="history-period">${dayEntry.date.toLocaleDateString('en-GB')}</div>
                            <div class="history-stats">
                                <span>${dayEntry.consignments} consignments</span>
                                <span class="history-total">£${dayEntry.totalAmount.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function generateMonthHTML(monthData, Utils, isCurrentMonth = false) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    const monthName = monthNames[monthData.month];
    const monthId = `month-${monthData.year}-${monthData.month}`;
    
    // Calculate month totals
    const monthTotals = monthData.weeks.reduce((acc, weekData) => {
        const weekTotal = weekData.items.reduce((weekAcc, dayEntry) => ({
            amount: weekAcc.amount + dayEntry.totalAmount,
            consignments: weekAcc.consignments + dayEntry.consignments,
            days: weekAcc.days + 1
        }), { amount: 0, consignments: 0, days: 0 });
        
        return {
            amount: acc.amount + weekTotal.amount,
            consignments: acc.consignments + weekTotal.consignments,
            days: acc.days + weekTotal.days,
            weeks: acc.weeks + 1
        };
    }, { amount: 0, consignments: 0, days: 0, weeks: 0 });
    
    const weeksHTML = monthData.weeks.map(weekData => generateWeekHTML(weekData, Utils)).join('');
    
    return `
        <div class="month-group">
            <div class="month-header ${isCurrentMonth ? 'expanded' : ''}" data-month-id="${monthId}">
                <div class="month-info">
                    <h2 class="month-title">${monthName} ${monthData.year}</h2>
                    <span class="month-stats">${monthTotals.weeks} weeks, ${monthTotals.days} days</span>
                </div>
                <div class="month-summary">
                    <span class="month-total">£${monthTotals.amount.toFixed(2)}</span>
                    <div class="month-toggle">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="month-content" id="${monthId}" style="display: ${isCurrentMonth ? 'block' : 'none'};">
                ${weeksHTML}
            </div>
        </div>
    `;
}

exports.showRecoveryBanner = function(timestamp) {
    const banner = document.getElementById('recoveryBanner');
    const text = document.getElementById('recoveryText');
    
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    let timeAgo;
    if (days > 0) timeAgo = `${days} day${days > 1 ? 's' : ''} ago`;
    else if (hours > 0) timeAgo = `${hours} hour${hours > 1 ? 's' : ''} ago`;
    else if (minutes > 0) timeAgo = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    else timeAgo = 'just now';
    
    text.textContent = `Restored your last analysis from ${timeAgo}`;
    banner.classList.add('show');
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        if (banner.classList.contains('show')) {
            banner.classList.remove('show');
        }
    }, 10000);
};

exports.hideRecoveryBanner = function() {
    const banner = document.getElementById('recoveryBanner');
    banner.classList.remove('show');
};

exports.updateSettingsForm = function(rules) {
    document.getElementById('weekdayRate').value = rules.weekdayRate.toFixed(2);
    document.getElementById('saturdayRate').value = rules.saturdayRate.toFixed(2);
    document.getElementById('unloadingBonus').value = rules.unloadingBonus.toFixed(2);
    document.getElementById('attendanceBonus').value = rules.attendanceBonus.toFixed(2);
    document.getElementById('earlyBonus').value = rules.earlyBonus.toFixed(2);
};

exports.getSettingsFormData = function() {
    return {
        weekdayRate: parseFloat(document.getElementById('weekdayRate').value) || 0,
        saturdayRate: parseFloat(document.getElementById('saturdayRate').value) || 0,
        unloadingBonus: parseFloat(document.getElementById('unloadingBonus').value) || 0,
        attendanceBonus: parseFloat(document.getElementById('attendanceBonus').value) || 0,
        earlyBonus: parseFloat(document.getElementById('earlyBonus').value) || 0
    };
};
</script>

<!-- Dashboard Module - Enhanced with chart visualizations -->
<script id="dashboardModule" type="application/x-module">
// Dashboard Module with enhanced features
let currentView = 'monthly'; // 'monthly' or 'weekly'
let currentCalendarMonth = new Date();
let selectedAnalysisId = null; // null = show all analyses, string = show specific analysis

exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('dashboard', {
        onLoad: () => {
            console.log('📊 Loading dashboard');
            // Set initial view to update period display correctly
            setView(currentView);
        }
    });
    
    // View toggle
    const monthlyToggleBtn = document.getElementById('monthlyToggle');
    if (monthlyToggleBtn) {
        monthlyToggleBtn.addEventListener('click', () => {
            setView('monthly');
        });
    }
    
    const weeklyToggleBtn = document.getElementById('weeklyToggle');
    if (weeklyToggleBtn) {
        weeklyToggleBtn.addEventListener('click', () => {
            setView('weekly');
        });
    }
    
    // Calendar navigation
    const calPrevBtn = document.getElementById('calPrev');
    if (calPrevBtn) {
        calPrevBtn.addEventListener('click', () => {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
            console.log('📅 Calendar: Previous month selected -', currentCalendarMonth.toLocaleDateString());
            renderCalendar();
            // Update period display and refresh all dashboard data
            setView(currentView);
        });
    }
    
    const calNextBtn = document.getElementById('calNext');
    if (calNextBtn) {
        calNextBtn.addEventListener('click', () => {
            // Only navigate if button is not disabled
            if (!calNextBtn.disabled) {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
                console.log('📅 Calendar: Next month selected -', currentCalendarMonth.toLocaleDateString());
                renderCalendar();
                // Update period display and refresh all dashboard data
                setView(currentView);
            }
        });
    }
    
    // Action buttons
    const refreshDashboardBtn = document.getElementById('refreshDashboard');
    if (refreshDashboardBtn) {
        refreshDashboardBtn.addEventListener('click', exports.refresh);
    }
    const quickAnalyzeBtn = document.getElementById('quickAnalyze');
    if (quickAnalyzeBtn) {
        quickAnalyzeBtn.addEventListener('click', () => {
            Router.navigate('analysis');
        });
    }
    const quickManualEntryBtn = document.getElementById('quickManualEntry');
    if (quickManualEntryBtn) {
        quickManualEntryBtn.addEventListener('click', () => {
            Router.navigate('analysis');
            // Set to manual mode and trigger manual entry
            setTimeout(() => {
                const analysisModule = requireModule('analysisModule');
                if (analysisModule.setInputMethod) {
                    analysisModule.setInputMethod('manual');
                }
            }, 100);
        });
    }
    const viewReportsBtn = document.getElementById('viewReports');
    if (viewReportsBtn) {
        viewReportsBtn.addEventListener('click', () => {
            Router.navigate('history');
        });
    }
    const emptyGetStartedBtn = document.getElementById('emptyGetStarted');
    if (emptyGetStartedBtn) {
        emptyGetStartedBtn.addEventListener('click', () => {
            Router.navigate('analysis');
        });
    }
    
    // Second "Get Started" button
    const emptyGetStartedSecondBtn = document.getElementById('emptyGetStartedSecond');
    if (emptyGetStartedSecondBtn) {
        emptyGetStartedSecondBtn.addEventListener('click', () => {
            Router.navigate('analysis');
        });
    }
    
    // Clear analysis filter button
    const clearAnalysisFilterBtn = document.getElementById('clearAnalysisFilter');
    if (clearAnalysisFilterBtn) {
        clearAnalysisFilterBtn.addEventListener('click', () => {
            exports.clearAnalysisSelection();
        });
    }
};

// Function to set selected analysis for dashboard filtering
exports.setSelectedAnalysis = function(analysisId) {
    selectedAnalysisId = analysisId;
    console.log('📊 Dashboard: Selected analysis changed to', analysisId || 'All analyses');
    
    // Filter indicator removed - not needed
    
    // Set calendar to the month of the selected analysis
    if (analysisId) {
        const State = requireModule('stateModule');
        const analyses = State.getAllAnalyses();
        const analysis = analyses[analysisId];
        
        if (analysis && analysis.metadata && analysis.metadata.createdAt) {
            const analysisDate = new Date(analysis.metadata.createdAt);
            currentCalendarMonth = new Date(analysisDate.getFullYear(), analysisDate.getMonth(), 1);
            console.log('📅 Calendar set to analysis month:', currentCalendarMonth.toLocaleDateString());
        }
    }
    
    // Refresh dashboard to show data from selected analysis
    setView(currentView);
};

// Function to clear analysis selection (show all data)
exports.clearAnalysisSelection = function() {
    selectedAnalysisId = null;
    console.log('📊 Dashboard: Showing all analyses data');
    
    // Filter indicator removed - not needed
    
    setView(currentView);
};

function setView(view) {
    currentView = view;
    
    // Remove any existing tooltips when view changes
    const existingTooltips = document.querySelectorAll('.calendar-tooltip, .chart-tooltip');
    existingTooltips.forEach(tooltip => {
        tooltip.remove();
    });
    
    // Update toggle buttons
    document.getElementById('monthlyToggle').classList.toggle('active', view === 'monthly');
    document.getElementById('weeklyToggle').classList.toggle('active', view === 'weekly');
    
    // Update period text with selected calendar month
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    if (view === 'monthly') {
        const selectedMonthName = monthNames[currentCalendarMonth.getMonth()];
        const selectedYear = currentCalendarMonth.getFullYear();
        const currentYear = new Date().getFullYear();
        
        // Show year only if different from current year
        if (selectedYear === currentYear) {
            document.getElementById('summaryPeriod').textContent = selectedMonthName;
        } else {
            document.getElementById('summaryPeriod').textContent = `${selectedMonthName} ${selectedYear}`;
        }
    } else {
        const selectedMonthName = monthNames[currentCalendarMonth.getMonth()];
        document.getElementById('summaryPeriod').textContent = `${selectedMonthName} Week`;
    }
    
    // Refresh data for new view
    exports.refresh();
}

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const monthYearEl = document.getElementById('calendarMonth');
    
    // Remove any existing tooltips when calendar re-renders
    const existingTooltips = document.querySelectorAll('.calendar-tooltip');
    existingTooltips.forEach(tooltip => {
        tooltip.remove();
    });
    
    // Clear tooltip markers from calendar days
    document.querySelectorAll('[data-tooltip-shown]').forEach(el => {
        el.removeAttribute('data-tooltip-shown');
    });
    
    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    monthYearEl.textContent = `${monthNames[currentCalendarMonth.getMonth()]} ${currentCalendarMonth.getFullYear()}`;
    
    // Clear grid
    grid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 1);
    const lastDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Get data for this month
    const State = requireModule('stateModule');
    const analyses = State.getAllAnalyses();
    const datesWithData = new Set();
    
    Object.values(analyses).forEach(analysis => {
        if (analysis.details && analysis.details.daily) {
            analysis.details.daily.forEach(result => {
                // Convert shortened date format (MM-DD) to full date
                const year = new Date().getFullYear();
                const [month, day] = result.d.split('-');
                const date = new Date(year, parseInt(month) - 1, parseInt(day));
                
                if (date.getMonth() === currentCalendarMonth.getMonth() && 
                    date.getFullYear() === currentCalendarMonth.getFullYear()) {
                    datesWithData.add(date.getDate());
                }
            });
        }
    });
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        grid.appendChild(emptyDay);
    }
    
    // Add days of month
    const today = new Date();
    const todayString = today.toDateString();
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = day;
        
        // Create date for this day
        const dayDate = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), day);
        const dayString = dayDate.toDateString();
        
        // Check if this is today
        if (dayString === todayString) {
            dayEl.classList.add('today');
        }
        
        // Check if this date is in the future
        if (dayDate > today) {
            dayEl.classList.add('future');
        } else {
            // Check if this day has data
            if (datesWithData.has(day)) {
                dayEl.classList.add('has-data', 'clickable');
                // Add click handler for days with data
                dayEl.addEventListener('click', () => showDayData(dayDate, day));
            } else {
                // Only add no-data class for past/present days without data
                dayEl.classList.add('no-data');
                // Add click handler for days without data
                dayEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showAddDataTooltip(dayEl, dayDate);
                });
            }
        }
        
        grid.appendChild(dayEl);
    }
    
    // Update navigation button states
    updateCalendarNavigation();
}

// Function to update calendar navigation button states
function updateCalendarNavigation() {
    const calNextBtn = document.getElementById('calNext');
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    if (calNextBtn) {
        // Get the next month that would be navigated to
        const nextMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 1);
        const nextMonthValue = nextMonth.getMonth();
        const nextYearValue = nextMonth.getFullYear();
        
        // Disable next button if next month would be beyond current month
        const isNextMonthBeyondCurrent = nextYearValue > currentYear || 
                                        (nextYearValue === currentYear && nextMonthValue > currentMonth);
        
        if (isNextMonthBeyondCurrent) {
            calNextBtn.disabled = true;
            calNextBtn.classList.add('disabled');
        } else {
            calNextBtn.disabled = false;
            calNextBtn.classList.remove('disabled');
        }
    }
}

// Function to show data for a specific day
function showDayData(date, day) {
    const State = requireModule('stateModule');
    const analyses = State.getAllAnalyses();
    
    // Find data for this specific day
    let dayData = [];
    
    Object.entries(analyses).forEach(([analysisId, analysis]) => {
        if (analysis.details && analysis.details.daily) {
            analysis.details.daily.forEach(result => {
                // Convert shortened date format (MM-DD) to full date for comparison
                const year = currentCalendarMonth.getFullYear();
                const [month, dayOfMonth] = result.d.split('-');
                const resultDate = new Date(year, parseInt(month) - 1, parseInt(dayOfMonth));
                
                if (resultDate.getTime() === date.getTime()) {
                    dayData.push({
                        analysisId,
                        analysisName: analysis.metadata?.fileName || `Analysis ${analysisId}`,
                        data: result
                    });
                }
            });
        }
    });
    
    if (dayData.length > 0) {
        showDayDataModal(date, dayData);
    }
}

// Global tooltip cleanup system
let activeTooltipCleanup = null;

// Function to show tooltip for days without data
function showAddDataTooltip(dayElement, date) {
    // Check if tooltip already exists for this element
    if (dayElement.hasAttribute('data-tooltip-shown')) {
        // Second click - navigate directly
        navigateToManualEntry(date);
        return;
    }
    
    // Mark that tooltip has been shown for this element
    dayElement.setAttribute('data-tooltip-shown', 'true');
    
    // Clean up any existing tooltip handlers
    if (activeTooltipCleanup) {
        activeTooltipCleanup();
        activeTooltipCleanup = null;
    }
    
    // Remove any existing tooltips
    const existingTooltips = document.querySelectorAll('.calendar-tooltip');
    existingTooltips.forEach(tooltip => {
        tooltip.remove();
    });
    
    // Remove tooltip markers from other elements
    document.querySelectorAll('[data-tooltip-shown]').forEach(el => {
        if (el !== dayElement) {
            el.removeAttribute('data-tooltip-shown');
        }
    });
    
    // Create tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'calendar-tooltip';
    tooltip.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">No data for ${date.toLocaleDateString()}</div>
        <div style="font-size: 11px; color: rgba(255,255,255,0.8);">Click again to add data manually</div>
    `;
    
    // Add tooltip to DOM first to get its dimensions
    tooltip.style.visibility = 'hidden';
    tooltip.style.position = 'absolute';
    document.body.appendChild(tooltip);
    
    // Get dimensions and viewport info
    const rect = dayElement.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    const tooltipRect = tooltip.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Calculate initial position (centered below the day element)
    let left = rect.left + rect.width / 2 + scrollLeft;
    let top = rect.bottom + scrollTop + 8;
    
    // Check if tooltip would overflow on the right
    if (left + tooltipRect.width / 2 > viewportWidth + scrollLeft) {
        left = viewportWidth + scrollLeft - tooltipRect.width / 2 - 10; // 10px margin from edge
    }
    
    // Check if tooltip would overflow on the left
    if (left - tooltipRect.width / 2 < scrollLeft) {
        left = scrollLeft + tooltipRect.width / 2 + 10; // 10px margin from edge
    }
    
    // Check if tooltip would overflow on the bottom
    if (rect.bottom + tooltipRect.height + 8 > viewportHeight) {
        // Position above the element instead
        top = rect.top + scrollTop - tooltipRect.height - 8;
        // Update arrow position
        tooltip.classList.add('above');
    }
    
    // Apply final position
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
    tooltip.style.transform = 'translateX(-50%)';
    tooltip.style.visibility = 'visible';
    
    // Show tooltip with animation
    setTimeout(() => tooltip.classList.add('show'), 10);
    
    // Remove tooltip after 8 seconds (longer duration for readability)
    setTimeout(() => {
        if (activeTooltipCleanup === cleanupFunction) {
            tooltip.classList.remove('show');
            setTimeout(() => {
                if (activeTooltipCleanup === cleanupFunction) {
                    cleanupFunction();
                    activeTooltipCleanup = null;
                }
            }, 200);
        }
    }, 300);
    
    // Create cleanup function for this tooltip
    const removeTooltip = (e) => {
        // Check if elements still exist and if click is outside
        if (tooltip.parentNode && dayElement.parentNode && 
            !dayElement.contains(e.target) && !tooltip.contains(e.target)) {
            tooltip.classList.remove('show');
            setTimeout(() => {
                if (tooltip.parentNode) {
                    tooltip.remove();
                    if (dayElement.parentNode) {
                        dayElement.removeAttribute('data-tooltip-shown');
                    }
                }
            }, 200);
            // Clean up global reference
            if (activeTooltipCleanup === cleanupFunction) {
                activeTooltipCleanup = null;
            }
            document.removeEventListener('click', removeTooltip);
        }
    };
    
    const cleanupFunction = () => {
        if (tooltip.parentNode) {
            tooltip.remove();
        }
        if (dayElement.parentNode) {
            dayElement.removeAttribute('data-tooltip-shown');
        }
        document.removeEventListener('click', removeTooltip);
    };
    
    // Store cleanup function globally
    activeTooltipCleanup = cleanupFunction;
    
    setTimeout(() => document.addEventListener('click', removeTooltip), 100);
}

// Function to navigate to manual entry with pre-filled date
function navigateToManualEntry(date) {
    // Remove all tooltips before navigating
    const allTooltips = document.querySelectorAll('.calendar-tooltip, .chart-tooltip');
    allTooltips.forEach(tooltip => {
        tooltip.remove();
    });
    
    const Router = requireModule('routerModule');
    Router.navigate('analysis');
    
    // Set to manual mode and open the manual entry modal
    setTimeout(() => {
        const analysisModule = requireModule('analysisModule');
        if (analysisModule.setInputMethod) {
            analysisModule.setInputMethod('manual');
            
            // Open the manual entry modal
            if (analysisModule.showManualEntryModal) {
                analysisModule.showManualEntryModal();
                
                // Pre-fill the date if possible
                setTimeout(() => {
                    const dateInput = document.getElementById('entryDate');
                    if (dateInput) {
                        // Format date as YYYY-MM-DD for input field
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        dateInput.value = `${year}-${month}-${day}`;
                        
                        // Also update the day field
                        const dayInput = document.getElementById('entryDay');
                        if (dayInput) {
                            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                            dayInput.value = days[date.getDay()];
                        }
                        
                        // Recalculate totals after filling the date
                        calculateManualEntryTotals();
                    }
                }, 150);
            }
        }
    }, 100);
}

// Function to show modal with day data
function showDayDataModal(date, dayData) {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    `;
    
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'manual-entry-modal';
    modal.innerHTML = `
        <div class="modal-header">
            <div class="modal-title">
                <span class="modal-icon">📅</span>
                Data for ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
            </div>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
        </div>
        <div class="modal-body">
            <div class="day-data-content">
                ${dayData.map(item => `
                    <div class="day-data-item" style="
                        border: 1px solid var(--slate-200);
                        border-radius: 8px;
                        padding: 16px;
                        margin-bottom: 12px;
                        background: var(--slate-50);
                    ">
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 8px;">
                            ${item.analysisName}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;">
                            <div>
                                <span style="color: var(--slate-600);">Amount:</span>
                                <strong style="color: var(--success);">£${item.data.a || '0'}</strong>
                            </div>
                            <div>
                                <span style="color: var(--slate-600);">Type:</span>
                                <strong>${item.data.t || 'N/A'}</strong>
                            </div>
                        </div>
                        <button onclick="editDayData('${item.analysisId}', '${item.data.d}')" style="
                            background: var(--accent);
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            font-size: 12px;
                            margin-top: 8px;
                            cursor: pointer;
                        ">Edit</button>
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="modal-footer" style="padding: 20px 24px; border-top: 1px solid var(--slate-200);">
            <button onclick="this.closest('.modal-overlay').remove()" style="
                background: var(--slate-200);
                color: var(--slate-700);
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
            ">Close</button>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Close modal when clicking overlay
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.remove();
        }
    });
}

// Global function to edit day data
window.editDayData = function(analysisId, dateString) {
    // Close the modal
    const modal = document.querySelector('.modal-overlay');
    if (modal) modal.remove();
    
    // Navigate to analysis page and show the specific analysis
    const Router = requireModule('routerModule');
    Router.navigate('analysis');
    
    // Show the specific analysis for editing
    setTimeout(() => {
        const analysisModule = requireModule('analysisModule');
        if (analysisModule.showAnalysis) {
            analysisModule.showAnalysis(analysisId);
        }
    }, 100);
};

function renderChart(data) {
    const chartContainer = document.getElementById('revenueChart');
    chartContainer.innerHTML = '';
    
    // Debug logging to understand data structure
    console.log('📊 Chart data received:', data);
    console.log('📊 Current view:', currentView);
    console.log('📊 Current calendar month:', currentCalendarMonth.toLocaleDateString());
    
    // Get data points based on view
    let dataPoints = currentView === 'weekly' ? getWeeklyData(data) : getMonthlyData(data);
    
    console.log('📊 Chart data points generated:', dataPoints);
    
    if (dataPoints.length === 0 || dataPoints.every(d => d.expected === 0 && d.actual === 0)) {
        const totalDataAvailable = Object.values(data).some(analysis => 
            analysis.details && analysis.details.daily && analysis.details.daily.length > 0
        );
        
        const emptyMessage = totalDataAvailable 
            ? `No data for ${currentView === 'monthly' ? currentCalendarMonth.toLocaleDateString('en-US', {month: 'long', year: 'numeric'}) : 'selected week'}`
            : 'No payment data available - upload PDF files to see charts';
            
        chartContainer.innerHTML = `<div class="empty-chart" style="text-align: center; padding: 40px; color: var(--slate-500); font-size: 14px;">${emptyMessage}</div>`;
        return;
    }
    
    // Find max value for scaling
    const maxValue = Math.max(...dataPoints.map(d => Math.max(d.expected, d.actual)), 1);
    
    // Define gradient styles as CSS
    const expectedGradient = 'linear-gradient(180deg, #3b82f6 0%, #2563eb 100%)';
    const actualGradient = 'linear-gradient(180deg, rgba(16, 185, 129, 0.8) 0%, rgba(5, 150, 105, 0.8) 100%)';
    
    // Render bars with animations - Simplified structure to match CSS expectations
    dataPoints.forEach((point, index) => {
        const column = document.createElement('div');
        column.className = 'bar-column';
        column.style.cssText = `
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            opacity: 1;
            transform: translateY(0);
            animation-delay: ${index * 50}ms;
        `;
        
        // Create a wrapper for the two bars (expected and actual)
        const barsWrapper = document.createElement('div');
        barsWrapper.style.cssText = `
            display: flex;
            align-items: flex-end;
            justify-content: center;
            height: 100px;
            width: 100%;
            padding: 0 4px;
        `;
        
        // Expected bar with enhanced styling
        const expectedBar = document.createElement('div');
        const expectedHeight = Math.max(8, (point.expected / maxValue) * 85); // Min 8px, max 85px for label space
        expectedBar.style.cssText = `
            height: ${expectedHeight}px;
            background: ${expectedGradient};
            width: 45%;
            min-height: 8px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
            transition: all 0.3s ease;
            margin-right: 4px;
        `;
        expectedBar.setAttribute('data-value', `£${point.expected.toFixed(0)}`);
        expectedBar.title = `Expected: £${point.expected.toFixed(0)}`;
        
        // Expected bar hover effects
        expectedBar.addEventListener('mouseenter', () => {
            expectedBar.style.transform = 'scaleY(1.05)';
            expectedBar.style.filter = 'brightness(1.1)';
            expectedBar.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        });
        expectedBar.addEventListener('mouseleave', () => {
            expectedBar.style.transform = 'scaleY(1)';
            expectedBar.style.filter = 'brightness(1)';
            expectedBar.style.boxShadow = '0 2px 6px rgba(59, 130, 246, 0.25)';
        });
        
        // Actual bar with enhanced styling
        const actualBar = document.createElement('div');
        const actualHeight = Math.max(8, (point.actual / maxValue) * 85); // Min 8px, max 85px for label space
        actualBar.style.cssText = `
            height: ${actualHeight}px;
            background: ${actualGradient};
            width: 45%;
            min-height: 8px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
            transition: all 0.3s ease;
            margin-left: 4px;
        `;
        actualBar.setAttribute('data-value', `£${point.actual.toFixed(0)}`);
        actualBar.title = `Actual: £${point.actual.toFixed(0)}`;
        
        // Actual bar hover effects
        actualBar.addEventListener('mouseenter', () => {
            actualBar.style.transform = 'scaleY(1.05)';
            actualBar.style.filter = 'brightness(1.1)';
            actualBar.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
        });
        actualBar.addEventListener('mouseleave', () => {
            actualBar.style.transform = 'scaleY(1)';
            actualBar.style.filter = 'brightness(1)';
            actualBar.style.boxShadow = '0 2px 6px rgba(16, 185, 129, 0.25)';
        });
        
        // Value labels on top of bars (show for any meaningful value)
        if (point.expected > 0) {
            const expectedLabel = document.createElement('div');
            expectedLabel.style.cssText = `
                position: absolute;
                top: -18px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 10px;
                font-weight: 600;
                color: #3b82f6;
                white-space: nowrap;
                pointer-events: none;
                background: rgba(255, 255, 255, 0.9);
                padding: 1px 4px;
                border-radius: 3px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            `;
            expectedLabel.textContent = `£${point.expected.toFixed(0)}`;
            expectedBar.appendChild(expectedLabel);
        }
        
        if (point.actual > 0) {
            const actualLabel = document.createElement('div');
            actualLabel.style.cssText = `
                position: absolute;
                top: -18px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 10px;
                font-weight: 600;
                color: #10b981;
                white-space: nowrap;
                pointer-events: none;
                background: rgba(255, 255, 255, 0.9);
                padding: 1px 4px;
                border-radius: 3px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            `;
            actualLabel.textContent = `£${point.actual.toFixed(0)}`;
            actualBar.appendChild(actualLabel);
        }
        
        // Debug logging for bar heights
        console.log(`📊 Bar ${point.label}: Expected ${point.expected} (${expectedHeight}px), Actual ${point.actual} (${actualHeight}px), MaxValue: ${maxValue}`);
        
        // Click handlers
        expectedBar.addEventListener('click', (e) => {
            showChartTooltip(e, `Expected: £${point.expected.toFixed(2)}`);
        });
        
        actualBar.addEventListener('click', (e) => {
            showChartTooltip(e, `Actual: £${point.actual.toFixed(2)}`);
        });
        
        // Label
        const label = document.createElement('div');
        label.className = 'bar-label';
        label.style.cssText = `
            margin-top: 8px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            color: var(--slate-600);
        `;
        label.textContent = point.label;
        
        // Assemble the structure
        barsWrapper.appendChild(expectedBar);
        barsWrapper.appendChild(actualBar);
        column.appendChild(barsWrapper);
        column.appendChild(label);
        chartContainer.appendChild(column);
    });
}

function showChartTooltip(event, text) {
    const tooltip = document.createElement('div');
    tooltip.className = 'chart-tooltip';
    tooltip.textContent = text;
    tooltip.style.cssText = `
        position: fixed;
        left: ${event.clientX}px;
        top: ${event.clientY - 40}px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 9999;
        pointer-events: none;
        animation: fadeIn 0.2s;
    `;
    document.body.appendChild(tooltip);
    
    setTimeout(() => tooltip.remove(), 2000);
}

function getWeeklyData(analyses) {
    const data = [];
    // Use mid-month of selected calendar month for weekly view
    const midMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 15);
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(midMonth);
        date.setDate(midMonth.getDate() - i);
        
        let expected = 0;
        let actual = 0;
        
        // Sum up data for this day across all analyses
        Object.values(analyses).forEach(analysis => {
            if (analysis.details && analysis.details.daily) {
                analysis.details.daily.forEach(result => {
                    // Convert shortened date format (MM-DD) to full date
                    // Use the calendar year being viewed, not current year
                    const year = currentCalendarMonth.getFullYear();
                    const [month, day] = result.d.split('-');
                    const resultDate = new Date(year, parseInt(month) - 1, parseInt(day));
                    
                    // Also check previous year for data
                    const prevYearDate = new Date(year - 1, parseInt(month) - 1, parseInt(day));
                    
                    if (resultDate.toDateString() === date.toDateString() || 
                        prevYearDate.toDateString() === date.toDateString()) {
                        expected += result.e || 0;  // expectedTotal -> e
                        actual += result.p || 0;    // paidAmount -> p
                    }
                });
            }
        });
        
        data.push({
            label: dayNames[date.getDay()],
            expected: expected,
            actual: actual
        });
    }
    
    return data;
}

function getMonthlyData(analyses) {
    const data = [];
    // Use the selected calendar month to show its weeks
    const monthStart = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 1);
    
    for (let i = 3; i >= 0; i--) {
        const weekStart = new Date(monthStart);
        weekStart.setDate(monthStart.getDate() + (i * 7));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        let expected = 0;
        let actual = 0;
        
        // Sum up data for this week across all analyses
        Object.values(analyses).forEach(analysis => {
            if (analysis.details && analysis.details.daily) {
                analysis.details.daily.forEach(result => {
                    // Convert shortened date format (MM-DD) to full date
                    // Use the calendar year being viewed, not current year
                    const year = currentCalendarMonth.getFullYear();
                    const [month, day] = result.d.split('-');
                    const resultDate = new Date(year, parseInt(month) - 1, parseInt(day));
                    
                    // Also check previous year for data
                    const prevYearDate = new Date(year - 1, parseInt(month) - 1, parseInt(day));
                    
                    if ((resultDate >= weekStart && resultDate <= weekEnd) || 
                        (prevYearDate >= weekStart && prevYearDate <= weekEnd)) {
                        expected += result.e || 0;  // expectedTotal -> e
                        actual += result.p || 0;    // paidAmount -> p
                    }
                });
            }
        });
        
        data.push({
            label: `W${4-i}`,
            expected: expected,
            actual: actual
        });
    }
    
    return data;
}

function calculateForecasts(analyses) {
    // Simple forecasting based on historical averages
    const analysesArray = Object.values(analyses);
    if (analysesArray.length === 0) {
        return {
            nextWeek: 0,
            monthEnd: 0,
            dailyTarget: 0
        };
    }
    
    // Calculate average daily revenue
    let totalRevenue = 0;
    let totalDays = 0;
    
    analysesArray.forEach(analysis => {
        if (analysis.totals) {
            totalRevenue += analysis.totals.expectedTotal || 0;
            totalDays += analysis.metadata?.totalDays || 0;
        }
    });
    
    const avgDaily = totalDays > 0 ? totalRevenue / totalDays : 0;
    
    // Simple forecasts based on selected calendar month
    const nextWeek = avgDaily * 5; // 5 working days
    const selectedMonthLastDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 0).getDate();
    const selectedMonthCurrentDay = Math.min(new Date().getDate(), selectedMonthLastDay);
    const daysLeftInSelectedMonth = selectedMonthLastDay - selectedMonthCurrentDay;
    const monthEnd = avgDaily * Math.min(daysLeftInSelectedMonth, 20); // Max 20 working days
    const dailyTarget = avgDaily * 1.1; // 10% growth target
    
    return {
        nextWeek,
        monthEnd,
        dailyTarget
    };
}

exports.refresh = function() {
    try {
        const State = requireModule('stateModule');
        const allAnalyses = State.getAllAnalyses();
        
        // Filter analyses based on selection
        let analyses, analysesArray;
        if (selectedAnalysisId) {
            // Show only selected analysis
            const selectedAnalysis = allAnalyses[selectedAnalysisId];
            if (selectedAnalysis) {
                analyses = { [selectedAnalysisId]: selectedAnalysis };
                analysesArray = [selectedAnalysis];
                console.log('📊 Dashboard refresh - showing selected analysis:', selectedAnalysisId);
            } else {
                console.warn('📊 Selected analysis not found, showing all analyses');
                analyses = allAnalyses;
                analysesArray = Object.values(allAnalyses);
                selectedAnalysisId = null; // Reset invalid selection
            }
        } else {
            // Show all analyses
            analyses = allAnalyses;
            analysesArray = Object.values(allAnalyses);
            console.log('📊 Dashboard refresh - showing all analyses:', analysesArray.length);
        }
        
        if (analysesArray.length > 0) {
            console.log('📊 Sample analysis structure:', analysesArray[0]);
        }
        
        // Check if we have data
        const hasData = analysesArray.length > 0;
    const dashboardContent = document.getElementById('dashboardContent');
    const emptyState = document.getElementById('dashboardEmpty');
    
    if (!hasData) {
        // Show empty state, hide all dashboard content
        document.querySelector('.view-toggle').style.display = 'none';
        document.querySelector('.executive-summary').style.display = 'none';
        document.querySelector('.calendar-widget').style.display = 'none';
        document.querySelector('.kpi-grid').style.display = 'none';
        document.querySelector('.chart-container').style.display = 'none';
        document.querySelector('.forecast-card').style.display = 'none';
        document.querySelector('.quick-actions').style.display = 'none';
        emptyState.style.display = 'block';
        
        // Clear navigation badges when no data
        const Router = requireModule('routerModule');
        Router.setNavBadge('reports', null);
        Router.setNavBadge('history', null);
        
        return;
    }
    
    // Hide empty state and show content
    document.querySelector('.view-toggle').style.display = 'flex';
    document.querySelector('.executive-summary').style.display = 'block';
    document.querySelector('.calendar-widget').style.display = 'block';
    document.querySelector('.kpi-grid').style.display = 'grid';
    document.querySelector('.chart-container').style.display = 'block';
    document.querySelector('.forecast-card').style.display = 'block';
    document.querySelector('.quick-actions').style.display = 'block';
    emptyState.style.display = 'none';
    
    // Set navigation badges when data is available
    const Router = requireModule('routerModule');
    Router.setNavBadge('reports', analysesArray.length);
    Router.setNavBadge('history', analysesArray.length);
    
    // Calculate metrics based on current view and selected calendar month
    const now = new Date();
    let periodStart, periodEnd;
    
    if (currentView === 'monthly') {
        // Use the selected calendar month instead of current month
        periodStart = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 1);
        periodEnd = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 0);
    } else {
        // Weekly view: Show 7 days from the selected calendar month (use 15th as middle point)
        const midMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 15);
        periodStart = new Date(midMonth);
        periodStart.setDate(midMonth.getDate() - 6);
        periodEnd = new Date(midMonth);
    }
    
    // Calculate totals for current period
    let currentRevenue = 0;
    let currentDeliveries = 0;
    let currentExpected = 0;
    let currentPaid = 0;
    let daysWithData = 0;
    
    analysesArray.forEach(analysis => {
        if (analysis.details && analysis.details.daily) {
            analysis.details.daily.forEach(result => {
                // Convert shortened date format (MM-DD) to full date
                const year = new Date().getFullYear();
                const [month, day] = result.d.split('-');
                const resultDate = new Date(year, parseInt(month) - 1, parseInt(day));
                
                if (resultDate >= periodStart && resultDate <= periodEnd) {
                    currentRevenue += result.e || 0;  // expectedTotal -> e
                    currentDeliveries += result.c || 0;  // consignments -> c
                    currentExpected += result.e || 0;
                    currentPaid += result.p || 0;  // paidAmount -> p
                    daysWithData++;
                }
            });
        }
    });
    
    // Calculate previous period for comparison
    let prevPeriodStart, prevPeriodEnd;
    if (currentView === 'monthly') {
        prevPeriodStart = new Date(periodStart);
        prevPeriodStart.setMonth(prevPeriodStart.getMonth() - 1);
        prevPeriodEnd = new Date(periodStart);
        prevPeriodEnd.setDate(prevPeriodEnd.getDate() - 1);
    } else {
        prevPeriodStart = new Date(periodStart);
        prevPeriodStart.setDate(prevPeriodStart.getDate() - 7);
        prevPeriodEnd = new Date(periodStart);
        prevPeriodEnd.setDate(prevPeriodEnd.getDate() - 1);
    }
    
    let prevRevenue = 0;
    let prevDeliveries = 0;
    
    analysesArray.forEach(analysis => {
        if (analysis.details && analysis.details.daily) {
            analysis.details.daily.forEach(result => {
                // Convert shortened date format (MM-DD) to full date
                const year = new Date().getFullYear();
                const [month, day] = result.d.split('-');
                const resultDate = new Date(year, parseInt(month) - 1, parseInt(day));
                
                if (resultDate >= prevPeriodStart && resultDate <= prevPeriodEnd) {
                    prevRevenue += result.e || 0;  // expectedTotal -> e
                    prevDeliveries += result.c || 0;  // consignments -> c
                }
            });
        }
    });
    
    // Calculate changes
    const revenueChangePercent = prevRevenue > 0 ? ((currentRevenue - prevRevenue) / prevRevenue * 100) : 0;
    const deliveriesChangePercent = prevDeliveries > 0 ? ((currentDeliveries - prevDeliveries) / prevDeliveries * 100) : 0;
    const avgDaily = daysWithData > 0 ? currentRevenue / daysWithData : 0;
    const performance = currentExpected > 0 ? (currentPaid / currentExpected * 100) : 0;
    
    // Update Executive Summary
    document.getElementById('summaryRevenue').textContent = `£${currentRevenue.toFixed(2)}`;
    document.getElementById('summaryDaily').textContent = `£${avgDaily.toFixed(2)}`;
    document.getElementById('summaryDeliveries').textContent = currentDeliveries.toString();
    document.getElementById('summaryPerformance').textContent = `${performance.toFixed(0)}%`;
    
    // Update change indicators
    const revenueChangeEl = document.getElementById('revenueChange');
    revenueChangeEl.textContent = `${revenueChangePercent >= 0 ? '↑' : '↓'} ${Math.abs(revenueChangePercent).toFixed(0)}%`;
    revenueChangeEl.className = `summary-stat-change ${revenueChangePercent >= 0 ? 'positive' : 'negative'}`;
    
    const deliveriesChangeEl = document.getElementById('deliveriesChange');
    deliveriesChangeEl.textContent = `${deliveriesChangePercent >= 0 ? '↑' : '↓'} ${Math.abs(deliveriesChangePercent).toFixed(0)}%`;
    deliveriesChangeEl.className = `summary-stat-change ${deliveriesChangePercent >= 0 ? 'positive' : 'negative'}`;
    
    // Update KPIs
    document.getElementById('kpiExpected').textContent = `£${currentExpected.toFixed(2)}`;
    document.getElementById('kpiReceived').textContent = `£${currentPaid.toFixed(2)}`;
    document.getElementById('kpiPending').textContent = `£${Math.max(0, currentExpected - currentPaid).toFixed(2)}`;
    document.getElementById('kpiEfficiency').textContent = `${Math.min(100, performance).toFixed(0)}%`;
    
    // Update trends
    document.getElementById('expectedTrend').innerHTML = `<span>${revenueChangePercent >= 0 ? '↑' : '↓'}</span><span>${Math.abs(revenueChangePercent).toFixed(0)}% vs last</span>`;
    document.getElementById('efficiencyTrend').innerHTML = `<span>↑</span><span>${performance >= 95 ? 'Excellent' : performance >= 85 ? 'Good' : 'Needs Review'}</span>`;
    
    // Render calendar
    renderCalendar();
    
    // Render chart
    renderChart(analyses);
    
    // Debug logging for data verification
    if (selectedAnalysisId) {
        console.log('📊 Dashboard showing single analysis data:', {
            analysisId: selectedAnalysisId,
            dateRange: `${periodStart.toLocaleDateString()} - ${periodEnd.toLocaleDateString()}`,
            dataPoints: analysesArray.length
        });
    }
    
    // Calculate and update forecasts
    const forecasts = calculateForecasts(analyses);
    document.getElementById('forecastWeek').textContent = `£${forecasts.nextWeek.toFixed(2)}`;
    document.getElementById('forecastMonth').textContent = `£${forecasts.monthEnd.toFixed(2)}`;
    document.getElementById('forecastTarget').textContent = `£${forecasts.dailyTarget.toFixed(2)}`;
    
    } catch (error) {
        console.error('Dashboard refresh error:', error);
        // Show user-friendly error
        requireModule('uiModule').showToast('Dashboard update failed', 'error');
    }
};

/**
 * Generate weekly statistics for the dashboard using utilitiesModule
 * This function demonstrates how to use the week grouping functions
 */
exports.generateWeeklyStatistics = function() {
    const Utils = requireModule('utilitiesModule');
    const State = requireModule('stateModule');
    
    try {
        // Get all saved analyses
        const analyses = State.getAllAnalyses();
        
        if (!analyses || analyses.length === 0) {
            console.log('📅 No analyses available for weekly statistics');
            return null;
        }
        
        // Convert analyses to appropriate format for grouping
        const dataForWeeks = [];
        analyses.forEach(analysis => {
            if (analysis.metadata && analysis.metadata.runsheetDate) {
                dataForWeeks.push({
                    date: analysis.metadata.runsheetDate,
                    amount: analysis.summary ? (analysis.summary.totalExpected || 0) : 0,
                    analysisId: analysis.id,
                    created: analysis.created
                });
            } else if (analysis.created) {
                // If no runsheetDate, use creation date
                dataForWeeks.push({
                    date: analysis.created,
                    amount: analysis.summary ? (analysis.summary.totalExpected || 0) : 0,
                    analysisId: analysis.id,
                    created: analysis.created
                });
            }
        });
        
        if (dataForWeeks.length === 0) {
            console.log('📅 No valid date data found for weekly statistics');
            return null;
        }
        
        // Use Reports Module function to generate weekly report
        const Reports = requireModule('reportsModule');
        const weeklyReport = Reports.generateWeeklyReport(dataForWeeks, 'date');
        
        // Log statistics for debugging
        console.log('📊 Weekly Statistics Generated:', {
            totalWeeks: weeklyReport.summary.totalWeeks,
            totalAnalyses: weeklyReport.summary.totalItems,
            currentWeek: weeklyReport.summary.currentWeek,
            averagePerWeek: weeklyReport.summary.averageItemsPerWeek
        });
        
        // Show current week statistics
        const currentWeekData = weeklyReport.weeks.find(w => w.weekKey === weeklyReport.summary.currentWeekKey);
        
        if (currentWeekData) {
            const message = `📅 Week ${currentWeekData.week}: ${currentWeekData.count} analyses (${Utils.formatDateForDisplay(currentWeekData.startDate)} - ${Utils.formatDateForDisplay(currentWeekData.endDate)})`;
            console.log('Current week info:', message);
        }
        
        return weeklyReport;
        
    } catch (error) {
        console.error('Error generating weekly statistics:', error);
        return null;
    }
};

/**
 * Demonstrate the use of getWeekOfYear function directly
 * Can be called via console for testing: requireModule('dashboardModule').testWeekCalculation()
 */
exports.testWeekCalculation = function() {
    const Utils = requireModule('utilitiesModule');
    
    // Example with the date from the original comment (August 23, 2025)
    const myDate = new Date(2025, 7, 23); // August 23, 2025 (month is 0-indexed)
    const weekNumber = Utils.getWeekOfYear(myDate);
    
    const result = {
        date: Utils.formatDateForDisplay(myDate),
        week: weekNumber,
        message: `The date ${Utils.formatDateForDisplay(myDate)} is in week ${weekNumber} of the year.`
    };
    
    console.log('🧪 Test Week Calculation:', result);
    
    // Also test with current date
    const currentDate = new Date();
    const currentWeek = Utils.getWeekOfYear(currentDate);
    
    console.log(`📅 Current week: ${currentWeek} (Date: ${Utils.formatDateForDisplay(currentDate)})`);
    
    return result;
};
</script>

<!-- Analysis Module - Enhanced with all production features -->
<script id="analysisModule" type="application/x-module">
// Analysis Module - Enhanced with production features
let uploadedFiles = [];
let manualEntries = [];
let lastAnalysisData = null;
let hasBeenAnalyzed = false;
let currentFilesSignature = null;
let currentStep = 1;
let currentInputMethod = 'upload'; // 'upload' or 'manual'

// Helper function to safely update UI elements
function safeUpdateFileList() {
    const fileListElement = document.getElementById('fileList');
    if (fileListElement) {
        requireModule('uiModule').updateFileList(uploadedFiles);
    }
}

function safeUpdateManualEntriesList() {
    const manualEntriesElement = document.getElementById('manualEntriesList');
    if (manualEntriesElement) {
        requireModule('uiModule').updateManualEntriesList(manualEntries);
    }
}

// File management
function detectFileType(filename) {
    const name = filename.toLowerCase();
    if (name.includes('runsheet') || name.includes('dv_')) return 'runsheet';
    if (name.includes('self') || name.includes('invoice') || name.includes('bill')) return 'invoice';
    return 'unknown';
}

// Step management functions
function updateSteps() {
    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber < currentStep) {
            step.classList.add('completed');
        } else if (stepNumber === currentStep) {
            step.classList.add('active');
        }
    });
}

function setStep(stepNumber) {
    if (stepNumber >= 1 && stepNumber <= 3) {
        currentStep = stepNumber;
        updateSteps();
        
        // Show/hide relevant sections based on step
        const uploadSection = document.querySelector('.upload-section-enhanced');
        const validateSection = document.querySelector('.validate-section');
        const analyzeSection = document.querySelector('.analyze-section');
        
        if (uploadSection) uploadSection.style.display = stepNumber === 1 ? 'block' : 'none';
        if (validateSection) validateSection.style.display = stepNumber === 2 ? 'block' : 'none';
        if (analyzeSection) analyzeSection.style.display = stepNumber === 3 ? 'block' : 'none';
        
        // Populate Step 2 content when entering step 2
        if (stepNumber === 2) {
            requireModule('analysisModule').populateStep2Content();
        }
        
        // Populate Step 3 content when entering step 3
        if (stepNumber === 3) {
            const analysisModule = requireModule('analysisModule');
            // Try to load previous analysis if we don't have current analysis data
            if (!lastAnalysisData && !hasBeenAnalyzed) {
                const State = requireModule('stateModule');
                const savedState = State.load();
                if (savedState && savedState.lastAnalysis) {
                    lastAnalysisData = savedState.lastAnalysis;
                    hasBeenAnalyzed = true;
                    console.log('📊 Loaded previous analysis data for step 3');
                }
            }
            analysisModule.populateStep3Content();
        }
        
        console.log(`📍 Step changed to: ${stepNumber}`);
    }
}

function canProgressToStep(stepNumber) {
    switch (stepNumber) {
        case 1: return true; // Always can go to step 1
        case 2: 
            // Allow step 2 if we have data OR if we've previously analyzed data
            return uploadedFiles.length > 0 || manualEntries.length > 0 || hasBeenAnalyzed || lastAnalysisData;
        case 3: 
            // Allow step 3 if we have data OR if we've previously analyzed data
            return uploadedFiles.length > 0 || manualEntries.length > 0 || hasBeenAnalyzed || lastAnalysisData;
        default: return false;
    }
}


exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('analysis', {
        onLoad: () => {
            console.log('🔍 Loading analysis page');
            
            // Load manual entries from storage
            loadManualEntries();
            
            // Check if we had uploaded files before (but can't restore File objects)
            const previousFileInfos = loadUploadedFilesInfo();
            if (previousFileInfos.length > 0 && uploadedFiles.length === 0) {
                console.log('⚠️ Found previous uploaded files but File objects are lost');
                // Set input method to upload to show user they need to re-upload
                setInputMethod('upload');
            }
            
            // Load previous analysis data if available
            const State = requireModule('stateModule');
            const savedState = State.load();
            if (savedState && savedState.lastAnalysis && !lastAnalysisData) {
                lastAnalysisData = savedState.lastAnalysis;
                hasBeenAnalyzed = true;
                console.log('📊 Loaded previous analysis data on page load');
            }
            
            // If no manual entries exist, ensure we're in upload mode
            if (manualEntries.length === 0) {
                setInputMethod('upload');
            }
            
            // Update UI to reflect current file state (only if elements exist)
            safeUpdateFileList();
            
            safeUpdateManualEntriesList();
            
            updateAnalyzeButton();
            updateSteps();
        }
    });
    
    // Add click handlers to step circles for navigation
    document.addEventListener('click', (e) => {
        if (e.target.closest('.step-circle')) {
            const step = e.target.closest('.step');
            const stepNumber = parseInt(step.dataset.step);
            
            if (canProgressToStep(stepNumber)) {
                setStep(stepNumber);
                requireModule('uiModule').showToast(`Switched to step ${stepNumber}`, 'info');
            } else {
                requireModule('uiModule').showToast('Complete previous steps first', 'warning');
            }
        }
    });
    
    // File upload
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    
    if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
    }
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
    
    // Enhanced drag and drop for desktop
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
    }

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    if (uploadArea) {
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-active');
            }, false);
        });
    }

    if (uploadArea) {
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-active');
            }, false);
        });
    }

    if (uploadArea) {
        uploadArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                // Create a synthetic event for the file input
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    const dataTransfer = new DataTransfer();
                    
                    Array.from(files).forEach(file => {
                        if (file.type === 'application/pdf') {
                            dataTransfer.items.add(file);
                        }
                    });
                    
                    fileInput.files = dataTransfer.files;
                    handleFileSelect({ target: fileInput });
                    
                    requireModule('uiModule').showToast(`${dataTransfer.files.length} file(s) added`, 'success');
                }
            }
        }, false);
    }
    
    // File removal
    const fileList = document.getElementById('fileList');
    if (fileList) {
        fileList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const fileId = e.target.dataset.fileId;
                removeFile(fileId);
            }
        });
    }
    
    // Clear all files
    const clearFilesBtn = document.getElementById('clearFiles');
    if (clearFilesBtn) {
        clearFilesBtn.addEventListener('click', () => {
            if (uploadedFiles.length > 0 && confirm('Clear all files?')) {
                uploadedFiles = [];
                hasBeenAnalyzed = false;
                currentFilesSignature = null;
                
                // Clear uploaded files info from localStorage
                clearUploadedFilesInfo();
                
                // Reset input method if no manual entries exist
                if (manualEntries.length === 0) {
                    setInputMethod('upload');
                }
                
                setStep(1); // Reset to step 1
                safeUpdateFileList();
                updateAnalyzeButton();
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.value = '';
                }
                requireModule('uiModule').showToast('All files cleared', 'info');
            }
        });
    }
    
    // Analyze button
    const analyzeBtn = document.getElementById('analyzeBtn');
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', analyze);
    }
    
    // Start New Analysis button
    const startNewAnalysisBtn = document.getElementById('startNewAnalysisBtn');
    if (startNewAnalysisBtn) {
        startNewAnalysisBtn.addEventListener('click', () => {
            console.log('✨ Start New Analysis clicked - clearing all data');
            uploadedFiles = [];
            manualEntries = [];
            hasBeenAnalyzed = false;
            currentFilesSignature = null;
            
            // Clear both uploaded files and manual entries from localStorage
            clearUploadedFilesInfo();
            saveManualEntries(); // This will save empty array
            
            setStep(1); // Reset to step 1
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            safeUpdateFileList();
            safeUpdateManualEntriesList();
            updateAnalyzeButton();
            requireModule('uiModule').showToast('Ready for new analysis', 'success');
        });
    }
    
    // Input method toggle
    const uploadMethodBtn = document.getElementById('uploadMethodBtn');
    if (uploadMethodBtn) {
        uploadMethodBtn.addEventListener('click', () => {
            setInputMethod('upload');
        });
    }
    
    const manualMethodBtn = document.getElementById('manualMethodBtn');
    if (manualMethodBtn) {
        manualMethodBtn.addEventListener('click', () => {
            setInputMethod('manual');
            showManualEntryModal();
        });
    }
    
    // Manual entry modal handlers
    const addNewEntryBtn = document.getElementById('addNewEntryBtn');
    if (addNewEntryBtn) {
        addNewEntryBtn.addEventListener('click', () => {
            showManualEntryModal();
        });
    }
    
    const closeManualEntry = document.getElementById('closeManualEntry');
    if (closeManualEntry) {
        closeManualEntry.addEventListener('click', () => {
            hideManualEntryModal();
            setInputMethod('upload');
        });
    }
    
    const cancelManualEntry = document.getElementById('cancelManualEntry');
    if (cancelManualEntry) {
        cancelManualEntry.addEventListener('click', () => {
            hideManualEntryModal();
        });
    }
    
    const manualEntryForm = document.getElementById('manualEntryForm');
    if (manualEntryForm) {
        manualEntryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleManualEntrySubmit();
        });
    }
    
    // Manual entry form calculations
    // Only listen to consignments changes - bonuses are automatically calculated
    const consignmentsField = document.getElementById('consignments');
    if (consignmentsField) {
        consignmentsField.addEventListener('input', calculateManualEntryTotals);
    }
    
    // Auto-set day when date changes
    const entryDate = document.getElementById('entryDate');
    if (entryDate) {
        entryDate.addEventListener('change', (e) => {
            console.log('📅 Date changed to:', e.target.value);
            const date = new Date(e.target.value);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const entryDay = document.getElementById('entryDay');
            if (entryDay) {
                entryDay.value = dayNames[date.getDay()];
                console.log('📅 Day updated to:', dayNames[date.getDay()]);
            }
            calculateManualEntryTotals(); // Recalculate when date changes
        });
        
        // Also listen to input events for more responsive updates
        entryDate.addEventListener('input', (e) => {
            if (e.target.value) {
                console.log('📅 Date input changed to:', e.target.value);
                const date = new Date(e.target.value);
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const entryDay = document.getElementById('entryDay');
                if (entryDay) {
                    entryDay.value = dayNames[date.getDay()];
                    console.log('📅 Day updated to:', dayNames[date.getDay()]);
                }
                calculateManualEntryTotals(); // Recalculate when date changes
            }
        });
    }
    
    // Recalculate when day changes (in case user manually changes it)
    const entryDay = document.getElementById('entryDay');
    if (entryDay) {
        entryDay.addEventListener('change', (e) => {
            console.log('📅 Day manually changed to:', e.target.value);
            calculateManualEntryTotals();
        });
    }
    
    // Edit Day Modal handlers
    const closeEditDay = document.getElementById('closeEditDay');
    if (closeEditDay) {
        closeEditDay.addEventListener('click', () => {
            hideEditDayModal();
        });
    }
    
    const cancelEditDay = document.getElementById('cancelEditDay');
    if (cancelEditDay) {
        cancelEditDay.addEventListener('click', () => {
            hideEditDayModal();
        });
    }
    
    const editDayForm = document.getElementById('editDayForm');
    if (editDayForm) {
        editDayForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleEditDaySubmit();
        });
    }
    
    // Edit day form calculations
    const editConsignmentsField = document.getElementById('editConsignments');
    if (editConsignmentsField) {
        editConsignmentsField.addEventListener('input', calculateEditDayTotals);
    }
    
    // Recalculate when edit day changes
    const editDayField = document.getElementById('editDay');
    if (editDayField) {
        editDayField.addEventListener('change', calculateEditDayTotals);
    }
    
    // Initialize info tooltips
    initializeInfoTooltips();
    
    // Badge click event delegation - add to table body
    const tableBody = document.getElementById('tableBody');
    if (tableBody) {
        tableBody.addEventListener('click', (e) => {
            // Check if clicked element is a status badge
            if (e.target.classList.contains('status-badge') || e.target.closest('.status-badge')) {
                const badge = e.target.classList.contains('status-badge') ? e.target : e.target.closest('.status-badge');
                const row = badge.closest('tr');
                
                if (row && row.cells.length > 0) {
                    // Extract data from the row
                    const date = row.cells[0].textContent.trim(); // Date column
                    const day = row.cells[1].textContent.trim(); // Day column
                    
                    // Create row data object from table cells
                    const rowData = {
                        day: day,
                        consignments: parseInt(row.cells[2].textContent.trim()) || 0,
                        pickups: 0, // Will need to be filled from actual data
                        earlyArrive: 0,
                        onTimePercentage: 0, 
                        loadingBonus: 0,
                        actualReceived: parseFloat(row.cells[9].textContent.replace('£', '').trim()) || 0
                    };
                    
                    // Find the actual data entry to get complete information
                    const actualEntry = manualEntries.find(entry => entry.date === date);
                    if (actualEntry) {
                        Object.assign(rowData, {
                            consignments: actualEntry.consignments || rowData.consignments,
                            pickups: actualEntry.pickups || 0,
                            earlyArrive: actualEntry.earlyArrive || 0,
                            onTimePercentage: actualEntry.onTimePercentage || 0,
                            loadingBonus: actualEntry.loadingBonus || 0
                        });
                    }
                    
                    // Open edit modal
                    showEditDayModal(date, rowData);
                }
            }
        });
    }
};

function handleFileSelect(event) {
    console.log('📁 handleFileSelect called');
    
    const files = Array.from(event.target.files);
    console.log(`  Processing ${files.length} file(s)`);
    
    files.forEach(file => {
        const fileObj = {
            id: Date.now() + Math.random(),
            file: file,
            name: file.name,
            type: detectFileType(file.name),
            size: file.size
        };
        
        console.log(`  Added file: ${file.name} (${fileObj.type})`);
        uploadedFiles.push(fileObj);
    });
    
    console.log(`  Total uploaded files: ${uploadedFiles.length}`);
    
    // Save uploaded files info to localStorage
    saveUploadedFilesInfo();
    
    // Set input method to upload and update UI
    setInputMethod('upload');
    safeUpdateFileList();
    updateAnalyzeButton();
    
    // Auto-progress to step 2 when files are uploaded
    if (uploadedFiles.length > 0 && currentStep === 1) {
        setTimeout(() => {
            setStep(2);
            requireModule('uiModule').showToast('Files uploaded! Ready to validate', 'success');
        }, 500);
    }
}

function removeFile(fileId) {
    console.log(`🗑️ Removing file with ID: ${fileId}`);
    uploadedFiles = uploadedFiles.filter(f => f.id !== parseFloat(fileId));
    
    // Update localStorage after file removal
    if (uploadedFiles.length > 0) {
        saveUploadedFilesInfo();
    } else {
        clearUploadedFilesInfo();
    }
    
    // Only reset analysis state if we're in upload mode and this affects the current analysis
    if (currentInputMethod === 'upload') {
        hasBeenAnalyzed = false;
        currentFilesSignature = null;
    }
    
    // Reset input method if no files remain and no manual entries
    if (uploadedFiles.length === 0 && manualEntries.length === 0) {
        setInputMethod('upload');
    }
    
    safeUpdateFileList();
    updateAnalyzeButton();
    
    // Go back to step 1 if no files remain and no analysis data exists
    if (uploadedFiles.length === 0 && currentStep > 1 && !lastAnalysisData) {
        setStep(1);
        requireModule('uiModule').showToast('No files remaining. Upload files to continue', 'info');
    }
}

function updateAnalyzeButton() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const startNewBtn = document.getElementById('startNewAnalysisBtn');
    
    const hasFiles = uploadedFiles.length > 0;
    const hasManualEntries = manualEntries.length > 0;
    const hasData = hasFiles || hasManualEntries;
    
    const newFilesSignature = hasFiles ? generateFilesSignature(uploadedFiles) : null;
    const filesChanged = newFilesSignature !== currentFilesSignature;
    
    console.log('🔄 Updating button states:', { 
        hasFiles, 
        hasManualEntries, 
        hasData, 
        hasBeenAnalyzed, 
        filesChanged,
        currentInputMethod 
    });
    
    if (!hasData) {
        // No data at all - disable both buttons
        analyzeBtn.disabled = true;
        startNewBtn.style.display = 'none';
        hasBeenAnalyzed = false;
        currentFilesSignature = null;
    } else if (hasBeenAnalyzed && !filesChanged && currentInputMethod === 'upload') {
        // Same files already analyzed (upload mode) - disable analyze, show start new
        analyzeBtn.disabled = true;
        startNewBtn.style.display = 'inline-flex';
    } else if (hasBeenAnalyzed && currentInputMethod === 'manual') {
        // Manual mode - always allow re-analysis since entries can be modified
        analyzeBtn.disabled = false;
        startNewBtn.style.display = 'inline-flex';
    } else {
        // Has data and (not analyzed OR files changed OR manual mode) - enable analyze, hide start new
        analyzeBtn.disabled = false;
        startNewBtn.style.display = 'none';
        // Don't reset hasBeenAnalyzed here - only reset when explicitly clearing or uploading new files
        if (hasFiles) {
            currentFilesSignature = newFilesSignature;
        }
    }
}

function generateFilesSignature(files) {
    // Create a simple signature based on file names and sizes
    return files.map(f => `${f.name}-${f.size}`).sort().join('|');
}

// Process manual entries for analysis
function processManualEntries() {
    if (manualEntries.length === 0) {
        return null;
    }
    
    console.log('📝 Processing manual entries for analysis:', manualEntries.length);
    
    // Create structures that match file processing output
    const invoices = {};
    const runsheets = {};
    const pickups = {};
    
    manualEntries.forEach(entry => {
        const dateKey = formatDateForAnalysis(entry.date); // MM-DD format
        
        // Add to invoices (expected totals by date)
        invoices[dateKey] = entry.expectedTotal;
        
        // Add to runsheets (daily data)
        runsheets[dateKey] = {
            date: dateKey,
            day: entry.day,
            consignments: entry.consignments,
            rate: entry.day.toLowerCase() === 'saturday' ? 3.00 : 2.00,
            baseAmount: entry.baseAmount,
            bonuses: {
                earlyArrive: entry.earlyArrive || 0,
                onTimePercentage: entry.onTimePercentage || 0,
                loading: entry.loadingBonus || 0
            },
            expectedTotal: entry.expectedTotal
        };
        
        // Add pickups if any
        if (entry.pickups > 0) {
            pickups[dateKey] = entry.pickups;
        }
    });
    
    console.log('📝 Manual entries converted to analysis format:');
    console.log('  Invoice dates:', Object.keys(invoices).join(', '));
    console.log('  Runsheet dates:', Object.keys(runsheets).join(', '));
    console.log('  Pickup dates:', Object.keys(pickups).join(', '));
    
    return {
        invoices: invoices,
        runsheets: runsheets,
        pickups: pickups,
        source: 'manual_entry'
    };
}

// Format date for analysis (MM-DD format)
function formatDateForAnalysis(dateStr) {
    const date = new Date(dateStr);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${month}-${day}`;
}

// Enhanced analysis with detailed progress updates
async function analyze() {
    const hasFiles = uploadedFiles.length > 0;
    const hasManualEntries = manualEntries.length > 0;
    
    if (!hasFiles && !hasManualEntries) {
        console.log('⚠️ No data to analyze');
        return;
    }
    
    // Progress to step 3 when analysis starts
    setStep(3);
    
    const UI = requireModule('uiModule');
    const Parser = requireModule('parserModule');
    const Rules = requireModule('rulesModule');
    const State = requireModule('stateModule');
    const Router = requireModule('routerModule');
    
    console.log('\n🔍 STARTING ANALYSIS...');
    console.log(`Input method: ${currentInputMethod}`);
    
    if (currentInputMethod === 'upload') {
        console.log(`Files to analyze: ${uploadedFiles.length}`);
        uploadedFiles.forEach((f, i) => {
            console.log(`  ${i + 1}. ${f.name} (${f.type})`);
        });
    } else {
        console.log(`Manual entries to analyze: ${manualEntries.length}`);
        manualEntries.forEach((e, i) => {
            console.log(`  ${i + 1}. ${e.date} - ${e.deliveries} deliveries`);
        });
    }
    
    // Progress stages - different for manual vs upload mode
    const stages = currentInputMethod === 'manual' ? [
        { percent: 10, text: 'Initializing analysis...' },
        { percent: 30, text: 'Loading payment rules...' },
        { percent: 50, text: 'Processing manual entries...' },
        { percent: 70, text: 'Calculating payments...' },
        { percent: 90, text: 'Generating report...' },
        { percent: 100, text: 'Analysis complete!' }
    ] : [
        { percent: 10, text: 'Initializing analysis...' },
        { percent: 20, text: 'Loading payment rules...' },
        { percent: 30, text: 'Reading PDF files...' },
        { percent: 50, text: 'Extracting invoice data...' },
        { percent: 60, text: 'Processing runsheets...' },
        { percent: 70, text: 'Validating amounts...' },
        { percent: 80, text: 'Calculating payments...' },
        { percent: 90, text: 'Generating report...' },
        { percent: 100, text: 'Analysis complete!' }
    ];
    
    let currentStage = 0;
    
    function updateStage() {
        if (currentStage < stages.length) {
            const stage = stages[currentStage];
            UI.updateProgress(stage.percent);
            UI.updateLoadingText(stage.text);
            currentStage++;
        }
    }
    
    // Check if these files have been analyzed before (only for upload mode)
    let existingAnalysis = null;
    if (currentInputMethod === 'upload' && hasFiles) {
        const files = uploadedFiles.map(f => f.file);
        console.log('🔍 Checking for existing analysis...');
        console.log('📁 Current files:', files.map(f => ({ name: f.name, size: f.size, lastModified: f.lastModified })));
        existingAnalysis = State.findExistingAnalysis(files);
    }
    
    if (existingAnalysis) {
        console.log('📦 Found existing analysis for these files!');
        console.log(`  Originally analyzed: ${new Date(existingAnalysis.timestamp).toLocaleString()}`);
        
        // Build message with rules change notification
        let message = `These files were analyzed before on ${new Date(existingAnalysis.timestamp).toLocaleDateString()}.\n\n`;
        
        if (existingAnalysis.previousCount > 0) {
            message += `📊 This set of files has been analyzed ${existingAnalysis.previousCount + 1} time(s) before.\n\n`;
        }
        
        if (existingAnalysis.rulesChanged) {
            message += `⚠️ NOTE: Payment rules have changed since the last analysis.\n`;
            message += `You may want to re-analyze with the new rules.\n\n`;
        }
        
        message += `Would you like to use the saved results?\n\n`;
        message += `✅ YES = Use saved results (faster, no duplicate)\n`;
        message += `🔄 NO = Re-analyze files (slower, creates new entry)\n\n`;
        message += `Click OK to use saved results, or Cancel to re-analyze.`;
        
        console.log('📋 Prompting user with message:', message);
        const useCache = confirm(message);
        
        if (useCache) {
            console.log('✅ Using cached analysis results');
            lastAnalysisData = existingAnalysis.analysis;
            
            // Render the cached results
            UI.renderReport(lastAnalysisData);
            
            if (existingAnalysis.rulesChanged) {
                UI.showToast('Using previous results (payment rules have changed)', 'warn');
            } else {
                UI.showToast('Using previously analyzed results', 'success');
            }
            
            // Save state but don't create new analysis
            State.save({
                version: State.VERSION,
                lastAnalysis: lastAnalysisData,
                lastModified: Date.now(),
                files: {
                    uploaded: uploadedFiles.map(f => ({
                        name: f.name,
                        size: f.size,
                        type: f.type,
                        lastModified: f.file.lastModified || 0
                    }))
                },
                rules: Rules.load()
            });
            
            // Navigate to reports page
            Router.navigate('reports');
            
            // Mark as analyzed since we used cached results
            hasBeenAnalyzed = true;
            updateAnalyzeButton();
            
            console.log('✅ Cached analysis loaded successfully (no duplicate created)!');
            return; // Exit without creating a new analysis entry
        } else {
            console.log('🔄 User chose to re-analyze files (will create new entry)');
        }
    }
    
    UI.showLoading(true);
    updateStage(); // Stage 0: Initializing
    
    try {
        updateStage(); // Stage 1: Loading rules
        
        const rules = Rules.load();
        
        console.log('\n=== PAYMENT RULES LOADED ===');
        console.log(`Weekday rate: £${rules.weekdayRate.toFixed(2)}/consignment`);
        console.log(`Saturday rate: £${rules.saturdayRate.toFixed(2)}/consignment`);
        console.log(`Unloading bonus: £${rules.unloadingBonus.toFixed(2)}/day (except Mondays)`);
        console.log(`Attendance bonus: £${rules.attendanceBonus.toFixed(2)}/day (weekdays only)`);
        console.log(`Early arrival bonus: £${rules.earlyBonus.toFixed(2)}/day (weekdays only)`);
        console.log('============================\n');
        
        let aggregateResult;
        
        if (currentInputMethod === 'manual') {
            updateStage(); // Stage 2: Processing manual entries
            
            console.log('📝 Processing manual entries...');
            aggregateResult = processManualEntries();
            
            if (!aggregateResult) {
                console.log('❌ No manual entries to process');
                UI.showToast('No manual entries to process', 'error');
                UI.showLoading(false);
                return;
            }
        } else {
            updateStage(); // Stage 2: Reading PDFs
            
            // Parse all documents
            const files = uploadedFiles.map(f => f.file);
            console.log('📄 Calling Parser.parseDocuments...');
            aggregateResult = await Parser.parseDocuments(files, rules);
        }
        
        updateStage(); // Stage 3: Extracting data
        
        console.log('\n📊 AGGREGATE RESULT RECEIVED: ');
        console.log(`  Type of result: ${typeof aggregateResult}`);
        console.log(`  Has invoices property: ${aggregateResult.hasOwnProperty('invoices')}`);
        console.log(`  Type of invoices: ${typeof aggregateResult.invoices}`);
        console.log(`  Invoice data points: ${Object.keys(aggregateResult.invoices).length}`);
        
        if (Object.keys(aggregateResult.invoices).length > 0) {
            console.log('  📊 Invoice amounts by date:');
            for (const [date, amount] of Object.entries(aggregateResult.invoices)) {
                console.log(`    ${date}: £${amount.toFixed(2)}`);
            }
        } else {
            console.log('  ⚠️ WARNING: No invoice data found in aggregate result!');
        }
        
        updateStage(); // Stage 4: Processing
        updateStage(); // Stage 5: Validating
        
        // Process results into daily analysis
        const results = [];
        const totals = {
            expectedTotal: 0,
            paidTotal: 0,
            totalConsignments: 0,
            differenceTotal: 0,
            baseTotal: 0,
            bonusTotal: 0,
            unloadingTotal: 0,
            attendanceTotal: 0,
            earlyTotal: 0,
            pickupTotal: 0,
            pickupCount: 0,
            workingDays: 0
        };
        
        // Get all dates
        const runsheetDates = Object.keys(aggregateResult.runsheets);
        const invoiceDates = Object.keys(aggregateResult.invoices);
        
        console.log(`\n📅 Date consolidation:`);
        console.log(`  Runsheet dates: ${runsheetDates.length > 0 ? runsheetDates.sort().join(', ') : 'none'}`);
        console.log(`  Invoice dates: ${invoiceDates.length > 0 ? invoiceDates.sort().join(', ') : 'none'}`);
        
        const allDates = Array.from(
            new Set([...runsheetDates, ...invoiceDates])
        ).sort();
        
        console.log(`  Combined unique dates: ${allDates.length > 0 ? allDates.join(', ') : 'none'}`);
        
        if (allDates.length === 0) {
            console.log('\n❌ ERROR: No dates found to process!');
            console.log('  This usually means the invoice parsing failed.');
            console.log('  Check that invoice amounts are being extracted correctly.');
            UI.showToast('No data found in documents', 'error');
            UI.showLoading(false);
            return;
        }
        
        console.log(`\n📅 Processing ${allDates.length} unique dates...`);
        
        updateStage(); // Stage 6: Calculating
        

        
        // Process each date
        allDates.forEach((date, index) => {
            console.log(`\n  Processing date ${index + 1}/${allDates.length}: ${date}`);
            
            const dateObj = new Date(date + 'T12:00:00');
            const dayOfWeek = dateObj.getDay();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const isSaturday = dayOfWeek === 6;
            const isMonday = dayOfWeek === 1;
            
            const consignments = aggregateResult.runsheets[date]?.consignments || 0;
            const rate = isSaturday ? rules.saturdayRate : rules.weekdayRate;
            const pickupInfo = aggregateResult.pickups[date] || { count: 0, total: 0 };
            
            console.log(`    Day: ${dayNames[dayOfWeek]}`);
            console.log(`    Consignments from runsheet: ${consignments}`);
            console.log(`    Rate applied: £${rate.toFixed(2)}`);
            
            let expectedTotal = 0;
            let basePayment = 0;
            let unloadingBonus = 0;
            let attendanceBonus = 0;
            let earlyBonus = 0;
            
            if (consignments > 0 || pickupInfo.total > 0) {
                if (consignments > 0) {
                    basePayment = consignments * rate;
                    unloadingBonus = isMonday ? 0 : rules.unloadingBonus;
                    attendanceBonus = isSaturday ? 0 : rules.attendanceBonus;
                    earlyBonus = isSaturday ? 0 : rules.earlyBonus;
                    totals.workingDays++;
                    
                    if (isMonday) {
                        console.log(`    📅 Monday detected: No unloading bonus`);
                    }
                }
                expectedTotal = basePayment + unloadingBonus + attendanceBonus + earlyBonus;
            }
            
            expectedTotal += pickupInfo.total;
            
            const paidAmount = aggregateResult.invoices[date] || 0;
            const difference = paidAmount - expectedTotal;
            
            console.log(`    Base payment: ${consignments} × £${rate.toFixed(2)} = £${basePayment.toFixed(2)}`);
            if (pickupInfo.count > 0) {
                console.log(`    Pickups: ${pickupInfo.count} service(s) = £${pickupInfo.total.toFixed(2)}`);
            }
            console.log(`    Bonuses: Unloading(£${unloadingBonus.toFixed(2)}) + Attendance(£${attendanceBonus.toFixed(2)}) + Early(£${earlyBonus.toFixed(2)}) = £${(unloadingBonus + attendanceBonus + earlyBonus).toFixed(2)}`);
            console.log(`    Expected total: £${expectedTotal.toFixed(2)}`);
            console.log(`    Paid amount from invoice: £${paidAmount.toFixed(2)}`);
            console.log(`    Difference: ${difference >= 0 ? '+' : ''}£${difference.toFixed(2)} ${difference === 0 ? '✅' : difference > 0 ? '💚' : '🔴'}`);
            
            results.push({
                date,
                day: dayNames[dayOfWeek],
                consignments,
                rate,
                basePayment,
                unloadingBonus,
                attendanceBonus,
                earlyBonus,
                totalBonus: unloadingBonus + attendanceBonus + earlyBonus,
                pickupCount: pickupInfo.count,
                pickupTotal: pickupInfo.total,
                expectedTotal,
                paidAmount,
                difference
            });
            
            // Update totals
            totals.expectedTotal += expectedTotal;
            totals.paidTotal += paidAmount;
            totals.totalConsignments += consignments;
            totals.differenceTotal += difference;
            totals.baseTotal += basePayment;
            totals.bonusTotal += unloadingBonus + attendanceBonus + earlyBonus;
            totals.unloadingTotal += unloadingBonus;
            totals.attendanceTotal += attendanceBonus;
            totals.earlyTotal += earlyBonus;
            totals.pickupTotal += pickupInfo.total;
            totals.pickupCount += pickupInfo.count;
        });
        
        console.log('\n=== FINAL CALCULATION TOTALS ===');
        console.log(`Working Days: ${totals.workingDays}`);
        console.log(`Total Consignments: ${totals.totalConsignments}`);
        console.log(`Base Payment Total: £${totals.baseTotal.toFixed(2)}`);
        console.log(`  - Unloading Bonus: £${totals.unloadingTotal.toFixed(2)}`);
        console.log(`  - Attendance Bonus: £${totals.attendanceTotal.toFixed(2)}`);
        console.log(`  - Early Arrival Bonus: £${totals.earlyTotal.toFixed(2)}`);
        console.log(`Total Bonuses: £${totals.bonusTotal.toFixed(2)}`);
        console.log(`Pickup Services: ${totals.pickupCount} = £${totals.pickupTotal.toFixed(2)}`);
        console.log(`EXPECTED TOTAL: £${totals.expectedTotal.toFixed(2)}`);
        console.log(`PAID TOTAL: £${totals.paidTotal.toFixed(2)}`);
        console.log(`DIFFERENCE: ${totals.differenceTotal >= 0 ? '+' : ''}£${totals.differenceTotal.toFixed(2)}`);
        console.log(`STATUS: ${totals.differenceTotal >= 0 ? '✅ FAVORABLE' : '❌ UNFAVORABLE'}`);
        console.log('=================================\n');
        
        updateStage(); // Stage 7: Generating report
        
        // Calculate metadata
        let periodRange = '-';
        if (allDates.length > 0) {
            const startDate = new Date(allDates[0] + 'T12:00:00');
            const endDate = new Date(allDates[allDates.length - 1] + 'T12:00:00');
            periodRange = `${startDate.toLocaleDateString('en-GB')} - ${endDate.toLocaleDateString('en-GB')}`;
        }
        
        let overallStatus = totals.differenceTotal >= 0 ? 'FAVORABLE' : 'UNFAVORABLE';
        
        // Check validation (only for file uploads, manual entries don't have validation items)
        if (aggregateResult.items) {
            const hasValidationIssue = aggregateResult.items.some(item => 
                item.type === 'invoice' && item.validationPassed === false
            );
            
            if (hasValidationIssue) {
                overallStatus = 'INVALID - REVIEW REQUIRED';
                UI.showValidationAlert('Invoice validation failed. Results may be inaccurate.', 'error');
                console.log('⚠️ Invoice validation failed - results may be inaccurate');
            } else if (aggregateResult.items.some(item => item.validationPassed === true)) {
                overallStatus = 'VALIDATED - ' + overallStatus;
                UI.showValidationAlert('Invoice validation successful', 'success');
                console.log('✅ Invoice validation passed');
            } else {
                console.log('ℹ️ No validation status available');
            }
        } else {
            // Manual entries - no validation needed
            console.log('📝 Manual entry analysis - no file validation required');
        }
        
        const metadata = {
            periodRange,
            totalDays: totals.workingDays,
            analysisDate: new Date().toLocaleDateString('en-GB'),
            overallStatus
        };
        
        // Store analysis data
        lastAnalysisData = { results, totals, metadata };
        
        // Create processed data structure for storage
        const processedData = {
            runsheets: aggregateResult.runsheets || {},
            invoices: aggregateResult.invoices || {},
            pickups: aggregateResult.pickups || {}
        };
        
        // Save to state with enhanced structure
        State.save({
            version: State.VERSION,
            lastAnalysis: lastAnalysisData,
            lastModified: Date.now(),
            files: currentInputMethod === 'upload' ? {
                uploaded: uploadedFiles.map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type,
                    lastModified: f.file.lastModified || 0
                })),
                processed: processedData
            } : {
                manual: manualEntries.map(e => ({...e})),
                processed: processedData
            },
            inputMethod: currentInputMethod,
            rules: rules
        });
        
        // ONLY save as new analysis when actually performing analysis
        console.log('💾 Saving as new analysis entry...');
        console.log('💾 Analysis data structure:', lastAnalysisData);
        
        if (currentInputMethod === 'upload') {
            const files = uploadedFiles.map(f => f.file);
            State.saveAnalysis(files, lastAnalysisData, processedData);
        } else {
            // For manual entries, use a different method or adapt saveAnalysis
            State.saveAnalysis([], lastAnalysisData, processedData, { inputMethod: 'manual', entries: manualEntries });
        }
        
        updateStage(); // Stage 8: Complete
        
        // Display results in Step 3
        console.log('📊 Displaying analysis results in Step 3...');
        displayAnalysisResults(lastAnalysisData);
        
        // Also populate step 3 content to ensure it shows analysis data
        populateStep3Content();
        
        UI.showToast('Analysis complete!', 'success');
        
        // DON'T clear data after successful analysis - keep it so user can navigate back
        // Only clear when explicitly requested via "Start New Analysis" button
        if (currentInputMethod === 'upload') {
            // Keep uploadedFiles so user can navigate back to step 2
            // uploadedFiles = []; // Don't clear!
            // clearUploadedFilesInfo(); // Don't clear!
            safeUpdateFileList();
        } else {
            // For manual mode, keep entries so user can navigate back and see what was analyzed
            safeUpdateManualEntriesList();
        }
        
        // Mark analysis as completed and update button states
        hasBeenAnalyzed = true;
        updateAnalyzeButton();
        
        // Refresh dashboard to show new data
        setTimeout(() => {
            requireModule('dashboardModule').refresh();
        }, 100);
        
        console.log('✅ ANALYSIS COMPLETE AND RENDERED!');
        
    } catch (error) {
        console.error('Analysis error:', error);
        UI.showToast('Error processing files: ' + (error && error.message ? error.message : 'Unknown error'), 'error');
    } finally {
        UI.showLoading(false);
        UI.hideValidationAlert();
    }
}

// Manual Entry Functions
function setInputMethod(method) {
    currentInputMethod = method;
    console.log('📝 Input method changed to:', method);
    
    // Update button states (with null checks)
    const uploadBtn = document.getElementById('uploadMethodBtn');
    const manualBtn = document.getElementById('manualMethodBtn');
    if (uploadBtn) uploadBtn.classList.toggle('active', method === 'upload');
    if (manualBtn) manualBtn.classList.toggle('active', method === 'manual');
    
    // Show/hide appropriate containers (with null checks)
    const uploadContainer = document.getElementById('uploadContainer');
    const manualSection = document.getElementById('manualEntriesSection');
    if (uploadContainer) uploadContainer.style.display = method === 'upload' ? 'block' : 'none';
    if (manualSection) manualSection.style.display = method === 'manual' ? 'block' : 'none';
    
    // Update analyze button based on current data
    updateAnalyzeButton();
}

function showManualEntryModal() {
    // Reset form and editing state
    const form = document.getElementById('manualEntryForm');
    form.reset();
    form.removeAttribute('data-editing-id');
    
    // Reset modal title and button text to default
    const modalTitle = document.querySelector('.modal-title');
    const submitButton = document.getElementById('saveManualEntry');
    if (modalTitle) modalTitle.textContent = 'Add Daily Entry';
    if (submitButton) {
        submitButton.innerHTML = '<span class="btn-icon">💾</span><span class="btn-text">Add Entry</span>';
    }
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    
    // Auto-set day (capitalized)
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    document.getElementById('entryDay').value = dayNames[new Date().getDay()];
    
    // Show modal first
    document.getElementById('manualEntryOverlay').classList.add('show');
    
    // Calculate initial totals with a delay to ensure DOM is ready
    setTimeout(() => {
        calculateManualEntryTotals();
    }, 50);
    
    // Focus first input
    setTimeout(() => {
        document.getElementById('consignments').focus();
    }, 100);
}

function hideManualEntryModal() {
    document.getElementById('manualEntryOverlay').classList.remove('show');
}

function showEditDayModal(date, rowData) {
    // Reset form
    const form = document.getElementById('editDayForm');
    form.reset();
    form.dataset.editingDate = date;
    
    // Fill in the form with existing data
    document.getElementById('editDate').value = date;
    document.getElementById('editDay').value = rowData.day || '';
    document.getElementById('editConsignments').value = rowData.consignments || 0;
    document.getElementById('editPickups').value = rowData.pickups || 0;
    document.getElementById('editEarlyArrive').value = rowData.earlyArrive || 0;
    document.getElementById('editOnTimePercentage').value = rowData.onTimePercentage || 0;
    document.getElementById('editLoadingBonus').value = rowData.loadingBonus || 0;
    document.getElementById('editActualReceived').value = rowData.actualReceived || 0;
    
    // Calculate and display base amount
    calculateEditDayTotals();
    
    // Show modal
    document.getElementById('editDayOverlay').classList.add('show');
    
    // Focus first editable input
    setTimeout(() => {
        document.getElementById('editConsignments').focus();
    }, 100);
}

function hideEditDayModal() {
    document.getElementById('editDayOverlay').classList.remove('show');
}

function calculateEditDayTotals() {
    // Get values
    const consignments = parseFloat(document.getElementById('editConsignments').value) || 0;
    const editDayValue = document.getElementById('editDay').value;
    
    // Get rules from settings
    const Rules = requireModule('rulesModule');
    const rules = Rules.load();
    
    // Get day type for rate calculation
    const dayType = editDayValue.toLowerCase();
    const isSaturday = dayType === 'saturday';
    const isMonday = dayType === 'monday';
    const isSunday = dayType === 'sunday';
    
    // Sunday is not a working day - no rate applies
    let rate = 0;
    if (!isSunday) {
        rate = isSaturday ? rules.saturdayRate : rules.weekdayRate;
    }
    
    // Calculate base amount
    const baseAmount = consignments * rate;
    document.getElementById('editBaseAmount').value = baseAmount.toFixed(2);
    
    // Calculate bonuses based on rules - only for working days
    let unloadingBonus = 0;
    let attendanceBonus = 0;
    let earlyBonus = 0;
    
    // Sunday is not a working day - no bonuses apply
    if (!isSunday) {
        // Unloading bonus: applies every working day except Monday
        unloadingBonus = isMonday ? 0 : rules.unloadingBonus;
        
        // Attendance and Early bonuses: apply only on weekdays (Monday-Friday, not Saturday)
        if (!isSaturday) {
            attendanceBonus = rules.attendanceBonus;
            earlyBonus = rules.earlyBonus;
        }
    }
    
    // Set the calculated bonuses to the form fields
    document.getElementById('editEarlyArrive').value = earlyBonus.toFixed(2);
    document.getElementById('editOnTimePercentage').value = attendanceBonus.toFixed(2);
    document.getElementById('editLoadingBonus').value = unloadingBonus.toFixed(2);
    
    // Update tooltip information with current rules and day
    updateFormTooltips(rules, dayType);
}

function handleEditDaySubmit() {
    console.log('📝 Edit day form submitted');
    
    const form = document.getElementById('editDayForm');
    const editingDate = form.dataset.editingDate;
    
    if (!editingDate) {
        requireModule('uiModule').showToast('Error: No date specified for editing', 'error');
        return;
    }
    
    // Get form data
    const formData = {
        date: editingDate,
        day: document.getElementById('editDay').value,
        consignments: parseInt(document.getElementById('editConsignments').value) || 0,
        baseAmount: parseFloat(document.getElementById('editBaseAmount').value) || 0,
        pickups: parseInt(document.getElementById('editPickups').value) || 0,
        earlyArrive: parseFloat(document.getElementById('editEarlyArrive').value) || 0,
        onTimePercentage: parseFloat(document.getElementById('editOnTimePercentage').value) || 0,
        loadingBonus: parseFloat(document.getElementById('editLoadingBonus').value) || 0,
        actualReceived: parseFloat(document.getElementById('editActualReceived').value) || 0
    };
    
    // Calculate expected total
    formData.expectedTotal = formData.baseAmount + formData.earlyArrive + formData.onTimePercentage + formData.loadingBonus;
    
    // Update the entry in manual entries
    updateDayData(editingDate, formData);
    
    // Hide modal and refresh UI
    hideEditDayModal();
    
    requireModule('uiModule').showToast('Day data updated successfully', 'success');
}

function updateDayData(date, newData) {
    // Find existing entry by date
    const entryIndex = manualEntries.findIndex(entry => entry.date === date);
    
    if (entryIndex !== -1) {
        // Update existing entry
        manualEntries[entryIndex] = {
            ...manualEntries[entryIndex],
            ...newData,
            updatedAt: new Date().toISOString()
        };
        console.log('📝 Day data updated:', manualEntries[entryIndex]);
    } else {
        // Create new entry if it doesn't exist
        const entry = {
            id: Date.now() + Math.random(),
            ...newData,
            createdAt: new Date().toISOString()
        };
        manualEntries.push(entry);
        console.log('📝 New day entry created:', entry);
    }
    
    // Save to storage
    saveManualEntries();
    
    // Update UI
    safeUpdateManualEntriesList();
    updateAnalyzeButton();
    
    // If we're currently viewing the dashboard or analysis, refresh the display
    if (document.getElementById('dashboard-page').classList.contains('active') || 
        document.getElementById('step-3').style.display !== 'none') {
        // Re-run analysis to update the table
        if (typeof analyze === 'function') {
            analyze();
        }
    }
}

function calculateManualEntryTotals() {
    // Get values
    const consignments = parseFloat(document.getElementById('consignments').value) || 0;
    const entryDateValue = document.getElementById('entryDate').value;
    const entryDayValue = document.getElementById('entryDay').value;
    
    console.log('🧮 calculateManualEntryTotals called:', { consignments, entryDateValue, entryDayValue });
    
    // Get rules from settings
    const Rules = requireModule('rulesModule');
    const rules = Rules.load();
    
    console.log('📋 Rules loaded:', rules);
    
    // Get day type for rate calculation
    const dayType = entryDayValue.toLowerCase();
    const isSaturday = dayType === 'saturday';
    const isMonday = dayType === 'monday';
    const isSunday = dayType === 'sunday';
    
    // Sunday is not a working day - no rate applies
    let rate = 0;
    if (!isSunday) {
        rate = isSaturday ? rules.saturdayRate : rules.weekdayRate;
    }
    
    console.log('📅 Day analysis:', { dayType, isSaturday, isMonday, isSunday, rate });
    
    // Calculate base amount
    const baseAmount = consignments * rate;
    console.log('💰 Base amount calculation:', { consignments, rate, baseAmount });
    
    const baseAmountField = document.getElementById('baseAmount');
    if (baseAmountField) {
        baseAmountField.value = baseAmount.toFixed(2);
        console.log('💰 Base amount field updated to:', baseAmount.toFixed(2));
    } else {
        console.error('❌ Base amount field not found!');
    }
    
    // Calculate bonuses based on rules - only for working days
    let unloadingBonus = 0;
    let attendanceBonus = 0;
    let earlyBonus = 0;
    
    // Sunday is not a working day - no bonuses apply
    if (!isSunday) {
        // Unloading bonus: applies every working day except Monday
        unloadingBonus = isMonday ? 0 : rules.unloadingBonus;
        
        // Attendance and Early bonuses: apply only on weekdays (Monday-Friday, not Saturday)
        if (!isSaturday) {
            attendanceBonus = rules.attendanceBonus;
            earlyBonus = rules.earlyBonus;
        }
    }
    
    console.log('💰 Bonuses calculated:', { unloadingBonus, attendanceBonus, earlyBonus });
    
    // Set the calculated bonuses to the form fields
    // Map the system bonuses to the form field names
    const earlyArriveField = document.getElementById('earlyArrive');
    const onTimePercentageField = document.getElementById('onTimePercentage');
    const loadingBonusField = document.getElementById('loadingBonus');
    
    console.log('🔍 DOM elements found:', { 
        earlyArriveField: !!earlyArriveField, 
        onTimePercentageField: !!onTimePercentageField, 
        loadingBonusField: !!loadingBonusField 
    });
    
    if (earlyArriveField) earlyArriveField.value = earlyBonus.toFixed(2);
    if (onTimePercentageField) onTimePercentageField.value = attendanceBonus.toFixed(2);
    if (loadingBonusField) loadingBonusField.value = unloadingBonus.toFixed(2);
    
    // Update tooltip information with current rules and day
    updateFormTooltips(rules, dayType);
    
    // Calculate expected total
    const expectedTotal = baseAmount + earlyBonus + attendanceBonus + unloadingBonus;
    
    // Update expected total field
    document.getElementById('expectedTotal').value = expectedTotal.toFixed(2);
    
    console.log('📊 Final totals:', { baseAmount, expectedTotal });
}

function handleManualEntrySubmit() {
    console.log('📝 Manual entry form submitted');
    
    // Check if we're editing or creating
    const form = document.getElementById('manualEntryForm');
    const editingId = form.dataset.editingId;
    const isEditing = editingId && editingId !== '';
    
    // Get form data
    const formData = {
        date: document.getElementById('entryDate').value,
        day: document.getElementById('entryDay').value,
        consignments: parseInt(document.getElementById('consignments').value) || 0,
        baseAmount: parseFloat(document.getElementById('baseAmount').value) || 0,
        pickups: parseInt(document.getElementById('pickups').value) || 0,
        earlyArrive: parseFloat(document.getElementById('earlyArrive').value) || 0,
        onTimePercentage: parseFloat(document.getElementById('onTimePercentage').value) || 0,
        loadingBonus: parseFloat(document.getElementById('loadingBonus').value) || 0,
        expectedTotal: parseFloat(document.getElementById('expectedTotal').value) || 0
    };
    
    // Basic validation
    if (!formData.date || !formData.day) {
        requireModule('uiModule').showToast('Please fill in date information', 'error');
        return;
    }
    
    if (formData.consignments === 0) {
        requireModule('uiModule').showToast('Please enter number of consignments', 'error');
        return;
    }
    
    // Check for date duplication (only when creating new entries, not editing)
    if (!isEditing) {
        const existingEntry = manualEntries.find(entry => entry.date === formData.date);
        if (existingEntry) {
            requireModule('uiModule').showToast('An entry for this date already exists. Please choose a different date or edit the existing entry.', 'error');
            return;
        }
    }
    
    if (isEditing) {
        // Update existing entry
        const entryIndex = manualEntries.findIndex(e => e.id == editingId);
        if (entryIndex !== -1) {
            manualEntries[entryIndex] = {
                ...manualEntries[entryIndex],
                ...formData,
                updatedAt: new Date().toISOString()
            };
            console.log('📝 Manual entry updated:', manualEntries[entryIndex]);
        }
    } else {
        // Create new entry
        const entry = {
            id: Date.now() + Math.random(),
            ...formData,
            createdAt: new Date().toISOString()
        };
        
        manualEntries.push(entry);
        console.log('📝 Manual entry added:', entry);
    }
    
    // Set input method to manual and save to storage
    setInputMethod('manual');
    saveManualEntries();
    
    // Update UI
    safeUpdateManualEntriesList();
    updateAnalyzeButton();
    hideManualEntryModal();
    
    // Clear editing state
    form.removeAttribute('data-editing-id');
    
    // Automatically progress to Step 2 (Validate) - but only for new entries
    if (!isEditing) {
        const Router = requireModule('routerModule');
        Router.navigateToStep(2);
    } else {
        // If editing and already on step 2, refresh the step 2 content
        if (currentStep === 2) {
            populateStep2Content();
        }
    }
    
    // Show appropriate success message
    const action = isEditing ? 'updated' : 'added';
    requireModule('uiModule').showToast(`Entry ${action} for ${new Date(formData.date).toLocaleDateString()}`, 'success');
}

function removeManualEntry(entryId) {
    console.log('🗑️ Removing manual entry with ID:', entryId);
    manualEntries = manualEntries.filter(e => e.id !== parseFloat(entryId));
    
    // Only reset analysis state if we're in manual mode and this affects the current analysis
    if (currentInputMethod === 'manual') {
        hasBeenAnalyzed = false;
        currentFilesSignature = null;
    }
    
    // Save changes and update input method if needed
    saveManualEntries();
    if (manualEntries.length === 0) {
        setInputMethod('upload');
    }
    
    safeUpdateManualEntriesList();
    updateAnalyzeButton();
    
    requireModule('uiModule').showToast('Entry removed', 'info');
}

// Generate styled HTML for Step 2 manual entries display
function generateStep2EntriesHTML() {
    if (manualEntries.length === 0) {
        return '<p class="no-entries-message">No entries added yet</p>';
    }

    // Sort entries by date
    const sortedEntries = [...manualEntries].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    return sortedEntries.map(entry => {
        const date = new Date(entry.date);
        const formattedDate = date.toLocaleDateString('en-GB', { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        });
        
        return `
            <div class="step2-entry-card" data-entry-id="${entry.id}">
                <div class="entry-card-header">
                    <div class="entry-day">${formattedDate}</div>
                    <div class="entry-total">£${entry.expectedTotal.toFixed(2)}</div>
                </div>
                <div class="entry-card-details">
                    <div class="entry-detail">
                        <span class="detail-icon">📦</span>
                        <span class="detail-text">${entry.consignments} consignments</span>
                    </div>
                    <div class="entry-detail">
                        <span class="detail-icon">💰</span>
                        <span class="detail-text">Base: £${entry.baseAmount.toFixed(2)}</span>
                    </div>
                    ${entry.earlyArrive > 0 ? `
                        <div class="entry-detail">
                            <span class="detail-icon">⏰</span>
                            <span class="detail-text">Early: £${entry.earlyArrive.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    ${entry.loadingBonus > 0 ? `
                        <div class="entry-detail">
                            <span class="detail-icon">🏋️</span>
                            <span class="detail-text">Loading: £${entry.loadingBonus.toFixed(2)}</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// Update scroll indicator for manual entries list
function updateScrollIndicator(container) {
    if (!container) return;
    
    const hasScrollableContent = container.scrollHeight > container.clientHeight;
    const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 5;
    
    // Show dots if content is scrollable and user is not at the bottom
    if (hasScrollableContent && !isAtBottom) {
        container.classList.add('has-more-content');
    } else {
        container.classList.remove('has-more-content');
    }
}

// Edit manual entry - opens modal with pre-filled data
function editManualEntry(entryId) {
    console.log('✏️ Editing manual entry with ID:', entryId);
    
    // Find the entry to edit
    const entry = manualEntries.find(e => e.id === entryId);
    if (!entry) {
        requireModule('uiModule').showToast('Entry not found', 'error');
        return;
    }
    
    // Show the modal
    showManualEntryModal();
    
    // Pre-fill the form with existing data
    setTimeout(() => {
        document.getElementById('entryDate').value = entry.date;
        document.getElementById('entryDay').value = entry.day;
        document.getElementById('consignments').value = entry.consignments;
        document.getElementById('baseAmount').value = entry.baseAmount.toFixed(2);
        document.getElementById('pickups').value = entry.pickups || 0;
        document.getElementById('earlyArrive').value = entry.earlyArrive.toFixed(2);
        document.getElementById('onTimePercentage').value = entry.onTimePercentage.toFixed(2);
        document.getElementById('loadingBonus').value = entry.loadingBonus.toFixed(2);
        document.getElementById('expectedTotal').value = entry.expectedTotal.toFixed(2);
        
        // Store the ID for updating instead of creating new
        const form = document.getElementById('manualEntryForm');
        form.dataset.editingId = entryId;
        
        // Update the modal title and button text
        const modalTitle = document.querySelector('.modal-title');
        const submitButton = document.getElementById('saveManualEntry');
        if (modalTitle) modalTitle.textContent = 'Edit Daily Entry';
        if (submitButton) {
            submitButton.innerHTML = '<span class="btn-icon">💾</span><span class="btn-text">Update Entry</span>';
        }
    }, 100);
}

// Populate Step 2 content based on input method
function populateStep2Content() {
    const validateSection = document.querySelector('.validate-section');
    if (!validateSection) return;
    
    if (currentInputMethod === 'manual' && manualEntries.length > 0) {
        // Manual entry workflow - show week summary and options
        validateSection.innerHTML = `
            <div class="validate-content">
                <div class="validate-header">
                    <h2 class="validate-title">Review Daily Data</h2>
                    <p class="validate-subtitle">Choose to add more days or analyze your current week</p>
                </div>

                <!-- Manual Entries Display -->
                <div class="manual-entries-display">
                    <h3 class="entries-title">Your Daily Entries</h3>
                    <div class="manual-entries-list" id="manualEntriesListStep2">
                        <!-- Entries will be populated here -->
                    </div>
                </div>

                <div class="manual-workflow-options">
                    <div class="workflow-cards">
                        <div class="workflow-card add-more-card" data-action="add-more">
                            <span class="workflow-icon">📅</span>
                            <div class="workflow-content">
                                <h3 class="workflow-title">Add More Days</h3>
                                <p class="workflow-description">Continue adding daily data for this week</p>
                                <button class="btn btn-secondary workflow-btn" id="addMoreDaysBtn">
                                    <span class="btn-icon">✏️</span>
                                    <span class="btn-text">Add Another Day</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="workflow-card analyze-card" data-action="analyze">
                            <span class="workflow-icon">📊</span>
                            <div class="workflow-content">
                                <h3 class="workflow-title">Analyze Current Week</h3>
                                <p class="workflow-description">Process the data you've entered so far</p>
                                <button class="btn btn-primary workflow-btn" id="analyzeWeekBtn">
                                    <span class="btn-icon">🚀</span>
                                    <span class="btn-text">Analyze Week</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Populate manual entries list in Step 2 with custom styling
        setTimeout(() => {
            const entriesListStep2 = document.getElementById('manualEntriesListStep2');
            if (entriesListStep2) {
                entriesListStep2.innerHTML = generateStep2EntriesHTML();
                
                // Add click event listeners to entry cards
                entriesListStep2.addEventListener('click', (e) => {
                    const entryCard = e.target.closest('.step2-entry-card');
                    if (entryCard) {
                        const entryId = parseFloat(entryCard.dataset.entryId);
                        editManualEntry(entryId);
                    }
                });
                
                // Check for scrollable content and add scroll indicator
                updateScrollIndicator(entriesListStep2);
                
                // Update indicator on scroll
                entriesListStep2.addEventListener('scroll', () => {
                    updateScrollIndicator(entriesListStep2);
                });
            }
        }, 100);
        
        // Add event listeners for manual workflow
        document.getElementById('addMoreDaysBtn').addEventListener('click', () => {
            showManualEntryModal();
        });
        
        document.getElementById('analyzeWeekBtn').addEventListener('click', () => {
            setStep(3);
            analyze();
        });
        
    } else {
        // File upload workflow - show validation with uploaded files list
        validateSection.innerHTML = `
            <div class="validate-content">
                <div class="validate-header">
                    <h2 class="validate-title">Validate Documents</h2>
                    <p class="validate-subtitle">Review your uploaded documents before analysis</p>
                </div>
                
                
                <div class="validation-status" id="validationStatus">
                    <div class="validation-card">
                        <div class="validation-info">
                            <h3>Document Review</h3>
                            <p>Check that all documents are correctly identified and ready for analysis</p>
                        </div>
                    </div>
                </div>

                
                <!-- Analysis Preview Section -->
                <div class="analysis-preview-section" id="analysisPreview" style="display: none;">
                    <div class="preview-header">
                        <h3 class="preview-title">Analysis Preview</h3>
                        <div class="validation-badge modern" id="previewValidationBadge">
                            <span class="badge-icon">⏳</span>
                            <span class="badge-text">Validating...</span>
                        </div>
                    </div>
                    
                    <div class="preview-grid">
                        <div class="preview-card">
                            <div class="preview-card-icon">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M7 13v4M11 10v7M15 7v10"/>
                                </svg>
                            </div>
                            <div class="preview-card-content">
                                <div class="preview-card-label">Total Files</div>
                                <div class="preview-card-value" id="previewTotalFiles">0</div>
                            </div>
                        </div>
                        <div class="preview-card">
                            <div class="preview-card-icon">📦</div>
                            <div class="preview-card-content">
                                <div class="preview-card-label">Runsheets</div>
                                <div class="preview-card-value" id="previewRunsheets">0</div>
                            </div>
                        </div>
                        <div class="preview-card">
                            <div class="preview-card-icon">💰</div>
                            <div class="preview-card-content">
                                <div class="preview-card-label">Invoices</div>
                                <div class="preview-card-value" id="previewInvoices">0</div>
                            </div>
                        </div>
                        <div class="preview-card">
                            <div class="preview-card-icon">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 12l2 2 4-4"/>
                                    <circle cx="12" cy="12" r="10"/>
                                </svg>
                            </div>
                            <div class="preview-card-content">
                                <div class="preview-card-label">Status</div>
                                <div class="preview-card-value" id="previewStatus">Ready</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Validation Alert -->
                <div class="validation-alert modern" id="validationAlert" style="display: none;">
                    <div class="alert-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" fill="none">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">Validation Issue</div>
                        <div class="alert-message" id="validationMessage">Please check your files</div>
                    </div>
                </div>

                <!-- File List Section -->
                <div class="files-section" id="filesSection" style="display: none;">
                    <div class="files-header">
                        <h3 class="files-title">Uploaded Files</h3>
                        <div class="files-count" id="filesCount">0 files</div>
                    </div>
                    <div class="file-list enhanced-file-list" id="fileList"></div>
                </div>

                
                <div class="validation-actions">
                    <button class="btn btn-primary" id="proceedToAnalysisBtn">
                        <span class="btn-icon">🚀</span>
                        <span class="btn-text">Proceed to Analysis</span>
                    </button>
                </div>
            </div>
        `;
        
        // Show uploaded files section and use enhanced file list display
        if (uploadedFiles.length > 0) {
            // Use the enhanced updateFileList function from uiModule
            const uiModule = requireModule('uiModule');
            uiModule.updateFileList(uploadedFiles);
        }
        
        // Add event listener for file workflow
        document.getElementById('proceedToAnalysisBtn').addEventListener('click', () => {
            setStep(3);
            analyze();
        });
    }
}

// Populate Step 3 content for analysis
function populateStep3Content() {
    const analyzeSection = document.querySelector('.analyze-section');
    if (!analyzeSection) return;
    
    // Check if we have current data to analyze or previous analysis results
    const hasCurrentData = (currentInputMethod === 'manual' && manualEntries.length > 0) || 
                           (currentInputMethod === 'upload' && uploadedFiles.length > 0);
    const hasPreviousAnalysis = hasBeenAnalyzed || lastAnalysisData;
    
    if (!hasCurrentData && !hasPreviousAnalysis) {
        analyzeSection.innerHTML = `
            <div class="analyze-content">
                <div class="analyze-header">
                    <h2 class="analyze-title">Ready to Analyze</h2>
                    <p class="analyze-subtitle">Complete your data entry to see analysis results</p>
                </div>
                <div class="empty-analysis-state">
                    <div class="empty-analysis-icon">📊</div>
                    <p class="empty-analysis-message">No data available for analysis</p>
                    <button class="btn btn-primary" onclick="setStep(1)">
                        <span class="btn-icon">📝</span>
                        <span class="btn-text">Add Data</span>
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    analyzeSection.innerHTML = `
        <div class="analyze-content">
            <div class="analyze-header">
                <h2 class="analyze-title">Analysis Complete</h2>
                <p class="analyze-subtitle">Your payment data has been processed successfully</p>
            </div>
                        <!-- Basic Analysis Summary -->
            <div class="analysis-summary">
                <h3 class="summary-title">Quick Summary</h3>
                <div class="summary-cards" id="step3SummaryCards">
                    ${generateStep3SummaryCards()}
                </div>
            </div>

            <!-- Week Data Summary after user press button proceedToAnalysisBtn on Step 2 -->
            <div class="week-data-summary">
                <h3 class="week-summary-title">Breakdown by Week</h3>
                <div class="week-summary-content" id="weekSummaryStep3">
                    ${generateWeekSummary()}
                </div>
            </div>
                      
            <div class="analysis-actions" id="analysisActions">
                ${generateAnalysisActions()}
            </div>
        </div>
    `;
    
    // Add event listeners
    setTimeout(() => {
        const viewReportBtn = document.getElementById('viewDetailedReportBtn');
        const newAnalysisBtn = document.getElementById('startNewAnalysisStep3Btn');
        
        // Global report button (for single week)
        if (viewReportBtn) {
            viewReportBtn.addEventListener('click', () => {
                const analysisData = generateAnalysisDataForReports();
                requireModule('uiModule').renderReport(analysisData);
                requireModule('routerModule').navigate('reports');
            });
        }
        
        if (newAnalysisBtn) {
            newAnalysisBtn.addEventListener('click', () => {
                // Clear any selected week when starting new analysis
                const State = requireModule('stateModule');
                State.clearSelectedWeek();
                
                setStep(1);
                if (currentInputMethod === 'upload') {
                    uploadedFiles = [];
                    safeUpdateFileList();
                } else {
                    manualEntries = [];
                    safeUpdateManualEntriesList();
                    saveManualEntries();
                }
                hasBeenAnalyzed = false;
                updateAnalyzeButton();
                requireModule('uiModule').showToast('Ready for new analysis', 'success');
            });
        }
        
        // Add week toggle functionality
        const weekHeaders = document.querySelectorAll('.week-header');
        weekHeaders.forEach(header => {
            header.addEventListener('click', (e) => {
                // Handle week title clicks for navigation to week report
                if (e.target.closest('.week-title')) {
                    const weekTitle = header.querySelector('.week-title');
                    if (weekTitle && weekTitle.textContent) {
                        const match = weekTitle.textContent.match(/Week (\d+), (\d+)/);
                        if (match) {
                            const weekInfo = {
                                week: parseInt(match[1]),
                                year: parseInt(match[2])
                            };
                            console.log(`📅 Week title clicked: Week ${weekInfo.week}, ${weekInfo.year}`);
                            // Navigate to reports with selected week
                            const State = requireModule('stateModule');
                            State.setSelectedWeek(weekInfo);
                            requireModule('routerModule').navigate('reports');
                        }
                    }
                    return;
                }
                
                const weekId = header.dataset.weekId;
                const weekContent = document.getElementById(`${weekId}-content`);
                const isExpanded = weekContent && weekContent.style.display !== 'none';
                
                if (weekContent) {
                    if (isExpanded) {
                        weekContent.style.display = 'none';
                        header.classList.remove('expanded');
                    } else {
                        weekContent.style.display = 'block';
                        header.classList.add('expanded');
                    }
                }
            });
        });
        
        // Add week report button functionality
        const weekReportButtons = document.querySelectorAll('.view-week-report-btn');
        weekReportButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent week toggle when clicking report button
                
                const weekNumber = parseInt(button.dataset.weekNumber);
                const weekYear = parseInt(button.dataset.weekYear);
                const weekIndex = parseInt(button.dataset.weekIndex);
                
                // Use the week selection mechanism instead of filtered reports
                const State = requireModule('stateModule');
                State.setSelectedWeek({
                    week: weekNumber,
                    year: weekYear
                });
                
                requireModule('routerModule').navigate('reports');
            });
        });
    }, 100);
}

// Generate analysis actions based on number of weeks
function generateAnalysisActions() {
    // Determine if we have multiple weeks
    let hasMultipleWeeks = false;
    
    if (lastAnalysisData && lastAnalysisData.results && lastAnalysisData.results.length > 0) {
        const Utils = requireModule('utilitiesModule');
        const weeks = new Set();
        
        lastAnalysisData.results.forEach(result => {
            const date = new Date(result.date);
            const weekNumber = Utils.getWeekOfYear(date);
            const year = date.getFullYear();
            weeks.add(`${year}-W${weekNumber}`);
        });
        
        hasMultipleWeeks = weeks.size > 1;
    }
    
    if (hasMultipleWeeks) {
        // Multiple weeks - only show "Start New Analysis" button
        // Individual week report buttons will be shown in each week section
        return `
            <button class="btn btn-secondary" id="startNewAnalysisStep3Btn">
                <span class="btn-icon">🔄</span>
                <span class="btn-text">Start New Analysis</span>
            </button>
        `;
    } else {
        // Single week - show both global report button and start new analysis
        return `
            <button class="btn btn-primary" id="viewDetailedReportBtn">
                <span class="btn-icon">📊</span>
                <span class="btn-text">View Detailed Report</span>
            </button>
            <div class="action-separator"></div>
            <button class="btn btn-secondary" id="startNewAnalysisStep3Btn">
                <span class="btn-icon">🔄</span>
                <span class="btn-text">Start New Analysis</span>
            </button>
        `;
    }
}

// Generate basic summary cards for Step 3 (simplified version)
function generateStep3SummaryCards() {
    // If we have analysis results from file upload, use those
    if (lastAnalysisData && lastAnalysisData.totals) {
        const totals = lastAnalysisData.totals;
        const difference = (totals.paidTotal || 0) - (totals.expectedTotal || 0);
        const differenceClass = difference >= 0 ? 'positive' : 'negative';
        const differenceIcon = difference >= 0 ? '↗️' : '↘️';
        const dailyAverage = totals.workingDays > 0 ? totals.expectedTotal / totals.workingDays : 0;
        
        return `
            <div class="preview-card enhanced">
                <div class="preview-card-icon">💰</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Total Actual</div>
                    <div class="preview-card-value">£${(totals.paidTotal || 0).toFixed(2)}</div>
                </div>
            </div>
            <div class="preview-card enhanced">
                <div class="preview-card-icon">📋</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Total Expected</div>
                    <div class="preview-card-value">£${(totals.expectedTotal || 0).toFixed(2)}</div>
                </div>
            </div>
            <div class="preview-card enhanced">
                <div class="preview-card-icon ${differenceClass}">${differenceIcon}</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Difference</div>
                    <div class="preview-card-value ${differenceClass}">£${Math.abs(difference).toFixed(2)}</div>
                </div>
            </div>
            <div class="preview-card enhanced">
                <div class="preview-card-icon">📅</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Working Days</div>
                    <div class="preview-card-value">${totals.workingDays || 0}</div>
                </div>
            </div>
            <div class="preview-card enhanced">
                <div class="preview-card-icon">📊</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Daily Average</div>
                    <div class="preview-card-value">£${dailyAverage.toFixed(2)}</div>
                </div>
            </div>
        `;
    }
    
    // Fall back to manual entries if no analysis data
    if (currentInputMethod === 'manual' && manualEntries.length > 0) {
        const totalConsignments = manualEntries.reduce((sum, entry) => sum + entry.consignments, 0);
        const totalExpected = manualEntries.reduce((sum, entry) => sum + entry.expectedTotal, 0);
        const workingDays = manualEntries.length;
        const avgDaily = workingDays > 0 ? totalExpected / workingDays : 0;
        
        return `
            <div class="preview-card enhanced">
                <div class="preview-card-icon">💰</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Total Expected</div>
                    <div class="preview-card-value">£${totalExpected.toFixed(2)}</div>
                </div>
            </div>
            <div class="preview-card enhanced">
                <div class="preview-card-icon">📦</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Consignments</div>
                    <div class="preview-card-value">${totalConsignments}</div>
                </div>
            </div>
            <div class="preview-card enhanced">
                <div class="preview-card-icon">📅</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Working Days</div>
                    <div class="preview-card-value">${workingDays}</div>
                </div>
            </div>
            <div class="preview-card enhanced">
                <div class="preview-card-icon">📊</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Daily Average</div>
                    <div class="preview-card-value">£${avgDaily.toFixed(2)}</div>
                </div>
            </div>
        `;
    }
    
    return `
        <div class="summary-card-simple">
            <div class="card-value">-</div>
            <div class="card-label">No Data</div>
        </div>
    `;
}

// Generate analysis data for reports page
function generateAnalysisDataForReports() {
    if (currentInputMethod === 'manual' && manualEntries.length > 0) {
        const totalConsignments = manualEntries.reduce((sum, entry) => sum + entry.consignments, 0);
        const totalExpected = manualEntries.reduce((sum, entry) => sum + entry.expectedTotal, 0);
        
        return {
            results: manualEntries,
            totals: {
                workingDays: manualEntries.length,
                totalConsignments: totalConsignments,
                totalExpected: totalExpected,
                totalPaid: totalExpected, // For manual entries, expected = paid
                averageDaily: totalExpected / manualEntries.length,
                totalDifference: 0
            },
            metadata: {
                inputMethod: 'manual',
                createdAt: new Date().toISOString(),
                period: `${manualEntries.length} working days`,
                entries: manualEntries.length
            }
        };
    }
    
    // For upload mode, return basic structure
    return {
        results: [],
        totals: {
            workingDays: 0,
            totalConsignments: 0,
            totalExpected: 0,
            totalPaid: 0,
            averageDaily: 0,
            totalDifference: 0
        },
        metadata: {
            inputMethod: 'upload',
            createdAt: new Date().toISOString(),
            period: 'No data',
            entries: 0
        }
    };
}

// Generate week-specific analysis data for reports
function generateWeekAnalysisDataForReports(weekNumber, weekYear, weekIndex) {
    // If we don't have lastAnalysisData, try to load it from state
    if (!lastAnalysisData || !lastAnalysisData.results) {
        const State = requireModule('stateModule');
        const savedState = State.load();
        if (savedState && savedState.lastAnalysis) {
            lastAnalysisData = savedState.lastAnalysis;
        }
    }
    
    if (!lastAnalysisData || !lastAnalysisData.results) {
        return generateAnalysisDataForReports(); // Fallback to full data
    }
    
    // Get the utilities module to calculate week boundaries
    const Utils = requireModule('utilitiesModule');
    const weekStartDate = Utils.getWeekStartDate(weekYear, weekNumber);
    const weekEndDate = Utils.getWeekEndDate(weekYear, weekNumber);
    
    // Filter results for this specific week
    const weekResults = lastAnalysisData.results.filter(result => {
        const resultDate = new Date(result.date);
        return resultDate >= weekStartDate && resultDate <= weekEndDate;
    });
    
    // Calculate totals for this week only
    let weekTotals = {
        workingDays: weekResults.length,
        totalConsignments: 0,
        expectedTotal: 0,
        paidTotal: 0,
        differenceTotal: 0,
        baseTotal: 0,
        bonusTotal: 0,
        unloadingTotal: 0,
        attendanceTotal: 0,
        earlyTotal: 0,
        pickupTotal: 0,
        pickupCount: 0
    };
    
    weekResults.forEach(result => {
        weekTotals.totalConsignments += result.consignments || 0;
        weekTotals.expectedTotal += result.expectedTotal || 0;
        weekTotals.paidTotal += result.paidAmount || 0;
        weekTotals.differenceTotal += result.difference || 0;
        weekTotals.baseTotal += result.basePayment || 0;
        weekTotals.bonusTotal += result.totalBonus || 0;
        weekTotals.unloadingTotal += result.unloadingBonus || 0;
        weekTotals.attendanceTotal += result.attendanceBonus || 0;
        weekTotals.earlyTotal += result.earlyBonus || 0;
        weekTotals.pickupTotal += result.pickupTotal || 0;
        weekTotals.pickupCount += result.pickupCount || 0;
    });
    
    const dailyAverage = weekTotals.workingDays > 0 ? weekTotals.expectedTotal / weekTotals.workingDays : 0;
    
    return {
        results: weekResults,
        totals: {
            ...weekTotals,
            dailyAverage: dailyAverage
        },
        metadata: {
            inputMethod: lastAnalysisData.metadata?.inputMethod || 'upload',
            createdAt: new Date().toISOString(),
            periodRange: `${weekStartDate.toLocaleDateString('en-GB')} - ${weekEndDate.toLocaleDateString('en-GB')}`,
            totalDays: weekTotals.workingDays,
            analysisDate: new Date().toLocaleDateString('en-GB'),
            overallStatus: weekTotals.differenceTotal >= 0 ? 'FAVORABLE' : 'UNFAVORABLE',
            weekInfo: {
                week: weekNumber,
                year: weekYear
            }
        }
    };
    
    return result;
}

// Display analysis results in Step 3
function displayAnalysisResults(analysisData) {
    const analysisStatus = document.getElementById('analysisStatus');
    const analysisResults = document.getElementById('analysisResults');
    const analysisActions = document.getElementById('analysisActions');
    
    if (!analysisStatus || !analysisResults || !analysisActions) return;
    
    // Hide loading status
    analysisStatus.style.display = 'none';
    
    // Generate results summary
    const { results, totals, metadata } = analysisData;
    
    analysisResults.innerHTML = `
        <div class="results-summary">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-icon">📅</div>
                    <div class="card-content">
                        <div class="card-label">Working Days</div>
                        <div class="card-value">${totals.workingDays}</div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">📦</div>
                    <div class="card-content">
                        <div class="card-label">Total Consignments</div>
                        <div class="card-value">${totals.totalConsignments}</div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">💰</div>
                    <div class="card-content">
                        <div class="card-label">Expected Total</div>
                        <div class="card-value">£${totals.expectedTotal.toFixed(2)}</div>
                    </div>
                </div>
                <div class="summary-card ${totals.differenceTotal >= 0 ? 'positive' : 'negative'}">
                    <div class="card-icon">${totals.differenceTotal >= 0 ? '✅' : '❌'}</div>
                    <div class="card-content">
                        <div class="card-label">Difference</div>
                        <div class="card-value">${totals.differenceTotal >= 0 ? '+' : ''}£${totals.differenceTotal.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <div class="status-badge-container">
                <div class="status-badge ${totals.differenceTotal >= 0 ? 'favorable' : 'unfavorable'}">
                    ${metadata.overallStatus}
                </div>
            </div>
            
            <div class="period-info">
                <strong>Analysis Period:</strong> ${metadata.periodRange} 
                <span class="analysis-date">(Analyzed on ${metadata.analysisDate})</span>
            </div>
        </div>
    `;
    
    // Show results and actions
    analysisResults.style.display = 'block';
    analysisActions.style.display = 'block';
    
    // Add event listeners
    document.getElementById('viewDetailedReportBtn').addEventListener('click', () => {
        // Render full report and navigate to reports page
        requireModule('uiModule').renderReport(analysisData);
        requireModule('routerModule').navigate('reports');
    });
    
    document.getElementById('startNewAnalysisStep3Btn').addEventListener('click', () => {
        // Reset to step 1
        setStep(1);
        // Clear current data based on input method
        if (currentInputMethod === 'upload') {
            uploadedFiles = [];
            safeUpdateFileList();
        } else {
            manualEntries = [];
            safeUpdateManualEntriesList();
            saveManualEntries();
        }
        hasBeenAnalyzed = false;
        updateAnalyzeButton();
        requireModule('uiModule').showToast('Ready for new analysis', 'info');
    });
}

// Generate week summary for manual entries or analysis data
function generateWeekSummary() {
    // If we have analysis results from file upload, use those
    if (lastAnalysisData && lastAnalysisData.results) {
        const results = lastAnalysisData.results;
        if (!results || results.length === 0) {
            return `
                <div class="week-empty-state">
                    <div class="week-empty-icon">📅</div>
                    <p class="week-empty-message">No analysis results available</p>
                    <p class="week-empty-subtitle">Run analysis to see daily breakdown</p>
                </div>
            `;
        }
        
        // Group results by week
        const weekGroups = {};
        results.forEach(result => {
            const date = new Date(result.date);
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay() + 1); // Monday
            const weekKey = weekStart.toISOString().split('T')[0];
            
            if (!weekGroups[weekKey]) {
                weekGroups[weekKey] = {
                    weekStart: weekStart,
                    days: [],
                    totalExpected: 0,
                    totalActual: 0,
                    workingDays: 0
                };
            }
            
            weekGroups[weekKey].days.push(result);
            weekGroups[weekKey].totalExpected += result.expectedTotal || 0;
            weekGroups[weekKey].totalActual += result.paidAmount || 0;
            weekGroups[weekKey].workingDays++;
        });
        
        // Sort weeks by date (most recent first)
        const sortedWeeks = Object.values(weekGroups).sort((a, b) => b.weekStart - a.weekStart);
        const hasMultipleWeeks = sortedWeeks.length > 1;
        
        // Generate HTML for each week
        const weekSections = sortedWeeks.map((week, index) => {
            const weekEndDate = new Date(week.weekStart);
            weekEndDate.setDate(weekEndDate.getDate() + 6);
            
            // Calculate week number and year
            const Utils = requireModule('utilitiesModule');
            const weekNumber = Utils.getWeekOfYear(week.weekStart);
            const weekYear = week.weekStart.getFullYear();
            
            const weekDifference = week.totalActual - week.totalExpected;
            const weekDifferenceClass = weekDifference >= 0 ? 'positive' : 'negative';
            
            // Sort days within week
            const sortedDays = week.days.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const dayCards = sortedDays.map(result => {
                const difference = (result.paidAmount || 0) - (result.expectedTotal || 0);
                const differenceClass = difference >= 0 ? 'positive' : 'negative';
                const differenceIcon = difference >= 0 ? '↗️' : '↘️';
                const dayName = new Date(result.date).toLocaleDateString('en-GB', { weekday: 'short' });
                
                return `
                    <div class="step2-entry-card enhanced-daily-card">
                        <div class="card-header">
                            <div class="date-info">
                                <h3 class="day-name">${dayName}</h3>
                                <p class="day-date">${result.date}</p>
                            </div>
                            ${Math.abs(difference) > 0 ? `
                            <div class="status-badge ${differenceClass}">
                                <span class="status-icon">${differenceIcon}</span>
                                <span class="status-amount">£${Math.abs(difference).toFixed(2)}</span>
                            </div>` : ''}
                        </div>
                        
                        <div class="card-body">
                            <div class="main-amounts">
                                <div class="amount-row">
                                    <span class="amount-label">Expected</span>
                                    <span class="amount-value">£${(result.expectedTotal || 0).toFixed(2)}</span>
                                </div>
                                <div class="amount-row">
                                    <span class="amount-label">Actual</span>
                                    <span class="amount-value">£${(result.paidAmount || 0).toFixed(2)}</span>
                                </div>
                            </div>
                            
                            ${(result.expectedTotal || 0) > 0 ? `
                            <div class="breakdown-section">
                                <h4 class="breakdown-title">Breakdown</h4>
                                <div class="breakdown-grid">
                                    <div class="breakdown-item">
                                        <span class="item-label">Base</span>
                                        <span class="item-value">£${(result.basePayment || 0).toFixed(2)}</span>
                                    </div>
                                    ${(result.pickupTotal || 0) > 0 ? `
                                    <div class="breakdown-item">
                                        <span class="item-label">Pickup</span>
                                        <span class="item-value">£${result.pickupTotal.toFixed(2)}</span>
                                    </div>` : ''}
                                    ${(result.unloadingBonus || 0) > 0 ? `
                                    <div class="breakdown-item">
                                        <span class="item-label">Unload</span>
                                        <span class="item-value">£${result.unloadingBonus.toFixed(2)}</span>
                                    </div>` : ''}
                                    ${(result.attendanceBonus || 0) > 0 ? `
                                    <div class="breakdown-item">
                                        <span class="item-label">Attend</span>
                                        <span class="item-value">£${result.attendanceBonus.toFixed(2)}</span>
                                    </div>` : ''}
                                    ${(result.earlyBonus || 0) > 0 ? `
                                    <div class="breakdown-item">
                                        <span class="item-label">Early</span>
                                        <span class="item-value">£${result.earlyBonus.toFixed(2)}</span>
                                    </div>` : ''}
                                </div>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="week-group">
                    <div class="week-header" data-week-id="week-${index}">
                        <div class="week-info">
                            <h3 class="week-title">Week ${weekNumber}, ${weekYear}</h3>
                            <div class="week-dates">${week.weekStart.toLocaleDateString('en-GB', {
                                day: 'numeric',
                                month: 'short'
                            })} - ${weekEndDate.toLocaleDateString('en-GB', {
                                day: 'numeric',
                                month: 'short',
                                year: 'numeric'
                            })}</div>
                        </div>
                        <div class="week-summary">
                            <div class="week-badge ${weekDifferenceClass}">
                                ${weekDifference >= 0 ? '↗️' : '↘️'} £${Math.abs(weekDifference).toFixed(2)}
                            </div>
                            <div class="week-toggle">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="week-content" id="week-${index}-content" style="display: none;">
                        <div class="week-days-list">
                            ${dayCards}
                        </div>
                        <div class="week-summary-totals">
                            <div class="preview-card enhanced compact">
                                <div class="preview-card-icon">📋</div>
                                <div class="preview-card-content">
                                    <div class="preview-card-label">Week Expected</div>
                                    <div class="preview-card-value">£${week.totalExpected.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="preview-card enhanced compact">
                                <div class="preview-card-icon">💰</div>
                                <div class="preview-card-content">
                                    <div class="preview-card-label">Week Actual</div>
                                    <div class="preview-card-value">£${week.totalActual.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="preview-card enhanced compact">
                                <div class="preview-card-icon">📅</div>
                                <div class="preview-card-content">
                                    <div class="preview-card-label">Working Days</div>
                                    <div class="preview-card-value">${week.workingDays}</div>
                                </div>
                            </div>
                        </div>
                        ${hasMultipleWeeks ? `
                        <div class="week-actions">
                            <button class="btn btn-primary view-week-report-btn" data-week-number="${weekNumber}" data-week-year="${weekYear}" data-week-index="${index}">
                                <span class="btn-icon">📊</span>
                                <span class="btn-text">View Week ${weekNumber} Report</span>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        return `
            <div class="weeks-container">
                ${weekSections}
            </div>
        `;
    }
    
    // Fall back to manual entries
    if (manualEntries.length === 0) {
        return `
            <div class="week-empty-state">
                <div class="week-empty-icon">📅</div>
                <p class="week-empty-message">No entries added yet</p>
                <p class="week-empty-subtitle">Add your daily data to see weekly progress</p>
            </div>
        `;
    }
    
    // Sort entries by date for chronological display
    const sortedEntries = [...manualEntries].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Calculate totals and statistics
    let totalExpected = 0;
    let totalConsignments = 0;
    let totalBonuses = 0;
    
    const enhancedItems = sortedEntries.map((entry, index) => {
        const expectedTotal = entry.expectedTotal || 0;
        const consignments = entry.consignments || 0;
        const bonuses = (entry.earlyArrive || 0) + (entry.loadingBonus || 0);
        
        totalExpected += expectedTotal;
        totalConsignments += consignments;
        totalBonuses += bonuses;
        
        const date = new Date(entry.date);
        const formattedDate = date.toLocaleDateString('en-GB', { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short' 
        });
        
        const dayName = date.toLocaleDateString('en-GB', { weekday: 'short' });
        
        return `
            <div class="step2-entry-card enhanced-daily-card">
                <div class="card-header">
                    <div class="date-info">
                        <h3 class="day-name">${dayName}</h3>
                        <p class="day-date">${formattedDate}</p>
                    </div>
                    <div class="total-badge">
                        <span class="total-amount">£${expectedTotal.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="main-amounts">
                        <div class="amount-row">
                            <span class="amount-label">📦 Consignments</span>
                            <span class="amount-value">${consignments}</span>
                        </div>
                        <div class="amount-row">
                            <span class="amount-label">💰 Base Rate</span>
                            <span class="amount-value">£${(entry.baseAmount || 0).toFixed(2)}</span>
                        </div>
                        ${bonuses > 0 ? `
                        <div class="amount-row bonus-row">
                            <span class="amount-label">⭐ Bonuses</span>
                            <span class="amount-value">£${bonuses.toFixed(2)}</span>
                        </div>` : ''}
                    </div>
                    
                    ${expectedTotal > 0 ? `
                    <div class="breakdown-section">
                        <h4 class="breakdown-title">Payment Breakdown</h4>
                        <div class="breakdown-grid">
                            <div class="breakdown-item">
                                <span class="item-label">Base</span>
                                <span class="item-value">£${(entry.baseAmount || 0).toFixed(2)}</span>
                            </div>
                            ${(entry.pickupBonus || 0) > 0 ? `
                            <div class="breakdown-item">
                                <span class="item-label">Pickup</span>
                                <span class="item-value">£${entry.pickupBonus.toFixed(2)}</span>
                            </div>` : ''}
                            ${(entry.loadingBonus || 0) > 0 ? `
                            <div class="breakdown-item">
                                <span class="item-label">Loading</span>
                                <span class="item-value">£${entry.loadingBonus.toFixed(2)}</span>
                            </div>` : ''}
                            ${(entry.attendanceBonus || 0) > 0 ? `
                            <div class="breakdown-item">
                                <span class="item-label">Attend</span>
                                <span class="item-value">£${entry.attendanceBonus.toFixed(2)}</span>
                            </div>` : ''}
                            ${(entry.earlyArrive || 0) > 0 ? `
                            <div class="breakdown-item">
                                <span class="item-label">Early</span>
                                <span class="item-value">£${entry.earlyArrive.toFixed(2)}</span>
                            </div>` : ''}
                        </div>
                    </div>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    // Calculate averages
    const avgDaily = sortedEntries.length > 0 ? totalExpected / sortedEntries.length : 0;
    const avgConsignments = sortedEntries.length > 0 ? totalConsignments / sortedEntries.length : 0;
    
    return `
        <div class="week-summary-list">
            ${enhancedItems}
        </div>
        <div class="week-summary-totals">
            <div class="preview-card enhanced compact">
                <div class="preview-card-icon">📅</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Days Entered</div>
                    <div class="preview-card-value">${sortedEntries.length}</div>
                </div>
            </div>
            <div class="preview-card enhanced compact">
                <div class="preview-card-icon">💰</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Total Expected</div>
                    <div class="preview-card-value">£${totalExpected.toFixed(2)}</div>
                </div>
            </div>
            <div class="preview-card enhanced compact">
                <div class="preview-card-icon">📊</div>
                <div class="preview-card-content">
                    <div class="preview-card-label">Daily Average</div>
                    <div class="preview-card-value">£${avgDaily.toFixed(2)}</div>
                </div>
            </div>
        </div>
    `;
}

// Format date for display (e.g., "19 Aug")
function formatDateForDisplay(dateStr) {
    const date = new Date(dateStr);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${date.getDate()} ${months[date.getMonth()]}`;
}

// Generate uploaded files list for Step 2 validation
function generateUploadedFilesList() {
    if (uploadedFiles.length === 0) return '<p class="no-files">No files uploaded</p>';
    
    return uploadedFiles.map(file => {
        const fileSize = (file.size / 1024).toFixed(1);
        const fileTypeIcon = file.type === 'runsheet' ? '📊' : file.type === 'invoice' ? '🧾' : '📄';
        const fileTypeLabel = file.type === 'runsheet' ? 'Runsheet' : file.type === 'invoice' ? 'Invoice' : 'Unknown';
        
        return `
            <div class="validation-file-item">
                <div class="file-icon-wrapper">
                    <span class="file-type-icon">${fileTypeIcon}</span>
                </div>
                <div class="file-details">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">
                        <span class="file-type">${fileTypeLabel}</span>
                        <span class="file-size">${fileSize} KB</span>
                    </div>
                </div>
                <div class="file-status">
                    <span class="status-badge status-ready">✓ Ready</span>
                </div>
            </div>
        `;
    }).join('');
}

// Save manual entries to localStorage
function saveManualEntries() {
    try {
        localStorage.setItem('manualEntries_v9', JSON.stringify(manualEntries));
        console.log('💾 Manual entries saved to storage');
    } catch (error) {
        console.error('Failed to save manual entries:', error);
    }
}

// Load manual entries from localStorage
function loadManualEntries() {
    try {
        const saved = localStorage.getItem('manualEntries_v9');
        if (saved) {
            manualEntries = JSON.parse(saved);
            console.log('📝 Loaded manual entries from storage:', manualEntries.length);
            
            if (manualEntries.length > 0) {
                setInputMethod('manual');
            } else {
                // Even if localStorage has an empty array, reset to upload mode
                setInputMethod('upload');
            }
            
            return manualEntries;
        } else {
            // No saved entries, ensure array is empty and UI is reset
            manualEntries = [];
            setInputMethod('upload');
            console.log('📝 No manual entries found in storage, resetting to upload mode');
            return [];
        }
    } catch (error) {
        console.error('Failed to load manual entries:', error);
        manualEntries = [];
        setInputMethod('upload');
        return [];
    }
}

// Save uploaded files to localStorage (Note: File objects can't be serialized)
function saveUploadedFilesInfo() {
    try {
        const fileInfos = uploadedFiles.map(f => ({
            id: f.id,
            name: f.name,
            type: f.type,
            size: f.size,
            lastModified: f.file?.lastModified || 0
        }));
        localStorage.setItem('uploadedFiles_v9', JSON.stringify(fileInfos));
        console.log('💾 Saved uploaded files info to storage:', fileInfos.length);
    } catch (error) {
        console.error('Failed to save uploaded files info:', error);
    }
}

// Load uploaded files info from localStorage (but can't restore actual File objects)
function loadUploadedFilesInfo() {
    try {
        const saved = localStorage.getItem('uploadedFiles_v9');
        if (saved) {
            const fileInfos = JSON.parse(saved);
            console.log('📁 Found uploaded files info in storage:', fileInfos.length);
            // Note: We can't restore File objects, only metadata
            // This info will be used to show user what was previously uploaded
            return fileInfos;
        }
    } catch (error) {
        console.error('Failed to load uploaded files info:', error);
    }
    return [];
}

// Clear uploaded files info from localStorage
function clearUploadedFilesInfo() {
    try {
        localStorage.removeItem('uploadedFiles_v9');
        console.log('🗑️ Cleared uploaded files info from storage');
    } catch (error) {
        console.error('Failed to clear uploaded files info:', error);
    }
}

// Info tooltip functionality
function initializeInfoTooltips() {
    // Handle info icon hover events
    document.addEventListener('mouseenter', (e) => {
        if (e.target.classList.contains('info-icon')) {
            showInfoTooltip(e.target);
        }
    }, true);
    
    document.addEventListener('mouseleave', (e) => {
        if (e.target.classList.contains('info-icon')) {
            hideInfoTooltip(e.target);
        }
    }, true);
    
    // Hide tooltips when modals are closed
    document.addEventListener('click', (e) => {
        if (e.target.id === 'manualEntryOverlay' || e.target.id === 'editDayOverlay') {
            hideAllInfoTooltips();
        }
    });
}

function showInfoTooltip(iconElement) {
    // Remove any existing tooltips
    hideAllInfoTooltips();
    
    const tooltipText = iconElement.getAttribute('data-tooltip');
    if (!tooltipText) return;
    
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.className = 'info-tooltip';
    tooltip.textContent = tooltipText;
    
    // Add tooltip to the icon
    iconElement.appendChild(tooltip);
    
    // Position tooltip relative to viewport
    setTimeout(() => {
        const iconRect = iconElement.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        
        // Check if tooltip would go off bottom of viewport
        if (iconRect.bottom + tooltipRect.height + 15 > window.innerHeight) {
            tooltip.classList.add('above');
        }
        
        // Check horizontal positioning (tooltip is much smaller now, so simpler logic)
        const tooltipLeftEdge = iconRect.left - tooltipRect.width / 2;
        const tooltipRightEdge = iconRect.left + tooltipRect.width / 2;
        
        if (tooltipRightEdge > window.innerWidth - 10) {
            // Would overflow right - align to right edge of icon
            tooltip.style.left = 'auto';
            tooltip.style.right = '0';
            tooltip.style.transform = 'translateY(4px)';
        } else if (tooltipLeftEdge < 10) {
            // Would overflow left - align to left edge of icon
            tooltip.style.left = '0';
            tooltip.style.right = 'auto';
            tooltip.style.transform = 'translateY(4px)';
        }
        
        tooltip.classList.add('show');
    }, 10);
}

function hideInfoTooltip(iconElement) {
    const tooltip = iconElement.querySelector('.info-tooltip');
    if (tooltip) {
        // Add delay before hiding to allow reading
        setTimeout(() => {
            if (tooltip.parentNode) {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.remove();
                    }
                }, 200);
            }
        }, 200); // 1.5 second delay before hiding
    }
}

function hideAllInfoTooltips() {
    const allTooltips = document.querySelectorAll('.info-tooltip');
    allTooltips.forEach(tooltip => {
        tooltip.classList.remove('show');
        setTimeout(() => {
            if (tooltip.parentNode) {
                tooltip.remove();
            }
        }, 200);
    });
}

function updateFormTooltips(rules, dayType = null) {
    // Get current day if not provided
    if (!dayType) {
        const entryDayField = document.getElementById('entryDay') || document.getElementById('editDay');
        dayType = entryDayField ? entryDayField.value.toLowerCase() : 'monday';
    }
    
    const isSaturday = dayType === 'saturday';
    const isMonday = dayType === 'monday';
    const isSunday = dayType === 'sunday';
    
    // Calculate current rate for the selected day
    let currentRate = 0;
    let rateText = 'Rest day - no work';
    if (!isSunday) {
        currentRate = isSaturday ? rules.saturdayRate : rules.weekdayRate;
        rateText = `You earn £${currentRate} per delivery`;
    }
    
    // Calculate current bonuses for the selected day
    let earlyAmount = 0, attendanceAmount = 0, unloadingAmount = 0;
    let earlyText = 'No bonus today', attendanceText = 'No bonus today', unloadingText = 'No bonus today';
    
    if (!isSunday) {
        // Unloading bonus
        unloadingAmount = isMonday ? 0 : rules.unloadingBonus;
        unloadingText = isMonday ? 'No unloading bonus on Monday' : `£${unloadingAmount} bonus today`;
        
        // Weekday bonuses (not Saturday)
        if (!isSaturday) {
            earlyAmount = rules.earlyBonus;
            attendanceAmount = rules.attendanceBonus;
            earlyText = `£${earlyAmount} bonus today`;
            attendanceText = `£${attendanceAmount} bonus today`;
        } else {
            earlyText = 'No early bonus on Saturday';
            attendanceText = 'No attendance bonus on Saturday';
        }
    }
    
    // Update tooltips with day-specific information
    const tooltipMappings = [
        {
            selector: '[for="baseAmount"]',
            tooltip: rateText
        },
        {
            selector: '[for="earlyArrive"], [for="editEarlyArrive"]',
            tooltip: earlyText
        },
        {
            selector: '[for="onTimePercentage"], [for="editOnTimePercentage"]',
            tooltip: attendanceText
        },
        {
            selector: '[for="loadingBonus"], [for="editLoadingBonus"]',
            tooltip: unloadingText
        }
    ];
    
    tooltipMappings.forEach(mapping => {
        const labels = document.querySelectorAll(mapping.selector);
        labels.forEach(label => {
            const infoIcon = label.parentElement.querySelector('.info-icon');
            if (infoIcon) {
                infoIcon.setAttribute('data-tooltip', mapping.tooltip);
            }
        });
    });
}

// Export functions for external access
exports.setInputMethod = setInputMethod;
exports.setStep = setStep;
exports.populateStep2Content = populateStep2Content;
exports.populateStep3Content = populateStep3Content;
exports.generateWeekAnalysisDataForReports = generateWeekAnalysisDataForReports;
exports.showManualEntryModal = showManualEntryModal;
</script>

<!-- Reports Module -->
<script id="reportsModule" type="application/x-module">
// Reports Module with enhanced export and print functionality
let currentReportData = null;

exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('reports', {
        onLoad: () => {
            console.log('📊 Loading reports page');
            exports.loadReport();
            // Scroll to top when reports page loads
            const reportsContent = document.getElementById('reportsContent');
            if (reportsContent) {
                reportsContent.scrollTop = 0;
            }
            // Also scroll the main page to top
            window.scrollTo(0, 0);
        }
    });
    
    // Print button with enhanced functionality
    document.getElementById('printReport').addEventListener('click', () => {
        if (!currentReportData) {
            requireModule('uiModule').showToast('No report to print', 'warn');
            return;
        }
        
        // Add print-specific class to body for styling
        document.body.classList.add('printing');
        
        // Trigger print
        window.print();
        
        // Remove print class after a delay
        setTimeout(() => {
            document.body.classList.remove('printing');
        }, 500);
    });
    
    // Export button with current report export
    document.getElementById('exportReport').addEventListener('click', () => {
        if (!currentReportData) {
            requireModule('uiModule').showToast('No report to export', 'warn');
            return;
        }
        
        const State = requireModule('stateModule');
        State.exportData(currentReportData, false);
    });
    
    // Pull-to-refresh for mobile (temporarily disabled to prevent aggressive refreshing)
    // TODO: Re-enable with better UX when navigation issues are resolved
    /*
    let startY = 0;
    let isPulling = false;
    let hasTriggeredRefresh = false;

    const reportsContent = document.getElementById('reportsContent');
    const pullIndicator = document.getElementById('pullIndicator');

    reportsContent.addEventListener('touchstart', (e) => {
        // Only enable pull-to-refresh if exactly at the top and not already refreshing
        if (reportsContent.scrollTop === 0 && !hasTriggeredRefresh) {
            startY = e.touches[0].clientY;
            isPulling = true;
        }
    });

    reportsContent.addEventListener('touchmove', (e) => {
        if (!isPulling || hasTriggeredRefresh) return;
        
        const currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        
        // Much more restrictive - require a significant pull distance
        if (diff > 0 && diff < 200) {
            e.preventDefault(); // Prevent scrolling while pulling
            pullIndicator.style.transform = `translateY(${diff}px)`;
            
            if (diff > 120) {
                pullIndicator.innerHTML = '<span>↑ Release to refresh</span>';
            } else {
                pullIndicator.innerHTML = '<span>↓ Pull down to refresh</span>';
            }
        }
    });

    reportsContent.addEventListener('touchend', (e) => {
        if (!isPulling || hasTriggeredRefresh) return;
        
        const endY = e.changedTouches[0].clientY;
        const diff = endY - startY;
        
        // Require a much larger pull distance (120px instead of 80px)
        if (diff > 120) {
            hasTriggeredRefresh = true;
            pullIndicator.innerHTML = '<span>🔄 Refreshing...</span>';
            
            // Use a timeout to prevent rapid successive calls
            setTimeout(() => {
                exports.loadReport();
                requireModule('uiModule').showToast('Report refreshed', 'success');
            }, 100);
            
            // Reset after a longer delay
            setTimeout(() => {
                hasTriggeredRefresh = false;
            }, 3000);
        }
        
        pullIndicator.style.transform = 'translateY(0)';
        isPulling = false;
    });
    */
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (Router.getCurrentPage() === 'reports') {
            // Ctrl/Cmd + P to print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                document.getElementById('printReport').click();
            }
            // Ctrl/Cmd + E to export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                document.getElementById('exportReport').click();
            }
        }
    });
};

// Flag to prevent duplicate calls
let isLoadingReport = false;

exports.loadReport = function() {
    // Prevent duplicate calls
    if (isLoadingReport) {
        console.log('📊 LoadReport already in progress, skipping');
        return;
    }
    
    isLoadingReport = true;
    
    const State = requireModule('stateModule');
    const UI = requireModule('uiModule');
    const Dashboard = requireModule('dashboardModule');
    
    // Priority 1: Check if a filtered report was set (day-specific)
    const filteredReport = State.getFilteredReport();
    console.log('📊 LoadReport - Filtered report:', filteredReport);
    
    if (filteredReport) {
        // Load filtered report (specific day)
        console.log('📊 Loading filtered report (day-specific)');
        currentReportData = filteredReport;
        UI.renderReport(currentReportData);
        // Delay clearing to prevent router onLoad from overwriting
        setTimeout(() => {
            State.clearFilteredReport();
        }, 100);
    } else {
        // Priority 2: Check if a specific week was selected
        const selectedWeek = State.getSelectedWeek();
        console.log('📊 LoadReport - Selected week:', selectedWeek);
        
        if (selectedWeek) {
            // Load data for specific week using our analysis module function
            console.log('📊 Loading week report');
            // Use the generateWeekAnalysisDataForReports function from analysisModule
            const analysisModule = requireModule('analysisModule');
            if (analysisModule && analysisModule.generateWeekAnalysisDataForReports) {
                currentReportData = analysisModule.generateWeekAnalysisDataForReports(selectedWeek.week, selectedWeek.year, 0);
                if (currentReportData && currentReportData.results && currentReportData.results.length > 0) {
                    UI.renderReport(currentReportData);
                } else {
                    // If week-specific data is empty, show "No Report Available" message
                    UI.renderReport(null);
                }
            } else {
                console.log('❌ Analysis module or function not available');
                // Fallback to regular report
                console.log('📊 Loading regular saved report');
                const savedState = State.load();
                if (savedState && savedState.lastAnalysis) {
                    currentReportData = savedState.lastAnalysis;
                    UI.renderReport(currentReportData);
                }
            }
            // Don't clear immediately - let it persist for the report display
        } else {
            // Priority 3: Load regular report (all data or selected analysis)
            console.log('📊 Loading regular saved report');
            const savedState = State.load();
            if (savedState && savedState.lastAnalysis) {
                currentReportData = savedState.lastAnalysis;
                UI.renderReport(currentReportData);
                
                // Check if validation passed
                if (currentReportData.metadata && currentReportData.metadata.overallStatus) {
                    if (currentReportData.metadata.overallStatus.includes('INVALID')) {
                        UI.showToast('⚠️ Report has validation issues', 'warn');
                    } else if (currentReportData.metadata.overallStatus.includes('VALIDATED')) {
                        console.log('✅ Report is validated');
                    }
                }
            } else {
                currentReportData = null;
                UI.renderReport(null);
            }
        }
    }
    
    // Reset the loading flag
    isLoadingReport = false;
};

exports.getWeekReportData = function(weekInfo) {
    const State = requireModule('stateModule');
    const Utils = requireModule('utilitiesModule');
    
    // Get all analyses
    const analyses = State.getAllAnalyses();
    const analysesArray = Object.values(analyses);
    
    if (analysesArray.length === 0) return null;
    
    // Filter analyses for the specified week
    const weekStart = Utils.getWeekStartDate(weekInfo.year, weekInfo.week);
    const weekEnd = Utils.getWeekEndDate(weekInfo.year, weekInfo.week);
    
    const weekData = [];
    analysesArray.forEach(analysis => {
        if (analysis.analysis && analysis.analysis.results) {
            analysis.analysis.results.forEach(result => {
                const resultDate = new Date(result.date);
                if (resultDate >= weekStart && resultDate <= weekEnd) {
                    weekData.push(result);
                }
            });
        }
    });
    
    if (weekData.length === 0) return null;
    
    // Calculate totals for the week
    const totals = {
        workingDays: weekData.length,
        totalConsignments: weekData.reduce((sum, r) => sum + (r.consignments || 0), 0),
        expectedTotal: weekData.reduce((sum, r) => sum + (r.expectedTotal || 0), 0),
        paidTotal: weekData.reduce((sum, r) => sum + (r.paidAmount || 0), 0),
        differenceTotal: weekData.reduce((sum, r) => sum + (r.difference || 0), 0),
        baseTotal: weekData.reduce((sum, r) => sum + (r.basePayment || 0), 0),
        pickupTotal: weekData.reduce((sum, r) => sum + (r.pickupTotal || 0), 0),
        bonusTotal: weekData.reduce((sum, r) => sum + (r.totalBonus || 0), 0),
        unloadingTotal: weekData.reduce((sum, r) => sum + (r.unloadingBonus || 0), 0),
        attendanceTotal: weekData.reduce((sum, r) => sum + (r.attendanceBonus || 0), 0),
        earlyTotal: weekData.reduce((sum, r) => sum + (r.earlyStartBonus || 0), 0)
    };
    
    // Format dates for display
    const startStr = weekStart.toLocaleDateString('en-GB');
    const endStr = weekEnd.toLocaleDateString('en-GB');
    
    return {
        results: weekData.sort((a, b) => a.date.localeCompare(b.date)),
        totals: totals,
        metadata: {
            periodRange: `${startStr} - ${endStr}`,
            totalDays: weekData.length,
            weekInfo: weekInfo,
            createdAt: new Date().toISOString(),
            inputMethod: 'weekly_view'
        }
    };
};

/**
 * Generate weekly report using utilitiesModule functions
 * @param {Array} data - Data to group by week
 * @param {string} dateField - Field containing the date (default: 'date')
 * @returns {Object} - Formatted weekly report
 */
exports.generateWeeklyReport = function(data, dateField = 'date') {
    const Utils = requireModule('utilitiesModule');
    
    if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn('📊 No data provided for weekly report');
        return { weeks: [], summary: { totalWeeks: 0, totalItems: 0 } };
    }
    
    console.log(`📅 Generating weekly report for ${data.length} items`);
    
    // Group data by week
    const weeklyData = Utils.groupByWeek(data, dateField);
    
    // Generate weekly summary
    const weeklySummary = Utils.generateWeeklySummary(weeklyData);
    
    // Calculate general statistics
    const totalItems = data.length;
    const totalWeeks = weeklySummary.length;
    const currentDate = new Date();
    const currentWeek = Utils.getWeekOfYear(currentDate);
    const currentYear = currentDate.getFullYear();
    
    const report = {
        weeks: weeklySummary,
        summary: {
            totalWeeks: totalWeeks,
            totalItems: totalItems,
            currentWeek: currentWeek,
            currentYear: currentYear,
            currentWeekKey: `${currentYear}-W${String(currentWeek).padStart(2, '0')}`,
            averageItemsPerWeek: totalWeeks > 0 ? Math.round(totalItems / totalWeeks) : 0,
            generatedAt: Utils.formatDateForDisplay(currentDate),
            generatedWeek: `Week ${currentWeek} of ${currentYear}`
        }
    };
    
    console.log(`📈 Weekly report generated: ${totalWeeks} weeks, ${totalItems} items`);
    return report;
};

/**
 * Demonstrate the use of getWeekOfYear function with current date
 * This is an example function that can be called to test
 */
exports.demonstrateWeekCalculation = function() {
    const Utils = requireModule('utilitiesModule');
    const UI = requireModule('uiModule');
    
    // Example with current date
    const currentDate = new Date();
    const weekNumber = Utils.getWeekOfYear(currentDate);
    
    // Example with the date provided in the original comment (August 23, 2025)
    const exampleDate = new Date(2025, 7, 23); // Month is 0-indexed
    const exampleWeek = Utils.getWeekOfYear(exampleDate);
    
    const message = `📅 Week calculation demonstration:
    
Current date: ${Utils.formatDateForDisplay(currentDate)}
Current week: ${weekNumber}

Example date (23/08/2025): ${Utils.formatDateForDisplay(exampleDate)}
Example week: ${exampleWeek}`;
    
    console.log(message);
    UI.showToast(`Current week: ${weekNumber} | Example (23/08/2025): ${exampleWeek}`, 'info');
    
    return {
        currentDate,
        currentWeek: weekNumber,
        exampleDate,
        exampleWeek
    };
};
</script>

<!-- History Module -->
<script id="historyModule" type="application/x-module">
// History Module
exports.init = function() {
    const Router = requireModule('routerModule');
    
    // Register page handler
    Router.registerPageHandler('history', {
        onLoad: () => {
            console.log('📜 Loading history page');
            exports.loadHistory();
        }
    });
    
    // Clear history button
    document.getElementById('clearHistory').addEventListener('click', () => {
        if (confirm('Clear all history? This cannot be undone.')) {
            const State = requireModule('stateModule');
            State.clear();
            exports.loadHistory();
            requireModule('uiModule').showToast('History cleared', 'success');
        }
    });
    
    // History item clicks and toggle handling (weeks and months)
    document.getElementById('historyList').addEventListener('click', (e) => {
        const item = e.target.closest('.history-item');
        const monthHeader = e.target.closest('.month-header');
        const weekHeader = e.target.closest('.week-header');
        
        if (item && item.dataset.analysisId) {
            // Handle history item click - show specific day report
            const analysisId = item.dataset.analysisId;
            const dayDate = item.dataset.dayDate;
            
            if (dayDate) {
                exports.loadDayReport(analysisId, dayDate);
            } else {
                exports.loadAnalysis(analysisId);
            }
        } else if (weekHeader && weekHeader.dataset.weekId) {
            // Check if user clicked on the week title or summary to view report
            const weekTitle = e.target.closest('.week-title');
            const weekTotal = e.target.closest('.week-total');
            
            if (weekTitle || weekTotal) {
                // Click on week title or total shows week report
                const weekId = weekHeader.dataset.weekId;
                const weekMatch = weekId.match(/week-(\d+)-(\d+)/);
                if (weekMatch) {
                    const weekInfo = {
                        week: parseInt(weekMatch[2]),
                        year: parseInt(weekMatch[1])
                    };
                    exports.loadWeekReport(weekInfo);
                    return;
                }
            }
            
            // Regular click on other areas - Handle week expand/collapse
            const weekId = weekHeader.dataset.weekId;
            const weekContent = document.getElementById(weekId);
            
            if (weekContent) {
                const isExpanded = weekContent.style.display !== 'none';
                
                if (isExpanded) {
                    // Collapse
                    weekContent.style.display = 'none';
                    weekHeader.classList.remove('expanded');
                } else {
                    // Expand
                    weekContent.style.display = 'block';
                    weekHeader.classList.add('expanded');
                }
            }
        } else if (monthHeader && monthHeader.dataset.monthId) {
            // Handle month expand/collapse
            const monthId = monthHeader.dataset.monthId;
            const monthContent = document.getElementById(monthId);
            
            if (monthContent) {
                const isExpanded = monthContent.style.display !== 'none';
                
                if (isExpanded) {
                    // Collapse
                    monthContent.style.display = 'none';
                    monthHeader.classList.remove('expanded');
                } else {
                    // Expand
                    monthContent.style.display = 'block';
                    monthHeader.classList.add('expanded');
                }
            }
        }
    });
};

exports.loadHistory = function() {
    const UI = requireModule('uiModule');
    UI.renderHistory();
};

exports.loadAnalysis = function(analysisId) {
    const State = requireModule('stateModule');
    const UI = requireModule('uiModule');
    const Router = requireModule('routerModule');
    const Dashboard = requireModule('dashboardModule');
    
    const analyses = State.getAllAnalyses();
    const analysis = analyses[analysisId];
    
    if (analysis) {
        // Set the selected analysis and navigate to reports page
        Dashboard.setSelectedAnalysis(analysisId);
        Router.navigate('reports');
        
        // Get analysis date for user feedback
        const analysisDate = analysis.metadata?.createdAt ? 
            new Date(analysis.metadata.createdAt).toLocaleDateString() : 'Unknown date';
        
        UI.showToast(`Viewing analysis from ${analysisDate}`, 'success');
    } else {
        UI.showToast('Analysis not found', 'error');
    }
};

exports.loadDayReport = function(analysisId, dayDate) {
    const State = requireModule('stateModule');
    const UI = requireModule('uiModule');
    const Router = requireModule('routerModule');
    
    const analyses = State.getAllAnalyses();
    const analysis = analyses[analysisId];
    
    if (analysis) {
        // Filter the analysis to show only the specific day
        const filteredAnalysis = exports.filterAnalysisByDay(analysis, dayDate);
        
        if (filteredAnalysis) {
            // Store the filtered analysis temporarily
            State.setFilteredReport(filteredAnalysis);
            
            // Navigate to reports page
            Router.navigate('reports');
            
            // Show user feedback
            const displayDate = new Date(dayDate).toLocaleDateString('en-GB');
            UI.showToast(`Viewing report for ${displayDate}`, 'success');
        } else {
            UI.showToast('No data found for this date', 'error');
        }
    } else {
        UI.showToast('Analysis not found', 'error');
    }
};

exports.filterAnalysisByDay = function(analysis, dayDate) {
    // Create a filtered version of the analysis containing only the specified day
    if (!analysis.details || !analysis.details.daily) {
        return null;
    }
    
    // Find the specific day in the analysis
    const targetDay = analysis.details.daily.find(day => {
        // Convert the compressed date format (MM-DD) to full date for comparison
        const currentYear = new Date().getFullYear();
        const [month, dayNum] = day.d.split('-');
        const fullDate = new Date(currentYear, parseInt(month) - 1, parseInt(dayNum));
        return fullDate.toISOString().split('T')[0] === dayDate;
    });
    
    if (!targetDay) {
        return null;
    }
    
    // Calculate week information for the day
    const Utils = requireModule('utilitiesModule');
    const date = new Date(dayDate);
    const weekNumber = Utils.getWeekOfYear(date);
    const year = date.getFullYear();
    
    console.log(`🗓️ Day filter: ${dayDate} -> Week ${weekNumber}, ${year}`);
    
    // Create filtered analysis with only this day
    return {
        results: [{
            date: dayDate,
            day: new Date(dayDate).toLocaleDateString('en-GB', { weekday: 'long' }),
            consignments: targetDay.c || 0,
            expectedTotal: targetDay.e || 0,
            paidAmount: targetDay.p || 0,
            difference: (targetDay.p || 0) - (targetDay.e || 0),
            pickupCount: targetDay.pc || 0
        }],
        totals: {
            expectedTotal: targetDay.e || 0,
            paidTotal: targetDay.p || 0,
            totalConsignments: targetDay.c || 0,
            differenceTotal: (targetDay.p || 0) - (targetDay.e || 0),
            workingDays: 1
        },
        metadata: {
            periodRange: new Date(dayDate).toLocaleDateString('en-GB'),
            totalDays: 1,
            weekInfo: {
                week: weekNumber,
                year: year
            },
            analysisDate: new Date().toLocaleDateString('en-GB'),
            overallStatus: (targetDay.p || 0) >= (targetDay.e || 0) ? 'FAVORABLE' : 'UNFAVORABLE'
        }
    };
};

exports.loadWeekReport = function(weekInfo) {
    const State = requireModule('stateModule');
    const Router = requireModule('routerModule');
    const UI = requireModule('uiModule');
    
    console.log('📅 Loading report for week:', weekInfo);
    
    // Set the selected week in state
    State.setSelectedWeek(weekInfo);
    
    // Navigate to reports page
    Router.navigate('reports');
    
    // Show user feedback
    UI.showToast(`Viewing Week ${weekInfo.week}, ${weekInfo.year} report`, 'success');
};

exports.viewWeekReport = function(weekInfo) {
    const State = requireModule('stateModule');
    const Router = requireModule('routerModule');
    const UI = requireModule('uiModule');
    
    console.log('📅 Viewing report for week:', weekInfo);
    
    // Set the selected week in state
    State.setSelectedWeek(weekInfo);
    
    // Navigate to reports page
    Router.navigate('reports');
    
    // Show user feedback
    UI.showToast(`Viewing Week ${weekInfo.week}, ${weekInfo.year} report`, 'success');
};

exports.resetToFreshState = function() {
    // Clear all module-level variables
    uploadedFiles = [];
    manualEntries = [];
    lastAnalysisData = null;
    hasBeenAnalyzed = false;
    currentFilesSignature = null;
    currentStep = 1;
    currentInputMethod = 'upload';
    
    // Reset UI to default state
    setInputMethod('upload');
    setStep(1);
    
    // Update UI elements
    safeUpdateFileList();
    safeUpdateManualEntriesList();
    
    // Clear any saved manual entries from localStorage
    saveManualEntries();
    
    // Clear uploaded files info from localStorage
    clearUploadedFilesInfo();
    
    console.log('✨ Analysis module reset to fresh state');
};
</script>

<!-- Settings Module -->
<script id="settingsModule" type="application/x-module">
// Settings Module with enhanced data management
exports.init = function() {
    const Router = requireModule('routerModule');
    const Rules = requireModule('rulesModule');
    const UI = requireModule('uiModule');
    const State = requireModule('stateModule');
    
    // Register page handler
    Router.registerPageHandler('settings', {
        onLoad: () => {
            console.log('⚙️ Loading settings page');
            const rules = Rules.load();
            UI.updateSettingsForm(rules);
            
            // Update storage info
            State.updateStorageDisplay();
            
            // Setup instant feedback
            setupInstantFeedback();
        }
    });
    
    function setupInstantFeedback() {
        // Add instant feedback for settings changes
        const settingsInputs = document.querySelectorAll('.setting-input');
        const originalValues = {};

        settingsInputs.forEach(input => {
            originalValues[input.id] = input.value;
            
            input.addEventListener('input', (e) => {
                const hasChanged = e.target.value !== originalValues[e.target.id];
                
                if (hasChanged) {
                    e.target.style.borderColor = 'var(--warning)';
                    e.target.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
                    
                    // Show live preview
                    const previewValue = parseFloat(e.target.value) || 0;
                    const description = e.target.nextElementSibling?.nextElementSibling;
                    if (description) {
                        description.innerHTML = `${description.textContent.split('(')[0].trim()} <span style="color: var(--warning); font-weight: bold;">(unsaved: £${previewValue.toFixed(2)})</span>`;
                    }
                } else {
                    e.target.style.borderColor = '';
                    e.target.style.boxShadow = '';
                }
                
                // Enable/disable save button
                const saveBtn = document.getElementById('saveRules');
                const hasAnyChange = Array.from(settingsInputs).some(input => 
                    input.value !== originalValues[input.id]
                );
                saveBtn.disabled = !hasAnyChange;
                saveBtn.textContent = hasAnyChange ? 'Save Changes' : 'No Changes';
            });
        });
    }
    
    // Save rules
    document.getElementById('saveRules').addEventListener('click', () => {
        const newRules = UI.getSettingsFormData();
        const oldRules = Rules.load();
        
        // Check if rules actually changed
        const rulesChanged = 
            newRules.weekdayRate !== oldRules.weekdayRate ||
            newRules.saturdayRate !== oldRules.saturdayRate ||
            newRules.unloadingBonus !== oldRules.unloadingBonus ||
            newRules.attendanceBonus !== oldRules.attendanceBonus ||
            newRules.earlyBonus !== oldRules.earlyBonus;
        
        if (rulesChanged) {
            Rules.save(newRules);
            UI.showToast('Settings saved successfully', 'success');
            
            // Check if we have analysis data that might need recalculation
            const savedState = State.load();
            if (savedState && savedState.lastAnalysis) {
                setTimeout(() => {
                    if (confirm('Payment rules have been updated. Would you like to view reports to re-analyze with the new rules?')) {
                        Router.navigate('reports');
                    }
                }, 500);
            }
        } else {
            UI.showToast('No changes to save', 'warn');
        }
    });
    
    // Reset rules
    document.getElementById('resetRules').addEventListener('click', () => {
        if (confirm('Reset to default payment rules?')) {
            const defaultRules = Rules.getDefaults();
            Rules.save(defaultRules);
            UI.updateSettingsForm(defaultRules);
            UI.showToast('Reset to defaults', 'success');
        }
    });
    
    // Export current analysis
    document.getElementById('exportCurrentBtn').addEventListener('click', () => {
        const savedState = State.load();
        if (savedState && savedState.lastAnalysis) {
            State.exportData(savedState.lastAnalysis, false);
        } else {
            UI.showToast('No current analysis to export', 'warn');
        }
    });
    
    // Export all data
    document.getElementById('exportAllBtn').addEventListener('click', () => {
        const analyses = State.getAllAnalyses();
        const analysesCount = Object.keys(analyses).length;
        
        if (analysesCount === 0) {
            UI.showToast('No data to export', 'warn');
            return;
        }
        
        State.exportData(null, true);
    });
    
    // Clear all data with enhanced confirmation
    document.getElementById('clearAllData').addEventListener('click', () => {
        const analyses = State.getAllAnalyses();
        const analysesCount = Object.keys(analyses).length;
        
        if (analysesCount === 0) {
            UI.showToast('No data to clear', 'warn');
            return;
        }
        
        const message = `⚠️ DELETE ALL DATA?\n\nThis will permanently delete:\n• ${analysesCount} saved analyse(s)\n• All payment history\n• All cached results\n\nThis action cannot be undone!`;
        
        if (confirm(message)) {
            if (confirm('Are you absolutely sure? This will delete EVERYTHING!')) {
                State.clear();
                
                // Clear analysis module data through proper module access
                const analysisModule = requireModule('analysisModule');
                if (analysisModule && analysisModule.resetToFreshState) {
                    analysisModule.resetToFreshState();
                }
                
                UI.showToast('All data cleared successfully', 'success');
                
                // Navigate back to dashboard after clearing
                setTimeout(() => {
                    Router.navigate('dashboard');
                    // Refresh dashboard to show empty state
                    requireModule('dashboardModule').refresh();
                }, 500);
            }
        }
    });
    
    // Recovery banner handlers
    document.getElementById('startNewBtn').addEventListener('click', () => {
        UI.hideRecoveryBanner();
        Router.navigate('analysis');
    });
    
    document.getElementById('closeBannerBtn').addEventListener('click', () => {
        UI.hideRecoveryBanner();
    });
    
    // Add keyboard shortcuts for settings
    document.addEventListener('keydown', (e) => {
        if (Router.getCurrentPage() === 'settings') {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveRules').click();
            }
            // Ctrl/Cmd + R to reset
            if ((e.ctrlKey || e.metaKey) && e.key === 'r' && e.shiftKey) {
                e.preventDefault();
                document.getElementById('resetRules').click();
            }
        }
    });
};
</script>

<!-- App Module -->
<script id="appModule" type="application/x-module">
// Main Application Module - Production Ready
const APP_VERSION = '9.0.0';
const BUILD_DATE = '2024-12-20';

exports.boot = function() {
    console.log('🚀 Initializing Payment Analyzer Mobile v' + APP_VERSION);
    console.log('📅 Build date:', BUILD_DATE);
    
    try {
        // Check for browser compatibility
        if (!checkBrowserCompatibility()) {
            alert('Your browser may not support all features. Please use a modern browser for the best experience.');
        }
        
        // Initialize all modules
        requireModule('routerModule').init();
        requireModule('dashboardModule').init();
        requireModule('analysisModule').init();
        requireModule('reportsModule').init();
        requireModule('historyModule').init();
        requireModule('settingsModule').init();
        
        // Ensure dashboard shows correct state on initial load
        setTimeout(() => {
            requireModule('dashboardModule').refresh();
        }, 100);
        
        // Check for saved state and migrations
        checkAndMigrateData();
        
        // Check for recovery data
        checkRecoveryData();
        
        // Set up global error handling
        setupErrorHandling();
        
        // Check for iOS standalone mode
        if (window.navigator.standalone) {
            console.log('📱 Running in iOS standalone mode');
            document.body.classList.add('ios-standalone');
        }
        
        // Register service worker if available (for PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                console.log('Service worker registration skipped');
            });
        }
        
        console.log('✅ Application initialized successfully');
        
        // Add to window for debugging
        window.PA = {
            version: APP_VERSION,
            buildDate: BUILD_DATE,
            modules: {
                router: requireModule('routerModule'),
                state: requireModule('stateModule'),
                rules: requireModule('rulesModule'),
                parser: requireModule('parserModule'),
                ui: requireModule('uiModule'),
                dashboard: requireModule('dashboardModule'),
                analysis: requireModule('analysisModule'),
                reports: requireModule('reportsModule'),
                history: requireModule('historyModule'),
                settings: requireModule('settingsModule')
            },
            debug: {
                clearAll: () => {
                    if (confirm('Clear ALL data including analyses?')) {
                        requireModule('stateModule').clear();
                        location.reload();
                    }
                },
                exportState: () => {
                    const state = requireModule('stateModule').load();
                    console.log('Current state:', state);
                    return state;
                },
                getAnalyses: () => {
                    const analyses = requireModule('stateModule').getAllAnalyses();
                    console.log('All analyses:', analyses);
                    return analyses;
                },
                getStorageInfo: () => {
                    return requireModule('stateModule').getStorageInfo();
                }
            }
        };
        
        console.log('🔧 Debug interface available at window.PA');
        
    } catch (error) {
        console.error('❌ Boot error:', error);
        console.error('Stack trace:', error.stack);
        
        // Show user-friendly error
        const errorMessage = 'Failed to initialize the application. Please refresh the page or clear your browser cache.';
        if (document.body) {
            document.body.innerHTML = `
                <div style="padding: 20px; text-align: center; font-family: system-ui;">
                    <h2>⚠️ Loading Error</h2>
                    <p>${errorMessage}</p>
                    <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px;">Refresh Page</button>
                    <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; margin: 10px;">Clear Data & Refresh</button>
                </div>
            `;
        } else {
            alert(errorMessage);
        }
    }
};

function checkBrowserCompatibility() {
    // Check for required features
    const required = [
        typeof Promise !== 'undefined',
        typeof localStorage !== 'undefined',
        typeof FileReader !== 'undefined',
        typeof Blob !== 'undefined',
        'querySelector' in document,
        'addEventListener' in window
    ];
    
    return required.every(feature => feature);
}

function checkAndMigrateData() {
    try {
        const State = requireModule('stateModule');
        
        // Check for old version data (v8)
        const oldData = localStorage.getItem('paymentAnalyzer_v8');
        const oldAnalyses = localStorage.getItem('paymentAnalyzer_v8_analyses');
        
        if (oldData || oldAnalyses) {
            console.log('📦 Found v8 data, migrating to v9...');
            
            // Migrate v8 data to v9
            if (oldAnalyses) {
                // Parse and save old analyses to new format
                try {
                    let analysesData;
                    if (window.LZString) {
                        const decompressed = LZString.decompressFromUTF16(oldAnalyses);
                        if (decompressed) {
                            analysesData = JSON.parse(decompressed);
                        }
                    }
                    if (!analysesData) {
                        analysesData = JSON.parse(oldAnalyses);
                    }
                    
                    // Save to new key
                    const serialized = JSON.stringify(analysesData);
                    if (window.LZString) {
                        const compressed = LZString.compressToUTF16(serialized);
                        localStorage.setItem('paymentAnalyzer_v9_analyses', compressed);
                    } else {
                        localStorage.setItem('paymentAnalyzer_v9_analyses', serialized);
                    }
                    
                    console.log('✅ Successfully migrated analyses to v9');
                } catch (e) {
                    console.error('Failed to migrate analyses:', e);
                }
            }
            
            // Clean up old data
            localStorage.removeItem('paymentAnalyzer_v8');
            localStorage.removeItem('paymentAnalyzer_v8_compressed');
            localStorage.removeItem('paymentAnalyzer_v8_analyses');
        }
        
        // Verify data integrity
        const currentState = State.load();
        if (currentState && currentState.version !== State.VERSION) {
            console.log('🔄 Version mismatch, updating...');
            currentState.version = State.VERSION;
            State.save(currentState);
        }
        
    } catch (error) {
        console.error('Migration error:', error);
    }
}

function checkRecoveryData() {
    try {
        const State = requireModule('stateModule');
        const UI = requireModule('uiModule');
        
        const savedState = State.load();
        if (savedState && savedState.lastAnalysis && savedState.lastModified) {
            // Show recovery banner if data is less than 24 hours old
            const age = Date.now() - new Date(savedState.lastModified).getTime();
            if (age < 86400000) { // 24 hours
                UI.showRecoveryBanner(new Date(savedState.lastModified).getTime());
            }
        }
    } catch (error) {
        console.error('Recovery check error:', error);
    }
}

function setupErrorHandling() {
    // Global error handler
    window.addEventListener('error', (event) => {
        console.error('Global error:', event.error);
        
        // Log to analytics if available
        if (window.gtag) {
            window.gtag('event', 'exception', {
                description: event.error.toString(),
                fatal: false
            });
        }
    });
    
    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        
        // Prevent the default handling
        event.preventDefault();
        
        // Show user notification for critical errors
        if (event.reason && event.reason.message && event.reason.message.includes('PDF')) {
            requireModule('uiModule').showToast('Error processing PDF file', 'error');
        }
    });
    
    // Enhanced iOS memory management
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        // Monitor memory usage
        let memoryWarningCount = 0;
        
        // Periodic cleanup
        setInterval(() => {
            // Clear unused module cache
            if (window.performance && window.performance.memory) {
                const used = window.performance.memory.usedJSHeapSize;
                const limit = window.performance.memory.jsHeapSizeLimit;
                const usage = (used / limit) * 100;
                
                if (usage > 80) {
                    console.warn(`High memory usage: ${usage.toFixed(1)}%`);
                    memoryWarningCount++;
                    
                    // Clear old chart data
                    const charts = document.querySelectorAll('.bar-chart');
                    charts.forEach(chart => {
                        if (chart.children.length > 10) {
                            while (chart.children.length > 7) {
                                chart.removeChild(chart.firstChild);
                            }
                        }
                    });
                    
                    // Clear old history items if too many
                    const historyItems = document.querySelectorAll('.history-item');
                    if (historyItems.length > 20) {
                        for (let i = 20; i < historyItems.length; i++) {
                            historyItems[i].remove();
                        }
                    }
                    
                    // Force garbage collection if available
                    if (window.gc) {
                        window.gc();
                    }
                    
                    if (memoryWarningCount > 3) {
                        requireModule('uiModule').showToast('Memory usage high, consider restarting app', 'warn');
                    }
                }
            }
        }, 30000); // Check every 30 seconds
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Save critical state when app goes to background
                const State = requireModule('stateModule');
                const currentState = State.load();
                if (currentState) {
                    currentState.lastBackgrounded = Date.now();
                    State.save(currentState);
                }
            } else {
                // Refresh data when app comes back
                const Router = requireModule('routerModule');
                const currentPage = Router.getCurrentPage();
                
                if (currentPage === 'dashboard') {
                    requireModule('dashboardModule').refresh();
                }
            }
        });
        
        // Handle iOS memory warnings
        window.addEventListener('pagehide', () => {
            // Save state before potential termination
            const State = requireModule('stateModule');
            const currentState = State.load();
            if (currentState) {
                State.save(currentState);
            }
        });
    }
}
</script>

<!-- Module Loader -->
<script>
(function() {
    const modules = {};
    const moduleCache = {};
    
    window.defineModule = function(id, factory) {
        modules[id] = factory;
    };
    
    window.requireModule = function(id) {
        if (moduleCache[id]) return moduleCache[id];
        if (!modules[id]) {
            console.error(`❌ Module ${id} not found. Available modules:`, Object.keys(modules));
            throw new Error(`Module ${id} not found`);
        }
        
        const module = { exports: {} };
        const require = (depId) => requireModule(depId);
        
        try {
            modules[id].call(module.exports, module, module.exports, require);
            moduleCache[id] = module.exports;
        } catch (error) {
            console.error(`❌ Error executing module ${id}:`, error);
            throw error;
        }
        
        return module.exports;
    };
    
    function loadModules() {
        console.log('📦 Starting module loading...');
        const moduleScripts = document.querySelectorAll('script[type="application/x-module"]');
        console.log(`Found ${moduleScripts.length} modules to load`);
        
        let loadedCount = 0;
        let failedModules = [];
        
        moduleScripts.forEach(script => {
            const id = script.id;
            const content = script.textContent;
            
            if (!id) {
                console.error('❌ Module script found without ID');
                return;
            }
            
            console.log(`Loading module: ${id}`);
            
            try {
                // Check for syntax errors first
                try {
                    new Function(content); // Basic syntax check
                } catch (syntaxError) {
                    console.error(`❌ Syntax error in module ${id}:`, syntaxError);
                    failedModules.push({id, error: syntaxError});
                    return;
                }
                
                const factory = new Function('module', 'exports', 'require', content);
                defineModule(id, factory);
                loadedCount++;
                console.log(`✅ Module ${id} loaded successfully (${loadedCount}/${moduleScripts.length})`);
            } catch (error) {
                console.error(`❌ Failed to load module ${id}:`, error);
                console.error(`Module content preview:`, content.substring(0, 200) + '...');
                failedModules.push({id, error});
            }
        });
        
        console.log(`📊 Module loading complete: ${loadedCount}/${moduleScripts.length} loaded`);
        
        if (failedModules.length > 0) {
            console.error('❌ Failed modules:', failedModules);
            
            // Show detailed error on page
            const errorDetails = failedModules.map(m => 
                `Module: ${m.id}\nError: ${m.error.message}`
            ).join('\n\n');
            
            document.body.innerHTML = `
                <div style="padding: 20px; font-family: monospace; background: #fff;">
                    <h2 style="color: red;">⚠️ Module Loading Errors</h2>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">
${errorDetails}
                    </pre>
                    <p><strong>Debug Info:</strong></p>
                    <ul>
                        <li>Total modules: ${moduleScripts.length}</li>
                        <li>Loaded: ${loadedCount}</li>
                        <li>Failed: ${failedModules.length}</li>
                    </ul>
                    <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px;">Retry</button>
                    <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; margin: 10px;">Clear & Retry</button>
                </div>
            `;
            
            throw new Error('Module loading failed');
        }
        
        return true;
    }
    
    function bootstrap() {
        console.log('=== PAYMENT ANALYZER PRO v9.0 ENHANCED BOOTSTRAP ===');
        console.log('Browser:', navigator.userAgent);
        console.log('URL:', window.location.href);
        
        try {
            // Check basic requirements
            if (!window.localStorage) {
                throw new Error('localStorage not available');
            }
            
            if (!window.FileReader) {
                throw new Error('FileReader API not available');
            }
            
            // Load modules
            const modulesLoaded = loadModules();
            if (!modulesLoaded) {
                return; // Error already handled
            }
            
            // Initialize app
            console.log('🚀 Initializing app module...');
            const app = requireModule('appModule');
            
            if (app && app.boot) {
                console.log('📱 Calling app.boot()...');
                app.boot();
                console.log('✅ Application started successfully');
            } else {
                throw new Error('App module or boot function not found');
            }
        } catch (error) {
            console.error('❌ Bootstrap failed:', error);
            console.error('Stack trace:', error.stack);
            
            // More detailed error display
            const errorHtml = `
                <div style="padding: 20px; font-family: system-ui; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #dc2626;">⚠️ Loading Error</h2>
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <p style="margin: 0 0 10px 0;"><strong>Error:</strong> ${error.message}</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #dc2626;">Technical Details</summary>
                            <pre style="margin: 10px 0 0 0; font-size: 12px; overflow: auto; background: white; padding: 10px; border-radius: 4px;">${error.stack}</pre>
                        </details>
                    </div>
                    <p>Please try one of these options:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Refresh Page</button>
                        <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">Clear Data & Refresh</button>
                        <button onclick="window.open('https://www.google.com/chrome/', '_blank')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">Try Chrome Browser</button>
                    </div>
                    <div style="margin-top: 30px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                        <p style="margin: 0 0 10px 0;"><strong>Browser Info:</strong></p>
                        <code style="font-size: 11px; word-break: break-all;">${navigator.userAgent}</code>
                    </div>
                </div>
            `;
            
            if (document.body) {
                document.body.innerHTML = errorHtml;
            } else {
                alert('Critical error: ' + error.message);
            }
        }
    }
    
    // Start when DOM is ready
    console.log('🔄 Waiting for DOM...');
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM loaded, starting bootstrap...');
            bootstrap();
        });
    } else {
        console.log('📄 DOM already loaded, starting bootstrap...');
        setTimeout(bootstrap, 0);
    }
})();
</script>

